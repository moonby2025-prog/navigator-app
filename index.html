<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investment Navigator (Ìà¨Ïûê ÎπÑÏÑú)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome (Icons) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <!-- React, ReactDOM, Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; letter-spacing: -0.02em; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        .nav-tab.active { background-color: #eff6ff; color: #2563eb; font-weight: 700; box-shadow: 0 1px 2px rgba(37,99,235,0.2); }
        .dark .nav-tab.active { background-color: #1e293b; color: #60a5fa; }
        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .sim-input { @apply mt-1 block w-full rounded-md border-gray-300 dark:border-slate-600 shadow-sm p-2 border dark:bg-slate-700 focus:ring-indigo-500 focus:border-indigo-500 text-sm font-bold; }
        .num-font { font-variant-numeric: tabular-nums; }
        .guide-card { @apply p-4 rounded-xl border border-slate-100 dark:border-slate-700 bg-white dark:bg-slate-800 shadow-sm; }
        
        /* Ìã∞Ïª§ Ïï†ÎãàÎ©îÏù¥ÏÖò Ìè¥Î∞± (Ïä§ÌÅ¨Î¶ΩÌä∏ Ï∞®Îã® Ïãú ÏãúÍ∞ÅÏ†Å Ìö®Í≥ºÏö©) */
        .ticker-fallback {
            display: flex;
            white-space: nowrap;
            overflow: hidden;
            align-items: center;
            height: 100%;
        }
        .ticker-scroll {
            display: inline-block;
            animation: tickerScroll 30s linear infinite;
            padding-left: 100%;
        }
        @keyframes tickerScroll {
            0% { transform: translateX(0); }
            100% { transform: translateX(-100%); }
        }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-900 transition-colors duration-200">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, memo, useCallback } = React;

        // --- Global Constants ---
        const ONE_HUNDRED_MILLION = 100000000;
        const TAX_THRESHOLD = 20000000;
        
        const DEFAULT_EXCHANGE_RATES = { 
            'KRW': { krw: 1 }, 
            'USD': { krw: 1380 }, 
            'JPY': { krw: 8.90 }, 
            'EUR': { krw: 1480 }, 
            'CNY': { krw: 190 }, 
            'ARS': { krw: 1.35 }, 
            'INR': { krw: 16.5 }
        };

        // --- Helpers ---
        const formatNumber = (num) => {
            if (num === null || num === undefined || isNaN(num)) return '0';
            return Math.round(num).toLocaleString('ko-KR');
        };
        const parseFormattedNumber = (value) => {
            if (typeof value !== 'string') return value || 0;
            return parseInt(value.replace(/[^0-9]/g, '')) || 0;
        };

        const calculateProgressiveIncomeTax = (income, rates) => {
            if (income <= 0) return 0;
            const threshold1 = 40000000;
            const threshold2 = 80000000;
            let tax = 0;
            const income1 = Math.min(income, threshold1);
            tax += income1 * (rates.rate1 / 100);
            if (income > threshold1) {
                const income2 = Math.min(income, threshold2) - threshold1;
                tax += income2 * (rates.rate2 / 100);
            }
            if (income > threshold2) {
                const income3 = income - threshold2;
                tax += income3 * (rates.rate3 / 100);
            }
            return Math.max(0, tax);
        };

        // --- Widgets ---
        const TradingViewTicker = memo(({ theme }) => {
            const containerRef = useRef(null);
            const [isLoaded, setIsLoaded] = useState(false);

            useEffect(() => {
                const container = containerRef.current;
                if (!container) return;
                
                container.innerHTML = '';
                const widgetDiv = document.createElement('div');
                widgetDiv.className = 'tradingview-widget-container__widget';
                container.appendChild(widgetDiv);

                const script = document.createElement('script');
                script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-ticker-tape.js';
                script.async = true;
                script.innerHTML = JSON.stringify({
                    "symbols": [
                        { "proName": "FOREXCOM:SPXUSD", "title": "S&P 500" },
                        { "proName": "NASDAQ:QQQ", "title": "ÎÇòÏä§Îã• QQQ" },
                        { "proName": "FX_IDC:USDKRW", "title": "ÏõêÎã¨Îü¨ ÌôòÏú®" },
                        { "proName": "FX_IDC:XAGUSD", "title": "ÏùÄ ÌòÑÎ¨º (XAG/USD)" },
                        { "proName": "BINANCE:BTCUSDT", "title": "ÎπÑÌä∏ÏΩîÏù∏" },
                        { "proName": "TVC:GOLD", "title": "Í∏à ÌòÑÎ¨º (XAU/USD)" },
                        { "proName": "NASDAQ:NVDA", "title": "ÏóîÎπÑÎîîÏïÑ" },
                        { "proName": "NASDAQ:TSLA", "title": "ÌÖåÏä¨Îùº" },
                        { "proName": "FX_IDC:JPYKRW", "title": "ÏóîÌôî ÌôòÏú®" },
                        { "proName": "KRX:005930", "title": "ÏÇºÏÑ±Ï†ÑÏûê" }
                    ],
                    "showSymbolLogo": true,
                    "colorTheme": theme,
                    "isTransparent": true,
                    "displayMode": "adaptive",
                    "locale": "kr"
                });

                script.onload = () => setIsLoaded(true);
                container.appendChild(script);

                const checkTimer = setTimeout(() => {
                    if (container.querySelector('iframe')) setIsLoaded(true);
                }, 2000);

                return () => clearTimeout(checkTimer);
            }, [theme]);

            return (
                <div className="relative w-full h-full overflow-hidden">
                    <div className={`tradingview-widget-container ${isLoaded ? 'opacity-100' : 'opacity-0'} transition-opacity duration-500`} ref={containerRef}></div>
                    {!isLoaded && (
                        <div className="absolute inset-0 ticker-fallback text-xs font-bold text-slate-400 dark:text-slate-500">
                            <div className="ticker-scroll flex gap-8">
                                <span><i className="fa-solid fa-chart-line mr-1"></i> S&P 500: Îç∞Ïù¥ÌÑ∞ Ïó∞Í≤∞ Ï§ë...</span>
                                <span><i className="fa-solid fa-money-bill-1-wave mr-1"></i> USD/KRW: 1,380.00</span>
                                <span><i className="fa-brands fa-bitcoin mr-1"></i> BTC/USDT: Ïã§ÏãúÍ∞Ñ Ïó∞Í≤∞ Ï§ë</span>
                                <span><i className="fa-solid fa-coins mr-1"></i> GOLD: ÏãúÏÑ∏ Î°úÎî© Ï§ë...</span>
                                <span><i className="fa-solid fa-microchip mr-1"></i> NVDA: ÎåÄÍ∏∞ Ï§ë</span>
                                <span><i className="fa-solid fa-car-bolt mr-1"></i> TSLA: ÎåÄÍ∏∞ Ï§ë</span>
                                <span><i className="fa-solid fa-chart-line mr-1"></i> KOSPI: Ï†ïÎ≥¥ ÏàòÏã† Ï§ë</span>
                            </div>
                        </div>
                    )}
                </div>
            );
        });

        const TradingViewHeatmap = memo(({ theme }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (!ref.current) return;
                ref.current.innerHTML = '';
                const script = document.createElement('script');
                script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-stock-heatmap.js';
                script.async = true;
                script.innerHTML = JSON.stringify({
                    "dataSource": "SPX500", "grouping": "sector", "blockSize": "market_cap_basic", "blockColor": "change", "locale": "kr", "colorTheme": theme, "hasTopBar": false, "isTransparent": true, "width": "100%", "height": "100%"
                });
                ref.current.appendChild(script);
            }, [theme]);
            return <div ref={ref} className="h-full"></div>;
        });

        // --- Main Component ---
        function App() {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [isDark, setIsDark] = useState(false);
            const [linkMode, setLinkMode] = useState('investment');
            const [marketStatus, setMarketStatus] = useState({ text: 'Ïû• ÎßàÍ∞ê', color: 'bg-red-600' });
            
            const [exchangeRates, setExchangeRates] = useState(DEFAULT_EXCHANGE_RATES);
            const [lastUpdated, setLastUpdated] = useState('Ïó∞Í≤∞ Ï§ë...');
            const [isFetching, setIsFetching] = useState(false);

            const [isRoutineEditMode, setIsRoutineEditMode] = useState(false);
            const [newFav, setNewFav] = useState({ name: '', code: '' });
            const [newRoutine, setNewRoutine] = useState({ category: '', name: '', url: '' });

            const [favorites, setFavorites] = useState([
                { code: "005930", name: "ÏÇºÏÑ±Ï†ÑÏûê" }, { code: "005380", name: "ÌòÑÎåÄÏ∞®" }, 
                { code: "237690", name: "ÏóêÏä§Ìã∞Ìåú" }, { code: "445680", name: "ÌÅêÎ¶¨Ïò•Ïä§" }
            ]);

            const [routineLinks, setRoutineLinks] = useState({
                "üåÖ ÏïÑÏπ® ÌïÑÏàò Ï≤¥ÌÅ¨ (Morning Routine)": [
                    { name: "ÎØ∏Íµ≠ ÏãúÏû• Ï†êÍ≤Ä", url: "https://kr.investing.com/portfolio/?portfolioID=OT4%2BZDRrZTFjM2thYTthYg%3D%3D", icon: "fa-list-check", color: "bg-blue-100 text-blue-700" },
                    { name: "Finviz (ÎØ∏Íµ≠ Îßµ)", url: "https://finviz.com/map.ashx", icon: "fa-map", color: "bg-emerald-100 text-emerald-700" },
                    { name: "ÌïÑÎùºÎç∏ÌîºÏïÑ Î∞òÎèÑÏ≤¥", url: "https://kr.investing.com/indices/phlx-semiconductor", icon: "fa-microchip", color: "bg-teal-100 text-teal-700" },
                    { name: "Í≥µÌè¨ ÌÉêÏöï ÏßÄÏàò (CNN)", url: "https://edition.cnn.com/markets/fear-and-greed", icon: "fa-gauge-high", color: "bg-orange-100 text-orange-700" },
                    { name: "ÌÅ¨Î¶ΩÌÜ† ÏßÄÌëú (MVRV)", url: "https://www.bitcoinmagazinepro.com/charts/mvrv-zscore/", icon: "fa-chart-area", color: "bg-amber-100 text-amber-700" },
                    { name: "SILVER (ÏùÄ Ïã§ÏãúÍ∞Ñ)", url: "https://kr.investing.com/currencies/xag-usd", icon: "fa-coins", color: "bg-slate-100 text-slate-700" },
                    { name: "ÏùÄÏãúÏÑ∏(ÏàúÏàòÌïúÍ∏à)", url: "https://blog.naver.com/wolfkickbox", icon: "fa-blog", color: "bg-yellow-100 text-yellow-700" }
                ],
                "üí∞ Í≥µÎ™®Ï£º & Ïã§Ï†Å (IPO & Earnings)": [
                    { name: "38 Ïª§ÎÆ§ÎãàÏºÄÏù¥ÏÖò", url: "http://www.38.co.kr/html/fund/index.htm?gjbcd=1460", icon: "fa-building", color: "bg-purple-100 text-purple-700" },
                    { name: "DART (Ï†ÑÏûêÍ≥µÏãú)", url: "https://dart.fss.or.kr/", icon: "fa-file-signature", color: "bg-yellow-100 text-yellow-700" },
                    { name: "KIND (Í∏∞ÏóÖÍ≥µÏãú)", url: "https://kind.krx.co.kr/", icon: "fa-file-invoice", color: "bg-blue-50 text-blue-600" },
                    { name: "KRX Ï†ïÎ≥¥Îç∞Ïù¥ÌÑ∞ÏãúÏä§ÌÖú", url: "http://data.krx.co.kr/", icon: "fa-database", color: "bg-indigo-100 text-indigo-700" },
                    { name: "Seibro (Ï¶ùÍ∂åÏ†ïÎ≥¥Ìè¨ÌÑ∏)", url: "https://seibro.or.kr/", icon: "fa-server", color: "bg-indigo-50 text-indigo-600" },
                    { name: "Ï¢ÖÎ™©Î≥Ñ Ïô∏Íµ≠Ïù∏ Íµ≠Ï†ÅÎ∂ÑÎ•ò", url: "https://data.krx.co.kr/contents/MDC/HARD/hardController/MDCHARD053.cmd", icon: "fa-globe", color: "bg-blue-50 text-blue-700" }
                ],
                "üìà Íµ≠ÎÇ¥ ÏãúÏû• Ïã¨Ï∏µ (Korea Market)": [
                    { name: "ÎÑ§Ïù¥Î≤Ñ Í∏àÏúµ", url: "https://finance.naver.com/", icon: "fa-n", color: "bg-green-50 text-green-600" },
                    { name: "Î≤ÑÌãÄÎü¨ (Butler)", url: "https://www.butler.works/ko/home", icon: "fa-chart-line", color: "bg-purple-50 text-purple-600" },
                    { name: "ÌïúÍ≤Ω Ïª®ÏÑºÏÑúÏä§", url: "https://markets.hankyung.com/consensus", icon: "fa-book-open", color: "bg-red-50 text-red-600" },
                    { name: "SMIC (ÏÑúÏö∏ÎåÄ Î¶¨ÏÑúÏπò)", url: "http://snusmic.com/research/", icon: "fa-graduation-cap", color: "bg-slate-200 text-slate-800" },
                    { name: "FDA ÏäπÏù∏ Ïã§ÏãúÍ∞Ñ", url: "https://www.youtube.com/user/USFoodandDrugAdmin", icon: "fa-video", color: "bg-red-100 text-red-700" },
                    { name: "Ï£ºÏãù/Î∂ÄÎèôÏÇ∞ Î™®ÏïÑÎ¥ê", url: "http://moabbs.com/blogs/lists", icon: "fa-users", color: "bg-orange-100 text-orange-700" },
                    { name: "Ï†ÑÏûêÏû°ÏßÄ (Î™®ÏïÑÏßÑ)", url: "https://lib.ice.go.kr/elib/module/elib/moazine.do?menu_idx=37", icon: "fa-book-open", color: "bg-yellow-100 text-yellow-700" }
                ],
                "üè° ÏùºÏÉÅ & Î∂ÄÎèôÏÇ∞ (Daily Life)": [
                    { name: "Ìò∏Í∞±ÎÖ∏ÎÖ∏", url: "https://hogangnono.com/", icon: "fa-map-pin", color: "bg-red-50 text-red-600" },
                    { name: "ÎÑ§Ïù¥Î≤Ñ Î∂ÄÎèôÏÇ∞", url: "https://land.naver.com/", icon: "fa-building", color: "bg-green-50 text-green-600" },
                    { name: "ÎÑ§Ïù¥Î≤Ñ ÏßÄÎèÑ", url: "https://map.naver.com/", icon: "fa-location-dot", color: "bg-blue-50 text-blue-600" },
                    { name: "Íµ¨Í∏Ä ÏßÄÎèÑ", url: "https://maps.google.com/", icon: "fa-location-dot", color: "bg-amber-50 text-amber-600" }
                ]
            });

            const [blogInsightLinks, setBlogInsightLinks] = useState({
                "üß¨ ÌÅêÎ¶¨Ïò•Ïä§Î∞îÏù¥Ïò§ÏãúÏä§ÌÖúÏ¶à": [
                    {name: "ÌïúÍ≥ÑÎ•º Íπ®Îäî ÏÇ¨Îûå", url: "https://blog.naver.com/unlimitedi"},
                    {name: "ÎÇòÎäî Ï†ÑÏÑ§Ïù¥Îã§", url: "https://blog.naver.com/legendyu"},
                    {name: "Ïù¥Í≥µÍ≥Ñ", url: "https://blog.naver.com/shyny38"},
                    {name: "Í≥µÎåÄÏÉù Ï£ºÏ†ëÎÖ∏Ìä∏", url: "https://blog.naver.com/b_g-duck"}
                ],
                "üíä ÏóêÏä§Ìã∞Ìåú": [
                    {name: "Ïò§Ïû¨Î≥µ", url: "https://blog.naver.com/hym090206"},
                    {name: "Ïô†ÏßÄÏÉÅÏæåÌïúÏÇ¨Îûå", url: "https://blog.naver.com/aphorism86"},
                    {name: "Chan", url: "https://blog.naver.com/chany2do"}
                ]
            });

            const [targetInputs, setTargetInputs] = useState({ mode: 'cap', price: '', shares: '', currentCap: '', targetCap: '', targetRate: '' });
            const [ipoCalcInputs, setIpoCalcInputs] = useState({ price: '', qty: '', fee: '', rate: 50 });
            const [avgRows, setAvgRows] = useState([{ id: 1, q: '', p: '' }]);
            const [exchInputs, setExchInputs] = useState({ base: 'USD', target: 'KRW', amount: '' });
            const [divInputs, setDivInputs] = useState({ shares: '', perShare: '', tax: '15.4' });
            const [toolTaxInputs, setToolTaxInputs] = useState({ profit: '', type: 'dividend' });

            const [simInputs, setSimInputs] = useState({
                currentAge: 51, spouseCurrentAge: 47, simulationStartAge: 53, 
                pensionStartAgeUser: 65, pensionStartAgeSpouse: 65,
                highCostStartAge: 80,
                capUserNonISA: 3.0, capSpouseNonISA: 2.0, capUserISA: 3.0, capSpouseISA: 2.0, 
                returnUserNonISA: 3.0, returnSpouseNonISA: 3.0, 
                returnUserISA: 3.0, returnSpouseISA: 3.0, 
                inflationRate: 2.0, livingCostInflationRate: 1.5, taxRate1: 6.6, taxRate2: 16.5, taxRate3: 27.5,
                monthlyLiving: "5,000,000", pensionSelf: "1,000,000", pensionSpouse: "600,000", ipoProfit: "5,000,000", otherIncome: "4,500,000", stockLending: "0", rentalIncome: "850,000",
                targetLegacy: "200,000,000", extraReserve: "5,000,000",
                monthlyMedical: "2,000,000"
            });
            const [simResult, setSimResult] = useState({ history: [], summary: null });
            
            const [finList, setFinList] = useState([]);
            const [otherIncomeList, setOtherIncomeList] = useState([]);

            const handleCommaChange = (e, callback) => {
                const val = e.target.value.replace(/[^0-9]/g, '');
                callback(val ? parseInt(val).toLocaleString('ko-KR') : '');
            };

            const fetchRealTimeRates = useCallback(async () => {
                setIsFetching(true);
                try {
                    const response = await fetch('https://open.er-api.com/v6/latest/KRW');
                    const data = await response.json();
                    if (data.result === 'success') {
                        const rates = data.rates;
                        const newRates = {
                            'KRW': { krw: 1 }, 
                            'USD': { krw: 1 / (rates.USD || 0.00072) }, 
                            'JPY': { krw: 1 / (rates.JPY || 0.11) },
                            'EUR': { krw: 1 / (rates.EUR || 0.00067) }, 
                            'CNY': { krw: 1 / (rates.CNY || 0.0052) },
                            'ARS': { krw: 1 / (rates.ARS || 0.65) }, 
                            'INR': { krw: 1 / (rates.INR || 0.06) }
                        };
                        setExchangeRates(newRates);
                        setLastUpdated(new Date().toLocaleString());
                    }
                } catch (error) {
                    console.error("ÌôòÏú® Î°úÎìú Ïã§Ìå®:", error);
                    setLastUpdated("Ïã§Ìå® (Í∏∞Î≥∏Í∞í ÏÇ¨Ïö©)");
                } finally { setIsFetching(false); }
            }, []);

            useEffect(() => {
                fetchRealTimeRates();
                const timer = setInterval(() => {
                    const now = new Date();
                    const hours = now.getHours();
                    const day = now.getDay();
                    let status = { text: "Ïû• ÎßàÍ∞ê", color: "bg-red-600" };
                    if (hours >= 9 && hours < 16 && day !== 0 && day !== 6) status = { text: "Íµ≠ÎÇ¥ Ïû• Ïö¥ÏòÅ", color: "bg-green-600" };
                    else if (hours >= 22 || hours < 6) status = { text: "ÎØ∏Íµ≠ Ïû• Ïö¥ÏòÅ", color: "bg-blue-600" };
                    setMarketStatus(status);
                }, 1000);
                return () => clearInterval(timer);
            }, [fetchRealTimeRates]);

            useEffect(() => {
                if (isDark) document.documentElement.classList.add('dark');
                else document.documentElement.classList.remove('dark');
            }, [isDark]);

            const searchSymbol = (query) => {
                if(!query) return;
                const url = /[a-zA-Z]/.test(query) ? `https://finance.naver.com/world/sise.naver?symbol=${query.trim().toUpperCase()}` : `https://finance.naver.com/item/main.naver?code=${query.trim()}`;
                window.open(url, '_blank');
            };

            const runSimulation = useCallback(() => {
                const s = simInputs;
                const ageDiff = s.currentAge - s.spouseCurrentAge;
                let cUserNon = s.capUserNonISA * ONE_HUNDRED_MILLION;
                let cSpouseNon = s.capSpouseNonISA * ONE_HUNDRED_MILLION;
                let cUserISA = s.capUserISA * ONE_HUNDRED_MILLION;
                let cSpouseISA = s.capSpouseISA * ONE_HUNDRED_MILLION;
                
                const targetLegacyValue = parseFormattedNumber(s.targetLegacy);
                const extraReserveValue = parseFormattedNumber(s.extraReserve);
                const medicalCostMonthly = parseFormattedNumber(s.monthlyMedical);
                
                const initLiving = parseFormattedNumber(s.monthlyLiving) * 12;
                const initPenSelf = parseFormattedNumber(s.pensionSelf) * 12;
                const initPenSpouse = parseFormattedNumber(s.pensionSpouse) * 12;
                const initOtherTotal = parseFormattedNumber(s.ipoProfit) + parseFormattedNumber(s.otherIncome) + parseFormattedNumber(s.stockLending) + parseFormattedNumber(s.rentalIncome);
                let history = []; let totalTax = 0; let depletionYear = null;
                const period = Math.max(1, 95 - s.simulationStartAge);
                
                for (let year = 1; year <= period; year++) {
                    const age = s.simulationStartAge + year - 1;
                    const spouseAge = age - ageDiff;
                    const pInf = Math.pow(1 + (s.inflationRate / 100), year - 1);
                    const lInf = Math.pow(1 + (s.livingCostInflationRate / 100), year - 1);
                    
                    let weight = 1.0;
                    let isHighCost = false;
                    let lateLifeMedicalAnnual = 0;

                    if (age >= Math.min(s.pensionStartAgeUser, s.pensionStartAgeSpouse)) {
                        if (age < s.highCostStartAge - 5) {
                            weight = 1.1; 
                        } else if (age < s.highCostStartAge) {
                            weight = 0.9; 
                        } else {
                            weight = 0.7; 
                            lateLifeMedicalAnnual = medicalCostMonthly * 12 * lInf; 
                            isHighCost = true;
                        }
                    }
                    
                    const livingCost = (initLiving * lInf * weight) + lateLifeMedicalAnnual + extraReserveValue;
                    
                    let pension = 0;
                    if (age >= s.pensionStartAgeUser) pension += initPenSelf; 
                    if (spouseAge >= s.pensionStartAgeSpouse) pension += initPenSpouse;
                    
                    const baseIncomeAtYear = (pension + initOtherTotal) * pInf;
                    
                    const profUserNon = cUserNon * (s.returnUserNonISA / 100) * 0.846;
                    const profSpouseNon = cSpouseNon * (s.returnUserNonISA / 100) * 0.846;
                    const profUserISA = cUserISA * (s.returnUserISA / 100) * 0.901;
                    const profSpouseISA = cSpouseISA * (s.returnSpouseISA / 100) * 0.901;
                    const profInvestmentTotal = profUserNon + profSpouseNon + profUserISA + profSpouseISA;
                    
                    const incTax = calculateProgressiveIncomeTax(baseIncomeAtYear, { rate1: s.taxRate1, rate2: s.taxRate2, rate3: s.taxRate3 });
                    totalTax += incTax;

                    const annualProfitTotal = profInvestmentTotal + baseIncomeAtYear;
                    const annualExpenseTotal = livingCost + incTax;
                    const netChange = annualProfitTotal - annualExpenseTotal;

                    let withdrawal = netChange < 0 ? Math.abs(netChange) : 0;
                    if (netChange >= 0) {
                        const tBefore = cUserNon + cSpouseNon + cUserISA + cSpouseISA;
                        if (tBefore > 0) {
                            const r1 = cUserNon / tBefore; const r2 = cSpouseNon / tBefore; const r3 = cUserISA / tBefore; const r4 = cSpouseISA / tBefore;
                            cUserNon += netChange * r1; cSpouseNon += netChange * r2; cUserISA += netChange * r3; cSpouseISA += netChange * r4;
                        } else {
                            cUserNon += netChange;
                        }
                    } else {
                        let rem = withdrawal;
                        let w1 = Math.min(rem, cUserNon); cUserNon -= w1; rem -= w1;
                        let w2 = Math.min(rem, cSpouseNon); cSpouseNon -= w2; rem -= w2;
                        let w3 = Math.min(rem, cSpouseISA); cSpouseISA -= w3; rem -= w3;
                        let w4 = Math.min(rem, cUserISA); cUserISA -= w4; rem -= w4;
                        if (rem > 0 && !depletionYear) depletionYear = age;
                    }

                    const currentTotal = cUserNon + cSpouseNon + cUserISA + cSpouseISA;

                    history.push({ 
                        age, 
                        total: currentTotal / ONE_HUNDRED_MILLION, 
                        tax: incTax, 
                        living: livingCost, 
                        profInvestment: profInvestmentTotal,
                        baseIncome: baseIncomeAtYear,
                        annualProfit: annualProfitTotal,
                        netChange: netChange,
                        un: cUserNon/ONE_HUNDRED_MILLION, 
                        sn: cSpouseNon/ONE_HUNDRED_MILLION, 
                        ui: cUserISA/ONE_HUNDRED_MILLION, 
                        si: cSpouseISA/ONE_HUNDRED_MILLION,
                        isHighCost,
                        medicalShare: (lateLifeMedicalAnnual / livingCost) * 100, 
                        isWarn: currentTotal < targetLegacyValue 
                    });
                    
                    if (currentTotal <= 0 && year > 1) break;
                }
                setSimResult({ history, summary: { initial: s.capUserNonISA + s.capSpouseNonISA + s.capUserISA + s.capSpouseISA, final: (history[history.length-1]?.total * ONE_HUNDRED_MILLION) || 0, tax: totalTax, depletion: depletionYear, isSuccess: (history[history.length-1]?.total * ONE_HUNDRED_MILLION) >= targetLegacyValue } });
            }, [simInputs]);

            useEffect(() => { runSimulation(); }, [runSimulation]);

            const SimulationChart = memo(({ history }) => {
                const canvasRef = useRef(null);
                const chartInstance = useRef(null);
                useEffect(() => {
                    if (!canvasRef.current || history.length === 0) return;
                    const ctx = canvasRef.current.getContext('2d');
                    if (chartInstance.current) chartInstance.current.destroy();
                    chartInstance.current = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: history.map(h => h.age + "ÏÑ∏"),
                            datasets: [
                                { label: 'Ï¥ù ÏûêÏÇ∞(Ïñµ)', data: history.map(h => h.total), borderColor: '#4f46e5', fill: true, backgroundColor: 'rgba(79, 70, 229, 0.1)', tension: 0.3, pointRadius: 2 },
                                { label: 'Î≥∏Ïù∏ ÏùºÎ∞ò', data: history.map(h => h.un), borderColor: '#ef4444', borderDash: [2,2], pointRadius: 0 },
                                { label: 'Î∞∞Ïö∞Ïûê ÏùºÎ∞ò', data: history.map(h => h.sn), borderColor: '#f59e0b', borderDash: [2,2], pointRadius: 0 },
                                { label: 'Î≥∏Ïù∏ ISA', data: history.map(h => h.ui), borderColor: '#10b981', pointRadius: 0 },
                                { label: 'Î∞∞Ïö∞Ïûê ISA', data: history.map(h => h.si), borderColor: '#3b82f6', pointRadius: 0 }
                            ]
                        },
                        options: { 
                            responsive: true, maintainAspectRatio: false, animation: false,
                            scales: { y: { beginAtZero: true } },
                            plugins: { legend: { position: 'top', labels: { boxWidth: 10, font: { size: 10, weight: 'bold' } } } }
                        }
                    });
                    return () => { if (chartInstance.current) chartInstance.current.destroy(); };
                }, [history]);
                return <div className="h-64 md:h-80 w-full"><canvas ref={canvasRef}></canvas></div>;
            });

            // --- Other Tab Handlers ---
            const addFavorite = () => { if (!newFav.name || !newFav.code) return; setFavorites([...favorites, { name: newFav.name, code: newFav.code }]); setNewFav({ name: '', code: '' }); };
            const removeFavorite = (code) => { setFavorites(favorites.filter(f => f.code !== code)); };
            const addRoutineLink = () => { if (!newRoutine.category || !newRoutine.name || !newRoutine.url) return; const updated = { ...routineLinks }; updated[newRoutine.category] = [...updated[newRoutine.category], { name: newRoutine.name, url: newRoutine.url, icon: "fa-link", color: "bg-slate-100 text-slate-700" }]; setRoutineLinks(updated); setNewRoutine({ category: '', name: '', url: '' }); };
            const removeRoutineLink = (category, index) => { const updated = { ...routineLinks }; updated[category] = updated[category].filter((_, i) => i !== index); setRoutineLinks(updated); };

            const renderDashboard = () => (
                <div className="space-y-6 animate-fade-in pb-10">
                    <div className="bg-white dark:bg-slate-800 rounded-xl shadow h-16 overflow-hidden border dark:border-slate-700">
                        <TradingViewTicker theme={isDark ? 'dark' : 'light'} />
                    </div>
                    <div className="bg-white dark:bg-slate-800 p-1 rounded-xl shadow h-[400px] border dark:border-slate-700 flex flex-col">
                        <div className="p-3 border-b dark:border-slate-700 flex justify-between items-center font-bold">
                            <span>S&P 500 ÌûàÌä∏Îßµ</span>
                            <span className={`px-2 py-0.5 rounded-full text-[10px] text-white ${marketStatus.color}`}>{marketStatus.text}</span>
                        </div>
                        <div className="flex-1 overflow-hidden">
                            <TradingViewHeatmap theme={isDark ? 'dark' : 'light'} />
                        </div>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div className="bg-white dark:bg-slate-800 rounded-xl shadow border p-5 font-bold">
                            <h3 className="text-xl font-bold mb-4 flex items-center gap-2 text-indigo-500"><i className="fa-solid fa-magnifying-glass-chart"></i> Ï¢ÖÎ™© Í≤ÄÏÉâ</h3>
                            <div className="flex gap-2 mb-4">
                                <input type="text" id="mainSearch" placeholder="Ï¢ÖÎ™©Î™Ö ÎòêÎäî ÏΩîÎìú" className="flex-1 p-3 border-2 border-indigo-200 rounded-lg dark:bg-slate-700 outline-none" onKeyPress={e=>e.key==='Enter'&&searchSymbol(e.target.value)} />
                                <button onClick={() => searchSymbol(document.getElementById('mainSearch').value)} className="bg-indigo-600 text-white px-6 rounded-lg font-bold">Í≤ÄÏÉâ</button>
                            </div>
                            <div className="flex flex-wrap gap-2 mb-6">
                                {favorites.map(s => (
                                    <div key={s.code} className="flex items-center group">
                                        <button onClick={() => searchSymbol(s.code)} className="px-3 py-1.5 bg-slate-50 dark:bg-slate-700 border border-r-0 rounded-l-lg text-xs hover:border-indigo-400 group-hover:border-indigo-400">
                                            {s.name}
                                        </button>
                                        <button onClick={() => removeFavorite(s.code)} className="px-2 py-1.5 bg-slate-50 dark:bg-slate-700 border rounded-r-lg text-[10px] text-red-400 hover:text-red-600 hover:border-indigo-400 group-hover:border-indigo-400">
                                            <i className="fa-solid fa-xmark"></i>
                                        </button>
                                    </div>
                                ))}
                            </div>
                            <div className="p-4 bg-slate-50 dark:bg-slate-900 rounded-xl border-2 border-dashed border-slate-200 dark:border-slate-700">
                                <h4 className="text-xs text-indigo-500 mb-2 font-black">ÏÉà Ï¶êÍ≤®Ï∞æÍ∏∞ Ï∂îÍ∞Ä</h4>
                                <div className="flex gap-2">
                                    <input type="text" placeholder="Ï¢ÖÎ™©Î™Ö" className="flex-1 sim-input !mt-0 !p-1 text-xs" value={newFav.name} onChange={e=>setNewFav({...newFav, name:e.target.value})} />
                                    <input type="text" placeholder="ÏΩîÎìú" className="w-24 sim-input !mt-0 !p-1 text-xs" value={newFav.code} onChange={e=>setNewFav({...newFav, code:e.target.value})} />
                                    <button onClick={addFavorite} className="bg-indigo-600 text-white px-3 rounded text-xs font-black">Ï∂îÍ∞Ä</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );

            const renderRoutine = () => (
                <div className="space-y-6 animate-fade-in pb-10">
                    <div className="flex justify-between items-center pb-4 border-b dark:border-slate-700 font-bold">
                        <div className="flex items-center gap-4">
                            <h2 className="text-2xl font-black">Ïò§ÎäòÏùò Î£®Ìã¥</h2>
                            <button onClick={() => setIsRoutineEditMode(!isRoutineEditMode)} className={`px-3 py-1 rounded text-xs transition-all ${isRoutineEditMode ? 'bg-indigo-600 text-white shadow-lg' : 'bg-slate-200 dark:bg-slate-700 text-slate-500'}`}>
                                <i className="fa-solid fa-pen-to-square mr-1"></i> {isRoutineEditMode ? 'Ìé∏Ïßë ÏôÑÎ£å' : 'ÎßÅÌÅ¨ Ìé∏Ïßë'}
                            </button>
                        </div>
                        <div className="flex bg-slate-100 dark:bg-slate-700 p-1 rounded-lg">
                            <button onClick={() => setLinkMode('investment')} className={`px-4 py-1.5 text-xs font-bold rounded-lg ${linkMode === 'investment' ? 'bg-white shadow text-blue-600' : 'text-slate-500'}`}>Ìà¨Ïûê & ÏùºÏÉÅ</button>
                            <button onClick={() => setLinkMode('blogs')} className={`px-4 py-1.5 text-xs font-bold rounded-lg ${linkMode === 'blogs' ? 'bg-white shadow text-blue-600' : 'text-slate-500'}`}>Ïù∏ÏÇ¨Ïù¥Ìä∏</button>
                        </div>
                    </div>
                    {isRoutineEditMode && (
                        <div className="p-6 bg-indigo-50 dark:bg-indigo-900/10 rounded-2xl border-2 border-indigo-200 dark:border-indigo-800 animate-fade-in mb-6">
                            <h3 className="font-black text-indigo-600 mb-4 text-sm"><i className="fa-solid fa-plus-circle mr-2"></i>ÏÉà Î£®Ìã¥ ÎßÅÌÅ¨ Ï∂îÍ∞Ä</h3>
                            <div className="grid grid-cols-1 md:grid-cols-4 gap-3">
                                <select className="sim-input !mt-0 text-xs" value={newRoutine.category} onChange={e=>setNewRoutine({...newRoutine, category:e.target.value})}>
                                    <option value="">Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÑ†ÌÉù</option>
                                    {Object.keys(routineLinks).map(cat => <option key={cat} value={cat}>{cat}</option>)}
                                </select>
                                <input type="text" placeholder="ÏÇ¨Ïù¥Ìä∏Î™Ö" className="sim-input !mt-0 text-xs" value={newRoutine.name} onChange={e=>setNewRoutine({...newRoutine, name:e.target.value})} />
                                <input type="text" placeholder="URL" className="flex-1 sim-input !mt-0 text-xs md:col-span-1" value={newRoutine.url} onChange={e=>setNewRoutine({...newRoutine, url:e.target.value})} />
                                <button onClick={addRoutineLink} className="bg-indigo-600 text-white rounded font-black text-xs h-10">Ï∂îÍ∞ÄÌïòÍ∏∞</button>
                            </div>
                        </div>
                    )}
                    {linkMode === 'blogs' ? (
                        <div className="flex flex-col gap-8 p-6 bg-white dark:bg-slate-800 rounded-2xl shadow-inner min-h-[400px]">
                            {Object.entries(blogInsightLinks).map(([cat, links]) => (
                                <div key={cat} className="flex flex-col md:flex-row items-center gap-4">
                                    <div className="bg-indigo-600 text-white px-4 py-2 rounded-xl font-bold min-w-[150px] text-center">{cat}</div>
                                    <div className="flex flex-wrap gap-2 flex-1 justify-center md:justify-start">
                                        {links.map((l, i) => <a key={i} href={l.url} target="_blank" className="px-4 py-2 bg-slate-50 dark:bg-slate-900 border rounded-full text-xs font-bold shadow-sm hover:shadow-md transition">{l.name}</a>)}
                                    </div>
                                </div>
                            ))}
                        </div>
                    ) : (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-6 font-bold">
                            {Object.entries(routineLinks).map(([cat, links]) => (
                                <div key={cat} className="bg-white dark:bg-slate-800 rounded-2xl p-6 shadow-lg border dark:border-slate-700">
                                    <h3 className="text-lg font-bold mb-4 border-b pb-2 text-indigo-600">{cat}</h3>
                                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                        {links.map((l, i) => (
                                            <div key={i} className="relative group">
                                                <a href={l.url} target="_blank" className="block p-3 rounded-xl bg-slate-50 dark:bg-slate-700 hover:shadow-md flex items-center gap-3 group transition-all">
                                                    <div className={`w-8 h-8 rounded flex items-center justify-center ${l.color} bg-opacity-20 group-hover:scale-110 transition`}><i className={`fa-solid ${l.icon}`}></i></div>
                                                    <span className="text-sm truncate pr-6">{l.name}</span>
                                                </a>
                                                {isRoutineEditMode && (
                                                    <button onClick={() => removeRoutineLink(cat, i)} className="absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center shadow-lg hover:bg-red-600 transition">
                                                        <i className="fa-solid fa-xmark text-[10px]"></i>
                                                    </button>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );

            const renderTools = () => {
                const targetRes = (() => {
                    const currentPrice = parseFormattedNumber(targetInputs.price); 
                    const shares = parseFormattedNumber(targetInputs.shares);
                    let targetPrice = 0, rate = 0;
                    if(targetInputs.mode === 'cap') {
                        const currentCap = parseFloat(targetInputs.currentCap) || 1; 
                        const targetCap = parseFloat(targetInputs.targetCap) || 0;
                        targetPrice = currentPrice * (targetCap / currentCap); 
                        rate = ((targetCap / currentCap) - 1) * 100;
                    } else {
                        targetPrice = parseFormattedNumber(targetInputs.targetRate); 
                        if(currentPrice > 0) rate = ((targetPrice - currentPrice) / currentPrice) * 100;
                    }
                    return { targetPrice, rate, totalAmount: targetPrice * shares, profit: (targetPrice - currentPrice) * shares };
                })();
                const exchRes = (parseFormattedNumber(exchInputs.amount) * (exchangeRates[exchInputs.base]?.krw || 1)) / (exchangeRates[exchInputs.target]?.krw || 1);
                let avgCost = 0, avgQ = 0;
                avgRows.forEach(r => { const q = parseFormattedNumber(r.q); const p = parseFormattedNumber(r.p); avgQ += q; avgCost += q * p; });
                const ipoNeeded = (parseFormattedNumber(ipoCalcInputs.price) * parseFormattedNumber(ipoCalcInputs.qty) * (ipoCalcInputs.rate/100)) + parseFormattedNumber(ipoCalcInputs.fee);
                const toolTaxRes = toolTaxInputs.type === 'dividend' ? parseFormattedNumber(toolTaxInputs.profit) * 0.154 : parseFormattedNumber(toolTaxInputs.profit) * 0.22;
                const divPreTax = parseFormattedNumber(divInputs.shares) * parseFormattedNumber(divInputs.perShare);
                const divPostTax = divPreTax * (1 - (parseFloat(divInputs.tax) / 100));

                return (
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 animate-fade-in pb-10 font-bold">
                        <div className="bg-white dark:bg-slate-800 p-5 rounded-xl shadow border dark:border-slate-700 flex flex-col">
                            <h3 className="font-bold mb-4 text-indigo-600 font-black"><i className="fa-solid fa-bullseye mr-2"></i>Î™©Ìëú Îã®Í∞Ä Î∂ÑÏÑù</h3>
                            <div className="flex bg-slate-100 dark:bg-slate-900 p-1 rounded mb-3 text-[10px]">
                                <button onClick={() => setTargetInputs({...targetInputs, mode:'cap'})} className={`flex-1 py-1 rounded ${targetInputs.mode==='cap'?'bg-white shadow text-indigo-600':'text-slate-500'}`}>ÏãúÏ¥ù ÎπÑÎ°Ä</button>
                                <button onClick={() => setTargetInputs({...targetInputs, mode:'rate'})} className={`flex-1 py-1 rounded ${targetInputs.mode==='rate'?'bg-white shadow text-indigo-600':'text-slate-500'}`}>Í∞ÄÍ≤© ÏßÅÏ†ë</button>
                            </div>
                            <div className="space-y-4 flex-1">
                                <div className="grid grid-cols-2 gap-3">
                                    <div className="flex flex-col"><label className="text-[10px] text-slate-500 mb-1">ÌòÑÏû¨Í∞Ä</label><input type="text" className="sim-input text-right" placeholder="0" value={targetInputs.price} onChange={e=>handleCommaChange(e, v=>setTargetInputs({...targetInputs, price:v}))} /></div>
                                    <div className="flex flex-col"><label className="text-[10px] text-slate-500 mb-1">Î≥¥Ïú† ÏàòÎüâ</label><input type="text" className="sim-input text-right" placeholder="0" value={targetInputs.shares} onChange={e=>handleCommaChange(e, v=>setTargetInputs({...targetInputs, shares:v}))} /></div>
                                </div>
                                {targetInputs.mode === 'cap' ? (
                                    <div className="grid grid-cols-2 gap-3">
                                        <div className="flex flex-col"><label className="text-[10px] text-slate-500 mb-1 truncate">ÌòÑÏû¨ ÏãúÏ¥ù(Ï°∞)</label><input type="number" step="0.1" className="sim-input" value={targetInputs.currentCap} onChange={e=>setTargetInputs({...targetInputs, currentCap:e.target.value})} /></div>
                                        <div className="flex flex-col"><label className="text-[10px] text-slate-500 mb-1 truncate">Î™©Ìëú ÏãúÏ¥ù(Ï°∞)</label><input type="number" step="0.1" className="sim-input" value={targetInputs.targetCap} onChange={e=>setTargetInputs({...targetInputs, targetCap:e.target.value})} /></div>
                                    </div>
                                ) : (
                                    <div className="flex flex-col"><label className="text-[10px] text-slate-500 mb-1">Î™©Ìëú Îã®Í∞Ä ÏßÅÏ†ë ÏûÖÎ†•</label><input type="text" className="sim-input text-right" placeholder="0" value={targetInputs.targetRate} onChange={e=>handleCommaChange(e, v=>setTargetInputs({...targetInputs, targetRate:v}))} /></div>
                                )}
                            </div>
                            <div className="mt-4 p-4 bg-indigo-50 dark:bg-indigo-900/20 rounded space-y-2 text-right text-indigo-600 num-font font-black">
                                <div className="flex justify-between items-center text-xs opacity-70 border-b border-indigo-100 pb-1"><span>Î™©Ìëú ÎèÑÎã¨ Îã®Í∞Ä</span><span>{formatNumber(targetRes.targetPrice)}Ïõê ({targetRes.rate.toFixed(1)}%)</span></div>
                                <div className="flex justify-between items-center text-xs opacity-70 border-b border-indigo-100 pb-1"><span>ÏòàÏÉÅ Ï¥ùÏï°</span><span>{formatNumber(targetRes.totalAmount)}Ïõê</span></div>
                                <div className="flex justify-between items-center text-sm border-t border-indigo-200 pt-1"><span>Ï¥ù ÏòàÏÉÅ ÏàòÏùµÍ∏à</span><span className="text-base">{formatNumber(targetRes.profit)}Ïõê</span></div>
                            </div>
                        </div>

                        <div className="bg-white dark:bg-slate-800 p-5 rounded-xl shadow border dark:border-slate-700">
                            <div className="flex justify-between items-center mb-4"><h3 className="font-bold text-blue-600 font-black"><i className="fa-solid fa-money-bill-transfer mr-2"></i>ÌôòÏú® Í≥ÑÏÇ∞Í∏∞</h3><button onClick={fetchRealTimeRates} className={`text-slate-400 ${isFetching ? 'animate-spin' : ''}`}><i className="fa-solid fa-arrows-rotate text-xs"></i></button></div>
                            <div className="space-y-4">
                                <div className="flex gap-2">
                                    <select className="w-1/3 sim-input" value={exchInputs.base} onChange={e=>setExchInputs({...exchInputs, base:e.target.value})}>{Object.keys(exchangeRates).map(k=><option key={k} value={k}>{k}</option>)}</select>
                                    <input type="text" className="flex-1 sim-input text-right" value={exchInputs.amount} onChange={e=>handleCommaChange(e, v=>setExchInputs({...exchInputs, amount:v}))} />
                                </div>
                                <div className="flex gap-2">
                                    <select className="w-1/3 sim-input" value={exchInputs.target} onChange={e=>setExchInputs({...exchInputs, target:e.target.value})}>{Object.keys(exchangeRates).map(k=><option key={k} value={k}>{k}</option>)}</select>
                                    <div className="flex-1 p-2 border rounded bg-slate-50 dark:bg-slate-900 text-right text-blue-600 font-black num-font">{formatNumber(exchRes)}</div>
                                </div>
                            </div>
                        </div>

                        <div className="bg-white dark:bg-slate-800 p-5 rounded-xl shadow border dark:border-slate-700 font-bold">
                            <h3 className="mb-4 text-rose-600 font-black"><i className="fa-solid fa-receipt mr-2"></i>Í∞ÑÏù¥ ÏÑ∏Í∏à Í≥ÑÏÇ∞Í∏∞</h3>
                            <div className="space-y-2">
                                <div className="flex bg-slate-100 dark:bg-slate-900 p-1 rounded mb-2 text-[10px]">
                                    <button onClick={() => setToolTaxInputs({...toolTaxInputs, type:'dividend'})} className={`flex-1 py-1 rounded ${toolTaxInputs.type==='dividend'?'bg-white shadow text-rose-600':'text-slate-500'}`}>Î∞∞Îãπ/Ïù¥Ïûê(15.4%)</button>
                                    <button onClick={() => setToolTaxInputs({...toolTaxInputs, type:'capital'})} className={`flex-1 py-1 rounded ${toolTaxInputs.type==='capital'?'bg-white shadow text-rose-600':'text-slate-500'}`}>ÏñëÎèÑÏÜåÎìù(22%)</button>
                                </div>
                                <div><label className="text-[10px] text-slate-500 block mb-1">ÏàòÏùµ Ï¥ùÏï°</label><input type="text" className="sim-input text-right" placeholder="0" value={toolTaxInputs.profit} onChange={e=>handleCommaChange(e, v=>setToolTaxInputs({...toolTaxInputs, profit:v}))} /></div>
                                <div className="p-3 bg-rose-50 dark:bg-rose-900/20 rounded text-center text-rose-600 mt-2 num-font font-black">ÏòàÏÉÅ ÏÑ∏Í∏à: {formatNumber(toolTaxRes)}Ïõê</div>
                            </div>
                        </div>

                        <div className="bg-white dark:bg-slate-800 p-5 rounded-xl shadow border dark:border-slate-700 font-bold">
                            <h3 className="mb-4 text-purple-600 font-black"><i className="fa-solid fa-piggy-bank mr-2"></i>Í≥µÎ™®Ï£º Ï≤≠ÏïΩ Í≥ÑÏÇ∞</h3>
                            <div className="grid grid-cols-2 gap-3 mb-4">
                                <div className="flex flex-col"><label className="text-[10px] text-slate-500 mb-1">Í≥µÎ™®Í∞Ä</label><input type="text" className="sim-input text-right" value={ipoCalcInputs.price} onChange={e=>handleCommaChange(e, v=>setIpoCalcInputs({...ipoCalcInputs, price:v}))} /></div>
                                <div className="flex flex-col"><label className="text-[10px] text-slate-500 mb-1">Ï≤≠ÏïΩÏàòÎüâ</label><input type="text" className="sim-input text-right" value={ipoCalcInputs.qty} onChange={e=>handleCommaChange(e, v=>setIpoCalcInputs({...ipoCalcInputs, qty:v}))} /></div>
                                <div className="flex flex-col"><label className="text-[10px] text-slate-500 mb-1">Ï¶ùÍ±∞Í∏àÏú®</label><select className="sim-input" value={ipoCalcInputs.rate} onChange={e=>setIpoCalcInputs({...ipoCalcInputs, rate:parseInt(e.target.value)})}><option value={50}>50%</option><option value={100}>100%</option></select></div>
                                <div className="flex flex-col"><label className="text-[10px] text-slate-500 mb-1">ÏàòÏàòÎ£å</label><input type="text" className="sim-input text-right" value={ipoCalcInputs.fee} onChange={e=>handleCommaChange(e, v=>setIpoCalcInputs({...ipoCalcInputs, fee:v}))} /></div>
                            </div>
                            <div className="p-3 bg-purple-50 dark:bg-purple-900/20 rounded-lg text-right text-purple-600 num-font font-black">Ï¥ù ÌïÑÏöîÏï°: {formatNumber(ipoNeeded)}Ïõê</div>
                        </div>

                        <div className="bg-white dark:bg-slate-800 p-5 rounded-xl shadow border dark:border-slate-700 font-bold flex flex-col">
                            <h3 className="mb-3 text-emerald-600 flex justify-between items-center font-black">
                                <span><i className="fa-solid fa-scale-balanced mr-2"></i>ÌèâÎã®Í∞Ä Í≥ÑÏÇ∞Í∏∞</span>
                                <button onClick={()=>setAvgRows([...avgRows, {id:Date.now(), q:'', p:''}])} className="bg-emerald-100 text-emerald-600 px-2 py-0.5 rounded text-[10px]">+ Ï∂îÍ∞Ä</button>
                            </h3>
                            <div className="space-y-2 overflow-y-auto max-h-40 mb-3 pr-1">
                                {avgRows.map((r, i) => (
                                    <div key={r.id} className="grid grid-cols-12 gap-1 items-center">
                                        <input type="text" placeholder="ÏàòÎüâ" className="col-span-5 sim-input text-right !p-1" value={r.q} onChange={e=>handleCommaChange(e, v=>{const n=[...avgRows]; n[i].q=v; setAvgRows(n);})} />
                                        <input type="text" placeholder="Îã®Í∞Ä" className="col-span-5 sim-input text-right !p-1" value={r.p} onChange={e=>handleCommaChange(e, v=>{const n=[...avgRows]; n[i].p=v; setAvgRows(n);})} />
                                        <button onClick={()=>{const n=avgRows.filter(row=>row.id!==r.id); setAvgRows(n.length?n:[{id:Date.now(),q:'',p:''}]);}} className="col-span-2 text-red-400"><i className="fa-solid fa-trash-can text-xs"></i></button>
                                    </div>
                                ))}
                            </div>
                            <div className="mt-auto p-3 bg-emerald-50 dark:bg-emerald-900/20 rounded text-right text-emerald-600 font-black num-font">
                                <div className="text-[10px] opacity-70">ÏµúÏ¢Ö ÌèâÎã®Í∞Ä</div>
                                <div className="text-base">{avgQ ? formatNumber(avgCost/avgQ) : 0}Ïõê</div>
                            </div>
                        </div>

                        <div className="bg-white dark:bg-slate-800 p-5 rounded-xl shadow border dark:border-slate-700 font-bold">
                            <h3 className="mb-4 text-amber-600 font-black"><i className="fa-solid fa-sack-dollar mr-2"></i>Î∞∞ÎãπÍ∏à Í≥ÑÏÇ∞Í∏∞</h3>
                            <div className="space-y-3">
                                <div className="grid grid-cols-2 gap-3">
                                    <div className="flex flex-col"><label className="text-[10px] text-slate-500 mb-1">Î≥¥Ïú† ÏàòÎüâ</label><input type="text" className="sim-input text-right" placeholder="0" value={divInputs.shares} onChange={e=>handleCommaChange(e, v=>setDivInputs({...divInputs, shares:v}))} /></div>
                                    <div className="flex flex-col"><label className="text-[10px] text-slate-500 mb-1">Ï£ºÎãπ Î∞∞ÎãπÍ∏à</label><input type="text" className="sim-input text-right" placeholder="0" value={divInputs.perShare} onChange={e=>handleCommaChange(e, v=>setDivInputs({...divInputs, perShare:v}))} /></div>
                                </div>
                                <div className="p-4 bg-amber-50 dark:bg-amber-900/20 rounded text-right text-amber-600 num-font font-black space-y-2">
                                    <div className="flex justify-between items-center text-xs opacity-70 border-b border-amber-100 pb-1"><span>ÏÑ∏Ï†Ñ Ï¥ùÏï°</span><span>{formatNumber(divPreTax)}Ïõê</span></div>
                                    <div className="flex justify-between items-center text-sm pt-1"><span>ÏÑ∏ÌõÑ Ïã§ÏàòÎ†π</span><span className="text-base">{formatNumber(divPostTax)}Ïõê</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            return (
                <div className={`min-h-screen flex flex-col transition-colors duration-200 ${isDark ? 'dark bg-slate-900 text-slate-100' : 'bg-slate-50 text-slate-800'}`}>
                    <header className="sticky top-0 z-50 bg-white dark:bg-slate-800 border-b dark:border-slate-700 shadow h-16">
                        <div className="max-w-7xl mx-auto px-4 h-full flex items-center justify-between">
                            <div className="flex items-center gap-2 font-black text-lg"><i className="fa-solid fa-compass text-blue-600"></i> Navigator</div>
                            <nav className="flex bg-slate-100 dark:bg-slate-700 p-1 rounded-xl gap-1">
                                {[{id:'dashboard',l:'ÎåÄÏãúÎ≥¥Îìú'},{id:'routine',l:'Î£®Ìã¥'},{id:'tools',l:'ÎèÑÍµ¨'},{id:'simulation',l:'ÎÖ∏ÌõÑÏûêÍ∏à'},{id:'tax',l:'Í∏àÏúµÍ≥ºÏÑ∏'}].map(t => (
                                    <button key={t.id} onClick={()=>setActiveTab(t.id)} className={`nav-tab px-3 md:px-5 py-1.5 text-xs rounded-lg transition-all ${activeTab === t.id ? 'active' : 'text-slate-500 font-bold'}`}>{t.l}</button>
                                ))}
                            </nav>
                            <button onClick={()=>setIsDark(!isDark)} className="p-2 rounded-full hover:bg-slate-200 transition"><i className={`fa-solid ${isDark?'fa-sun text-amber-400':'fa-moon'}`}></i></button>
                        </div>
                    </header>
                    <main className="max-w-7xl w-full mx-auto px-4 py-6 flex-1">
                        {activeTab === 'dashboard' && renderDashboard()}
                        {activeTab === 'routine' && renderRoutine()}
                        {activeTab === 'tools' && renderTools()}
                        {activeTab === 'simulation' && (
                            <div className="animate-fade-in pb-10 font-bold space-y-6">
                                <h2 className="text-2xl font-black mb-4 border-b dark:border-slate-700 pb-2 flex items-center gap-3">
                                    ÎÖ∏ÌõÑ ÏûêÍ∏à ÏãúÎÆ¨Î†àÏù¥ÏÖò
                                    <span className="text-xs bg-indigo-100 text-indigo-600 px-2 py-1 rounded font-black">v2.2 ÏßÄÏ∂ú Í≥°ÏÑ† ÏµúÏ†ÅÌôî</span>
                                </h2>

                                <div className="guide-card border-l-4 border-l-amber-500 flex gap-4 items-start mb-6">
                                    <div className="bg-amber-100 text-amber-600 p-3 rounded-lg"><i className="fa-solid fa-lightbulb text-xl"></i></div>
                                    <div className="text-xs space-y-1">
                                        <h3 className="font-black text-amber-700 mb-1">ÏßÄÏ∂ú Í≥°ÏÑ† ÏãúÎÆ¨Î†àÏù¥ÏÖò ÏõêÎ¶¨ (U-Shape Curve)</h3>
                                        <p className="text-slate-500">‚Ä¢ <strong>ÌôúÎèôÍ∏∞(Go-Go):</strong> ÏùÄÌá¥ ÏßÅÌõÑ Ïó¨Í∞ÄÌôúÎèô Ï¶ùÍ∞ÄÎ°ú Í∏∞Î≥∏ ÏÉùÌôúÎπÑÏùò 110% ÏßÄÏ∂ú</p>
                                        <p className="text-slate-500">‚Ä¢ <strong>Ïá†Ìá¥Í∏∞(Slow-Go):</strong> ÌôúÎèôÎüâ Í∞êÏÜåÎ°ú Í∏∞Î≥∏ ÏÉùÌôúÎπÑÏùò 90% ÏàòÏ§ÄÏúºÎ°ú ÌïòÎùΩ</p>
                                        <p className="text-slate-500">‚Ä¢ <strong>Í∞ÑÎ≥ëÍ∏∞(No-Go):</strong> Ïô∏Î∂Ä ÌôúÎèô Ï†ÑÎ¨¥Î°ú Í∏∞Î≥∏ ÏÉùÌôúÎπÑÎäî 70%ÍπåÏßÄ Í∏âÍ∞êÌïòÎÇò, ÏûÖÎ†•ÌïòÏã† <strong>ÏùòÎ£å/Í∞ÑÎ≥ëÎπÑ</strong>Í∞Ä Ï∂îÍ∞Ä Ìï©ÏÇ∞Îê©ÎãàÎã§.</p>
                                    </div>
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 font-bold">
                                    <div className="bg-white dark:bg-slate-800 p-5 rounded-xl border shadow-sm space-y-4">
                                        <h3 className="text-indigo-600 text-sm border-b pb-1 font-black"><i className="fa-solid fa-calendar-day mr-1"></i> 1. Ïó∞Î†π Î∞è ÏàòÎ†π ÏãúÍ∏∞</h3>
                                        <div className="grid grid-cols-2 gap-2">
                                            <div className="flex flex-col"><label className="text-[10px] text-slate-500">Î≥∏Ïù∏ ÌòÑÏû¨ ÎÇòÏù¥</label><input type="number" className="sim-input" value={simInputs.currentAge} onChange={e=>setSimInputs({...simInputs, currentAge:parseInt(e.target.value)})}/></div>
                                            <div className="flex flex-col"><label className="text-[10px] text-slate-500">Î∞∞Ïö∞Ïûê ÌòÑÏû¨ ÎÇòÏù¥</label><input type="number" className="sim-input" value={simInputs.spouseCurrentAge} onChange={e=>setSimInputs({...simInputs, spouseCurrentAge:parseInt(e.target.value)})}/></div>
                                            <div className="flex flex-col"><label className="text-[10px] text-indigo-500 font-bold">ÏãúÎÆ¨Î†àÏù¥ÏÖò ÏãúÏûëÎÇòÏù¥</label><input type="number" className="sim-input border-indigo-300" value={simInputs.simulationStartAge} onChange={e=>setSimInputs({...simInputs, simulationStartAge:parseInt(e.target.value)})}/></div>
                                            <div className="flex flex-col"><label className="text-[10px] text-slate-500">Í∞ÑÎ≥ëÍ∏∞ Ï†ÑÌôò ÎÇòÏù¥</label><input type="number" className="sim-input" value={simInputs.highCostStartAge} onChange={e=>setSimInputs({...simInputs, highCostStartAge:parseInt(e.target.value)})}/></div>
                                            <div className="flex flex-col"><label className="text-[10px] text-indigo-500 font-black">Ïó∞Í∏à ÏàòÎ†π(Î≥∏Ïù∏)</label><input type="number" className="sim-input border-indigo-300" value={simInputs.pensionStartAgeUser} onChange={e=>setSimInputs({...simInputs, pensionStartAgeUser:parseInt(e.target.value)})}/></div>
                                            <div className="flex flex-col"><label className="text-[10px] text-indigo-500 font-black">Ïó∞Í∏à ÏàòÎ†π(Î∞∞Ïö∞Ïûê)</label><input type="number" className="sim-input border-indigo-300" value={simInputs.pensionStartAgeSpouse} onChange={e=>setSimInputs({...simInputs, pensionStartAgeSpouse:parseInt(e.target.value)})}/></div>
                                        </div>
                                    </div>

                                    <div className="bg-white dark:bg-slate-800 p-5 rounded-xl border shadow-sm space-y-4">
                                        <h3 className="text-emerald-600 text-sm border-b pb-1 font-black"><i className="fa-solid fa-vault mr-1"></i> 2. Í∏∞Ï¥à ÏûêÏÇ∞(Ïñµ) Î∞è ÏàòÏùµÎ•†(%)</h3>
                                        <div className="grid grid-cols-2 gap-x-2 gap-y-3">
                                            <div className="flex flex-col"><label className="text-[9px] text-blue-500">Î≥∏Ïù∏ ÏùºÎ∞ò(Ïñµ)</label><input type="number" step="0.1" className="sim-input" value={simInputs.capUserNonISA} onChange={e=>setSimInputs({...simInputs, capUserNonISA:parseFloat(e.target.value)})}/></div>
                                            <div className="flex flex-col"><label className="text-[9px] text-blue-400">ÏùºÎ∞ò ÏàòÏùµÎ•†(%)</label><input type="number" step="0.1" className="sim-input" value={simInputs.returnUserNonISA} onChange={e=>setSimInputs({...simInputs, returnUserNonISA:parseFloat(e.target.value)})}/></div>
                                            <div className="flex flex-col"><label className="text-[9px] text-blue-500">Î∞∞Ïö∞Ïûê ÏùºÎ∞ò(Ïñµ)</label><input type="number" step="0.1" className="sim-input" value={simInputs.capSpouseNonISA} onChange={e=>setSimInputs({...simInputs, capSpouseNonISA:parseFloat(e.target.value)})}/></div>
                                            <div className="flex flex-col"><label className="text-[9px] text-blue-400">ÏùºÎ∞ò ÏàòÏùµÎ•†(%)</label><input type="number" step="0.1" className="sim-input" value={simInputs.returnSpouseNonISA} onChange={e=>setSimInputs({...simInputs, returnSpouseNonISA:parseFloat(e.target.value)})}/></div>
                                            <div className="flex flex-col border-t pt-2 mt-1"><label className="text-[9px] text-emerald-500">Î≥∏Ïù∏ ISA(Ïñµ)</label><input type="number" step="0.1" className="sim-input" value={simInputs.capUserISA} onChange={e=>setSimInputs({...simInputs, capUserISA:parseFloat(e.target.value)})}/></div>
                                            <div className="flex flex-col border-t pt-2 mt-1"><label className="text-[9px] text-emerald-400">ISA ÏàòÏùµÎ•†(%)</label><input type="number" step="0.1" className="sim-input" value={simInputs.returnUserISA} onChange={e=>setSimInputs({...simInputs, returnUserISA:parseFloat(e.target.value)})}/></div>
                                            <div className="flex flex-col"><label className="text-[9px] text-emerald-500">Î∞∞Ïö∞Ïûê ISA(Ïñµ)</label><input type="number" step="0.1" className="sim-input" value={simInputs.capSpouseISA} onChange={e=>setSimInputs({...simInputs, capSpouseISA:parseFloat(e.target.value)})}/></div>
                                            <div className="flex flex-col"><label className="text-[9px] text-emerald-400">ISA ÏàòÏùµÎ•†(%)</label><input type="number" step="0.1" className="sim-input" value={simInputs.returnSpouseISA} onChange={e=>setSimInputs({...simInputs, returnSpouseISA:parseFloat(e.target.value)})}/></div>
                                        </div>
                                    </div>

                                    <div className="bg-white dark:bg-slate-800 p-5 rounded-xl border shadow-sm space-y-4">
                                        <h3 className="text-orange-600 text-sm border-b pb-1 font-black"><i className="fa-solid fa-chart-line mr-1"></i> 3. Î¨ºÍ∞Ä Î∞è ÏÑ∏Ïú® ÏÑ§Ï†ï(%)</h3>
                                        <div className="grid grid-cols-2 gap-2">
                                            <div className="flex flex-col"><label className="text-[10px] text-slate-500">Ï†ÑÏ≤¥ Î¨ºÍ∞Ä ÏÉÅÏäπÎ•†</label><input type="number" step="0.1" className="sim-input" value={simInputs.inflationRate} onChange={e=>setSimInputs({...simInputs, inflationRate:parseFloat(e.target.value)})}/></div>
                                            <div className="flex flex-col"><label className="text-[10px] text-slate-500">ÏÉùÌôúÎπÑ ÏÉÅÏäπÎ•†</label><input type="number" step="0.1" className="sim-input" value={simInputs.livingCostInflationRate} onChange={e=>setSimInputs({...simInputs, livingCostInflationRate:parseFloat(e.target.value)})}/></div>
                                            <div className="flex flex-col"><label className="text-[10px] text-red-500">ÏÜåÎìùÏÑ∏Ïú®1(Í∏∞Î≥∏)</label><input type="number" step="0.1" className="sim-input" value={simInputs.taxRate1} onChange={e=>setSimInputs({...simInputs, taxRate1:parseFloat(e.target.value)})}/></div>
                                            <div className="flex flex-col"><label className="text-[10px] text-red-700">ÏÜåÎìùÏÑ∏Ïú®2(ÎàÑÏßÑ)</label><input type="number" step="0.1" className="sim-input" value={simInputs.taxRate2} onChange={e=>setSimInputs({...simInputs, taxRate2:parseFloat(e.target.value)})}/></div>
                                        </div>
                                        <div className="flex flex-col border-t pt-3 mt-1">
                                            <label className="text-[10px] text-indigo-500 font-black">95ÏÑ∏ Î™©Ìëú ÏûîÏï° (ÏÉÅÏÜç Îì±)</label>
                                            <input type="text" className="sim-input border-indigo-200" value={simInputs.targetLegacy} onChange={e=>handleCommaChange(e, v=>setSimInputs({...simInputs, targetLegacy:v}))}/>
                                        </div>
                                    </div>

                                    <div className="bg-white dark:bg-slate-800 p-5 rounded-xl border shadow-sm space-y-4">
                                        <h3 className="text-rose-600 text-sm border-b pb-1 font-black"><i className="fa-solid fa-money-check-dollar mr-1"></i> 4. Ïõî ÏàòÏûÖ Î∞è ÏßÄÏ∂ú(Ïõê)</h3>
                                        <div className="flex flex-col">
                                            <label className="text-[11px] text-red-600 font-black">Í∏∞Î≥∏ ÏÉùÌôúÎπÑ(Ïõî)</label>
                                            <p className="text-[8px] text-slate-400 -mt-1 mb-1">ÏãùÎπÑ, Ï£ºÍ±∞, Ïó¨Í∞Ä Îì± Í∏∞Ï¥à ÎπÑÏö©</p>
                                            <input type="text" className="sim-input text-right text-red-600" value={simInputs.monthlyLiving} onChange={e=>handleCommaChange(e, v=>setSimInputs({...simInputs, monthlyLiving:v}))}/>
                                        </div>
                                        <div className="flex flex-col bg-rose-50 dark:bg-rose-900/10 p-2 rounded">
                                            <label className="text-[10px] text-rose-500 font-black">Í∞ÑÎ≥ëÍ∏∞ ÏùòÎ£å/Í∞ÑÎ≥ëÎπÑ(Ïõî)</label>
                                            <p className="text-[8px] text-slate-400 -mt-0.5">ÏÑ§Ï†ïÌïòÏã† ÎÇòÏù¥ Ïù¥ÌõÑÎ∂ÄÌÑ∞ Ìï©ÏÇ∞Îê®</p>
                                            <input type="text" className="sim-input !mt-1 !p-1 text-right text-rose-700" value={simInputs.monthlyMedical} onChange={e=>handleCommaChange(e, v=>setSimInputs({...simInputs, monthlyMedical:v}))}/>
                                        </div>
                                        <div className="grid grid-cols-2 gap-2 pt-2">
                                            <div className="flex flex-col"><label className="text-[10px] text-slate-500">Î≥∏Ïù∏ Ïõî Ïó∞Í∏à</label><input type="text" className="sim-input text-right" value={simInputs.pensionSelf} onChange={e=>handleCommaChange(e, v=>setSimInputs({...simInputs, pensionSelf:v}))}/></div>
                                            <div className="flex flex-col"><label className="text-[10px] text-slate-500">Î∞∞Ïö∞Ïûê Ïõî Ïó∞Í∏à</label><input type="text" className="sim-input text-right" value={simInputs.pensionSpouse} onChange={e=>handleCommaChange(e, v=>setSimInputs({...simInputs, pensionSpouse:v}))}/></div>
                                        </div>
                                    </div>

                                    <div className="bg-white dark:bg-slate-800 p-5 rounded-xl border shadow-sm space-y-4">
                                        <h3 className="text-blue-600 text-sm border-b pb-1 font-black"><i className="fa-solid fa-hand-holding-dollar mr-1"></i> 5. Í∏∞ÌÉÄ Ïó∞Í∞Ñ ÏàòÏûÖ(Ïõê)</h3>
                                        <div className="grid grid-cols-2 gap-2">
                                            <div className="flex flex-col"><label className="text-[10px] text-slate-500">Í≥µÎ™®Ï£º ÏàòÏùµ</label><input type="text" className="sim-input text-right" value={simInputs.ipoProfit} onChange={e=>handleCommaChange(e, v=>setSimInputs({...simInputs, ipoProfit:v}))}/></div>
                                            <div className="flex flex-col"><label className="text-[10px] text-slate-500">ÏûÑÎåÄ ÏÜåÎìù</label><input type="text" className="sim-input text-right" value={simInputs.rentalIncome} onChange={e=>handleCommaChange(e, v=>setSimInputs({...simInputs, rentalIncome:v}))}/></div>
                                            <div className="flex flex-col"><label className="text-[10px] text-slate-500">Í∏∞ÌÉÄ ÏÇ¨ÏóÖ/Í∑ºÎ°ú</label><input type="text" className="sim-input text-right" value={simInputs.otherIncome} onChange={e=>handleCommaChange(e, v=>setSimInputs({...simInputs, otherIncome:v}))}/></div>
                                            <div className="flex flex-col"><label className="text-[10px] text-slate-500">Ï£ºÏãù ÎåÄÏó¨ ÏàòÏàòÎ£å</label><input type="text" className="sim-input text-right" value={simInputs.stockLending} onChange={e=>handleCommaChange(e, v=>setSimInputs({...simInputs, stockLending:v}))}/></div>
                                        </div>
                                        <div className="flex flex-col border-t pt-2">
                                            <label className="text-[10px] text-slate-500">Ïó∞Í∞Ñ Í≥†Ï†ï ÏòàÎπÑÎπÑ(ÎπÑÏÉÅÍ∏à)</label>
                                            <input type="text" className="sim-input text-right" value={simInputs.extraReserve} onChange={e=>handleCommaChange(e, v=>setSimInputs({...simInputs, extraReserve:v}))}/>
                                        </div>
                                    </div>

                                    <div className={`${simResult.summary?.isSuccess ? 'bg-indigo-600' : 'bg-rose-600'} text-white p-5 rounded-xl shadow-lg flex flex-col justify-center text-center transition-colors duration-500`}>
                                        <p className="text-xs opacity-80 mb-2">95ÏÑ∏ ÏòàÏ∏° ÏûêÏÇ∞</p>
                                        <h3 className={`text-2xl font-black ${simResult.summary?.depletion ? 'text-yellow-300' : 'text-white'}`}>
                                            {simResult.summary?.depletion ? `${simResult.summary.depletion}ÏÑ∏ ÏûêÏÇ∞ Í≥†Í∞à` : formatNumber(simResult.summary?.final) + 'Ïõê'}
                                        </h3>
                                        <div className="mt-3 py-1 px-3 bg-white/20 rounded-full text-[10px] inline-block mx-auto font-black">
                                            {simResult.summary?.isSuccess ? "‚úÖ ÏÑ§Í≥Ñ Î™©Ìëú Îã¨ÏÑ± ÏÑ±Í≥µ" : "‚ö†Ô∏è ÏÑ§Í≥Ñ Î™©Ìëú ÎØ∏Îã¨ (Ï°∞Ï†ï ÌïÑÏöî)"}
                                        </div>
                                    </div>
                                </div>

                                <div className="mt-6 bg-white dark:bg-slate-800 p-6 rounded-xl border shadow-sm">
                                    <SimulationChart history={simResult.history} />
                                </div>

                                <div className="mt-6 bg-white dark:bg-slate-800 p-4 rounded-xl border shadow-sm overflow-x-auto">
                                    <h3 className="text-sm font-black mb-4"><i className="fa-solid fa-table mr-2"></i>Ïó∞Î†πÎ≥Ñ ÏûêÏÇ∞ Î≥ÄÌôî ÏÉÅÏÑ∏ ÎÇ¥Ïó≠ (ÏßÄÏ∂ú Ìå®ÌÑ¥ Î∂ÑÏÑù Ìè¨Ìï®)</h3>
                                    <table className="w-full text-[10px] text-left border-collapse min-w-[1050px]">
                                        <thead className="bg-slate-50 dark:bg-slate-900">
                                            <tr>
                                                <th className="p-2 border-b">ÎÇòÏù¥</th>
                                                <th className="p-2 border-b">Ï¥ùÏûêÏÇ∞(Ïñµ)</th>
                                                <th className="p-2 border-b text-indigo-500">Ìï©Í≥Ñ ÏàòÏùµ(Ïõê)</th>
                                                <th className="p-2 border-b text-blue-500 text-center">ÏàòÏùµ ÏÉÅÏÑ∏ (Ìà¨Ïûê+Í∏∞Î≥∏)</th>
                                                <th className="p-2 border-b text-rose-500 text-center">Ï¶ùÍ∞êÎ∂Ñ(Ïõê)</th>
                                                <th className="p-2 border-b text-center">Í≥ÑÏ¢åÎ≥Ñ ÏûêÏÇ∞(Îã®ÏúÑ: Ïñµ)</th>
                                                <th className="p-2 border-b text-right text-rose-600">Ï¥ù ÏßÄÏ∂ú(Ïõê)</th>
                                                <th className="p-2 border-b text-center">ÏßÄÏ∂ú ÏÑ±Í≤©</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {simResult.history.map((h, idx) => (
                                                <tr key={idx} className={`hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors ${h.isWarn ? 'bg-rose-50/50 dark:bg-rose-900/5' : ''}`}>
                                                    <td className="p-2 border-b font-medium">{h.age}ÏÑ∏</td>
                                                    <td className={`p-2 border-b font-black ${h.isWarn ? 'text-rose-600' : 'text-indigo-600'}`}>{h.total.toFixed(2)}</td>
                                                    <td className="p-2 border-b text-indigo-600 font-black num-font">{formatNumber(h.annualProfit)}</td>
                                                    <td className="p-2 border-b text-center">
                                                        <div className="flex justify-center gap-3">
                                                            <span className="text-blue-500 font-bold num-font">Ìà¨Ïûê:{formatNumber(h.profInvestment)}</span>
                                                            <span className="text-slate-400 font-medium num-font">Í∏∞Î≥∏:{formatNumber(h.baseIncome)}</span>
                                                        </div>
                                                    </td>
                                                    <td className={`p-2 border-b text-center font-bold num-font ${h.netChange >= 0 ? 'text-emerald-600' : 'text-rose-500'}`}>
                                                        {h.netChange >= 0 ? '+' : ''}{formatNumber(h.netChange)}
                                                    </td>
                                                    <td className="p-2 border-b">
                                                        <div className="grid grid-cols-2 gap-x-3 gap-y-0.5 text-[9px] opacity-80 leading-tight">
                                                            <div className="flex justify-between"><span>Î≥∏Ïù∏ÏùºÎ∞ò:</span><span className="font-bold">{h.un.toFixed(1)}</span></div>
                                                            <div className="flex justify-between text-emerald-600"><span>Î≥∏Ïù∏ISA:</span><span className="font-bold">{h.ui.toFixed(1)}</span></div>
                                                            <div className="flex justify-between"><span>Î∞∞Ïö∞ÏùºÎ∞ò:</span><span className="font-bold">{h.sn.toFixed(1)}</span></div>
                                                            <div className="flex justify-between text-emerald-600"><span>Î∞∞Ïö∞ISA:</span><span className="font-bold">{h.si.toFixed(1)}</span></div>
                                                        </div>
                                                    </td>
                                                    <td className="p-2 border-b num-font text-rose-600 font-bold text-right">
                                                        {formatNumber(h.tax + h.living)}
                                                    </td>
                                                    <td className="p-2 border-b text-center">
                                                        <div className="flex flex-col items-center gap-1">
                                                            {h.isHighCost ? (
                                                                <span className="px-1.5 py-0.5 bg-rose-100 text-rose-600 rounded-sm text-[8px] font-black">Í∞ÑÎ≥ëÍ∏∞(ÏùòÎ£åÎπÑ‚Üë)</span>
                                                            ) : (
                                                                <span className="px-1.5 py-0.5 bg-slate-100 text-slate-500 rounded-sm text-[8px] font-black">ÌôúÎèôÍ∏∞</span>
                                                            )}
                                                            {h.medicalShare > 40 && <span className="text-[7px] text-rose-400 font-black">ÏùòÎ£åÎπÑ ÎπÑÏ§ë ÎÜíÏùå</span>}
                                                        </div>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}
                        {activeTab === 'tax' && (
                            <div className="space-y-6 animate-fade-in pb-10 font-bold">
                                <h2 className="text-2xl font-black mb-4 border-b dark:border-slate-700 pb-2">Í∏àÏúµ ÏÜåÎìù Î∞è Í≥ºÏÑ∏ Í¥ÄÎ¶¨</h2>
                                <div className="guide-card border-l-4 border-l-blue-500 flex gap-4 items-start mb-6">
                                    <div className="bg-blue-100 text-blue-600 p-3 rounded-lg"><i className="fa-solid fa-circle-info text-xl"></i></div>
                                    <div>
                                        <h3 className="font-black text-blue-600 mb-1">Ï¥àÎ≥¥ÏûêÎ•º ÏúÑÌïú Í∏àÏúµÍ≥ºÏÑ∏ ÌïµÏã¨ ÏöîÏïΩ</h3>
                                        <ul className="text-xs text-slate-500 space-y-1 list-disc pl-4">
                                            <li>Ïó∞Í∞Ñ Í∏àÏúµÏÜåÎìù(Ïù¥Ïûê+Î∞∞Îãπ)Ïù¥ <strong>2,000Îßå Ïõê</strong> Ïù¥ÌïòÏù¥Î©¥ 15.4%Î°ú Í≥ºÏÑ∏Í∞Ä ÎÅùÎÇ©ÎãàÎã§.</li>
                                            <li>2,000Îßå ÏõêÏùÑ Ï¥àÍ≥ºÌïòÎ©¥ Ï¢ÖÌï©Í≥ºÏÑ∏ ÎåÄÏÉÅÏù¥ ÎêòÏñ¥ Ìï©ÏÇ∞ Í≥ºÏÑ∏Îê©ÎãàÎã§.</li>
                                            <li>Í≥µÎ™®Ï£º ÏàòÏùµ, Ìï¥Ïô∏Ï£ºÏãù ÏñëÎèÑÏ∞®Ïùµ Îì±ÏùÄ Î≥ÑÎèÑÏùò Í≥ºÏÑ∏ Ï≤¥Í≥ÑÎ•º Îî∞Î•¥ÎØÄÎ°ú Ï£ºÏùòÍ∞Ä ÌïÑÏöîÌï©ÎãàÎã§.</li>
                                        </ul>
                                    </div>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 font-black text-center gap-6">
                                    <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow border dark:border-slate-700">
                                        <p className="text-xs text-slate-500 mb-1">Ïù¥Ïûê/Î∞∞Îãπ ÏÜåÎìù Ìï©Í≥Ñ</p>
                                        <h3 className="text-2xl text-blue-600">{formatNumber(finList.reduce((a,c)=>a+c.amount,0))}Ïõê</h3>
                                    </div>
                                    <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow border dark:border-slate-700">
                                        <p className="text-xs text-slate-500 mb-1">Í∏∞ÌÉÄ Í∏àÏúµ ÏàòÏùµ Ìï©Í≥Ñ</p>
                                        <h3 className="text-2xl text-emerald-600">{formatNumber(otherIncomeList.reduce((a,c)=>a+c.amount,0))}Ïõê</h3>
                                    </div>
                                    <div className="bg-indigo-600 text-white p-6 rounded-xl shadow">
                                        <p className="text-xs opacity-70 mb-1">Ïù¥Ïûê/Î∞∞Îãπ Î∂ÑÎ¶¨Í≥ºÏÑ∏ ÏòàÏÉÅ ÏÑ∏Ïï°(15.4%)</p>
                                        <h3 className="text-2xl">{formatNumber(finList.reduce((a,c)=>a+c.amount,0) * 0.154)}Ïõê</h3>
                                    </div>
                                </div>
                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
                                    <div className="bg-white dark:bg-slate-800 p-5 rounded-xl border shadow font-bold">
                                        <h4 className="font-black mb-4 flex justify-between items-center text-blue-600 border-b pb-2">
                                            <span><i className="fa-solid fa-piggy-bank mr-1"></i> Ïù¥Ïûê/Î∞∞Îãπ ÎÇ¥Ïó≠ Îì±Î°ù</span>
                                            <div className="flex gap-1">
                                                <input id="fD" type="text" placeholder="Ìï≠Î™©" className="w-24 sim-input !mt-0 !p-1 text-xs" />
                                                <input id="fA" type="number" placeholder="Í∏àÏï°" className="w-24 sim-input !mt-0 !p-1 text-xs" />
                                                <button onClick={()=>{const d=document.getElementById('fD').value, a=parseInt(document.getElementById('fA').value); if(d&&a){setFinList([...finList,{id:Date.now(),desc:d,amount:a}]); document.getElementById('fD').value=''; document.getElementById('fA').value='';}}} className="bg-blue-600 text-white px-3 rounded text-xs font-black">Ï∂îÍ∞Ä</button>
                                            </div>
                                        </h4>
                                        <div className="max-h-60 overflow-y-auto space-y-1 font-bold">
                                            {finList.length === 0 ? <p className="text-xs text-slate-400 text-center py-4">Îì±Î°ùÎêú Ïù¥Ïûê/Î∞∞Îãπ ÎÇ¥Ïó≠Ïù¥ ÏóÜÏäµÎãàÎã§.</p> : finList.map(f => (
                                                <div key={f.id} className="flex justify-between items-center text-xs border-b py-2 dark:border-slate-700">
                                                    <span>{f.desc}</span>
                                                    <div className="flex items-center gap-3">
                                                        <span className="num-font font-black">{formatNumber(f.amount)}Ïõê</span>
                                                        <button onClick={()=>setFinList(finList.filter(item=>item.id!==f.id))} className="text-red-400 hover:text-red-600"><i className="fa-solid fa-xmark"></i></button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                    <div className="bg-white dark:bg-slate-800 p-5 rounded-xl border shadow font-bold">
                                        <h4 className="font-black mb-4 flex justify-between items-center text-emerald-600 border-b pb-2">
                                            <span><i className="fa-solid fa-coins mr-1"></i> Í∏∞ÌÉÄ Í∏àÏúµ ÏàòÏùµ(Í≥µÎ™®Ï£º Îì±)</span>
                                            <div className="flex gap-1">
                                                <input id="oD" type="text" placeholder="Ìï≠Î™©" className="w-24 sim-input !mt-0 !p-1 text-xs" />
                                                <input id="oA" type="number" placeholder="ÏàòÏùµ" className="w-24 sim-input !mt-0 !p-1 text-xs" />
                                                <button onClick={()=>{const d=document.getElementById('oD').value, a=parseInt(document.getElementById('oA').value); if(d&&a){setOtherIncomeList([...otherIncomeList,{id:Date.now(),desc:d,amount:a}]); document.getElementById('oD').value=''; document.getElementById('oA').value='';}}} className="bg-emerald-600 text-white px-3 rounded text-xs font-black">Ï∂îÍ∞Ä</button>
                                            </div>
                                        </h4>
                                        <div className="max-h-60 overflow-y-auto space-y-1 font-bold">
                                            {otherIncomeList.length === 0 ? <p className="text-xs text-slate-400 text-center py-4">Îì±Î°ùÎêú Í∏∞ÌÉÄ ÏàòÏùµÏù¥ ÏóÜÏäµÎãàÎã§.</p> : otherIncomeList.map(f => (
                                                <div key={f.id} className="flex justify-between items-center text-xs border-b py-2 dark:border-slate-700">
                                                    <span>{f.desc}</span>
                                                    <div className="flex items-center gap-3">
                                                        <span className="num-font font-black">{formatNumber(f.amount)}Ïõê</span>
                                                        <button onClick={()=>setOtherIncomeList(otherIncomeList.filter(item=>item.id!==f.id))} className="text-red-400 hover:text-red-600"><i className="fa-solid fa-xmark"></i></button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                    <div className="lg:col-span-2 bg-slate-50 dark:bg-slate-900 p-5 rounded-xl border-2 border-dashed border-slate-200 dark:border-slate-700 flex flex-col mt-4">
                                        <h4 className="font-black mb-4 border-b pb-2 text-slate-700 dark:text-slate-200"><i className="fa-solid fa-calculator mr-2"></i>ÏòàÏÉÅ ÏÑ∏Ïï° ÎèÑÏ∂ú Í≥ºÏ†ï ÏãúÎÆ¨Î†àÏù¥ÏÖò</h4>
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6 text-xs font-bold">
                                            <div className="flex items-start gap-3 bg-white dark:bg-slate-800 p-3 rounded-lg shadow-sm">
                                                <div className="w-6 h-6 bg-slate-200 dark:bg-slate-700 rounded-full flex items-center justify-center text-[10px]">1</div>
                                                <div><p className="text-slate-500">Í∏àÏúµÏÜåÎìù Ìï©ÏÇ∞</p><p className="mt-1">Ìï©Í≥Ñ: {formatNumber(finList.reduce((a,c)=>a+c.amount,0))}Ïõê</p></div>
                                            </div>
                                            <div className="flex items-start gap-3 bg-white dark:bg-slate-800 p-3 rounded-lg shadow-sm">
                                                <div className="w-6 h-6 bg-slate-200 dark:bg-slate-700 rounded-full flex items-center justify-center text-[10px]">2</div>
                                                <div><p className="text-slate-500">Ï¢ÖÌï©Í≥ºÏÑ∏ ÌåêÎã®</p><p className="mt-1">{finList.reduce((a,c)=>a+c.amount,0) > TAX_THRESHOLD ? <span className="text-red-500">Ï¥àÍ≥º(Ï¢ÖÌï©Í≥ºÏÑ∏)</span> : <span className="text-emerald-600">Ïù¥Ìïò(Î∂ÑÎ¶¨Í≥ºÏÑ∏)</span>}</p></div>
                                            </div>
                                            <div className="flex items-start gap-3 bg-indigo-100 text-indigo-600 dark:bg-indigo-900/30 p-3 rounded-lg shadow-sm">
                                                <div className="w-6 h-6 bg-indigo-200 text-indigo-600 dark:bg-indigo-900 rounded-full flex items-center justify-center text-[10px]">3</div>
                                                <div><p className="text-indigo-600 font-black">ÏõêÏ≤úÏßïÏàòÏï°</p><p className="mt-1 font-black text-sm">{formatNumber(finList.reduce((a,c)=>a+c.amount,0) * 0.154)}Ïõê</p></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>