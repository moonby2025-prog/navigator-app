<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investment Navigator (íˆ¬ì ë¹„ì„œ)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome (Icons) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <!-- React, ReactDOM, Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; letter-spacing: -0.02em; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        .nav-tab.active { background-color: #eff6ff; color: #2563eb; font-weight: 700; box-shadow: 0 1px 2px rgba(37,99,235,0.2); }
        .dark .nav-tab.active { background-color: #1e293b; color: #60a5fa; }
        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .sim-input { @apply mt-1 block w-full rounded-md border-gray-300 dark:border-slate-600 shadow-sm p-2 border dark:bg-slate-700 focus:ring-indigo-500 focus:border-indigo-500 text-sm font-bold; }
        .num-font { font-variant-numeric: tabular-nums; }
        .guide-card { @apply p-4 rounded-xl border border-slate-100 dark:border-slate-700 bg-white dark:bg-slate-800 shadow-sm; }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-900 transition-colors duration-200">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, memo, useCallback } = React;

        // --- Global Constants ---
        const ONE_HUNDRED_MILLION = 100000000;
        const TAX_THRESHOLD = 20000000;
        const EXCHANGE_RATES = { 'USD': { krw: 1380 }, 'JPY': { krw: 8.90 }, 'EUR': { krw: 1480 }, 'CNY': { krw: 190 }, 'KRW': { krw: 1 } };

        // --- Helpers ---
        const formatNumber = (num) => {
            if (num === null || num === undefined) return '0';
            return Math.round(num).toLocaleString('ko-KR');
        };
        const parseFormattedNumber = (value) => {
            if (typeof value !== 'string') return value || 0;
            return parseInt(value.replace(/[^0-9]/g, '')) || 0;
        };

        const calculateProgressiveIncomeTax = (income, rates) => {
            if (income <= 0) return 0;
            const threshold1 = 40000000;
            const threshold2 = 80000000;
            let tax = 0;
            const income1 = Math.min(income, threshold1);
            tax += income1 * (rates.rate1 / 100);
            if (income > threshold1) {
                const income2 = Math.min(income, threshold2) - threshold1;
                tax += income2 * (rates.rate2 / 100);
            }
            if (income > threshold2) {
                const income3 = income - threshold2;
                tax += income3 * (rates.rate3 / 100);
            }
            return Math.max(0, tax);
        };

        // --- Widgets ---
        const TradingViewTicker = memo(({ theme }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (!ref.current) return;
                ref.current.innerHTML = '';
                const script = document.createElement('script');
                script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-ticker-tape.js';
                script.async = true;
                script.innerHTML = JSON.stringify({
                    "symbols": [
                        { "proName": "FOREXCOM:SPXUSD", "title": "S&P 500" },
                        { "proName": "NASDAQ:QQQ", "title": "ë‚˜ìŠ¤ë‹¥ QQQ" },
                        { "proName": "FX_IDC:USDKRW", "title": "ì›ë‹¬ëŸ¬ í™˜ìœ¨" },
                        { "proName": "BINANCE:BTCUSDT", "title": "ë¹„íŠ¸ì½”ì¸" },
                        { "proName": "TVC:SILVER", "title": "ì€ í˜„ë¬¼" }
                    ],
                    "showSymbolLogo": true,
                    "colorTheme": theme,
                    "isTransparent": true,
                    "displayMode": "adaptive",
                    "locale": "kr"
                });
                ref.current.appendChild(script);
            }, [theme]);
            return <div ref={ref}></div>;
        });

        const TradingViewHeatmap = memo(({ theme }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (!ref.current) return;
                ref.current.innerHTML = '';
                const script = document.createElement('script');
                script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-stock-heatmap.js';
                script.async = true;
                script.innerHTML = JSON.stringify({
                    "dataSource": "SPX500", "grouping": "sector", "blockSize": "market_cap_basic", "blockColor": "change", "locale": "kr", "colorTheme": theme, "hasTopBar": false, "isTransparent": true, "width": "100%", "height": "100%"
                });
                ref.current.appendChild(script);
            }, [theme]);
            return <div ref={ref} className="h-full"></div>;
        });

        // --- Main Component ---
        function App() {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [isDark, setIsDark] = useState(false);
            const [linkMode, setLinkMode] = useState('investment');
            const [marketStatus, setMarketStatus] = useState({ text: 'ì¥ ë§ˆê°', color: 'bg-red-600' });

            // Dashboard Favorites
            const [favorites, setFavorites] = useState([
                { code: "005930", name: "ì‚¼ì„±ì „ì" }, { code: "005380", name: "í˜„ëŒ€ì°¨" }, 
                { code: "237690", name: "ì—ìŠ¤í‹°íŒœ" }, { code: "445680", name: "íë¦¬ì˜¥ìŠ¤" }
            ]);

            // Routine Links State
            const [routineLinks, setRoutineLinks] = useState({
                "ğŸŒ… ì•„ì¹¨ í•„ìˆ˜ ì²´í¬ (Morning Routine)": [
                    { name: "ë¯¸êµ­ ì‹œì¥ ì ê²€", url: "https://kr.investing.com/portfolio/?portfolioID=OT4%2BZDRrZTFjM2thYTthYg%3D%3D", icon: "fa-list-check", color: "bg-blue-100 text-blue-700" },
                    { name: "Finviz (ë¯¸êµ­ ë§µ)", url: "https://finviz.com/map.ashx", icon: "fa-map", color: "bg-emerald-100 text-emerald-700" },
                    { name: "í•„ë¼ë¸í”¼ì•„ ë°˜ë„ì²´", url: "https://kr.investing.com/indices/phlx-semiconductor", icon: "fa-microchip", color: "bg-teal-100 text-teal-700" },
                    { name: "ê³µí¬ íƒìš• ì§€ìˆ˜ (CNN)", url: "https://edition.cnn.com/markets/fear-and-greed", icon: "fa-gauge-high", color: "bg-orange-100 text-orange-700" },
                    { name: "í¬ë¦½í†  ì§€í‘œ (MVRV)", url: "https://www.bitcoinmagazinepro.com/charts/mvrv-zscore/", icon: "fa-chart-area", color: "bg-amber-100 text-amber-700" },
                    { name: "SILVER (ì€ ì‹¤ì‹œê°„)", url: "https://kr.investing.com/currencies/xag-usd", icon: "fa-coins", color: "bg-slate-100 text-slate-700" },
                    { name: "ì€ì‹œì„¸(ìˆœìˆ˜í•œê¸ˆ)", url: "https://blog.naver.com/wolfkickbox", icon: "fa-blog", color: "bg-yellow-100 text-yellow-700" }
                ],
                "ğŸ’° ê³µëª¨ì£¼ & ì‹¤ì  (IPO & Earnings)": [
                    { name: "38 ì»¤ë®¤ë‹ˆì¼€ì´ì…˜", url: "http://www.38.co.kr/html/fund/index.htm?gjbcd=1460", icon: "fa-building", color: "bg-purple-100 text-purple-700" },
                    { name: "DART (ì „ìê³µì‹œ)", url: "https://dart.fss.or.kr/", icon: "fa-file-signature", color: "bg-yellow-100 text-yellow-700" },
                    { name: "KIND (ê¸°ì—…ê³µì‹œ)", url: "https://kind.krx.co.kr/", icon: "fa-file-invoice", color: "bg-blue-50 text-blue-600" },
                    { name: "KRX ì •ë³´ë°ì´í„°ì‹œìŠ¤í…œ", url: "http://data.krx.co.kr/", icon: "fa-database", color: "bg-indigo-100 text-indigo-700" },
                    { name: "Seibro (ì¦ê¶Œì •ë³´í¬í„¸)", url: "https://seibro.or.kr/", icon: "fa-server", color: "bg-indigo-50 text-indigo-600" },
                    { name: "ì¢…ëª©ë³„ ì™¸êµ­ì¸ êµ­ì ë¶„ë¥˜", url: "https://data.krx.co.kr/contents/MDC/HARD/hardController/MDCHARD053.cmd", icon: "fa-globe", color: "bg-blue-50 text-blue-700" }
                ],
                "ğŸ“ˆ êµ­ë‚´ ì‹œì¥ ì‹¬ì¸µ (Korea Market)": [
                    { name: "ë„¤ì´ë²„ ê¸ˆìœµ", url: "https://finance.naver.com/", icon: "fa-n", color: "bg-green-50 text-green-600" },
                    { name: "ë²„í‹€ëŸ¬ (Butler)", url: "https://www.butler.works/ko/home", icon: "fa-chart-line", color: "bg-purple-50 text-purple-600" },
                    { name: "í•œê²½ ì»¨ì„¼ì„œìŠ¤", url: "https://markets.hankyung.com/consensus", icon: "fa-book-open", color: "bg-red-50 text-red-600" },
                    { name: "SMIC (ì„œìš¸ëŒ€ ë¦¬ì„œì¹˜)", url: "http://snusmic.com/research/", icon: "fa-graduation-cap", color: "bg-slate-200 text-slate-800" },
                    { name: "FDA ìŠ¹ì¸ ì‹¤ì‹œê°„", url: "https://www.youtube.com/user/USFoodandDrugAdmin", icon: "fa-video", color: "bg-red-100 text-red-700" },
                    { name: "ì£¼ì‹/ë¶€ë™ì‚° ëª¨ì•„ë´", url: "http://moabbs.com/blogs/lists", icon: "fa-users", color: "bg-orange-100 text-orange-700" },
                    { name: "ì „ìì¡ì§€ (ëª¨ì•„ì§„)", url: "https://lib.ice.go.kr/elib/module/elib/moazine.do?menu_idx=37", icon: "fa-book-open", color: "bg-yellow-100 text-yellow-700" }
                ],
                "ğŸ¡ ì¼ìƒ & ë¶€ë™ì‚° (Daily Life)": [
                    { name: "í˜¸ê°±ë…¸ë…¸", url: "https://hogangnono.com/", icon: "fa-map-pin", color: "bg-red-50 text-red-600" },
                    { name: "ë„¤ì´ë²„ ë¶€ë™ì‚°", url: "https://land.naver.com/", icon: "fa-building", color: "bg-green-50 text-green-600" },
                    { name: "ë„¤ì´ë²„ ì§€ë„", url: "https://map.naver.com/", icon: "fa-location-dot", color: "bg-blue-50 text-blue-600" },
                    { name: "êµ¬ê¸€ ì§€ë„", url: "https://maps.google.com/", icon: "fa-location-dot", color: "bg-amber-50 text-amber-600" }
                ]
            });

            // Blog Insight
            const [blogInsightLinks, setBlogInsightLinks] = useState({
                "ğŸ§¬ íë¦¬ì˜¥ìŠ¤": [
                    { name: "í•œê³„ë¥¼ ê¹¨ëŠ” ì‚¬ëŒ", url: "https://blog.naver.com/unlimitedi" },
                    { name: "ê³µëŒ€ìƒ ì£¼ì ‘ë…¸íŠ¸", url: "https://blog.naver.com/b_g-duck" }
                ],
                "ğŸ’Š ì—ìŠ¤í‹°íŒœ": [
                    { name: "ì˜¤ì¬ë³µ", url: "https://blog.naver.com/hym090206" },
                    { name: "Chan", url: "https://blog.naver.com/chany2do" }
                ]
            });

            // Tools state
            const [targetInputs, setTargetInputs] = useState({ mode: 'cap', price: '70,000', shares: '100', currentCap: '400', targetCap: '500', targetRate: '85,000' });
            const [pnlInputs, setPnlInputs] = useState({ buy: '10,000,000', sell: '12,000,000', fee: '0.3' });
            const [ipoCalcInputs, setIpoCalcInputs] = useState({ price: '20,000', qty: '100', fee: '2,000', rate: 50 });
            const [avgRows, setAvgRows] = useState([{ id: 1, q: '50', p: '65,000' }, { id: 2, q: '30', p: '70,000' }]);
            const [exchInputs, setExchInputs] = useState({ base: 'USD', target: 'KRW', amount: '1,000' });
            const [divInputs, setDivInputs] = useState({ shares: '1,000', perShare: '2,500', tax: '15.4' });
            const [toolTaxInputs, setToolTaxInputs] = useState({ profit: '10,000,000', type: 'dividend' });

            // Simulation state
            const [simInputs, setSimInputs] = useState({
                currentAge: 51, spouseCurrentAge: 47, simulationStartAge: 53,
                retirementAge: 65, spouseRetirementAge: 65, highCostStartAge: 80,
                capUserNonISA: 3.0, capSpouseNonISA: 2.0, capUserISA: 3.0, capSpouseISA: 2.0,
                returnUserNonISA: 5.0, returnSpouseNonISA: 5.0, returnUserISA: 6.0, returnSpouseISA: 6.0,
                inflationRate: 2.0, livingCostInflationRate: 1.5,
                taxRate1: 6.6, taxRate2: 16.5, taxRate3: 27.5,
                monthlyLiving: "5,000,000", pensionSelf: "1,000,000", pensionSpouse: "600,000",
                ipoProfit: "5,000,000", otherIncome: "4,500,000", stockLending: "0", rentalIncome: "850,000"
            });
            const [simResult, setSimResult] = useState({ history: [], summary: null });

            // Tax tab state
            const [finList, setFinList] = useState([]);
            const [otherList, setOtherList] = useState([]);

            useEffect(() => {
                const timer = setInterval(() => {
                    const now = new Date();
                    const hours = now.getHours();
                    const day = now.getDay();
                    let status = { text: "ì¥ ë§ˆê°", color: "bg-red-600" };
                    if (hours >= 9 && hours < 16 && day !== 0 && day !== 6) status = { text: "êµ­ë‚´ ì¥ ìš´ì˜ ì¤‘", color: "bg-green-600" };
                    else if (hours >= 22 || hours < 6) status = { text: "ë¯¸êµ­ ì¥ ìš´ì˜ ì¤‘", color: "bg-blue-600" };
                    setMarketStatus(status);
                }, 1000);
                return () => clearInterval(timer);
            }, []);

            useEffect(() => {
                if (isDark) document.documentElement.classList.add('dark');
                else document.documentElement.classList.remove('dark');
            }, [isDark]);

            const searchSymbol = (query) => {
                if(!query) return;
                const url = /[a-zA-Z]/.test(query) 
                    ? `https://finance.naver.com/world/sise.naver?symbol=${query.trim().toUpperCase()}` 
                    : `https://finance.naver.com/item/main.naver?code=${query.trim()}`;
                window.open(url, '_blank');
            };

            const runSimulation = useCallback(() => {
                const s = simInputs;
                const ageDiff = s.currentAge - s.spouseCurrentAge;
                let cUserNon = s.capUserNonISA * ONE_HUNDRED_MILLION;
                let cSpouseNon = s.capSpouseNonISA * ONE_HUNDRED_MILLION;
                let cUserISA = s.capUserISA * ONE_HUNDRED_MILLION;
                let cSpouseISA = s.capSpouseISA * ONE_HUNDRED_MILLION;
                
                const initLiving = parseFormattedNumber(s.monthlyLiving) * 12;
                const initPenSelf = parseFormattedNumber(s.pensionSelf) * 12;
                const initPenSpouse = parseFormattedNumber(s.pensionSpouse) * 12;
                const initOtherTotal = parseFormattedNumber(s.ipoProfit) + parseFormattedNumber(s.otherIncome) + parseFormattedNumber(s.stockLending) + parseFormattedNumber(s.rentalIncome);

                let history = []; let totalTax = 0; let depletionYear = null;
                const period = Math.max(1, 95 - s.simulationStartAge);

                for (let year = 1; year <= period; year++) {
                    const age = s.simulationStartAge + year - 1;
                    const spouseAge = age - ageDiff;
                    const pInf = Math.pow(1 + (s.inflationRate / 100), year - 1);
                    const lInf = Math.pow(1 + (s.livingCostInflationRate / 100), year - 1);

                    let weight = 1.0;
                    if (age >= Math.min(s.retirementAge, s.spouseRetirementAge)) {
                        if (age < s.highCostStartAge - 5) weight = 1.1;
                        else if (age < s.highCostStartAge) weight = 0.9;
                        else weight = 1.2;
                    }
                    const livingCost = initLiving * lInf * weight;

                    let pension = 0;
                    if (age >= s.retirementAge) pension += initPenSelf;
                    if (spouseAge >= s.spouseRetirementAge) pension += initPenSpouse;
                    const totalIncome = (pension + initOtherTotal) * pInf;

                    const profUserNon = cUserNon * (s.returnUserNonISA / 100) * 0.846;
                    const profSpouseNon = cSpouseNon * (s.returnSpouseNonISA / 100) * 0.846;
                    const profUserISA = cUserISA * (s.returnUserISA / 100) * 0.901;
                    const profSpouseISA = cSpouseISA * (s.returnSpouseISA / 100) * 0.901;

                    const incTax = calculateProgressiveIncomeTax(totalIncome, { rate1: s.taxRate1, rate2: s.taxRate2, rate3: s.taxRate3 });
                    totalTax += incTax;

                    let netCash = totalIncome - (livingCost + incTax);
                    let profTotal = profUserNon + profSpouseNon + profUserISA + profSpouseISA;
                    let withdrawal = netCash < 0 ? Math.abs(netCash) : 0;
                    if (netCash >= 0) profTotal += netCash;

                    if (withdrawal > 0) {
                        let rem = withdrawal;
                        let w1 = Math.min(rem, cUserNon); cUserNon -= w1; rem -= w1;
                        let w2 = Math.min(rem, cSpouseNon); cSpouseNon -= w2; rem -= w2;
                        let w3 = Math.min(rem, cSpouseISA); cSpouseISA -= w3; rem -= w3;
                        let w4 = Math.min(rem, cUserISA); cUserISA -= w4; rem -= w4;
                        if (rem > 0 && !depletionYear) depletionYear = age;
                    }

                    const tBefore = cUserNon + cSpouseNon + cUserISA + cSpouseISA;
                    if (tBefore > 0) {
                        const r1 = cUserNon / tBefore; const r2 = cSpouseNon / tBefore;
                        const r3 = cUserISA / tBefore; const r4 = cSpouseISA / tBefore;
                        cUserNon += profTotal * r1; cSpouseNon += profTotal * r2;
                        cUserISA += profTotal * r3; cSpouseISA += profTotal * r4;
                    }

                    history.push({ 
                        age, total: (cUserNon + cSpouseNon + cUserISA + cSpouseISA) / ONE_HUNDRED_MILLION, 
                        tax: incTax, living: livingCost, 
                        un: cUserNon/ONE_HUNDRED_MILLION, sn: cSpouseNon/ONE_HUNDRED_MILLION, ui: cUserISA/ONE_HUNDRED_MILLION, si: cSpouseISA/ONE_HUNDRED_MILLION 
                    });
                    if (cUserNon + cSpouseNon + cUserISA + cSpouseISA <= 0 && year > 1) break;
                }
                setSimResult({ history, summary: { initial: s.capUserNonISA + s.capSpouseNonISA + s.capUserISA + s.capSpouseISA, final: history[history.length-1]?.total || 0, tax: totalTax, depletion: depletionYear } });
            }, [simInputs]);

            useEffect(() => { runSimulation(); }, [runSimulation]);

            // --- Helpers for Input ---
            const handleCommaChange = (e, callback) => {
                const val = e.target.value.replace(/[^0-9]/g, '');
                callback(val ? parseInt(val).toLocaleString('ko-KR') : '');
            };

            const SimulationChart = memo(({ history }) => {
                const canvasRef = useRef(null);
                const chartInstance = useRef(null);
                useEffect(() => {
                    if (!canvasRef.current || history.length === 0) return;
                    const ctx = canvasRef.current.getContext('2d');
                    if (chartInstance.current) chartInstance.current.destroy();
                    chartInstance.current = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: history.map(h => h.age + "ì„¸"),
                            datasets: [
                                { label: 'ì´ ìì‚°(ì–µ)', data: history.map(h => h.total), borderColor: '#4f46e5', fill: true, backgroundColor: 'rgba(79, 70, 229, 0.1)', tension: 0.3 },
                                { label: 'ë³¸ì¸ ì¼ë°˜', data: history.map(h => h.un), borderColor: '#ef4444', pointRadius: 0 },
                                { label: 'ë°°ìš°ì ì¼ë°˜', data: history.map(h => h.sn), borderColor: '#f97316', pointRadius: 0 },
                                { label: 'ë³¸ì¸ ISA', data: history.map(h => h.ui), borderColor: '#10b981', pointRadius: 0 },
                                { label: 'ë°°ìš°ì ISA', data: history.map(h => h.si), borderColor: '#06b6d4', pointRadius: 0 }
                            ]
                        },
                        options: { 
                            responsive: true, maintainAspectRatio: false, animation: false,
                            scales: { y: { beginAtZero: true } },
                            plugins: {
                                legend: { position: 'top', labels: { boxWidth: 10, font: { size: 10, weight: 'bold' } } }
                            }
                        }
                    });
                    return () => { if (chartInstance.current) chartInstance.current.destroy(); };
                }, [history]);
                return <div className="h-64 md:h-80 w-full"><canvas ref={canvasRef}></canvas></div>;
            });

            // --- Tab Renderers ---

            const renderDashboard = () => (
                <div className="space-y-6 animate-fade-in pb-10">
                    <div className="bg-white dark:bg-slate-800 rounded-xl shadow h-14 overflow-hidden border dark:border-slate-700">
                        <TradingViewTicker theme={isDark ? 'dark' : 'light'} />
                    </div>
                    <div className="bg-white dark:bg-slate-800 p-1 rounded-xl shadow h-[400px] border dark:border-slate-700 flex flex-col">
                        <div className="p-3 border-b dark:border-slate-700 flex justify-between items-center font-bold">
                            <span>S&P 500 íˆíŠ¸ë§µ</span>
                            <span className={`px-2 py-0.5 rounded-full text-[10px] text-white ${marketStatus.color}`}>{marketStatus.text}</span>
                        </div>
                        <div className="flex-1 overflow-hidden">
                            <TradingViewHeatmap theme={isDark ? 'dark' : 'light'} />
                        </div>
                    </div>
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div className="bg-white dark:bg-slate-800 rounded-xl shadow-lg border p-5 font-bold">
                            <h3 className="text-xl font-bold mb-4 flex items-center gap-2 text-indigo-500"><i className="fa-solid fa-magnifying-glass-chart"></i> ì¢…ëª© ê²€ìƒ‰ ë° ë°”ë¡œê°€ê¸°</h3>
                            <div className="flex gap-2 mb-4">
                                <input type="text" id="mainSearch" placeholder="ì¢…ëª©ëª… ë˜ëŠ” ì½”ë“œ" className="flex-1 p-3 border-2 border-indigo-200 rounded-lg dark:bg-slate-700 outline-none focus:border-indigo-500" onKeyPress={e=>e.key==='Enter'&&searchSymbol(e.target.value)} />
                                <button onClick={() => searchSymbol(document.getElementById('mainSearch').value)} className="bg-indigo-600 text-white px-6 rounded-lg font-bold">ê²€ìƒ‰</button>
                            </div>
                            <div className="flex flex-wrap gap-2">
                                {favorites.map(s => (
                                    <div key={s.code} className="group relative">
                                        <button onClick={() => searchSymbol(s.code)} className="pl-3 pr-8 py-1.5 bg-slate-50 dark:bg-slate-700 border dark:border-slate-600 rounded-lg text-xs font-bold shadow-sm hover:border-indigo-400">
                                            <span className="text-slate-400 mr-1">{s.code}</span> {s.name}
                                        </button>
                                        <button onClick={() => setFavorites(favorites.filter(f => f.code !== s.code))} className="absolute right-1 top-1.5 text-slate-300 hover:text-red-500 text-[10px] px-1 opacity-0 group-hover:opacity-100 transition">
                                            <i className="fa-solid fa-xmark"></i>
                                        </button>
                                    </div>
                                ))}
                            </div>
                        </div>

                        <div className="bg-white dark:bg-slate-800 rounded-xl shadow-lg border p-5 font-bold">
                            <h3 className="text-lg font-bold mb-4 flex items-center gap-2 text-slate-500"><i className="fa-solid fa-gear"></i> ì¢…ëª© í¸ì§‘ ì„¤ì •</h3>
                            <div className="flex gap-2 mb-2">
                                <input type="text" id="addName" placeholder="ì¢…ëª©ëª…" className="flex-1 sim-input" />
                                <input type="text" id="addCode" placeholder="ì½”ë“œ" className="w-24 sim-input" />
                                <button onClick={() => {
                                    const n = document.getElementById('addName').value;
                                    const c = document.getElementById('addCode').value;
                                    if(n && c) {
                                        setFavorites([...favorites, {name: n, code: c}]);
                                        document.getElementById('addName').value = '';
                                        document.getElementById('addCode').value = '';
                                    }
                                }} className="bg-emerald-600 text-white px-4 rounded-lg mt-1 font-bold text-xs">ì¶”ê°€</button>
                            </div>
                            <p className="text-[10px] text-slate-400">ì¢…ëª© ì½”ë“œ 6ìë¦¬ë¥¼ ì •í™•íˆ ì…ë ¥í•˜ì„¸ìš”. (ë¯¸êµ­ì£¼ëŠ” í‹°ì»¤ ì…ë ¥)</p>
                        </div>
                    </div>
                </div>
            );

            const renderRoutine = () => (
                <div className="space-y-6 animate-fade-in pb-10">
                    <div className="flex justify-between items-center pb-4 border-b dark:border-slate-700 font-bold">
                        <h2 className="text-2xl font-black">ì˜¤ëŠ˜ì˜ ë£¨í‹´</h2>
                        <div className="flex bg-slate-100 dark:bg-slate-700 p-1 rounded-lg">
                            <button onClick={() => setLinkMode('investment')} className={`px-4 py-1.5 text-xs font-bold rounded-lg transition-all ${linkMode === 'investment' ? 'bg-white shadow text-blue-600' : 'text-slate-500'}`}>íˆ¬ì & ì¼ìƒ</button>
                            <button onClick={() => setLinkMode('blogs')} className={`px-4 py-1.5 text-xs font-bold rounded-lg transition-all ${linkMode === 'blogs' ? 'bg-white shadow text-blue-600' : 'text-slate-500'}`}>ì¸ì‚¬ì´íŠ¸</button>
                            <button onClick={() => setLinkMode('settings')} className={`px-4 py-1.5 text-xs font-bold rounded-lg transition-all ${linkMode === 'settings' ? 'bg-white shadow text-indigo-600' : 'text-slate-500'}`}><i className="fa-solid fa-gear"></i></button>
                        </div>
                    </div>

                    {linkMode === 'settings' ? (
                        <div className="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow border dark:border-slate-700 font-bold space-y-6">
                            <h3 className="text-xl font-black text-indigo-500 border-b pb-2"><i className="fa-solid fa-list-check mr-2"></i>ë£¨í‹´ ë§í¬ í¸ì§‘ ê´€ë¦¬</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                {Object.keys(routineLinks).map(cat => (
                                    <div key={cat} className="p-4 border rounded-xl bg-slate-50 dark:bg-slate-900">
                                        <h4 className="text-sm font-bold mb-3 text-slate-600">{cat}</h4>
                                        <div className="space-y-2 mb-4 max-h-40 overflow-y-auto">
                                            {routineLinks[cat].map((l, idx) => (
                                                <div key={idx} className="flex justify-between items-center bg-white dark:bg-slate-800 p-2 rounded border text-xs">
                                                    <span className="truncate flex-1">{l.name}</span>
                                                    <button onClick={() => {
                                                        const newLinks = {...routineLinks};
                                                        newLinks[cat] = newLinks[cat].filter((_, i) => i !== idx);
                                                        setRoutineLinks(newLinks);
                                                    }} className="text-red-400 hover:text-red-600 ml-2">ì‚­ì œ</button>
                                                </div>
                                            ))}
                                        </div>
                                        <div className="space-y-2">
                                            <input id={`n-${cat}`} placeholder="ì‚¬ì´íŠ¸ ì´ë¦„" className="w-full sim-input" />
                                            <div className="flex gap-1">
                                                <input id={`u-${cat}`} placeholder="https://..." className="flex-1 sim-input" />
                                                <button onClick={() => {
                                                    const nameVal = document.getElementById(`n-${cat}`).value;
                                                    const urlVal = document.getElementById(`u-${cat}`).value;
                                                    if(nameVal && urlVal) {
                                                        const newLinks = {...routineLinks};
                                                        newLinks[cat] = [...newLinks[cat], { name: nameVal, url: urlVal, icon: "fa-link", color: "bg-slate-100 text-slate-700" }];
                                                        setRoutineLinks(newLinks);
                                                        document.getElementById(`n-${cat}`).value = '';
                                                        document.getElementById(`u-${cat}`).value = '';
                                                    }
                                                }} className="bg-blue-600 text-white px-3 rounded-lg mt-1 font-bold text-xs">ì¶”ê°€</button>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    ) : linkMode === 'blogs' ? (
                        <div className="flex flex-col gap-8 p-6 bg-white dark:bg-slate-800 rounded-2xl shadow-inner min-h-[400px]">
                            {Object.entries(blogInsightLinks).map(([cat, links]) => (
                                <div key={cat} className="flex flex-col md:flex-row items-center gap-4">
                                    <div className="bg-indigo-600 text-white px-4 py-2 rounded-xl font-bold min-w-[120px] text-center">{cat}</div>
                                    <div className="flex flex-wrap gap-2 flex-1 justify-center md:justify-start">
                                        {links.map((l, i) => <a key={i} href={l.url} target="_blank" className="px-4 py-2 bg-slate-50 dark:bg-slate-900 border rounded-full text-xs font-bold shadow-sm hover:shadow-md transition">{l.name}</a>)}
                                    </div>
                                </div>
                            ))}
                        </div>
                    ) : (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 font-bold">
                            {Object.entries(routineLinks).map(([cat, links]) => (
                                <div key={cat} className="bg-white dark:bg-slate-800 rounded-2xl p-6 shadow-lg border dark:border-slate-700">
                                    <h3 className="text-lg font-bold mb-4 border-b pb-2 dark:border-slate-700 text-indigo-600">{cat}</h3>
                                    <div className="space-y-3">
                                        {links.map((l, i) => (
                                            <a key={i} href={l.url} target="_blank" className="block p-3 rounded-xl bg-slate-50 dark:bg-slate-700 hover:shadow-md transition flex items-center gap-3 group">
                                                <div className={`w-8 h-8 rounded flex items-center justify-center ${l.color} bg-opacity-20 group-hover:scale-110 transition`}><i className={`fa-solid ${l.icon}`}></i></div>
                                                <span className="font-bold text-sm truncate">{l.name}</span>
                                            </a>
                                        ))}
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );

            const renderTools = () => {
                const targetRes = (() => {
                    const p = parseFormattedNumber(targetInputs.price); const s = parseFormattedNumber(targetInputs.shares);
                    let tP = 0, r = 0;
                    if(targetInputs.mode === 'cap') {
                        const c = parseFloat(targetInputs.currentCap) || 1; const t = parseFloat(targetInputs.targetCap) || 0;
                        tP = p * (t/c); r = ((t/c)-1)*100;
                    } else {
                        tP = parseFormattedNumber(targetInputs.targetRate); if(p > 0) r = ((tP - p)/p)*100;
                    }
                    return { price: tP, rate: r, profit: (tP - p) * s };
                })();
                const exchRes = (parseFormattedNumber(exchInputs.amount) * EXCHANGE_RATES[exchInputs.base].krw) / EXCHANGE_RATES[exchInputs.target].krw;
                const pnlRes = parseFormattedNumber(pnlInputs.sell) - parseFormattedNumber(pnlInputs.buy) - ((parseFormattedNumber(pnlInputs.sell) + parseFormattedNumber(pnlInputs.buy)) * (parseFloat(pnlInputs.fee) / 100));
                let avgQ = 0, avgCost = 0;
                avgRows.forEach(r => { const q = parseFormattedNumber(r.q); const p = parseFormattedNumber(r.p); avgQ += q; avgCost += q*p; });
                
                // IPO & SPAC Calculation
                const ipoPrice = parseFormattedNumber(ipoCalcInputs.price);
                const ipoQty = parseFormattedNumber(ipoCalcInputs.qty);
                const ipoFee = parseFormattedNumber(ipoCalcInputs.fee);
                const ipoDeposit = (ipoPrice * ipoQty) * (ipoCalcInputs.rate / 100);
                const ipoTotalNeeded = ipoDeposit + ipoFee;

                // Tool Tax Calculation (ë³µêµ¬ëœ ë¶€ë¶„)
                const toolTaxProfit = parseFormattedNumber(toolTaxInputs.profit);
                const toolTaxRes = toolTaxInputs.type === 'dividend' ? toolTaxProfit * 0.154 : toolTaxProfit * 0.22;

                return (
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 animate-fade-in pb-10 font-bold">
                        <div className="bg-white dark:bg-slate-800 p-5 rounded-xl shadow border dark:border-slate-700 flex flex-col">
                            <h3 className="font-bold mb-4 text-indigo-600 font-black"><i className="fa-solid fa-bullseye mr-2"></i>ëª©í‘œ ë‹¨ê°€ ë¶„ì„</h3>
                            <div className="flex bg-slate-100 dark:bg-slate-900 p-1 rounded mb-3 text-[10px]">
                                <button onClick={() => setTargetInputs({...targetInputs, mode:'cap'})} className={`flex-1 py-1 rounded ${targetInputs.mode==='cap'?'bg-white shadow text-indigo-600':'text-slate-500'}`}>ì‹œì´ ë¹„ë¡€</button>
                                <button onClick={() => setTargetInputs({...targetInputs, mode:'rate'})} className={`flex-1 py-1 rounded ${targetInputs.mode==='rate'?'bg-white shadow text-indigo-600':'text-slate-500'}`}>ê°€ê²© ì§ì ‘</button>
                            </div>
                            <div className="space-y-2 flex-1">
                                <div><label className="text-[10px] text-slate-500 block">í˜„ì¬ í‰ë‹¨ê°€</label><input type="text" className="sim-input text-right" value={targetInputs.price} onChange={e=>handleCommaChange(e, v=>setTargetInputs({...targetInputs, price:v}))} /></div>
                                <div><label className="text-[10px] text-slate-500 block">ë³´ìœ  ìˆ˜ëŸ‰</label><input type="text" className="sim-input text-right" value={targetInputs.shares} onChange={e=>handleCommaChange(e, v=>setTargetInputs({...targetInputs, shares:v}))} /></div>
                                {targetInputs.mode==='cap' ? (
                                    <div className="grid grid-cols-2 gap-2">
                                        <div><label className="text-[10px] text-slate-500 block">í˜„ì¬ ì‹œì´(ì¡°)</label><input type="number" step="0.1" className="sim-input" value={targetInputs.currentCap} onChange={e=>setTargetInputs({...targetInputs, currentCap:e.target.value})} /></div>
                                        <div><label className="text-[10px] text-slate-500 block">ëª©í‘œ ì‹œì´(ì¡°)</label><input type="number" step="0.1" className="sim-input" value={targetInputs.targetCap} onChange={e=>setTargetInputs({...targetInputs, targetCap:e.target.value})} /></div>
                                    </div>
                                ) : (
                                    <div><label className="text-[10px] text-slate-500 block">ëª©í‘œê°€</label><input type="text" className="sim-input text-right" value={targetInputs.targetRate} onChange={e=>handleCommaChange(e, v=>setTargetInputs({...targetInputs, targetRate:v}))} /></div>
                                )}
                            </div>
                            <div className="mt-4 p-3 bg-indigo-50 dark:bg-indigo-900/20 rounded text-right text-indigo-600 num-font font-black">
                                <div>{formatNumber(targetRes.price)}ì› ({targetRes.rate.toFixed(1)}%)</div>
                                <div className="text-[10px] opacity-70">ì˜ˆìƒ ìˆ˜ìµ: {formatNumber(targetRes.profit)}ì›</div>
                            </div>
                        </div>

                        <div className="bg-white dark:bg-slate-800 p-5 rounded-xl shadow border dark:border-slate-700">
                            <h3 className="font-bold mb-4 text-blue-600 font-black"><i className="fa-solid fa-money-bill-transfer mr-2"></i>í™˜ìœ¨ ê³„ì‚°ê¸°</h3>
                            <div className="space-y-4">
                                <div className="flex gap-2">
                                    <select className="w-1/3 sim-input" value={exchInputs.base} onChange={e=>setExchInputs({...exchInputs, base:e.target.value})}>{Object.keys(EXCHANGE_RATES).map(k=><option key={k} value={k}>{k}</option>)}</select>
                                    <input type="text" className="flex-1 sim-input text-right" value={exchInputs.amount} onChange={e=>handleCommaChange(e, v=>setExchInputs({...exchInputs, amount:v}))} />
                                </div>
                                <div className="flex gap-2 items-center">
                                    <select className="w-1/3 sim-input" value={exchInputs.target} onChange={e=>setExchInputs({...exchInputs, target:e.target.value})}>{Object.keys(EXCHANGE_RATES).map(k=><option key={k} value={k}>{k}</option>)}</select>
                                    <div className="flex-1 p-2 border rounded bg-slate-50 dark:bg-slate-900 text-right text-blue-600 num-font font-black">{exchInputs.target==='KRW'?formatNumber(exchRes):exchRes.toFixed(2)}</div>
                                </div>
                            </div>
                        </div>

                        <div className="bg-white dark:bg-slate-800 p-5 rounded-xl shadow border dark:border-slate-700 font-bold">
                            <h3 className="mb-4 text-rose-600 font-black"><i className="fa-solid fa-receipt mr-2"></i>ê°„ì´ ì„¸ê¸ˆ ê³„ì‚°ê¸°</h3>
                            <div className="space-y-2">
                                <div className="flex bg-slate-100 dark:bg-slate-900 p-1 rounded mb-2 text-[10px]">
                                    <button onClick={() => setToolTaxInputs({...toolTaxInputs, type:'dividend'})} className={`flex-1 py-1 rounded ${toolTaxInputs.type==='dividend'?'bg-white shadow text-rose-600':'text-slate-500'}`}>ë°°ë‹¹/ì´ì(15.4%)</button>
                                    <button onClick={() => setToolTaxInputs({...toolTaxInputs, type:'capital'})} className={`flex-1 py-1 rounded ${toolTaxInputs.type==='capital'?'bg-white shadow text-rose-600':'text-slate-500'}`}>ì–‘ë„ì†Œë“(22%)</button>
                                </div>
                                <div><label className="text-[10px] text-slate-500 block">ìˆ˜ìµ ì´ì•¡</label><input type="text" className="sim-input text-right" value={toolTaxInputs.profit} onChange={e=>handleCommaChange(e, v=>setToolTaxInputs({...toolTaxInputs, profit:v}))} /></div>
                                <div className="p-3 bg-rose-50 dark:bg-rose-900/20 rounded text-center text-rose-600 mt-2 num-font font-black">ì˜ˆìƒ ì„¸ê¸ˆ: {formatNumber(toolTaxRes)}ì›</div>
                            </div>
                        </div>

                        <div className="bg-white dark:bg-slate-800 p-5 rounded-xl shadow border dark:border-slate-700 font-bold">
                            <h3 className="mb-4 text-purple-600 font-black flex justify-between items-center">
                                <span><i className="fa-solid fa-piggy-bank mr-2"></i>ê³µëª¨ì£¼ & ìŠ¤íŒ© ì²­ì•½</span>
                                <button onClick={()=>setIpoCalcInputs({...ipoCalcInputs, price:'2,000', rate:100})} className="text-[10px] bg-purple-100 dark:bg-purple-900 text-purple-600 px-2 py-0.5 rounded">ìŠ¤íŒ©ì „í™˜</button>
                            </h3>
                            <div className="space-y-2">
                                <div className="grid grid-cols-2 gap-2">
                                    <div><label className="text-[10px] text-slate-500 block">ê³µëª¨ê°€</label><input type="text" className="sim-input text-right" value={ipoCalcInputs.price} onChange={e=>handleCommaChange(e, v=>setIpoCalcInputs({...ipoCalcInputs, price:v}))} /></div>
                                    <div><label className="text-[10px] text-slate-500 block">ì²­ì•½ìˆ˜ëŸ‰</label><input type="text" className="sim-input text-right" value={ipoCalcInputs.qty} onChange={e=>handleCommaChange(e, v=>setIpoCalcInputs({...ipoCalcInputs, qty:v}))} /></div>
                                </div>
                                <div className="grid grid-cols-2 gap-2">
                                    <div>
                                        <label className="text-[10px] text-slate-500 block">ì¦ê±°ê¸ˆìœ¨</label>
                                        <select className="sim-input" value={ipoCalcInputs.rate} onChange={e=>setIpoCalcInputs({...ipoCalcInputs, rate:parseInt(e.target.value)})}>
                                            <option value={50}>50% (ì¼ë°˜)</option>
                                            <option value={100}>100% (ê¸°ê´€/ì¼ë¶€ìŠ¤íŒ©)</option>
                                        </select>
                                    </div>
                                    <div><label className="text-[10px] text-slate-500 block">ì²­ì•½ ìˆ˜ìˆ˜ë£Œ</label><input type="text" className="sim-input text-right" value={ipoCalcInputs.fee} onChange={e=>handleCommaChange(e, v=>setIpoCalcInputs({...ipoCalcInputs, fee:v}))} /></div>
                                </div>
                                <div className="p-3 bg-purple-50 dark:bg-purple-900/20 rounded mt-2 num-font font-black">
                                    <div className="flex justify-between text-[11px] opacity-70 mb-1"><span>ìˆœìˆ˜ ì¦ê±°ê¸ˆ</span><span>{formatNumber(ipoDeposit)}ì›</span></div>
                                    <div className="flex justify-between text-purple-600"><span>ì´ í•„ìš” í˜„ê¸ˆ</span><span>{formatNumber(ipoTotalNeeded)}ì›</span></div>
                                </div>
                            </div>
                        </div>

                        <div className="bg-white dark:bg-slate-800 p-5 rounded-xl shadow border dark:border-slate-700 font-bold flex flex-col">
                            <h3 className="mb-4 text-emerald-600 flex justify-between items-center font-black">
                                <span><i className="fa-solid fa-scale-balanced mr-2"></i>í‰ë‹¨ê°€ ê³„ì‚°</span>
                                <button onClick={()=>setAvgRows([...avgRows, {id:Date.now(), q:'', p:''}])} className="bg-emerald-100 text-emerald-600 px-2 py-0.5 rounded text-[10px]">+ ì¶”ê°€</button>
                            </h3>
                            <div className="space-y-2 overflow-y-auto max-h-32 mb-2">
                                {avgRows.map((r, i) => (
                                    <div key={r.id} className="flex gap-2">
                                        <input type="text" placeholder="ìˆ˜ëŸ‰" className="flex-1 sim-input text-right" value={r.q} onChange={e=>handleCommaChange(e, v=>{const n=[...avgRows]; n[i].q=v; setAvgRows(n);})} />
                                        <input type="text" placeholder="ë‹¨ê°€" className="flex-1 sim-input text-right" value={r.p} onChange={e=>handleCommaChange(e, v=>{const n=[...avgRows]; n[i].p=v; setAvgRows(n);})} />
                                    </div>
                                ))}
                            </div>
                            <div className="mt-auto p-3 bg-emerald-50 dark:bg-emerald-900/20 rounded text-right text-emerald-600 num-font font-black">í‰ë‹¨: {avgQ?formatNumber(avgCost/avgQ):0}ì›</div>
                        </div>

                        <div className="bg-white dark:bg-slate-800 p-5 rounded-xl shadow border dark:border-slate-700 font-bold">
                            <h3 className="mb-4 text-amber-600 font-black"><i className="fa-solid fa-sack-dollar mr-2"></i>ë°°ë‹¹ê¸ˆ ê³„ì‚°</h3>
                            <div className="space-y-2">
                                <div><label className="text-[10px] text-slate-500 block">ìˆ˜ëŸ‰</label><input type="text" className="sim-input text-right" value={divInputs.shares} onChange={e=>handleCommaChange(e, v=>setDivInputs({...divInputs, shares:v}))} /></div>
                                <div><label className="text-[10px] text-slate-500 block">ë°°ë‹¹ê¸ˆ</label><input type="text" className="sim-input text-right" value={divInputs.perShare} onChange={e=>handleCommaChange(e, v=>setDivInputs({...divInputs, perShare:v}))} /></div>
                                <div className="p-3 bg-amber-50 dark:bg-amber-900/20 rounded text-right text-amber-600 mt-2 num-font font-black">ì‹¤ìˆ˜ë ¹(15.4%): {formatNumber(parseFormattedNumber(divInputs.shares)*parseFormattedNumber(divInputs.perShare)*0.846)}ì›</div>
                            </div>
                        </div>
                    </div>
                );
            };

            const renderSimulation = () => (
                <div className="space-y-6 animate-fade-in pb-10 font-bold">
                    <div className="flex justify-between items-end border-b pb-2 dark:border-slate-700">
                        <h2 className="text-2xl font-black">ë…¸í›„ ìê¸ˆ ìš´ìš© ì‹œë®¬ë ˆì´ì…˜</h2>
                        <span className="text-[10px] text-slate-400">ìë™ ì‹¤í–‰ ë° ë ˆì´ì•„ì›ƒ ë°€ë¦¼ ë°©ì§€ ì ìš©</span>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div className="bg-white dark:bg-slate-800 p-5 rounded-xl border-2 border-indigo-100 dark:border-indigo-900/50 space-y-4">
                            <h3 className="text-indigo-600 text-sm border-b pb-1 font-black">1. ì—°ë ¹ ë° ê¸°ì´ˆ ìë³¸ (ì–µ)</h3>
                            <div className="grid grid-cols-2 gap-2">
                                <div className="flex flex-col"><label className="text-[10px] text-slate-500 mb-0.5">ë³¸ì¸ í˜„ì¬ ë‚˜ì´</label><input type="number" className="sim-input" value={simInputs.currentAge} onChange={e=>setSimInputs({...simInputs, currentAge:parseInt(e.target.value)})}/></div>
                                <div className="flex flex-col"><label className="text-[10px] text-slate-500 mb-0.5">ë°°ìš°ì í˜„ì¬ ë‚˜ì´</label><input type="number" className="sim-input" value={simInputs.spouseCurrentAge} onChange={e=>setSimInputs({...simInputs, spouseCurrentAge:parseInt(e.target.value)})}/></div>
                                <div className="flex flex-col"><label className="text-[10px] text-indigo-500 mb-0.5">ì‹œì‘ ë‚˜ì´(ë¶„ì„)</label><input type="number" className="sim-input border-indigo-300" value={simInputs.simulationStartAge} onChange={e=>setSimInputs({...simInputs, simulationStartAge:parseInt(e.target.value)})}/></div>
                                <div className="flex flex-col"><label className="text-[10px] text-red-500 mb-0.5">ê³ ë¹„ìš© ì‹œì‘ë‚˜ì´</label><input type="number" className="sim-input border-red-200" value={simInputs.highCostStartAge} onChange={e=>setSimInputs({...simInputs, highCostStartAge:parseInt(e.target.value)})}/></div>
                            </div>
                            <div className="grid grid-cols-2 gap-x-2 gap-y-3 pt-2 border-t dark:border-slate-700">
                                <div className="flex flex-col"><label className="text-[10px] text-blue-500 font-bold block">ë³¸ì¸ ì¼ë°˜</label><input type="number" step="0.1" className="sim-input" value={simInputs.capUserNonISA} onChange={e=>setSimInputs({...simInputs, capUserNonISA:parseFloat(e.target.value)})}/></div>
                                <div className="flex flex-col"><label className="text-[10px] text-blue-500 font-bold block">ë°°ìš°ì ì¼ë°˜</label><input type="number" step="0.1" className="sim-input" value={simInputs.capSpouseNonISA} onChange={e=>setSimInputs({...simInputs, capSpouseNonISA:parseFloat(e.target.value)})}/></div>
                                <div className="flex flex-col"><label className="text-[10px] text-emerald-500 font-bold block">ë³¸ì¸ ISA</label><input type="number" step="0.1" className="sim-input" value={simInputs.capUserISA} onChange={e=>setSimInputs({...simInputs, capUserISA:parseFloat(e.target.value)})}/></div>
                                <div className="flex flex-col"><label className="text-[10px] text-emerald-500 font-bold block">ë°°ìš°ì ISA</label><input type="number" step="0.1" className="sim-input" value={simInputs.capSpouseISA} onChange={e=>setSimInputs({...simInputs, capSpouseISA:parseFloat(e.target.value)})}/></div>
                            </div>
                        </div>
                        <div className="bg-white dark:bg-slate-800 p-5 rounded-xl border-2 border-green-100 dark:border-green-900/50 space-y-4">
                            <h3 className="text-green-600 text-sm border-b pb-1 font-black">2. ìˆ˜ìµë¥  ë° ì„¸ìœ¨ (%)</h3>
                            <div className="grid grid-cols-2 gap-2">
                                <div className="flex flex-col"><label className="text-[10px] mb-0.5">ìˆ˜ì… ë¬¼ê°€ìƒìŠ¹</label><input type="number" step="0.1" className="sim-input" value={simInputs.inflationRate} onChange={e=>setSimInputs({...simInputs, inflationRate:parseFloat(e.target.value)})}/></div>
                                <div className="flex flex-col"><label className="text-[10px] text-red-500 mb-0.5">ì§€ì¶œ ë¬¼ê°€ìƒìŠ¹</label><input type="number" step="0.1" className="sim-input border-red-100" value={simInputs.livingCostInflationRate} onChange={e=>setSimInputs({...simInputs, livingCostInflationRate:parseFloat(e.target.value)})}/></div>
                                <div className="flex flex-col"><label className="text-[10px] mb-0.5">ì¼ë°˜ ìˆ˜ìµë¥ </label><input type="number" step="0.1" className="sim-input" value={simInputs.returnUserNonISA} onChange={e=>setSimInputs({...simInputs, returnUserNonISA:parseFloat(e.target.value), returnSpouseNonISA:parseFloat(e.target.value)})}/></div>
                                <div className="flex flex-col"><label className="text-[10px] mb-0.5">ISA ìˆ˜ìµë¥ </label><input type="number" step="0.1" className="sim-input" value={simInputs.returnUserISA} onChange={e=>setSimInputs({...simInputs, returnUserISA:parseFloat(e.target.value), returnSpouseISA:parseFloat(e.target.value)})}/></div>
                            </div>
                            <div className="p-3 bg-red-50 dark:bg-red-900/20 rounded-lg"><label className="text-[10px] text-red-600 font-black block">ëˆ„ì§„ì†Œë“ì„¸ìœ¨ (%)</label><div className="grid grid-cols-3 gap-1"><input type="number" step="0.1" className="sim-input text-center" value={simInputs.taxRate1} onChange={e=>setSimInputs({...simInputs, taxRate1:parseFloat(e.target.value)})}/><input type="number" step="0.1" className="sim-input text-center" value={simInputs.taxRate2} onChange={e=>setSimInputs({...simInputs, taxRate2:parseFloat(e.target.value)})}/><input type="number" step="0.1" className="sim-input text-center" value={simInputs.taxRate3} onChange={e=>setSimInputs({...simInputs, taxRate3:parseFloat(e.target.value)})}/></div></div>
                        </div>

                        <div className="bg-white dark:bg-slate-800 p-5 rounded-xl border-2 border-red-100 dark:border-red-900/50 space-y-4 font-bold flex flex-col min-h-[450px]">
                            <h3 className="text-red-600 text-sm border-b pb-1 font-black"><i className="fa-solid fa-won-sign mr-1"></i> ìˆ˜ì… ë° ì§€ì¶œ (ì›)</h3>
                            <div className="flex flex-col space-y-1">
                                <label className="text-[11px] text-slate-500 font-bold">ì›” ëª©í‘œ ìƒí™œë¹„</label>
                                <input type="text" className="sim-input text-right text-red-600 font-black text-base" value={simInputs.monthlyLiving} onChange={e=>handleCommaChange(e, v=>setSimInputs({...simInputs, monthlyLiving:v}))}/>
                            </div>
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 pt-3 border-t dark:border-slate-700 flex-1 overflow-visible">
                                <div className="flex flex-col space-y-0.5">
                                    <label className="text-[10px] text-slate-500 leading-tight">ë³¸ì¸ ì—°ê¸ˆ(ì›”)</label>
                                    <input type="text" className="sim-input text-right text-xs" value={simInputs.pensionSelf} onChange={e=>handleCommaChange(e, v=>setSimInputs({...simInputs, pensionSelf:v}))}/>
                                    <label className="text-[9px] text-indigo-500 font-bold">ìˆ˜ë ¹ ê°œì‹œ ë‚˜ì´</label>
                                    <input type="number" className="sim-input text-center text-xs" value={simInputs.retirementAge} onChange={e=>setSimInputs({...simInputs, retirementAge:parseInt(e.target.value)})}/>
                                </div>
                                <div className="flex flex-col space-y-0.5">
                                    <label className="text-[10px] text-slate-500 leading-tight">ë°°ìš°ì ì—°ê¸ˆ(ì›”)</label>
                                    <input type="text" className="sim-input text-right text-xs" value={simInputs.pensionSpouse} onChange={e=>handleCommaChange(e, v=>setSimInputs({...simInputs, pensionSpouse:v}))}/>
                                    <label className="text-[9px] text-indigo-500 font-bold">ìˆ˜ë ¹ ê°œì‹œ ë‚˜ì´</label>
                                    <input type="number" className="sim-input text-center text-xs" value={simInputs.spouseRetirementAge} onChange={e=>setSimInputs({...simInputs, spouseRetirementAge:parseInt(e.target.value)})}/>
                                </div>
                                <div className="flex flex-col space-y-0.5">
                                    <label className="text-[10px] text-slate-500 leading-tight">ì—°ê°„ ì„ëŒ€ ìˆ˜ìµ</label>
                                    <input type="text" className="sim-input text-right text-xs" value={simInputs.rentalIncome} onChange={e=>handleCommaChange(e, v=>setSimInputs({...simInputs, rentalIncome:v}))}/>
                                </div>
                                <div className="flex flex-col space-y-0.5">
                                    <label className="text-[10px] text-slate-500 leading-tight">ì—°ê°„ ê³µëª¨ì£¼/ê¸°íƒ€</label>
                                    <input type="text" className="sim-input text-right text-xs" value={simInputs.ipoProfit} onChange={e=>handleCommaChange(e, v=>setSimInputs({...simInputs, ipoProfit:v}))}/>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div className="bg-white dark:bg-slate-800 p-4 rounded-xl shadow border border-blue-100 font-black"><p className="text-[10px] text-slate-500">ì‹œì‘ ì´ ìì‚°</p><p className="text-lg text-blue-600 num-font break-all">{formatNumber(simResult.summary?.initial * ONE_HUNDRED_MILLION)}ì›</p></div>
                        <div className="bg-white dark:bg-slate-800 p-4 rounded-xl shadow border border-green-100 font-black"><p className="text-[10px] text-slate-500">95ì„¸ ì˜ˆì¸¡ ìì‚°</p><p className="text-lg text-green-600 num-font break-all">{formatNumber(simResult.summary?.final * ONE_HUNDRED_MILLION)}ì›</p></div>
                        <div className="bg-white dark:bg-slate-800 p-4 rounded-xl shadow border border-red-100 font-black"><p className="text-[10px] text-slate-500">ëˆ„ì  ë‚©ë¶€ ì„¸ê¸ˆ</p><p className="text-lg text-red-500 num-font break-all">{formatNumber(simResult.summary?.tax)}ì›</p></div>
                        <div className={`p-4 rounded-xl shadow border font-black flex flex-col justify-center ${simResult.summary?.depletion ? 'bg-red-50 border-red-200 text-red-700' : 'bg-green-50 border-green-300 text-green-700'}`}><p className="text-[10px] opacity-70">ì‹œë®¬ ê²°ê³¼</p><p className="text-sm">{simResult.summary?.depletion ? `${simResult.summary.depletion}ì„¸ ìì‚° ê³ ê°ˆ` : "ì•ˆì •ì  ìœ ì§€"}</p></div>
                    </div>

                    <div className="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-xl border dark:border-slate-700">
                        <h3 className="text-xl font-black text-indigo-500 border-b pb-2 mb-4">ìì‚° ë³€í™” ìƒì„¸ ì¶”ì´</h3>
                        <SimulationChart history={simResult.history} />
                    </div>

                    <div className="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-xl overflow-x-auto border dark:border-slate-700">
                        <table className="w-full text-[11px] min-w-[850px]">
                            <thead className="bg-slate-50 dark:bg-slate-900 sticky top-0 font-black"><tr className="text-slate-500 border-b font-black"><th className="p-3 text-center">ë‚˜ì´</th><th className="p-3 text-indigo-600 text-right">ì´ìì‚°(ì–µ)</th><th className="p-3 text-right">ë³¸ì¸ì¼ë°˜</th><th className="p-3 text-right">ë°°ìš°ìì¼ë°˜</th><th className="p-3 text-emerald-500 text-right">ë³¸ì¸ISA</th><th className="p-3 text-emerald-500 text-right">ë°°ìš°ìISA</th><th className="p-3 text-red-500 text-right">ì—°ì„¸ê¸ˆ</th><th className="p-3 text-right">ì—°ì§€ì¶œ</th></tr></thead>
                            <tbody className="divide-y dark:divide-slate-700">
                                {simResult.history.map((h, i) => (
                                    <tr key={i} className="hover:bg-slate-50 dark:hover:bg-slate-900 transition num-font"><td className="p-2 text-center">{h.age}ì„¸</td><td className="p-2 text-indigo-600 text-right font-black">{h.total.toFixed(2)}</td><td className="p-2 text-right opacity-60">{(h.un || 0).toFixed(2)}</td><td className="p-2 text-right opacity-60">{(h.sn || 0).toFixed(2)}</td><td className="p-2 text-emerald-500 text-right">{(h.ui || 0).toFixed(2)}</td><td className="p-2 text-emerald-500 text-right">{(h.si || 0).toFixed(2)}</td><td className="p-2 text-red-400 text-right">{formatNumber(h.tax/10000)}ë§Œ</td><td className="p-2 text-right">{formatNumber(h.living/10000)}ë§Œ</td></tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );

            const renderTax = () => {
                const finTotal = finList.reduce((a, c) => a + c.amount, 0);
                const otherTotal = otherList.reduce((a, c) => a + (c.rev - c.exp), 0);
                const limit = TAX_THRESHOLD;
                let step1 = Math.min(finTotal, limit) * 0.154;
                let step2 = finTotal > limit ? calculateProgressiveIncomeTax(otherTotal + (finTotal - limit), {rate1:simInputs.taxRate1, rate2:simInputs.taxRate2, rate3:simInputs.taxRate3}) : 0;

                return (
                    <div className="space-y-6 animate-fade-in pb-10 font-bold">
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6 text-center font-black">
                            <div className="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow border dark:border-slate-700">
                                <p className="text-xs text-slate-500">ì—°ê°„ ê¸ˆìœµì†Œë“</p>
                                <h3 className="text-2xl mt-2">{formatNumber(finTotal)}ì›</h3>
                                <span className={`inline-block mt-3 px-3 py-1 text-[10px] rounded-full ${finTotal > limit ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600'}`}>{finTotal > limit ? 'ì¢…í•©ê³¼ì„¸ ëŒ€ìƒ' : 'ë¶„ë¦¬ê³¼ì„¸ ì¢…ê²°'}</span>
                            </div>
                            <div className="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow border dark:border-slate-700"><p className="text-xs text-slate-500">ê¸°íƒ€ì†Œë“ í•©ê³„</p><h3 className="text-2xl mt-2">{formatNumber(otherTotal)}ì›</h3></div>
                            <div className="bg-blue-600 text-white p-6 rounded-2xl shadow flex flex-col justify-center font-black"><p className="text-xs text-blue-100">ì˜ˆìƒ ì„¸ê¸ˆ í•©ê³„</p><h3 className="text-2xl mt-1">{formatNumber(step1 + step2)}ì›</h3></div>
                        </div>

                        <div className="bg-white dark:bg-slate-800 p-6 rounded-xl border dark:border-slate-700 font-bold">
                            <h3 className="text-lg mb-4 text-blue-600 font-black"><i className="fa-solid fa-receipt mr-2"></i>ì„¸ê¸ˆ ê³„ì‚° ìƒì„¸ (ê²°ê³¼ ë„ì¶œ ê³¼ì •)</h3>
                            <div className="space-y-4 text-sm font-bold">
                                <div className="p-4 bg-slate-50 dark:bg-slate-900 rounded-lg border-l-4 border-blue-500">
                                    <p className="text-blue-700 font-black">[Step 1] ê¸°ë³¸ ê¸ˆìœµì†Œë“ ê³¼ì„¸ (2,000ë§Œì› ì´í•˜)</p>
                                    <p className="mt-2 text-xs font-medium italic opacity-70">ì´ì ë° ë°°ë‹¹ ìˆ˜ìµì˜ 2,000ë§Œì›ê¹Œì§€ëŠ” ì›ì²œì§•ìˆ˜ì„¸ìœ¨(15.4%)ì´ ì ìš©ë©ë‹ˆë‹¤.</p>
                                    <p className="mt-2 p-2 bg-white dark:bg-slate-800 rounded shadow-sm text-xs num-font">ê³„ì‚°: {formatNumber(Math.min(finTotal, limit))} Ã— 15.4% = {formatNumber(step1)}ì›</p>
                                </div>
                                <div className="p-4 bg-slate-50 dark:bg-slate-900 rounded-lg border-l-4 border-red-500">
                                    <p className="text-red-700 font-black">[Step 2] ëˆ„ì§„ ì¢…í•©ì†Œë“ ê³¼ì„¸ (2,000ë§Œì› ì´ˆê³¼ë¶„)</p>
                                    {finTotal > limit ? <p className="mt-2 p-2 bg-white dark:bg-slate-800 rounded shadow-sm text-xs num-font">ì´ˆê³¼ë¶„ ì„¸ì•¡: {formatNumber(step2)}ì› (ë‹¤ë¥¸ ì†Œë“ê³¼ í•©ì‚°ë˜ì–´ ëˆ„ì§„ ì ìš©)</p> : <p className="mt-2 text-slate-400 italic text-xs">2,000ë§Œì› ì´í•˜ë¡œ ì¶”ê°€ ì¢…í•©ê³¼ì„¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>}
                                </div>
                            </div>
                        </div>

                        <div className="bg-indigo-50 dark:bg-slate-800 p-6 rounded-2xl border-2 border-indigo-100 dark:border-indigo-900 shadow-sm font-bold">
                            <h3 className="text-lg font-black text-indigo-700 dark:text-indigo-400 mb-6 flex items-center gap-2"><i className="fa-solid fa-graduation-cap"></i> ì´ˆë³´ íˆ¬ìê°€ ì„¸ê¸ˆ ê°€ì´ë“œ</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div className="guide-card"><h4 className="font-bold text-indigo-600 mb-2">1. ì¢…í•©ê³¼ì„¸ë€?</h4><p className="text-xs text-slate-600 dark:text-slate-400 leading-relaxed font-medium">ì—°ê°„ ì´ì/ë°°ë‹¹ í•©ê³„ê°€ <strong>2,000ë§Œì›</strong>ì„ ë„˜ìœ¼ë©´ ì´ˆê³¼ë¶„ì€ ëˆ„ì§„ì„¸ìœ¨(6~45%)ì´ ì ìš©ë©ë‹ˆë‹¤.</p></div>
                                <div className="guide-card"><h4 className="font-bold text-indigo-600 mb-2">2. ì ˆì„¸ ê³„ì¢Œ(ISA) í™œìš©</h4><p className="text-xs text-slate-600 dark:text-slate-400 leading-relaxed font-medium">ISA ê³„ì¢Œ ë‚´ ìˆ˜ìµì€ í•œë„ ë‚´ <strong>ë¹„ê³¼ì„¸</strong>, ì´ˆê³¼ë¶„ì€ 9.9% ì €ìœ¨ ë¶„ë¦¬ê³¼ì„¸ë˜ì–´ ì ˆì„¸ì— ìœ ë¦¬í•©ë‹ˆë‹¤.</p></div>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div className="bg-white dark:bg-slate-800 p-5 rounded-xl border shadow font-bold">
                                <h4 className="font-black mb-4">ê¸ˆìœµì†Œë“ (ì´ì/ë°°ë‹¹)</h4>
                                <div className="flex gap-2 mb-4">
                                    <input id="fD" type="text" placeholder="í•­ëª©" className="flex-1 sim-input" />
                                    <input id="fA" type="number" placeholder="ê¸ˆì•¡" className="w-24 sim-input" />
                                    <button onClick={()=>{const d=document.getElementById('fD').value, a=parseInt(document.getElementById('fA').value); if(d&&a){setFinList([...finList,{id:Date.now(),desc:d,amount:a}]); document.getElementById('fD').value=''; document.getElementById('fA').value='';}}} className="bg-blue-600 text-white px-3 rounded font-black text-xs font-black">ì¶”ê°€</button>
                                </div>
                                <div className="max-h-40 overflow-y-auto space-y-1">{finList.map(f => <div key={f.id} className="flex justify-between text-xs border-b py-1 font-bold"><span>{f.desc}</span><span>{formatNumber(f.amount)}ì›</span></div>)}</div>
                            </div>
                            <div className="bg-white dark:bg-slate-800 p-5 rounded-xl border shadow font-bold">
                                <h4 className="font-black mb-4">ê¸°íƒ€ì†Œë“ (ì„ëŒ€/ê°•ì—°)</h4>
                                <div className="flex gap-2 mb-4">
                                    <input id="oR" type="number" placeholder="ìˆ˜ì…" className="flex-1 sim-input" />
                                    <input id="oE" type="number" placeholder="ê²½ë¹„" className="flex-1 sim-input" />
                                    <button onClick={()=>{const r=parseInt(document.getElementById('oR').value), e=parseInt(document.getElementById('oE').value)||0; if(r){setOtherList([...otherList,{id:Date.now(),rev:r,exp:e}]); document.getElementById('oR').value=''; document.getElementById('oE').value='';}}} className="bg-emerald-600 text-white px-3 rounded font-black text-xs font-black">ì¶”ê°€</button>
                                </div>
                                <div className="max-h-40 overflow-y-auto space-y-1">{otherList.map(o => <div key={o.id} className="flex justify-between text-xs border-b py-1 font-bold"><span>ê¸°íƒ€ìˆ˜ìµ</span><span>{formatNumber(o.rev-o.exp)}ì›</span></div>)}</div>
                            </div>
                        </div>
                    </div>
                );
            };

            return (
                <div className={`min-h-screen flex flex-col transition-colors duration-200 ${isDark ? 'dark bg-slate-900 text-slate-100' : 'bg-slate-50 text-slate-800'}`}>
                    <header className="sticky top-0 z-50 bg-white dark:bg-slate-800 border-b dark:border-slate-700 shadow h-16">
                        <div className="max-w-7xl mx-auto px-4 h-full flex items-center justify-between">
                            <div className="flex items-center gap-2 font-black text-lg"><i className="fa-solid fa-compass text-blue-600"></i> Navigator</div>
                            <nav className="flex bg-slate-100 dark:bg-slate-700 p-1 rounded-xl gap-1">
                                {[{id:'dashboard',l:'ëŒ€ì‹œë³´ë“œ'},{id:'routine',l:'ë£¨í‹´'},{id:'tools',l:'ë„êµ¬'},{id:'simulation',l:'ë…¸í›„ìê¸ˆ'},{id:'tax',l:'ê¸ˆìœµê³¼ì„¸'}].map(t => (
                                    <button key={t.id} onClick={()=>setActiveTab(t.id)} className={`nav-tab px-3 md:px-5 py-1.5 text-xs rounded-lg transition-all ${activeTab === t.id ? 'active' : 'text-slate-500 font-bold'}`}>{t.l}</button>
                                ))}
                            </nav>
                            <button onClick={()=>setIsDark(!isDark)} className="p-2 rounded-full hover:bg-slate-200 transition"><i className={`fa-solid ${isDark?'fa-sun text-amber-400':'fa-moon'}`}></i></button>
                        </div>
                    </header>
                    <main className="max-w-7xl w-full mx-auto px-4 py-6 flex-1">
                        {activeTab === 'dashboard' && renderDashboard()}
                        {activeTab === 'routine' && renderRoutine()}
                        {activeTab === 'tools' && renderTools()}
                        {activeTab === 'simulation' && renderSimulation()}
                        {activeTab === 'tax' && renderTax()}
                    </main>
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>