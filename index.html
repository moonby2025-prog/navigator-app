<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investment Navigator (íˆ¬ì ë¹„ì„œ)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome (Icons) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <!-- React, ReactDOM, Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; letter-spacing: -0.02em; overflow-x: hidden; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        .nav-tab.active { background-color: #eff6ff; color: #2563eb; font-weight: 700; box-shadow: 0 1px 2px rgba(37,99,235,0.2); }
        .dark .nav-tab.active { background-color: #1e293b; color: #60a5fa; }
        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .sim-input { @apply mt-1 block w-full rounded-md border-gray-300 dark:border-slate-600 shadow-sm p-2 border dark:bg-slate-700 focus:ring-indigo-500 focus:border-indigo-500 text-sm font-bold; }
        .num-font { font-variant-numeric: tabular-nums; }
        .guide-card { @apply p-4 rounded-xl border border-slate-100 dark:border-slate-700 bg-white dark:bg-slate-800 shadow-sm; }
        
        /* ë„¤ë¹„ê²Œì´ì…˜ ëª¨ë°”ì¼ ìŠ¤í¬ë¡¤ */
        .nav-container { overflow-x: auto; white-space: nowrap; -webkit-overflow-scrolling: touch; }
        .nav-container::-webkit-scrollbar { display: none; }

        /* í‹°ì»¤ ì• ë‹ˆë©”ì´ì…˜ í´ë°± */
        .ticker-fallback {
            display: flex;
            white-space: nowrap;
            overflow: hidden;
            align-items: center;
            height: 100%;
        }
        .ticker-scroll {
            display: inline-block;
            animation: tickerScroll 30s linear infinite;
            padding-left: 100%;
        }
        @keyframes tickerScroll {
            0% { transform: translateX(0); }
            100% { transform: translateX(-100%); }
        }

        /* [ë„êµ¬ ë° ê³¼ì„¸ íƒ­ ì „ìš©] ì‹œê°ì  ê°€ë…ì„± ê·¹ëŒ€í™” ìŠ¤íƒ€ì¼ ìˆ˜ì • */
        .tool-input { 
            @apply !bg-slate-100 dark:!bg-slate-800/80 border border-slate-300 dark:border-slate-600 shadow-sm focus:!bg-white dark:focus:!bg-slate-700 focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/10 transition-all text-slate-900 dark:text-slate-100 placeholder-slate-400 font-bold; 
        }
        
        .tool-result-container {
            @apply mt-4 p-4 rounded-xl border-2 transition-all text-right shadow-sm;
        }

        /* ë§ˆìš°ìŠ¤ í˜¸ë²„ ì‹œ ì¡°ê¸ˆ ë” ì–´ë‘ì›Œì§€ê²Œ í•˜ì—¬ ì…ë ¥ ì˜ì—­ì„ì„ ê°•ì¡° */
        .tool-input:hover { @apply border-slate-400 dark:border-slate-500 bg-slate-200 dark:bg-slate-800; }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-900 transition-colors duration-200">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, memo, useCallback, useMemo } = React;

        // --- Global Constants ---
        const ONE_HUNDRED_MILLION = 100000000;
        const TAX_THRESHOLD = 20000000;
        
        const DEFAULT_EXCHANGE_RATES = { 
            'KRW': { krw: 1 }, 
            'USD': { krw: 1380 }, 
            'JPY': { krw: 8.90 }, 
            'EUR': { krw: 1480 }, 
            'CNY': { krw: 190 }, 
            'ARS': { krw: 1.35 }, 
            'INR': { krw: 16.5 }
        };

        // --- Helpers ---
        const formatNumber = (num) => {
            if (num === null || num === undefined || isNaN(num)) return '0';
            return Math.round(num).toLocaleString('ko-KR');
        };
        const parseFormattedNumber = (value) => {
            if (typeof value !== 'string') return value || 0;
            return parseInt(value.replace(/[^0-9]/g, '')) || 0;
        };

        const calculateProgressiveIncomeTax = (income, rates) => {
            if (income <= 0) return 0;
            const threshold1 = 40000000;
            const threshold2 = 80000000;
            let tax = 0;
            const income1 = Math.min(income, threshold1);
            tax += income1 * (rates.rate1 / 100);
            if (income > threshold1) {
                const income2 = Math.min(income, threshold2) - threshold1;
                tax += income2 * (rates.rate2 / 100);
            }
            if (income > threshold2) {
                const income3 = income - threshold2;
                tax += income3 * (rates.rate3 / 100);
            }
            return Math.max(0, tax);
        };

        // --- Widgets ---
        const TradingViewTicker = memo(({ theme }) => {
            const containerRef = useRef(null);
            const [isLoaded, setIsLoaded] = useState(false);

            useEffect(() => {
                const container = containerRef.current;
                if (!container) return;
                
                container.innerHTML = '';
                const widgetDiv = document.createElement('div');
                widgetDiv.className = 'tradingview-widget-container__widget';
                container.appendChild(widgetDiv);

                const script = document.createElement('script');
                script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-ticker-tape.js';
                script.async = true;
                script.innerHTML = JSON.stringify({
                    "symbols": [
                        { "proName": "FOREXCOM:SPXUSD", "title": "S&P 500" },
                        { "proName": "NASDAQ:QQQ", "title": "ë‚˜ìŠ¤ë‹¥ QQQ" },
                        { "proName": "FX_IDC:USDKRW", "title": "ì›ë‹¬ëŸ¬ í™˜ìœ¨" },
                        { "proName": "FX_IDC:XAGUSD", "title": "ì€ í˜„ë¬¼ (XAG/USD)" },
                        { "proName": "BINANCE:BTCUSDT", "title": "ë¹„íŠ¸ì½”ì¸" },
                        { "proName": "TVC:GOLD", "title": "ê¸ˆ í˜„ë¬¼ (XAU/USD)" },
                        { "proName": "FX_IDC:JPYKRW", "title": "ì—”í™” í™˜ìœ¨" }
                    ],
                    "showSymbolLogo": true,
                    "colorTheme": theme,
                    "isTransparent": true,
                    "displayMode": "adaptive",
                    "locale": "kr"
                });

                script.onload = () => setIsLoaded(true);
                container.appendChild(script);

                const checkTimer = setTimeout(() => {
                    if (container.querySelector('iframe')) setIsLoaded(true);
                }, 2000);

                return () => clearTimeout(checkTimer);
            }, [theme]);

            return (
                <div className="relative w-full h-full overflow-hidden">
                    <div className={`tradingview-widget-container ${isLoaded ? 'opacity-100' : 'opacity-0'} transition-opacity duration-500`} ref={containerRef}></div>
                    {!isLoaded && (
                        <div className="absolute inset-0 ticker-fallback text-xs font-bold text-slate-400 dark:text-slate-500">
                            <div className="ticker-scroll flex gap-8">
                                <span><i className="fa-solid fa-chart-line mr-1"></i> S&P 500: ë°ì´í„° ì—°ê²° ì¤‘...</span>
                                <span><i className="fa-solid fa-money-bill-1-wave mr-1"></i> USD/KRW: 1,380.00</span>
                                <span><i className="fa-brands fa-bitcoin mr-1"></i> BTC/USDT: ì‹¤ì‹œê°„ ì—°ê²° ì¤‘</span>
                                <span><i className="fa-solid fa-coins mr-1"></i> GOLD: ì‹œì„¸ ë¡œë”© ì¤‘...</span>
                                <span><i className="fa-solid fa-chart-line mr-1"></i> KOSPI: ì •ë³´ ìˆ˜ì‹  ì¤‘</span>
                            </div>
                        </div>
                    )}
                </div>
            );
        });

        const TradingViewHeatmap = memo(({ theme }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (!ref.current) return;
                ref.current.innerHTML = '';
                const script = document.createElement('script');
                script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-stock-heatmap.js';
                script.async = true;
                script.innerHTML = JSON.stringify({
                    "dataSource": "SPX500", "grouping": "sector", "blockSize": "market_cap_basic", "blockColor": "change", "locale": "kr", "colorTheme": theme, "hasTopBar": false, "isTransparent": true, "width": "100%", "height": "100%"
                });
                ref.current.appendChild(script);
            }, [theme]);
            return <div ref={ref} className="h-full"></div>;
        });

        // --- Main Component ---
        function App() {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [isDark, setIsDark] = useState(false);
            const [linkMode, setLinkMode] = useState('investment');
            const [marketStatus, setMarketStatus] = useState({ text: 'ì¥ ë§ˆê°', color: 'bg-red-600' });
            
            const [exchangeRates, setExchangeRates] = useState(DEFAULT_EXCHANGE_RATES);
            const [lastUpdated, setLastUpdated] = useState('ì—°ê²° ì¤‘...');
            const [isFetching, setIsFetching] = useState(false);

            const [isRoutineEditMode, setIsRoutineEditMode] = useState(false);
            const [newFav, setNewFav] = useState({ name: '', code: '' });
            const [newRoutine, setNewRoutine] = useState({ category: '', name: '', url: '' });

            const [favorites, setFavorites] = useState([
                { code: "005930", name: "ì‚¼ì„±ì „ì" }, { code: "005380", name: "í˜„ëŒ€ì°¨" }, 
                { code: "237690", name: "ì—ìŠ¤í‹°íŒœ" }, { code: "445680", name: "íë¦¬ì˜¥ìŠ¤" }
            ]);

            const [routineLinks, setRoutineLinks] = useState({
                "ğŸŒ… ì•„ì¹¨ í•„ìˆ˜ ì²´í¬ (Morning Routine)": [
                    { name: "ë¯¸êµ­ ì‹œì¥ ì ê²€", url: "https://kr.investing.com/portfolio/?portfolioID=OT4%2BZDRrZTFjM2thYTthYg%3D%3D", icon: "fa-list-check", color: "bg-blue-100 text-blue-700" },
                    { name: "Finviz (ë¯¸êµ­ ë§µ)", url: "https://finviz.com/map.ashx", icon: "fa-map", color: "bg-emerald-100 text-emerald-700" },
                    { name: "í•„ë¼ë¸í”¼ì•„ ë°˜ë„ì²´", url: "https://kr.investing.com/indices/phlx-semiconductor", icon: "fa-microchip", color: "bg-teal-100 text-teal-700" },
                    { name: "ê³µí¬ íƒìš• ì§€ìˆ˜ (CNN)", url: "https://edition.cnn.com/markets/fear-and-greed", icon: "fa-gauge-high", color: "bg-orange-100 text-orange-700" },
                    { name: "í¬ë¦½í†  ì§€í‘œ (MVRV)", url: "https://www.bitcoinmagazinepro.com/charts/mvrv-zscore/", icon: "fa-chart-area", color: "bg-amber-100 text-amber-700" },
                    { name: "SILVER (ì€ ì‹¤ì‹œê°„)", url: "https://kr.investing.com/currencies/xag-usd", icon: "fa-coins", color: "bg-slate-100 text-slate-700" },
                    { name: "ì€ì‹œì„¸(ìˆœìˆ˜í•œê¸ˆ)", url: "https://blog.naver.com/wolfkickbox", icon: "fa-blog", color: "bg-yellow-100 text-yellow-700" }
                ],
                "ğŸ’° ê³µëª¨ì£¼ & ì‹¤ì  (IPO & Earnings)": [
                    { name: "38 ì»¤ë®¤ë‹ˆì¼€ì´ì…˜", url: "http://www.38.co.kr/html/fund/index.htm?gjbcd=1460", icon: "fa-building", color: "bg-purple-100 text-purple-700" },
                    { name: "DART (ì „ìê³µì‹œ)", url: "https://dart.fss.or.kr/", icon: "fa-file-signature", color: "bg-yellow-100 text-yellow-700" },
                    { name: "KIND (ê¸°ì—…ê³µì‹œ)", url: "https://kind.krx.co.kr/", icon: "fa-file-invoice", color: "bg-blue-50 text-blue-600" },
                    { name: "KRX ì •ë³´ë°ì´í„°ì‹œìŠ¤í…œ", url: "http://data.krx.co.kr/", icon: "fa-database", color: "bg-indigo-100 text-indigo-700" },
                    { name: "Seibro (ì¦ê¶Œì •ë³´í¬í„¸)", url: "https://seibro.or.kr/", icon: "fa-server", color: "bg-indigo-50 text-indigo-600" },
                    { name: "ì¢…ëª©ë³„ ì™¸êµ­ì¸ êµ­ì ë¶„ë¥˜", url: "https://data.krx.co.kr/contents/MDC/HARD/hardController/MDCHARD053.cmd", icon: "fa-globe", color: "bg-blue-50 text-blue-700" }
                ],
                "ğŸ“ˆ êµ­ë‚´ ì‹œì¥ ì‹¬ì¸µ (Korea Market)": [
                    { name: "ë„¤ì´ë²„ ê¸ˆìœµ", url: "https://finance.naver.com/", icon: "fa-n", color: "bg-green-50 text-green-600" },
                    { name: "ë²„í‹€ëŸ¬ (Butler)", url: "https://www.butler.works/ko/home", icon: "fa-chart-line", color: "bg-purple-50 text-purple-600" },
                    { name: "í•œê²½ ì»¨ì„¼ì„œìŠ¤", url: "https://markets.hankyung.com/consensus", icon: "fa-book-open", color: "bg-red-50 text-red-600" },
                    { name: "SMIC (ì„œìš¸ëŒ€ ë¦¬ì„œì¹˜)", url: "http://snusmic.com/research/", icon: "fa-graduation-cap", color: "bg-slate-200 text-slate-800" },
                    { name: "FDA ìŠ¹ì¸ ì‹¤ì‹œê°„", url: "https://www.youtube.com/user/USFoodandDrugAdmin", icon: "fa-video", color: "bg-red-100 text-red-700" },
                    { name: "ì£¼ì‹/ë¶€ë™ì‚° ëª¨ì•„ë´", url: "http://moabbs.com/blogs/lists", icon: "fa-users", color: "bg-orange-100 text-orange-700" },
                    { name: "ì „ìì¡ì§€ (ëª¨ì•„ì§„)", url: "https://lib.ice.go.kr/elib/module/elib/moazine.do?menu_idx=37", icon: "fa-book-open", color: "bg-yellow-100 text-yellow-700" }
                ],
                "ğŸ¡ ì¼ìƒ & ë¶€ë™ì‚° (Daily Life)": [
                    { name: "í˜¸ê°±ë…¸ë…¸", url: "https://hogangnono.com/", icon: "fa-map-pin", color: "bg-red-50 text-red-600" },
                    { name: "ë„¤ì´ë²„ ë¶€ë™ì‚°", url: "https://land.naver.com/", icon: "fa-building", color: "bg-green-50 text-green-600" },
                    { name: "ë„¤ì´ë²„ ì§€ë„", url: "https://map.naver.com/", icon: "fa-location-dot", color: "bg-blue-50 text-blue-600" },
                    { name: "êµ¬ê¸€ ì§€ë„", url: "https://maps.google.com/", icon: "fa-location-dot", color: "bg-amber-50 text-amber-600" }
                ]
            });

            const [blogInsightLinks, setBlogInsightLinks] = useState({
                "ğŸ§¬ íë¦¬ì˜¥ìŠ¤ë°”ì´ì˜¤ì‹œìŠ¤í…œì¦ˆ": [
                    {name: "í•œê³„ë¥¼ ê¹¨ëŠ” ì‚¬ëŒ", url: "https://blog.naver.com/unlimitedi"},
                    {name: "ë‚˜ëŠ” ì „ì„¤ì´ë‹¤", url: "https://blog.naver.com/legendyu"},
                    {name: "ì´ê³µê³„", url: "https://blog.naver.com/shyny38"},
                    {name: "ê³µëŒ€ìƒ ì£¼ì ‘ë…¸íŠ¸", url: "https://blog.naver.com/b_g-duck"}
                ],
                "ğŸ’Š ì—ìŠ¤í‹°íŒœ": [
                    {name: "ì˜¤ì¬ë³µ", url: "https://blog.naver.com/hym090206"},
                    {name: "ì™ ì§€ìƒì¾Œí•œì‚¬ëŒ", url: "https://blog.naver.com/aphorism86"},
                    {name: "Chan", url: "https://blog.naver.com/chany2do"}
                ]
            });

            const [targetInputs, setTargetInputs] = useState({ mode: 'cap', price: '', shares: '', currentCap: '', targetCap: '', targetRate: '' });
            const [ipoCalcInputs, setIpoCalcInputs] = useState({ price: '', qty: '', fee: '', rate: 50 });
            const [avgRows, setAvgRows] = useState([{ id: 1, q: '', p: '' }]);
            const [exchInputs, setExchInputs] = useState({ base: 'USD', target: 'KRW', amount: '' });
            const [divInputs, setDivInputs] = useState({ shares: '', perShare: '', tax: '15.4' });
            const [toolTaxInputs, setToolTaxInputs] = useState({ profit: '', type: 'dividend' });

            const [simInputs, setSimInputs] = useState({
                currentAge: 51, spouseCurrentAge: 47, simulationStartAge: 53, 
                pensionStartAgeUser: 65, pensionStartAgeSpouse: 65,
                highCostStartAge: 80,
                capUserNonISA: 3.0, capSpouseNonISA: 2.0, capUserISA: 3.0, capSpouseISA: 2.0, 
                returnUserNonISA: 3.0, returnSpouseNonISA: 3.0, 
                returnUserISA: 3.0, returnSpouseISA: 3.0, 
                inflationRate: 2.0, livingCostInflationRate: 1.5, taxRate1: 6.6, taxRate2: 16.5, taxRate3: 27.5,
                monthlyLiving: "5,000,000", pensionSelf: "1,000,000", pensionSpouse: "600,000", ipoProfit: "5,000,000", otherIncome: "4,500,000", stockLending: "0", rentalIncome: "850,000",
                targetLegacy: "200,000,000", extraReserve: "5,000,000",
                monthlyMedical: ""
            });
            const [simResult, setSimResult] = useState({ history: [], summary: null });
            
            // --- Financial Tax States ---
            const [earnedIncome, setEarnedIncome] = useState("0");
            const [finList, setFinList] = useState([]);
            const [otherIncomeList, setOtherIncomeList] = useState([]);

            const handleCommaChange = (e, callback) => {
                const val = e.target.value.replace(/[^0-9]/g, '');
                callback(val ? parseInt(val).toLocaleString('ko-KR') : '');
            };

            const fetchRealTimeRates = useCallback(async () => {
                setIsFetching(true);
                try {
                    const response = await fetch('https://open.er-api.com/v6/latest/KRW');
                    const data = await response.json();
                    if (data.result === 'success') {
                        const rates = data.rates;
                        const newRates = {
                            'KRW': { krw: 1 }, 
                            'USD': { krw: 1 / (rates.USD || 0.00072) }, 
                            'JPY': { krw: 1 / (rates.JPY || 0.11) },
                            'EUR': { krw: 1 / (rates.EUR || 0.00067) }, 
                            'CNY': { krw: 1 / (rates.CNY || 0.0052) },
                            'ARS': { krw: 1 / (rates.ARS || 0.65) }, 
                            'INR': { krw: 1 / (rates.INR || 0.06) }
                        };
                        setExchangeRates(newRates);
                        setLastUpdated(new Date().toLocaleString());
                    }
                } catch (error) {
                    console.error("í™˜ìœ¨ ë¡œë“œ ì‹¤íŒ¨:", error);
                    setLastUpdated("ì‹¤íŒ¨ (ê¸°ë³¸ê°’ ì‚¬ìš©)");
                } finally { setIsFetching(false); }
            }, []);

            useEffect(() => {
                fetchRealTimeRates();
                const timer = setInterval(() => {
                    const now = new Date();
                    const hours = now.getHours();
                    const day = now.getDay();
                    let status = { text: "ì¥ ë§ˆê°", color: "bg-red-600" };
                    if (hours >= 9 && hours < 16 && day !== 0 && day !== 6) status = { text: "êµ­ë‚´ ì¥ ìš´ì˜", color: "bg-green-600" };
                    else if (hours >= 22 || hours < 6) status = { text: "ë¯¸êµ­ ì¥ ìš´ì˜", color: "bg-blue-600" };
                    setMarketStatus(status);
                }, 1000);
                return () => clearInterval(timer);
            }, [fetchRealTimeRates]);

            useEffect(() => {
                if (isDark) document.documentElement.classList.add('dark');
                else document.documentElement.classList.remove('dark');
            }, [isDark]);

            const searchSymbol = (query) => {
                if(!query) return;
                const url = /[a-zA-Z]/.test(query) ? `https://finance.naver.com/world/sise.naver?symbol=${query.trim().toUpperCase()}` : `https://finance.naver.com/item/main.naver?code=${query.trim()}`;
                window.open(url, '_blank');
            };

            const runSimulation = useCallback(() => {
                const s = simInputs;
                const ageDiff = s.currentAge - s.spouseCurrentAge;
                let cUserNon = s.capUserNonISA * ONE_HUNDRED_MILLION;
                let cSpouseNon = s.capSpouseNonISA * ONE_HUNDRED_MILLION;
                let cUserISA = s.capUserISA * ONE_HUNDRED_MILLION;
                let cSpouseISA = s.capSpouseISA * ONE_HUNDRED_MILLION;
                
                const targetLegacyValue = parseFormattedNumber(s.targetLegacy);
                const extraReserveValue = parseFormattedNumber(s.extraReserve);
                const medicalCostMonthly = parseFormattedNumber(s.monthlyMedical);
                
                const initLiving = parseFormattedNumber(s.monthlyLiving) * 12;
                const initPenSelf = parseFormattedNumber(s.pensionSelf) * 12;
                const initPenSpouse = parseFormattedNumber(s.pensionSpouse) * 12;
                const initOtherTotal = parseFormattedNumber(s.ipoProfit) + parseFormattedNumber(s.otherIncome) + parseFormattedNumber(s.stockLending) + parseFormattedNumber(s.rentalIncome);
                let history = []; let totalTax = 0; let depletionYear = null;
                const period = Math.max(1, 95 - s.simulationStartAge);
                
                for (let year = 1; year <= period; year++) {
                    const age = s.simulationStartAge + year - 1;
                    const spouseAge = age - ageDiff;
                    const pInf = Math.pow(1 + (s.inflationRate / 100), year - 1);
                    const lInf = Math.pow(1 + (s.livingCostInflationRate / 100), year - 1);
                    
                    let weight = 1.0;
                    let isHighCost = false;
                    let lateLifeMedicalAnnual = 0;

                    if (age >= Math.min(s.pensionStartAgeUser, s.pensionStartAgeSpouse)) {
                        if (age < s.highCostStartAge - 5) {
                            weight = 1.1; 
                        } else if (age < s.highCostStartAge) {
                            weight = 0.9; 
                        } else {
                            weight = 0.7; 
                            lateLifeMedicalAnnual = medicalCostMonthly * 12 * lInf; 
                            isHighCost = true;
                        }
                    }
                    
                    const livingCost = (initLiving * lInf * weight) + lateLifeMedicalAnnual + extraReserveValue;
                    
                    let pension = 0;
                    if (age >= s.pensionStartAgeUser) pension += initPenSelf; 
                    if (spouseAge >= s.pensionStartAgeSpouse) pension += initPenSpouse;
                    
                    const baseIncomeAtYear = (pension + initOtherTotal) * pInf;
                    
                    const profUserNon = cUserNon * (s.returnUserNonISA / 100) * 0.846;
                    const profSpouseNon = cSpouseNon * (s.returnUserNonISA / 100) * 0.846;
                    const profUserISA = cUserISA * (s.returnUserISA / 100) * 0.901;
                    const profSpouseISA = cSpouseISA * (s.returnSpouseISA / 100) * 0.901;
                    const profInvestmentTotal = profUserNon + profSpouseNon + profUserISA + profSpouseISA;
                    
                    const incTax = calculateProgressiveIncomeTax(baseIncomeAtYear, { rate1: s.taxRate1, rate2: s.taxRate2, rate3: s.taxRate3 });
                    totalTax += incTax;

                    const annualProfitTotal = profInvestmentTotal + baseIncomeAtYear;
                    const annualExpenseTotal = livingCost + incTax;
                    const netChange = annualProfitTotal - annualExpenseTotal;

                    let withdrawal = netChange < 0 ? Math.abs(netChange) : 0;
                    if (netChange >= 0) {
                        const tBefore = cUserNon + cSpouseNon + cUserISA + cSpouseISA;
                        if (tBefore > 0) {
                            const r1 = cUserNon / tBefore; const r2 = cSpouseNon / tBefore; const r3 = cUserISA / tBefore; const r4 = cSpouseISA / tBefore;
                            cUserNon += netChange * r1; cSpouseNon += netChange * r2; cUserISA += netChange * r3; cSpouseISA += netChange * r4;
                        } else {
                            cUserNon += netChange;
                        }
                    } else {
                        let rem = withdrawal;
                        let w1 = Math.min(rem, cUserNon); cUserNon -= w1; rem -= w1;
                        let w2 = Math.min(rem, cSpouseNon); cSpouseNon -= w2; rem -= w2;
                        let w3 = Math.min(rem, cSpouseISA); cSpouseISA -= w3; rem -= w3;
                        let w4 = Math.min(rem, cUserISA); cUserISA -= w4; rem -= w4;
                        if (rem > 0 && !depletionYear) depletionYear = age;
                    }

                    const currentTotal = cUserNon + cSpouseNon + cUserISA + cSpouseISA;

                    history.push({ 
                        age, 
                        total: currentTotal / ONE_HUNDRED_MILLION, 
                        tax: incTax, 
                        living: livingCost, 
                        profInvestment: profInvestmentTotal,
                        baseIncome: baseIncomeAtYear,
                        annualProfit: annualProfitTotal,
                        netChange: netChange,
                        un: cUserNon/ONE_HUNDRED_MILLION, 
                        sn: cSpouseNon/ONE_HUNDRED_MILLION, 
                        ui: cUserISA/ONE_HUNDRED_MILLION, 
                        si: cSpouseISA/ONE_HUNDRED_MILLION,
                        isHighCost,
                        medicalShare: (lateLifeMedicalAnnual / livingCost) * 100, 
                        isWarn: currentTotal < targetLegacyValue 
                    });
                    
                    if (currentTotal <= 0 && year > 1) break;
                }
                setSimResult({ history, summary: { initial: s.capUserNonISA + s.capSpouseNonISA + s.capUserISA + s.capSpouseISA, final: (history[history.length-1]?.total * ONE_HUNDRED_MILLION) || 0, tax: totalTax, depletion: depletionYear, isSuccess: (history[history.length-1]?.total * ONE_HUNDRED_MILLION) >= targetLegacyValue } });
            }, [simInputs]);

            useEffect(() => { runSimulation(); }, [runSimulation]);

            const SimulationChart = memo(({ history }) => {
                const canvasRef = useRef(null);
                const chartInstance = useRef(null);
                useEffect(() => {
                    if (!canvasRef.current || history.length === 0) return;
                    const ctx = canvasRef.current.getContext('2d');
                    if (chartInstance.current) chartInstance.current.destroy();
                    chartInstance.current = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: history.map(h => h.age + "ì„¸"),
                            datasets: [
                                { label: 'ì´ ìì‚°(ì–µ)', data: history.map(h => h.total), borderColor: '#4f46e5', fill: true, backgroundColor: 'rgba(79, 70, 229, 0.1)', tension: 0.3, pointRadius: 2 },
                                { label: 'ë³¸ì¸ ì¼ë°˜', data: history.map(h => h.un), borderColor: '#ef4444', borderDash: [2,2], pointRadius: 0 },
                                { label: 'ë°°ìš°ì ì¼ë°˜', data: history.map(h => h.sn), borderColor: '#f59e0b', borderDash: [2,2], pointRadius: 0 },
                                { label: 'ë³¸ì¸ ISA', data: history.map(h => h.ui), borderColor: '#10b981', pointRadius: 0 },
                                { label: 'ë°°ìš°ì ISA', data: history.map(h => h.si), borderColor: '#3b82f6', pointRadius: 0 }
                            ]
                        },
                        options: { 
                            responsive: true, maintainAspectRatio: false, animation: false,
                            scales: { y: { beginAtZero: true } },
                            plugins: { legend: { position: 'top', labels: { boxWidth: 10, font: { size: 10, weight: 'bold' } } } }
                        }
                    });
                    return () => { if (chartInstance.current) chartInstance.current.destroy(); };
                }, [history]);
                return <div className="h-64 md:h-80 w-full"><canvas ref={canvasRef}></canvas></div>;
            });

            // --- Other Tab Handlers ---
            const addFavorite = () => { if (!newFav.name || !newFav.code) return; setFavorites([...favorites, { name: newFav.name, code: newFav.code }]); setNewFav({ name: '', code: '' }); };
            const removeFavorite = (code) => { setFavorites(favorites.filter(f => f.code !== code)); };
            const addRoutineLink = () => { if (!newRoutine.category || !newRoutine.name || !newRoutine.url) return; const updated = { ...routineLinks }; updated[newRoutine.category] = [...updated[newRoutine.category], { name: newRoutine.name, url: newRoutine.url, icon: "fa-link", color: "bg-slate-100 text-slate-700" }]; setRoutineLinks(updated); setNewRoutine({ category: '', name: '', url: '' }); };
            const removeRoutineLink = (category, index) => { const updated = { ...routineLinks }; updated[category] = updated[category].filter((_, i) => i !== index); setRoutineLinks(updated); };

            const renderDashboard = () => (
                <div className="space-y-6 animate-fade-in pb-10">
                    <div className="bg-white dark:bg-slate-800 rounded-xl shadow h-16 overflow-hidden border dark:border-slate-700">
                        <TradingViewTicker theme={isDark ? 'dark' : 'light'} />
                    </div>
                    <div className="bg-white dark:bg-slate-800 p-1 rounded-xl shadow h-[400px] border dark:border-slate-700 flex flex-col">
                        <div className="p-3 border-b dark:border-slate-700 flex justify-between items-center font-bold">
                            <span>S&P 500 íˆíŠ¸ë§µ</span>
                            <span className={`px-2 py-0.5 rounded-full text-[10px] text-white ${marketStatus.color}`}>{marketStatus.text}</span>
                        </div>
                        <div className="flex-1 overflow-hidden">
                            <TradingViewHeatmap theme={isDark ? 'dark' : 'light'} />
                        </div>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div className="bg-white dark:bg-slate-800 rounded-xl shadow border p-5 font-bold">
                            <h3 className="text-xl font-bold mb-4 flex items-center gap-2 text-indigo-500"><i className="fa-solid fa-magnifying-glass-chart"></i> ì¢…ëª© ê²€ìƒ‰</h3>
                            <div className="flex flex-col sm:flex-row gap-2 mb-4">
                                <input type="text" id="mainSearch" placeholder="ì¢…ëª©ëª… ë˜ëŠ” ì½”ë“œ" className="flex-1 p-3 border-2 border-indigo-200 rounded-lg dark:bg-slate-700 outline-none w-full" onKeyPress={e=>e.key==='Enter'&&searchSymbol(e.target.value)} />
                                <button onClick={() => searchSymbol(document.getElementById('mainSearch').value)} className="bg-indigo-600 text-white px-6 py-3 sm:py-0 rounded-lg font-bold w-full sm:w-auto">ê²€ìƒ‰</button>
                            </div>
                            <div className="flex flex-wrap gap-2 mb-6">
                                {favorites.map(s => (
                                    <div key={s.code} className="flex items-center group">
                                        <button onClick={() => searchSymbol(s.code)} className="px-3 py-1.5 bg-slate-50 dark:bg-slate-700 border border-r-0 rounded-l-lg text-xs hover:border-indigo-400 group-hover:border-indigo-400">
                                            {s.name}
                                        </button>
                                        <button onClick={() => removeFavorite(s.code)} className="px-2 py-1.5 bg-slate-50 dark:bg-slate-700 border rounded-r-lg text-[10px] text-red-400 hover:text-red-600 hover:border-indigo-400 group-hover:border-indigo-400">
                                            <i className="fa-solid fa-xmark"></i>
                                        </button>
                                    </div>
                                ))}
                            </div>
                            <div className="p-4 bg-slate-50 dark:bg-slate-900 rounded-xl border-2 border-dashed border-slate-200 dark:border-slate-700">
                                <h4 className="text-xs text-indigo-500 mb-2 font-black">ìƒˆ ì¦ê²¨ì°¾ê¸° ì¶”ê°€</h4>
                                <div className="flex flex-col sm:flex-row gap-2">
                                    <input type="text" placeholder="ì¢…ëª©ëª…" className="flex-1 sim-input !mt-0 !p-1 text-xs" value={newFav.name} onChange={e=>setNewFav({...newFav, name:e.target.value})} />
                                    <input type="text" placeholder="ì½”ë“œ" className="sm:w-24 sim-input !mt-0 !p-1 text-xs" value={newFav.code} onChange={e=>setNewFav({...newFav, code:e.target.value})} />
                                    <button onClick={addFavorite} className="bg-indigo-600 text-white px-3 py-2 sm:py-0 rounded text-xs font-black w-full sm:w-auto">ì¶”ê°€</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );

            const renderRoutine = () => (
                <div className="space-y-6 animate-fade-in pb-10">
                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 pb-4 border-b dark:border-slate-700 font-bold">
                        <div className="flex items-center gap-4">
                            <h2 className="text-2xl font-black">ì˜¤ëŠ˜ì˜ ë£¨í‹´</h2>
                            <button onClick={() => setIsRoutineEditMode(!isRoutineEditMode)} className={`px-3 py-1 rounded text-xs transition-all ${isRoutineEditMode ? 'bg-indigo-600 text-white shadow-lg' : 'bg-slate-200 dark:bg-slate-700 text-slate-500'}`}>
                                <i className="fa-solid fa-pen-to-square mr-1"></i> {isRoutineEditMode ? 'í¸ì§‘ ì™„ë£Œ' : 'ë§í¬ í¸ì§‘'}
                            </button>
                        </div>
                        <div className="flex bg-slate-100 dark:bg-slate-700 p-1 rounded-lg w-full sm:w-auto">
                            <button onClick={() => setLinkMode('investment')} className={`flex-1 sm:flex-none px-4 py-1.5 text-xs font-bold rounded-lg ${linkMode === 'investment' ? 'bg-white shadow text-blue-600' : 'text-slate-500'}`}>íˆ¬ì & ì¼ìƒ</button>
                            <button onClick={() => setLinkMode('blogs')} className={`flex-1 sm:flex-none px-4 py-1.5 text-xs font-bold rounded-lg ${linkMode === 'blogs' ? 'bg-white shadow text-blue-600' : 'text-slate-500'}`}>ì¸ì‚¬ì´íŠ¸</button>
                        </div>
                    </div>
                    {isRoutineEditMode && (
                        <div className="p-6 bg-indigo-50 dark:bg-indigo-900/10 rounded-2xl border-2 border-indigo-200 dark:border-indigo-800 animate-fade-in mb-6">
                            <h3 className="font-black text-indigo-600 mb-4 text-sm"><i className="fa-solid fa-plus-circle mr-2"></i>ìƒˆ ë£¨í‹´ ë§í¬ ì¶”ê°€</h3>
                            <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-3">
                                <select className="sim-input !mt-0 text-xs" value={newRoutine.category} onChange={e=>setNewRoutine({...newRoutine, category:e.target.value})}>
                                    <option value="">ì¹´í…Œê³ ë¦¬ ì„ íƒ</option>
                                    {Object.keys(linkMode === 'blogs' ? blogInsightLinks : routineLinks).map(cat => <option key={cat} value={cat}>{cat}</option>)}
                                </select>
                                <input type="text" placeholder="ì‚¬ì´íŠ¸ëª…" className="sim-input !mt-0 text-xs" value={newRoutine.name} onChange={e=>setNewRoutine({...newRoutine, name:e.target.value})} />
                                <input type="text" placeholder="URL" className="sim-input !mt-0 text-xs" value={newRoutine.url} onChange={e=>setNewRoutine({...newRoutine, url:e.target.value})} />
                                <button onClick={() => {
                                    if(linkMode === 'blogs') {
                                        if (!newRoutine.category || !newRoutine.name || !newRoutine.url) return;
                                        const updated = { ...blogInsightLinks };
                                        updated[newRoutine.category] = [...updated[newRoutine.category], { name: newRoutine.name, url: newRoutine.url }];
                                        setBlogInsightLinks(updated);
                                        setNewRoutine({ category: '', name: '', url: '' });
                                    } else {
                                        addRoutineLink();
                                    }
                                }} className="bg-indigo-600 text-white rounded font-black text-xs h-10">ì¶”ê°€í•˜ê¸°</button>
                            </div>
                        </div>
                    )}
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-6 font-bold">
                        {Object.entries(linkMode === 'blogs' ? blogInsightLinks : routineLinks).map(([cat, links]) => (
                            <div key={cat} className="bg-white dark:bg-slate-800 rounded-2xl p-6 shadow-lg border dark:border-slate-700">
                                <h3 className={`text-lg font-bold mb-4 border-b pb-2 ${linkMode === 'blogs' ? 'text-green-600' : 'text-indigo-600'}`}>{cat}</h3>
                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                    {links.map((l, i) => (
                                        <div key={i} className="relative group">
                                            <a href={l.url} target="_blank" className="block p-3 rounded-xl bg-slate-50 dark:bg-slate-700 hover:shadow-md flex items-center gap-3 group transition-all">
                                                <div className={`w-8 h-8 rounded flex items-center justify-center ${linkMode === 'blogs' ? 'bg-green-100 text-green-700' : l.color} bg-opacity-20 group-hover:scale-110 transition`}>
                                                    <i className={`fa-solid ${linkMode === 'blogs' ? 'fa-blog' : l.icon}`}></i>
                                                </div>
                                                <span className="text-sm truncate pr-6">{l.name}</span>
                                            </a>
                                            {isRoutineEditMode && (
                                                <button onClick={() => {
                                                    if(linkMode === 'blogs') {
                                                        const updated = { ...blogInsightLinks };
                                                        updated[cat] = updated[cat].filter((_, index) => index !== i);
                                                        setBlogInsightLinks(updated);
                                                    } else {
                                                        removeRoutineLink(cat, i);
                                                    }
                                                }} className="absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center shadow-lg hover:bg-red-600 transition">
                                                    <i className="fa-solid fa-xmark text-[10px]"></i>
                                                </button>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );

            const renderTools = () => {
                const targetRes = (() => {
                    const currentPrice = parseFormattedNumber(targetInputs.price); 
                    const shares = parseFormattedNumber(targetInputs.shares);
                    let targetPrice = 0, rate = 0;
                    if(targetInputs.mode === 'cap') {
                        const currentCap = parseFloat(targetInputs.currentCap) || 1; 
                        const targetCap = parseFloat(targetInputs.targetCap) || 0;
                        targetPrice = currentPrice * (targetCap / currentCap); 
                        rate = ((targetCap / currentCap) - 1) * 100;
                    } else {
                        targetPrice = parseFormattedNumber(targetInputs.targetRate); 
                        if(currentPrice > 0) rate = ((targetPrice - currentPrice) / currentPrice) * 100;
                    }
                    return { targetPrice, rate, totalAmount: targetPrice * shares, profit: (targetPrice - currentPrice) * shares };
                })();
                const exchRes = (parseFormattedNumber(exchInputs.amount) * (exchangeRates[exchInputs.base]?.krw || 1)) / (exchangeRates[exchInputs.target]?.krw || 1);
                let avgCost = 0, avgQ = 0;
                avgRows.forEach(r => { const q = parseFormattedNumber(r.q); const p = parseFormattedNumber(r.p); avgQ += q; avgCost += q * p; });
                const ipoNeeded = (parseFormattedNumber(ipoCalcInputs.price) * parseFormattedNumber(ipoCalcInputs.qty) * (ipoCalcInputs.rate/100)) + parseFormattedNumber(ipoCalcInputs.fee);
                const toolTaxRes = toolTaxInputs.type === 'dividend' ? parseFormattedNumber(toolTaxInputs.profit) * 0.154 : parseFormattedNumber(toolTaxInputs.profit) * 0.22;
                const divPreTax = parseFormattedNumber(divInputs.shares) * parseFormattedNumber(divInputs.perShare);
                const divPostTax = divPreTax * (1 - (parseFloat(divInputs.tax) / 100));

                return (
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 animate-fade-in pb-10 font-bold">
                        {/* ëª©í‘œ ë‹¨ê°€ ë¶„ì„ */}
                        <div className="bg-white dark:bg-slate-800 p-5 rounded-2xl shadow-sm border dark:border-slate-700 flex flex-col">
                            <h3 className="font-bold mb-4 text-indigo-600 font-black flex items-center gap-2">
                                <i className="fa-solid fa-bullseye"></i> ëª©í‘œ ë‹¨ê°€ ë¶„ì„
                            </h3>
                            <div className="flex bg-slate-100 dark:bg-slate-900 p-1 rounded-lg mb-4 text-[10px]">
                                <button onClick={() => setTargetInputs({...targetInputs, mode:'cap'})} className={`flex-1 py-1.5 rounded-md transition-all ${targetInputs.mode==='cap'?'bg-white shadow text-indigo-600':'text-slate-500'}`}>ì‹œì´ ë¹„ë¡€</button>
                                <button onClick={() => setTargetInputs({...targetInputs, mode:'rate'})} className={`flex-1 py-1.5 rounded-md transition-all ${targetInputs.mode==='rate'?'bg-white shadow text-indigo-600':'text-slate-500'}`}>ê°€ê²© ì§ì ‘</button>
                            </div>
                            <div className="space-y-4 flex-1">
                                <div className="grid grid-cols-2 gap-3">
                                    <div className="flex flex-col"><label className="text-[10px] text-slate-500 mb-1">í˜„ì¬ê°€</label><input type="text" className="sim-input tool-input text-right" placeholder="0" value={targetInputs.price} onChange={e=>handleCommaChange(e, v=>setTargetInputs({...targetInputs, price:v}))} /></div>
                                    <div className="flex flex-col"><label className="text-[10px] text-slate-500 mb-1">ë³´ìœ  ìˆ˜ëŸ‰</label><input type="text" className="sim-input tool-input text-right" placeholder="0" value={targetInputs.shares} onChange={e=>handleCommaChange(e, v=>setTargetInputs({...targetInputs, shares:v}))} /></div>
                                </div>
                                {targetInputs.mode === 'cap' ? (
                                    <div className="grid grid-cols-2 gap-3">
                                        <div className="flex flex-col"><label className="text-[10px] text-slate-500 mb-1 truncate">í˜„ì¬ ì‹œì´(ì¡°)</label><input type="number" step="0.1" className="sim-input tool-input" value={targetInputs.currentCap} onChange={e=>setTargetInputs({...targetInputs, currentCap:e.target.value})} /></div>
                                        <div className="flex flex-col"><label className="text-[10px] text-slate-500 mb-1 truncate">ëª©í‘œ ì‹œì´(ì¡°)</label><input type="number" step="0.1" className="sim-input tool-input" value={targetInputs.targetCap} onChange={e=>setTargetInputs({...targetInputs, targetCap:e.target.value})} /></div>
                                    </div>
                                ) : (
                                    <div className="flex flex-col"><label className="text-[10px] text-slate-500 mb-1">ëª©í‘œ ë‹¨ê°€ ì§ì ‘ ì…ë ¥</label><input type="text" className="sim-input tool-input text-right" placeholder="0" value={targetInputs.targetRate} onChange={e=>handleCommaChange(e, v=>setTargetInputs({...targetInputs, targetRate:v}))} /></div>
                                )}
                            </div>
                            <div className="tool-result-container bg-indigo-50/50 dark:bg-indigo-900/20 border-indigo-200 dark:border-indigo-800 text-indigo-700 dark:text-indigo-400 num-font font-black">
                                <div className="flex justify-between items-center text-xs opacity-80 border-b border-indigo-100 dark:border-indigo-800/50 pb-2 mb-2"><span>ëª©í‘œ ë„ë‹¬ ë‹¨ê°€</span><span>{formatNumber(targetRes.targetPrice)}ì› ({targetRes.rate.toFixed(1)}%)</span></div>
                                <div className="flex justify-between items-center text-xs opacity-80 mb-1"><span>ì˜ˆìƒ ì´ì•¡</span><span>{formatNumber(targetRes.totalAmount)}ì›</span></div>
                                <div className="flex justify-between items-center text-sm border-t border-indigo-200 dark:border-indigo-700 pt-2 mt-2"><span>ì´ ì˜ˆìƒ ìˆ˜ìµê¸ˆ</span><span className="text-lg">{formatNumber(targetRes.profit)}ì›</span></div>
                            </div>
                        </div>

                        {/* í™˜ìœ¨ ê³„ì‚°ê¸° */}
                        <div className="bg-white dark:bg-slate-800 p-5 rounded-2xl shadow-sm border dark:border-slate-700">
                            <div className="flex justify-between items-center mb-4 text-blue-600">
                                <h3 className="font-bold font-black flex items-center gap-2"><i className="fa-solid fa-money-bill-transfer"></i> í™˜ìœ¨ ê³„ì‚°ê¸°</h3>
                                <button onClick={fetchRealTimeRates} className={`text-slate-400 hover:text-blue-500 transition-colors ${isFetching ? 'animate-spin' : ''}`}><i className="fa-solid fa-arrows-rotate text-xs"></i></button>
                            </div>
                            <div className="space-y-4">
                                <div className="flex gap-2">
                                    <select className="w-1/3 sim-input tool-input" value={exchInputs.base} onChange={e=>setExchInputs({...exchInputs, base:e.target.value})}>{Object.keys(exchangeRates).map(k=><option key={k} value={k}>{k}</option>)}</select>
                                    <input type="text" className="flex-1 sim-input tool-input text-right" value={exchInputs.amount} onChange={e=>handleCommaChange(e, v=>setExchInputs({...exchInputs, amount:v}))} />
                                </div>
                                <div className="flex gap-2">
                                    <select className="w-1/3 sim-input tool-input" value={exchInputs.target} onChange={e=>setExchInputs({...exchInputs, target:e.target.value})}>{Object.keys(exchangeRates).map(k=><option key={k} value={k}>{k}</option>)}</select>
                                    <div className="flex-1 flex items-center justify-end px-3 rounded-md bg-white dark:bg-slate-800 border-2 border-blue-200 dark:border-blue-900 text-blue-600 dark:text-blue-400 font-black text-lg num-font shadow-inner">{formatNumber(exchRes)}</div>
                                </div>
                            </div>
                            <div className="mt-4 p-3 rounded-xl bg-blue-50/50 dark:bg-blue-900/20 text-[10px] text-blue-500 text-center font-normal">ì‹¤ì‹œê°„ í™˜ìœ¨ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ìë™ ê³„ì‚°ë©ë‹ˆë‹¤.</div>
                        </div>

                        {/* ê°„ì´ ì„¸ê¸ˆ ê³„ì‚°ê¸° */}
                        <div className="bg-white dark:bg-slate-800 p-5 rounded-2xl shadow-sm border dark:border-slate-700 font-bold">
                            <h3 className="mb-4 text-rose-600 font-black flex items-center gap-2">
                                <i className="fa-solid fa-receipt"></i> ê°„ì´ ì„¸ê¸ˆ ê³„ì‚°ê¸°
                            </h3>
                            <div className="space-y-3">
                                <div className="flex bg-slate-100 dark:bg-slate-900 p-1 rounded-lg mb-2 text-[10px]">
                                    <button onClick={() => setToolTaxInputs({...toolTaxInputs, type:'dividend'})} className={`flex-1 py-1.5 rounded-md transition-all ${toolTaxInputs.type==='dividend'?'bg-white shadow text-rose-600':'text-slate-500'}`}>ë°°ë‹¹/ì´ì(15.4%)</button>
                                    <button onClick={() => setToolTaxInputs({...toolTaxInputs, type:'capital'})} className={`flex-1 py-1.5 rounded-md transition-all ${toolTaxInputs.type==='capital'?'bg-white shadow text-rose-600':'text-slate-500'}`}>ì–‘ë„ì†Œë“(22%)</button>
                                </div>
                                <div><label className="text-[10px] text-slate-500 block mb-1 px-1">ìˆ˜ìµ ì´ì•¡</label><input type="text" className="sim-input tool-input text-right" placeholder="0" value={toolTaxInputs.profit} onChange={e=>handleCommaChange(e, v=>setToolTaxInputs({...toolTaxInputs, profit:v}))} /></div>
                                <div className="tool-result-container bg-rose-50/50 dark:bg-rose-900/20 border-rose-200 dark:border-rose-900 text-rose-600 dark:text-rose-400 mt-2 num-font font-black">
                                    <span className="text-xs opacity-70 block mb-1">ì˜ˆìƒ ì„¸ê¸ˆ í•©ê³„</span>
                                    <span className="text-xl">{formatNumber(toolTaxRes)}ì›</span>
                                </div>
                            </div>
                        </div>

                        {/* ê³µëª¨ì£¼ ì²­ì•½ ê³„ì‚° */}
                        <div className="bg-white dark:bg-slate-800 p-5 rounded-2xl shadow-sm border dark:border-slate-700 font-bold">
                            <h3 className="mb-4 text-purple-600 font-black flex items-center gap-2">
                                <i className="fa-solid fa-piggy-bank"></i> ê³µëª¨ì£¼ ì²­ì•½ ê³„ì‚°
                            </h3>
                            <div className="grid grid-cols-2 gap-3 mb-4">
                                <div className="flex flex-col"><label className="text-[10px] text-slate-500 mb-1">ê³µëª¨ê°€</label><input type="text" className="sim-input tool-input text-right" value={ipoCalcInputs.price} onChange={e=>handleCommaChange(e, v=>setIpoCalcInputs({...ipoCalcInputs, price:v}))} /></div>
                                <div className="flex flex-col"><label className="text-[10px] text-slate-500 mb-1">ì²­ì•½ìˆ˜ëŸ‰</label><input type="text" className="sim-input tool-input text-right" value={ipoCalcInputs.qty} onChange={e=>handleCommaChange(e, v=>setIpoCalcInputs({...ipoCalcInputs, qty:v}))} /></div>
                                <div className="flex flex-col"><label className="text-[10px] text-slate-500 mb-1">ì¦ê±°ê¸ˆìœ¨</label><select className="sim-input tool-input" value={ipoCalcInputs.rate} onChange={e=>setIpoCalcInputs({...ipoCalcInputs, rate:parseInt(e.target.value)})}><option value={50}>50%</option><option value={100}>100%</option></select></div>
                                <div className="flex flex-col"><label className="text-[10px] text-slate-500 mb-1">ìˆ˜ìˆ˜ë£Œ</label><input type="text" className="sim-input tool-input text-right" value={ipoCalcInputs.fee} onChange={e=>handleCommaChange(e, v=>setIpoCalcInputs({...ipoCalcInputs, fee:v}))} /></div>
                            </div>
                            <div className="tool-result-container bg-purple-50/50 dark:bg-purple-900/20 border-purple-200 dark:border-purple-900 text-purple-600 dark:text-purple-400 num-font font-black">
                                <span className="text-xs opacity-70 block mb-1">ì´ í•„ìš” ì¦ê±°ê¸ˆ</span>
                                <span className="text-xl">{formatNumber(ipoNeeded)}ì›</span>
                            </div>
                        </div>

                        {/* í‰ë‹¨ê°€ ê³„ì‚°ê¸° */}
                        <div className="bg-white dark:bg-slate-800 p-5 rounded-2xl shadow-sm border dark:border-slate-700 font-bold flex flex-col">
                            <h3 className="mb-3 text-emerald-600 flex justify-between items-center font-black">
                                <span className="flex items-center gap-2"><i className="fa-solid fa-scale-balanced"></i> í‰ë‹¨ê°€ ê³„ì‚°ê¸°</span>
                                <button onClick={()=>setAvgRows([...avgRows, {id:Date.now(), q:'', p:''}])} className="bg-emerald-100 dark:bg-emerald-900/40 text-emerald-600 dark:text-emerald-400 px-2 py-0.5 rounded text-[10px] hover:bg-emerald-200 transition-colors">+ ì¶”ê°€</button>
                            </h3>
                            <div className="space-y-2 overflow-y-auto max-h-40 mb-3 pr-1 scrollbar-thin">
                                {avgRows.map((r, i) => (
                                    <div key={r.id} className="grid grid-cols-12 gap-1 items-center animate-fade-in">
                                        <input type="text" placeholder="ìˆ˜ëŸ‰" className="col-span-5 sim-input tool-input text-right !p-1.5" value={r.q} onChange={e=>handleCommaChange(e, v=>{const n=[...avgRows]; n[i].q=v; setAvgRows(n);})} />
                                        <input type="text" placeholder="ë‹¨ê°€" className="col-span-5 sim-input tool-input text-right !p-1.5" value={r.p} onChange={e=>handleCommaChange(e, v=>{const n=[...avgRows]; n[i].p=v; setAvgRows(n);})} />
                                        <button onClick={()=>{const n=avgRows.filter(row=>row.id!==r.id); setAvgRows(n.length?n:[{id:Date.now(),q:'',p:''}]);}} className="col-span-2 text-rose-400 hover:text-rose-600"><i className="fa-solid fa-trash-can text-xs"></i></button>
                                    </div>
                                ))}
                            </div>
                            <div className="tool-result-container bg-emerald-50/50 dark:bg-emerald-900/20 border-emerald-200 dark:border-emerald-900 text-emerald-600 dark:text-emerald-400 mt-auto num-font font-black">
                                <div className="flex justify-between items-center text-[10px] opacity-70 border-b border-emerald-100 dark:border-emerald-800/50 pb-1 mb-2">
                                    <span>í•©ê³„ ìˆ˜ëŸ‰</span>
                                    <span>{formatNumber(avgQ)}</span>
                                </div>
                                <div className="text-[10px] opacity-70">ìµœì¢… í‰ë‹¨ê°€</div>
                                <div className="text-xl">{avgQ ? formatNumber(avgCost/avgQ) : 0}ì›</div>
                            </div>
                        </div>

                        {/* ë°°ë‹¹ê¸ˆ ê³„ì‚°ê¸° */}
                        <div className="bg-white dark:bg-slate-800 p-5 rounded-2xl shadow-sm border dark:border-slate-700 font-bold">
                            <h3 className="mb-4 text-amber-600 font-black flex items-center gap-2">
                                <i className="fa-solid fa-sack-dollar"></i> ë°°ë‹¹ê¸ˆ ê³„ì‚°ê¸°
                            </h3>
                            <div className="space-y-3">
                                <div className="grid grid-cols-2 gap-3">
                                    <div className="flex flex-col"><label className="text-[10px] text-slate-500 mb-1">ë³´ìœ  ìˆ˜ëŸ‰</label><input type="text" className="sim-input tool-input text-right" placeholder="0" value={divInputs.shares} onChange={e=>handleCommaChange(e, v=>setDivInputs({...divInputs, shares:v}))} /></div>
                                    <div className="flex flex-col"><label className="text-[10px] text-slate-500 mb-1">ì£¼ë‹¹ ë°°ë‹¹ê¸ˆ</label><input type="text" className="sim-input tool-input text-right" placeholder="0" value={divInputs.perShare} onChange={e=>handleCommaChange(e, v=>setDivInputs({...divInputs, perShare:v}))} /></div>
                                </div>
                                <div className="tool-result-container bg-amber-50/50 dark:bg-amber-900/20 border-amber-200 dark:border-amber-900 text-amber-600 dark:text-amber-400 num-font font-black space-y-1">
                                    <div className={`flex justify-between items-center text-xs opacity-70 border-b border-amber-100 dark:border-amber-800/50 pb-2 mb-2`}><span>ì„¸ì „ ì´ì•¡</span><span>{formatNumber(divPreTax)}ì›</span></div>
                                    <div className="flex justify-between items-center text-[10px] opacity-70"><span>ì‹¤íš¨ì„¸ìœ¨ {divInputs.tax}% ì ìš©</span></div>
                                    <div className="flex justify-between items-center text-sm"><span>ì„¸í›„ ì‹¤ìˆ˜ë ¹</span><span className="text-xl">{formatNumber(divPostTax)}ì›</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            const renderFinancialTax = () => {
                const totalFinIncome = finList.reduce((a, c) => a + c.amount, 0);
                const isGlobalTaxTarget = totalFinIncome > TAX_THRESHOLD;
                const earnedIncomeValue = parseFormattedNumber(earnedIncome);

                const calculateTaxResult = (earned, fin) => {
                    const brackets = [
                        { limit: 14000000, rate: 0.06 },
                        { limit: 50000000, rate: 0.15 },
                        { limit: 88000000, rate: 0.24 },
                        { limit: 150000000, rate: 0.35 },
                        { limit: 300000000, rate: 0.38 },
                        { limit: 500000000, rate: 0.40 },
                        { limit: 1000000000, rate: 0.42 },
                        { limit: Infinity, rate: 0.45 }
                    ];

                    const isTarget = fin > TAX_THRESHOLD;
                    const taxBase = earned + (isTarget ? (fin - TAX_THRESHOLD) : 0);
                    
                    let rem = taxBase;
                    let totalProgressive = 0;
                    let lastLimit = 0;
                    const details = [];

                    for (const b of brackets) {
                        if (rem <= 0) break;
                        const chunk = Math.min(rem, b.limit - lastLimit);
                        const tax = chunk * b.rate;
                        details.push({ bracket: `${formatNumber(lastLimit/10000)}ë§Œ~${isFinite(b.limit) ? formatNumber(b.limit/10000)+'ë§Œ' : 'ì´ˆê³¼'}`, chunk, rate: b.rate * 100, tax });
                        totalProgressive += tax;
                        rem -= chunk;
                        lastLimit = b.limit;
                    }

                    const separateFinTax = isTarget ? TAX_THRESHOLD * 0.14 : fin * 0.14; 
                    const otherTax = otherIncomeList.reduce((a, c) => c.isTaxed ? a + (c.amount * (c.taxRate / 100)) : a, 0);
                    
                    const decidedTax = totalProgressive + separateFinTax + otherTax;
                    const totalDecided = decidedTax * 1.1;

                    const prepaidEarned = calculateProgressiveIncomeTax(earned, {rate1:6, rate2:15, rate3:24}) * 1.1; 
                    const prepaidFin = fin * 0.154;
                    const totalPrepaid = prepaidEarned + prepaidFin;

                    const additionalPayable = totalDecided - totalPrepaid;

                    return { totalDecided, totalPrepaid, additionalPayable, details, taxBase };
                };

                const resultCurrent = calculateTaxResult(earnedIncomeValue, totalFinIncome);
                const resultZeroEarned = calculateTaxResult(0, totalFinIncome);
                const impact = resultCurrent.additionalPayable - resultZeroEarned.additionalPayable;
                const nhiAnnual = Math.max(0, totalFinIncome - 20000000) * 0.0709 * 1.1281;

                return (
                    <div className="space-y-6 animate-fade-in pb-10 font-bold">
                        <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center border-b dark:border-slate-700 pb-2 gap-2">
                            <h2 className="text-xl sm:text-2xl font-black">ì¢…í•© ê¸ˆìœµ ì†Œë“ ë° ì‹¤ì§ˆ ì„¸ë¶€ë‹´ ë¶„ì„</h2>
                            <div className="text-[10px] text-slate-400 font-bold">ê±´ê°•ë³´í—˜ë£Œ ë° ê·¼ë¡œì†Œë“ Impact í¬í•¨</div>
                        </div>

                        <div className="guide-card border-l-4 border-l-indigo-600 bg-indigo-50/30 dark:bg-indigo-900/10 mb-6">
                            <div className="flex flex-col sm:flex-row gap-4 items-start">
                                <div className="bg-indigo-600 text-white p-3 rounded-lg shadow-lg"><i className="fa-solid fa-book-bookmark text-xl"></i></div>
                                <div className="flex-1">
                                    <h3 className="font-black text-indigo-700 dark:text-indigo-400 text-base mb-1">í™˜ê¸‰ê³¼ ì¶”ê°€ ë‚©ë¶€ì˜ ì›ë¦¬</h3>
                                    <p className="text-[11px] text-slate-500 mb-2 leading-relaxed font-normal">
                                        ì´ì/ë°°ë‹¹ ìˆ˜ë ¹ ì‹œ ê¸ˆìœµê¸°ê´€ì€ ì´ë¯¸ <strong>15.4%</strong>ë¥¼ ë–¼ê³  ì¤ë‹ˆë‹¤. 5ì›” ì‹ ê³  ì‹œ ë‚´ ì‹¤ì œ ëˆ„ì§„ì„¸ìœ¨(6~45%)ì„ ì ìš©í•œ <strong>ê²°ì •ì„¸ì•¡</strong>ì´ ì´ë¯¸ ë‚¸ ì„¸ê¸ˆë³´ë‹¤ ì ë‹¤ë©´ <strong>í™˜ê¸‰</strong>ì„ ë°›ê³ , ë§ë‹¤ë©´ <strong>ì¶”ê°€ ë‚©ë¶€</strong>ë¥¼ í•˜ê²Œ ë©ë‹ˆë‹¤.
                                    </p>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-[10px]">
                                        <div className="p-2 bg-white dark:bg-slate-800 rounded border">
                                            <span className="block font-black text-rose-600 mb-1">ê±´ê°•ë³´í—˜ë£Œ ì¶”ê°€ ë¶€ë‹´</span>
                                            <span className="text-slate-500 font-normal">ê¸ˆìœµì†Œë“ì´ ì—° 2,000ë§Œ ì›ì„ ì´ˆê³¼í•˜ë©´, ì´ˆê³¼ë¶„ì— ëŒ€í•´ ì•½ <strong>8%</strong>ì˜ ë³´í—˜ë£Œê°€ ë§¤ë‹¬ ì¶”ê°€ë¡œ ê³ ì§€ë©ë‹ˆë‹¤.</span>
                                        </div>
                                        <div className="p-2 bg-white dark:bg-slate-800 rounded border">
                                            <span className="block font-black text-emerald-600 mb-1">ì‹¤ì§ˆ ì„¸ë¶€ë‹´(Impact)</span>
                                            <span className="text-slate-500 font-normal">"ê·¼ë¡œì†Œë“ì´ ì—†ì—ˆì„ ë•Œ ë°›ì„ ìˆ˜ ìˆì—ˆë˜ í™˜ê¸‰ì•¡"ê³¼ "ê·¼ë¡œì†Œë“ ë•Œë¬¸ì— ë‚´ì•¼ í•˜ëŠ” ë‚©ë¶€ì•¡"ì˜ ì°¨ì´ê°€ ê³§ ì£¼ë¨¸ë‹ˆ ì‚¬ì •ì˜ ë³€í™”ì…ë‹ˆë‹¤.</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6 animate-fade-in">
                            <div className="bg-white dark:bg-slate-800 p-5 rounded-2xl border shadow-sm text-center">
                                <p className="text-[11px] text-slate-500 mb-2 font-black">ì´ë¯¸ ë‚©ë¶€í•œ ì„¸ê¸ˆ (ê¸°ë‚©ë¶€ í•©ê³„)</p>
                                <h3 className="text-xl text-slate-700 dark:text-slate-200 num-font mb-1">{formatNumber(resultCurrent.totalPrepaid)}ì›</h3>
                                <p className="text-[9px] text-slate-400 font-normal">ê¸ˆìœµê¸°ê´€ 15.4% + ê¸‰ì—¬ ê³µì œì•¡ ì¶”ì •</p>
                            </div>
                            <div className="bg-white dark:bg-slate-800 p-5 rounded-2xl border shadow-sm text-center border-indigo-200 dark:border-indigo-800">
                                <p className="text-[11px] text-indigo-500 mb-2 font-black">ìµœì¢… ê²°ì • ì„¸ì•¡ (ì—°ê°„ ì´ì•¡)</p>
                                <h3 className="text-xl text-indigo-600 num-font mb-1">{formatNumber(resultCurrent.totalDecided)}ì›</h3>
                                <p className="text-[9px] text-slate-400 font-normal">ëˆ„ì§„ ì„¸ìœ¨ ì ìš© í›„ í™•ì •ëœ ì„¸ì•¡</p>
                            </div>
                            <div className={`p-5 rounded-2xl shadow-lg text-center flex flex-col justify-center ${resultCurrent.additionalPayable > 0 ? 'bg-rose-600 text-white' : 'bg-emerald-600 text-white'}`}>
                                <p className="text-[11px] opacity-80 mb-1 font-black">ì‹¤ì§ˆ ì¶”ê°€ ë‚©ë¶€/í™˜ê¸‰ì•¡ (5ì›”)</p>
                                <h3 className="text-2xl font-black num-font whitespace-nowrap">
                                    {resultCurrent.additionalPayable > 0 ? `â–² ${formatNumber(resultCurrent.additionalPayable)}ì›` : `â–¼ ${formatNumber(Math.abs(resultCurrent.additionalPayable))}ì› í™˜ê¸‰`}
                                </h3>
                                <p className="text-[10px] mt-1 opacity-70">5ì›” ì‹ ê³  ì‹œ ì‹¤ì œ í†µì¥ì—ì„œ ë‚˜ê°€ëŠ”/ë“¤ì–´ì˜¤ëŠ” ëˆ</p>
                            </div>
                        </div>

                        <div className={`p-6 rounded-2xl border-2 shadow-sm animate-fade-in bg-slate-900 border-indigo-500 text-white`}>
                            <div className="flex flex-col md:flex-row justify-between items-center gap-6">
                                <div className="flex-1 text-center md:text-left">
                                    <h4 className="text-lg font-black text-indigo-400 mb-2">
                                        <i className="fa-solid fa-bolt-lightning mr-2"></i> ê·¼ë¡œì†Œë“ ìœ ë¬´ì— ë”°ë¥¸ ì‹¤ì§ˆ ì˜í–¥ë„ (Impact)
                                    </h4>
                                    <p className="text-xs text-slate-400 leading-relaxed font-normal">
                                        ê·¼ë¡œì†Œë“ì´ 0ì›ì¼ ë•Œ ë°›ì„ ìˆ˜ ìˆì—ˆë˜ <strong>í™˜ê¸‰ì•¡({formatNumber(Math.abs(resultZeroEarned.additionalPayable))})</strong>ê³¼, 
                                        í˜„ì¬ ì†Œë“ ìœ ì§€ ì‹œ ë‚´ì•¼ í•˜ëŠ” <strong>ë‚©ë¶€ì•¡({formatNumber(Math.max(0, resultCurrent.additionalPayable))})</strong>ì„ í•©ì‚°í•œ ìˆ˜ì¹˜ì…ë‹ˆë‹¤. 
                                    </p>
                                </div>
                                <div className="bg-slate-800 p-4 rounded-xl border border-slate-700 flex flex-col sm:flex-row gap-6 sm:gap-8 items-center num-font w-full sm:w-auto">
                                    <div className="text-center sm:border-r border-slate-700 sm:pr-8 w-full sm:w-auto">
                                        <p className="text-[10px] text-slate-400 mb-1">ê·¼ë¡œì†Œë“ 0ì› ì‹œ</p>
                                        <p className={`text-lg font-black ${resultZeroEarned.additionalPayable < 0 ? 'text-emerald-400' : 'text-rose-400'}`}>
                                            {resultZeroEarned.additionalPayable < 0 ? `â–¼ ${formatNumber(Math.abs(resultZeroEarned.additionalPayable))}` : `â–² ${formatNumber(resultZeroEarned.additionalPayable)}`}
                                        </p>
                                    </div>
                                    <div className="text-center w-full sm:w-auto">
                                        <p className="text-[10px] text-slate-400 mb-1">ì‹¤ì§ˆ ì„¸ë¶€ë‹´ ì°¨ì´</p>
                                        <p className="text-2xl font-black text-indigo-400">+ {formatNumber(impact)}</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div className="p-5 rounded-2xl border bg-amber-50 dark:bg-amber-900/10 border-amber-200 dark:border-amber-800 flex flex-col md:flex-row justify-between items-center gap-4">
                            <div className="flex gap-4 items-center">
                                <div className="w-10 h-10 bg-amber-500 text-white rounded-full flex items-center justify-center shadow-md flex-shrink-0"><i className="fa-solid fa-hand-holding-medical"></i></div>
                                <div>
                                    <h4 className="font-black text-amber-700 dark:text-amber-400">ê±´ê°•ë³´í—˜ë£Œ ì¶”ê°€ ë¶€ë‹´ì•¡ (ì†Œë“ì›”ì•¡ë³´í—˜ë£Œ)</h4>
                                    <p className="text-[10px] text-slate-500 font-normal">ê¸ˆìœµì†Œë“ì´ ì—° 2,000ë§Œ ì›ì„ ì´ˆê³¼í•  ê²½ìš° ë¶€ê³¼ë©ë‹ˆë‹¤.</p>
                                </div>
                            </div>
                            <div className="text-center md:text-right">
                                <div className="text-amber-600 font-black text-xl num-font">ì—°ê°„ + {formatNumber(nhiAnnual)}ì›</div>
                                <div className="text-slate-400 text-[10px] font-bold">ë§¤ì›” ì•½ {formatNumber(nhiAnnual / 12)}ì› ì¶”ê°€ ê³ ì§€</div>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
                            <div className="space-y-6">
                                <div className="bg-white dark:bg-slate-800 p-5 rounded-xl border shadow font-bold">
                                    <h4 className="font-black mb-4 flex items-center gap-2 text-blue-600 border-b pb-2">
                                        <i className="fa-solid fa-briefcase"></i> 1. ì†Œë“ ì •ë³´ ì…ë ¥
                                    </h4>
                                    <div className="space-y-4">
                                        <div className="overflow-hidden">
                                            <label className="text-[10px] text-slate-500">ì—°ê°„ ì„¸ì „ ê·¼ë¡œì†Œë“ (ì´ê¸‰ì—¬)</label>
                                            <input type="text" className="tool-input w-full text-right text-base sm:text-lg !py-2 sm:!py-3 border-2 border-blue-100 dark:border-blue-900" placeholder="0" value={earnedIncome} onChange={e=>handleCommaChange(e, setEarnedIncome)} />
                                        </div>
                                        <div className="p-4 bg-slate-50 dark:bg-slate-900 rounded-lg border-2 border-dashed border-slate-200 dark:border-slate-700">
                                            <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-3 gap-2">
                                                <span className="text-[11px] text-indigo-600 font-black">2. ì´ì/ë°°ë‹¹ ì†Œë“ ìƒì„¸</span>
                                                <div className="flex gap-1 w-full sm:w-auto">
                                                    <input id="fD" type="text" placeholder="í•­ëª©" className="min-w-0 flex-1 sm:w-20 tool-input !mt-0 !p-1 text-[10px]" />
                                                    <input id="fA" type="number" placeholder="ê¸ˆì•¡" className="min-w-0 flex-1 sm:w-24 tool-input !mt-0 !p-1 text-[10px]" />
                                                    <button onClick={()=>{const d=document.getElementById('fD').value, a=parseInt(document.getElementById('fA').value); if(d&&a){setFinList([...finList,{id:Date.now(),desc:d,amount:a}]); document.getElementById('fD').value=''; document.getElementById('fA').value='';}}} className="flex-shrink-0 bg-indigo-600 text-white px-2 rounded text-[10px] font-black h-8">ì¶”ê°€</button>
                                                </div>
                                            </div>
                                            <div className="max-h-40 overflow-y-auto space-y-1">
                                                {finList.length === 0 ? <p className="text-[10px] text-slate-400 text-center py-2">ë‚´ì—­ ì—†ìŒ</p> : finList.map(f => (
                                                    <div key={f.id} className="flex justify-between items-center text-[11px] border-b py-1.5 dark:border-slate-700 hover:bg-white dark:hover:bg-slate-800 px-1">
                                                        <span className="truncate mr-2">{f.desc}</span>
                                                        <div className="flex items-center gap-3 flex-shrink-0">
                                                            <span className="num-font font-black">{formatNumber(f.amount)}ì›</span>
                                                            <button onClick={()=>setFinList(finList.filter(item=>item.id!==f.id))} className="text-red-400"><i className="fa-solid fa-xmark text-[10px]"></i></button>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div className="bg-white dark:bg-slate-800 p-5 rounded-xl border shadow font-bold">
                                    <h4 className="font-black mb-4 flex items-center gap-2 text-indigo-700 dark:text-indigo-300 border-b pb-2">
                                        <i className="fa-solid fa-layer-group"></i> ë‚´ ì†Œë“ì˜ ëˆ„ì§„êµ¬ê°„ ë° ì„¸ìœ¨
                                    </h4>
                                    <div className="overflow-x-auto">
                                        <table className="w-full text-[11px] min-w-[300px]">
                                            <thead>
                                                <tr className="text-slate-500 border-b">
                                                    <th className="pb-2 text-left">ëˆ„ì§„ êµ¬ê°„</th>
                                                    <th className="pb-2 text-right">ì„¸ìœ¨</th>
                                                    <th className="pb-2 text-right">ì„¸ì•¡</th>
                                                </tr>
                                            </thead>
                                            <tbody className="num-font">
                                                {resultCurrent.details.map((d, i) => (
                                                    <tr key={i} className="border-b last:border-0">
                                                        <td className="py-2 text-slate-500 text-[10px]">{d.bracket}</td>
                                                        <td className="py-2 text-right text-blue-600 font-black">{d.rate}%</td>
                                                        <td className="py-2 text-right text-indigo-600">{formatNumber(d.tax)}ì›</td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <div className="bg-white dark:bg-slate-800 p-6 rounded-2xl border shadow font-bold flex flex-col">
                                <h4 className="font-black mb-4 flex items-center gap-2 text-slate-700 dark:text-slate-200 border-b pb-2">
                                    <i className="fa-solid fa-file-invoice-dollar"></i> ìƒì„¸ ì„¸ì•¡ ë„ì¶œ ë‚´ì—­
                                </h4>
                                <div className="space-y-4 flex-1">
                                    <div className="p-4 bg-slate-50 dark:bg-slate-900 rounded-xl space-y-3">
                                        <div className="flex justify-between items-center text-[11px]">
                                            <span className="text-slate-500 font-normal">â‘  ê³¼ì„¸ í‘œì¤€:</span>
                                            <span className="font-black text-slate-700 dark:text-slate-200 ml-2 text-right">{formatNumber(resultCurrent.taxBase)}ì›</span>
                                        </div>
                                        <div className="flex justify-between items-center text-[11px]">
                                            <span className="text-slate-500 font-normal">â‘¡ ê¸ˆìœµ ë¶„ë¦¬ê³¼ì„¸ë¶„:</span>
                                            <span className="font-black text-slate-700 dark:text-slate-200 ml-2 text-right">{formatNumber(TAX_THRESHOLD * 0.14)}ì›</span>
                                        </div>
                                        <div className="flex justify-between items-center text-[11px] border-t pt-2 dark:border-slate-700">
                                            <span className="text-slate-500 font-normal">â‘¢ ì‚°ì¶œ ì„¸ì•¡(â‘ +â‘¡):</span>
                                            <span className="font-black text-indigo-600 ml-2 text-right">{formatNumber(resultCurrent.totalDecided / 1.1)}ì›</span>
                                        </div>
                                        <div className="flex justify-between items-center text-[11px]">
                                            <span className="text-slate-500 font-normal">â‘£ ì§€ë°©ì†Œë“ì„¸(10%):</span>
                                            <span className="font-black text-indigo-600 ml-2 text-right">{formatNumber(resultCurrent.totalDecided * 0.1 / 1.1)}ì›</span>
                                        </div>
                                        <div className="border-t-2 border-slate-200 dark:border-slate-700 pt-3">
                                            <div className="flex justify-between items-center text-sm">
                                                <span className="font-black text-indigo-700">â‘¤ ì´ ê²°ì • ì„¸ì•¡:</span>
                                                <span className="font-black text-indigo-700 underline text-lg ml-2 text-right">{formatNumber(resultCurrent.totalDecided)}ì›</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="p-4 bg-rose-50 dark:bg-rose-900/10 rounded-xl space-y-2 border border-rose-100 dark:border-rose-900">
                                        <div className="flex justify-between items-center text-[11px]">
                                          <span className="text-rose-600">ê²°ì • ì„¸ì•¡ (â‘¤)</span>
                                          <span className="font-black ml-2 text-right">{formatNumber(resultCurrent.totalDecided)}ì›</span>
                                        </div>
                                        <div className="flex justify-between items-center text-[11px]">
                                          <span className="text-slate-500 font-normal">ê¸°ë‚©ë¶€ ì„¸ì•¡</span>
                                          <span className="font-black text-slate-700 dark:text-slate-200 ml-2 text-right">- {formatNumber(resultCurrent.totalPrepaid)}ì›</span>
                                        </div>
                                        <div className="border-t border-rose-200 pt-2 flex justify-between items-center">
                                          <span className="text-sm font-black text-rose-700">ìµœì¢… ë‚©ë¶€/í™˜ê¸‰ì•¡</span>
                                          <span className={`text-base font-black ml-2 text-right ${resultCurrent.additionalPayable > 0 ? 'text-rose-700' : 'text-emerald-600'}`}>
                                            {formatNumber(resultCurrent.additionalPayable)}ì›
                                          </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            return (
                <div className={`min-h-screen flex flex-col transition-colors duration-200 ${isDark ? 'dark bg-slate-900 text-slate-100' : 'bg-slate-50 text-slate-800'}`}>
                    <header className="sticky top-0 z-50 bg-white dark:bg-slate-800 border-b dark:border-slate-700 shadow h-16">
                        <div className="max-w-7xl mx-auto px-4 h-full flex items-center justify-between">
                            <div className="flex items-center gap-2 font-black text-lg flex-shrink-0"><i className="fa-solid fa-compass text-blue-600"></i> <span className="hidden sm:inline">Navigator</span></div>
                            <div className="nav-container flex-1 mx-4">
                                <nav className="inline-flex bg-slate-100 dark:bg-slate-700 p-1 rounded-xl gap-1">
                                    {[{id:'dashboard',l:'ëŒ€ì‹œë³´ë“œ'},{id:'routine',l:'ë£¨í‹´'},{id:'tools',l:'ë„êµ¬'},{id:'simulation',l:'ë…¸í›„ìê¸ˆ'},{id:'tax',l:'ê¸ˆìœµê³¼ì„¸'}].map(t => (
                                        <button key={t.id} onClick={()=>setActiveTab(t.id)} className={`nav-tab px-3 sm:px-5 py-1.5 text-xs rounded-lg transition-all ${activeTab === t.id ? 'active' : 'text-slate-500 font-bold'}`}>{t.l}</button>
                                    ))}
                                </nav>
                            </div>
                            <button onClick={()=>setIsDark(!isDark)} className="p-2 rounded-full hover:bg-slate-200 transition flex-shrink-0"><i className={`fa-solid ${isDark?'fa-sun text-amber-400':'fa-moon'}`}></i></button>
                        </div>
                    </header>
                    <main className="max-w-7xl w-full mx-auto px-4 py-6 flex-1 overflow-x-hidden">
                        {activeTab === 'dashboard' && renderDashboard()}
                        {activeTab === 'routine' && renderRoutine()}
                        {activeTab === 'tools' && renderTools()}
                        {activeTab === 'simulation' && (
                            <div className="animate-fade-in pb-10 font-bold space-y-6">
                                <h2 className="text-xl sm:text-2xl font-black mb-4 border-b dark:border-slate-700 pb-2 flex flex-col sm:flex-row sm:items-center gap-3">
                                    ë…¸í›„ ìê¸ˆ ì‹œë®¬ë ˆì´ì…˜
                                    <span className="text-[10px] sm:text-xs bg-indigo-100 text-indigo-600 px-2 py-1 rounded font-black w-max">v2.2 ì§€ì¶œ ê³¡ì„  ìµœì í™”</span>
                                </h2>

                                <div className="guide-card border-l-4 border-l-amber-500 flex gap-4 items-start mb-6">
                                    <div className="bg-amber-100 text-amber-600 p-3 rounded-lg flex-shrink-0"><i className="fa-solid fa-lightbulb text-xl"></i></div>
                                    <div className="text-[10px] sm:text-xs space-y-1">
                                        <h3 className="font-black text-amber-700 mb-1">ì§€ì¶œ ê³¡ì„  ì‹œë®¬ë ˆì´ì…˜ ì›ë¦¬ (U-Shape)</h3>
                                        <p className="text-slate-500 font-normal">â€¢ <strong>í™œë™ê¸°:</strong> ê¸°ë³¸ ìƒí™œë¹„ì˜ 110% ì§€ì¶œ / <strong>ì‡ í‡´ê¸°:</strong> 90% ìˆ˜ì¤€ í•˜ë½</p>
                                        <p className="text-slate-500 font-normal">â€¢ <strong>ê°„ë³‘ê¸°:</strong> ìƒí™œë¹„ 70% ê¸‰ê° + ì…ë ¥í•˜ì‹  <strong>ì˜ë£Œ/ê°„ë³‘ë¹„</strong> ì¶”ê°€ í•©ì‚°</p>
                                    </div>
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 font-bold">
                                    <div className="bg-white dark:bg-slate-800 p-5 rounded-xl border shadow-sm space-y-4">
                                        <h3 className="text-indigo-600 text-sm border-b pb-1 font-black"><i className="fa-solid fa-calendar-day mr-1"></i> 1. ì—°ë ¹ ë° ìˆ˜ë ¹ ì‹œê¸°</h3>
                                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                            <div className="flex flex-col"><label className="text-[10px] text-slate-500">ë³¸ì¸ í˜„ì¬ ë‚˜ì´</label><input type="number" className="sim-input" value={simInputs.currentAge} onChange={e=>setSimInputs({...simInputs, currentAge:parseInt(e.target.value)})}/></div>
                                            <div className="flex flex-col"><label className="text-[10px] text-slate-500">ë°°ìš°ì í˜„ì¬ ë‚˜ì´</label><input type="number" className="sim-input" value={simInputs.spouseCurrentAge} onChange={e=>setSimInputs({...simInputs, spouseCurrentAge:parseInt(e.target.value)})}/></div>
                                            <div className="flex flex-col"><label className="text-[10px] text-indigo-500 font-bold">ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘ë‚˜ì´</label><input type="number" className="sim-input border-indigo-300" value={simInputs.simulationStartAge} onChange={e=>setSimInputs({...simInputs, simulationStartAge:parseInt(e.target.value)})}/></div>
                                            <div className="flex flex-col"><label className="text-[10px] text-slate-500">ê°„ë³‘ê¸° ì „í™˜ ë‚˜ì´</label><input type="number" className="sim-input" value={simInputs.highCostStartAge} onChange={e=>setSimInputs({...simInputs, highCostStartAge:parseInt(e.target.value)})}/></div>
                                            <div className="flex flex-col"><label className="text-[10px] text-indigo-500 font-black">ì—°ê¸ˆ ìˆ˜ë ¹(ë³¸ì¸)</label><input type="number" className="sim-input border-indigo-300" value={simInputs.pensionStartAgeUser} onChange={e=>setSimInputs({...simInputs, pensionStartAgeUser:parseInt(e.target.value)})}/></div>
                                            <div className="flex flex-col"><label className="text-[10px] text-indigo-500 font-black">ì—°ê¸ˆ ìˆ˜ë ¹(ë°°ìš°ì)</label><input type="number" className="sim-input border-indigo-300" value={simInputs.pensionStartAgeSpouse} onChange={e=>setSimInputs({...simInputs, pensionStartAgeSpouse:parseInt(e.target.value)})}/></div>
                                        </div>
                                    </div>

                                    <div className="bg-white dark:bg-slate-800 p-5 rounded-xl border shadow-sm space-y-4">
                                        <h3 className="text-emerald-600 text-sm border-b pb-1 font-black"><i className="fa-solid fa-vault mr-1"></i> 2. ê¸°ì´ˆ ìì‚°(ì–µ) ë° ìˆ˜ìµë¥ (%)</h3>
                                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-x-2 gap-y-3">
                                            <div className="flex flex-col"><label className="text-[9px] text-blue-500">ë³¸ì¸ ì¼ë°˜(ì–µ)</label><input type="number" step="0.1" className="sim-input" value={simInputs.capUserNonISA} onChange={e=>setSimInputs({...simInputs, capUserNonISA:parseFloat(e.target.value)})}/></div>
                                            <div className="flex flex-col"><label className="text-[9px] text-blue-400">ìˆ˜ìµë¥ (%)</label><input type="number" step="0.1" className="sim-input" value={simInputs.returnUserNonISA} onChange={e=>setSimInputs({...simInputs, returnUserNonISA:parseFloat(e.target.value)})}/></div>
                                            <div className="flex flex-col"><label className="text-[9px] text-blue-500">ë°°ìš°ì ì¼ë°˜(ì–µ)</label><input type="number" step="0.1" className="sim-input" value={simInputs.capSpouseNonISA} onChange={e=>setSimInputs({...simInputs, capSpouseNonISA:parseFloat(e.target.value)})}/></div>
                                            <div className="flex flex-col"><label className="text-[9px] text-blue-400">ìˆ˜ìµë¥ (%)</label><input type="number" step="0.1" className="sim-input" value={simInputs.returnSpouseNonISA} onChange={e=>setSimInputs({...simInputs, returnSpouseNonISA:parseFloat(e.target.value)})}/></div>
                                            <div className="flex flex-col border-t pt-2"><label className="text-[9px] text-emerald-500">ë³¸ì¸ ISA(ì–µ)</label><input type="number" step="0.1" className="sim-input" value={simInputs.capUserISA} onChange={e=>setSimInputs({...simInputs, capUserISA:parseFloat(e.target.value)})}/></div>
                                            <div className="flex flex-col border-t pt-2"><label className="text-[9px] text-emerald-400">ìˆ˜ìµë¥ (%)</label><input type="number" step="0.1" className="sim-input" value={simInputs.returnUserISA} onChange={e=>setSimInputs({...simInputs, returnUserISA:parseFloat(e.target.value)})}/></div>
                                            <div className="flex col-span-1 border-t pt-2"><label className="text-[9px] text-emerald-500">ë°°ìš°ì ISA(ì–µ)</label><input type="number" step="0.1" className="sim-input" value={simInputs.capSpouseISA} onChange={e=>setSimInputs({...simInputs, capSpouseISA:parseFloat(e.target.value)})}/></div>
                                            <div className="flex col-span-1 border-t pt-2"><label className="text-[9px] text-emerald-400">ìˆ˜ìµë¥ (%)</label><input type="number" step="0.1" className="sim-input" value={simInputs.returnSpouseISA} onChange={e=>setSimInputs({...simInputs, returnSpouseISA:parseFloat(e.target.value)})}/></div>
                                        </div>
                                    </div>

                                    <div className="bg-white dark:bg-slate-800 p-5 rounded-xl border shadow-sm space-y-4">
                                        <h3 className="text-orange-600 text-sm border-b pb-1 font-black"><i className="fa-solid fa-chart-line mr-1"></i> 3. ë¬¼ê°€ ë° ì„¸ìœ¨ ì„¤ì •(%)</h3>
                                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                            <div className="flex flex-col"><label className="text-[10px] text-slate-500">ë¬¼ê°€ ìƒìŠ¹ë¥ </label><input type="number" step="0.1" className="sim-input" value={simInputs.inflationRate} onChange={e=>setSimInputs({...simInputs, inflationRate:parseFloat(e.target.value)})}/></div>
                                            <div className="flex flex-col"><label className="text-[10px] text-slate-500">ìƒí™œë¹„ ìƒìŠ¹ë¥ </label><input type="number" step="0.1" className="sim-input" value={simInputs.livingCostInflationRate} onChange={e=>setSimInputs({...simInputs, livingCostInflationRate:parseFloat(e.target.value)})}/></div>
                                            <div className="flex flex-col"><label className="text-[10px] text-red-500">ì„¸ìœ¨1(ê¸°ë³¸)</label><input type="number" step="0.1" className="sim-input" value={simInputs.taxRate1} onChange={e=>setSimInputs({...simInputs, taxRate1:parseFloat(e.target.value)})}/></div>
                                            <div className="flex flex-col"><label className="text-[10px] text-red-700">ì„¸ìœ¨2(ëˆ„ì§„)</label><input type="number" step="0.1" className="sim-input" value={simInputs.taxRate2} onChange={e=>setSimInputs({...simInputs, taxRate2:parseFloat(e.target.value)})}/></div>
                                        </div>
                                        <div className="flex flex-col border-t pt-3 mt-1">
                                            <label className="text-[10px] text-indigo-500 font-black">95ì„¸ ëª©í‘œ ì”ì•¡ (ìƒì† ë“±)</label>
                                            <input type="text" className="sim-input border-indigo-200" value={simInputs.targetLegacy} onChange={e=>handleCommaChange(e, v=>setSimInputs({...simInputs, targetLegacy:v}))}/>
                                        </div>
                                    </div>

                                    <div className="bg-white dark:bg-slate-800 p-5 rounded-xl border shadow-sm space-y-4">
                                        <h3 className="text-rose-600 text-sm border-b pb-1 font-black"><i className="fa-solid fa-money-check-dollar mr-1"></i> 4. ì›” ìˆ˜ì… ë° ì§€ì¶œ(ì›)</h3>
                                        <div className="flex flex-col">
                                            <label className="text-[11px] text-red-600 font-black">ê¸°ë³¸ ìƒí™œë¹„(ì›”)</label>
                                            <input type="text" className="sim-input text-right text-red-600" value={simInputs.monthlyLiving} onChange={e=>handleCommaChange(e, v=>setSimInputs({...simInputs, monthlyLiving:v}))}/>
                                        </div>
                                        <div className="flex flex-col bg-rose-50 dark:bg-rose-900/10 p-2 rounded">
                                            <label className="text-[10px] text-rose-500 font-black">ê°„ë³‘ê¸° ì˜ë£Œ/ê°„ë³‘ë¹„(ì›”)</label>
                                            <input type="text" className="sim-input !mt-1 !p-1 text-right text-rose-700" placeholder="0" value={simInputs.monthlyMedical} onChange={e=>handleCommaChange(e, v=>setSimInputs({...simInputs, monthlyMedical:v}))}/>
                                        </div>
                                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 pt-2">
                                            <div className="flex flex-col"><label className="text-[10px] text-slate-500">ë³¸ì¸ ì›” ì—°ê¸ˆ</label><input type="text" className="sim-input text-right" value={simInputs.pensionSelf} onChange={e=>handleCommaChange(e, v=>setSimInputs({...simInputs, pensionSelf: v}))}/></div>
                                            <div className="flex flex-col"><label className="text-[10px] text-slate-500">ë°°ìš°ì ì›” ì—°ê¸ˆ</label><input type="text" className="sim-input text-right" value={simInputs.pensionSpouse} onChange={e=>handleCommaChange(e, v=>setSimInputs({...simInputs, pensionSpouse: v}))}/></div>
                                        </div>
                                    </div>

                                    <div className="bg-white dark:bg-slate-800 p-5 rounded-xl border shadow-sm space-y-4">
                                        <h3 className="text-blue-600 text-sm border-b pb-1 font-black"><i className="fa-solid fa-hand-holding-dollar mr-1"></i> 5. ê¸°íƒ€ ì—°ê°„ ìˆ˜ì…(ì›)</h3>
                                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                            <div className="flex flex-col"><label className="text-[10px] text-slate-500">ê³µëª¨ì£¼ ìˆ˜ìµ</label><input type="text" className="sim-input text-right" value={simInputs.ipoProfit} onChange={e=>handleCommaChange(e, v=>setSimInputs({...simInputs, ipoProfit: v}))}/></div>
                                            <div className="flex flex-col"><label className="text-[10px] text-slate-500">ì„ëŒ€ ì†Œë“</label><input type="text" className="sim-input text-right" value={simInputs.rentalIncome} onChange={e=>handleCommaChange(e, v=>setSimInputs({...simInputs, rentalIncome: v}))}/></div>
                                            <div className="flex flex-col"><label className="text-[10px] text-slate-500">ê¸°íƒ€ ì‚¬ì—…</label><input type="text" className="sim-input text-right" value={simInputs.otherIncome} onChange={e=>handleCommaChange(e, v=>setSimInputs({...simInputs, otherIncome: v}))}/></div>
                                            <div className="flex flex-col"><label className="text-[10px] text-slate-500">ëŒ€ì—¬ ìˆ˜ìˆ˜ë£Œ</label><input type="text" className="sim-input text-right" value={simInputs.stockLending} onChange={e=>handleCommaChange(e, v=>setSimInputs({...simInputs, stockLending: v}))}/></div>
                                        </div>
                                        <div className="flex flex-col border-t pt-2">
                                            <label className="text-[10px] text-slate-500">ì—°ê°„ ë¹„ìƒê¸ˆ</label>
                                            <input type="text" className="sim-input text-right" value={simInputs.extraReserve} onChange={e=>handleCommaChange(e, v=>setSimInputs({...simInputs, extraReserve: v}))}/>
                                        </div>
                                    </div>

                                    <div className={`${simResult.summary?.isSuccess ? 'bg-indigo-600' : 'bg-rose-600'} text-white p-5 rounded-xl shadow-lg flex flex-col justify-center text-center transition-colors duration-500 h-full`}>
                                        <p className="text-xs opacity-80 mb-2">95ì„¸ ì˜ˆì¸¡ ìì‚°</p>
                                        <h3 className={`text-xl sm:text-2xl font-black ${simResult.summary?.depletion ? 'text-yellow-300' : 'text-white'}`}>
                                            {simResult.summary?.depletion ? `${simResult.summary.depletion}ì„¸ ìì‚° ê³ ê°ˆ` : formatNumber(simResult.summary?.final) + 'ì›'}
                                        </h3>
                                        <div className="mt-3 py-1 px-3 bg-white/20 rounded-full text-[10px] inline-block mx-auto font-black">
                                            {simResult.summary?.isSuccess ? "âœ… ëª©í‘œ ë‹¬ì„± ì„±ê³µ" : "âš ï¸ ëª©í‘œ ë¯¸ë‹¬ (ì¡°ì • í•„ìš”)"}
                                        </div>
                                    </div>
                                </div>

                                <div className="mt-6 bg-white dark:bg-slate-800 p-6 rounded-xl border shadow-sm h-[350px] sm:h-[450px]">
                                    <SimulationChart history={simResult.history} />
                                </div>

                                <div className="mt-6 bg-white dark:bg-slate-800 p-4 rounded-xl border shadow-sm overflow-x-auto">
                                    <h3 className="text-sm font-black mb-4"><i className="fa-solid fa-table mr-2"></i>ì—°ë ¹ë³„ ìƒì„¸ ë‚´ì—­ (ê°€ë¡œ ìŠ¤í¬ë¡¤ ê°€ëŠ¥)</h3>
                                    <table className="w-full text-[10px] text-left border-collapse min-w-[900px]">
                                        <thead className="bg-slate-50 dark:bg-slate-900">
                                            <tr>
                                                <th className="p-2 border-b">ë‚˜ì´</th>
                                                <th className="p-2 border-b">ì´ìì‚°(ì–µ)</th>
                                                <th className="p-2 border-b text-indigo-500">í•©ê³„ ìˆ˜ìµ(ì›)</th>
                                                <th className="p-2 border-b text-rose-500 text-center">ì¦ê°ë¶„(ì›)</th>
                                                <th className="p-2 border-b text-center">ê³„ì¢Œë³„ ìì‚°(ì–µ)</th>
                                                <th className="p-2 border-b text-right text-rose-600">ì´ ì§€ì¶œ(ì›)</th>
                                                <th className="p-2 border-b text-center">ìƒíƒœ</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {simResult.history.map((h, idx) => (
                                                <tr key={idx} className={`hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors ${h.isWarn ? 'bg-rose-50/50 dark:bg-rose-900/5' : ''}`}>
                                                    <td className="p-2 border-b font-medium">{h.age}ì„¸</td>
                                                    <td className={`p-2 border-b font-black ${h.isWarn ? 'text-rose-600' : 'text-indigo-600'}`}>{h.total.toFixed(2)}</td>
                                                    <td className="p-2 border-b text-indigo-600 font-black num-font">{formatNumber(h.annualProfit)}</td>
                                                    <td className={`p-2 border-b text-center font-bold num-font ${h.netChange >= 0 ? 'text-emerald-600' : 'text-rose-500'}`}>
                                                        {h.netChange >= 0 ? '+' : ''}{formatNumber(h.netChange)}
                                                    </td>
                                                    <td className="p-2 border-b">
                                                        <div className="flex justify-center gap-2 text-[8px] opacity-80 font-bold">
                                                            <span>ì¼ë°˜:{ (h.un + h.sn).toFixed(1) }</span>
                                                            <span className="text-emerald-600">ISA:{ (h.ui + h.si).toFixed(1) }</span>
                                                        </div>
                                                    </td>
                                                    <td className="p-2 border-b num-font text-rose-600 font-bold text-right">{formatNumber(h.tax + h.living)}</td>
                                                    <td className="p-2 border-b text-center">
                                                        <span className={`px-1.5 py-0.5 rounded-sm text-[8px] font-black ${h.isHighCost ? 'bg-rose-100 text-rose-600' : 'bg-slate-100 text-slate-500'}`}>
                                                            {h.isHighCost ? 'ê°„ë³‘' : 'í™œë™'}
                                                        </span>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}
                        {activeTab === 'tax' && renderFinancialTax()}
                    </main>
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>