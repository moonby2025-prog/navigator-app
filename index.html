<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investment Navigator (íˆ¬ì ë¹„ì„œ)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome (Icons) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <!-- React, ReactDOM, Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; letter-spacing: -0.02em; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        .nav-tab.active { background-color: #eff6ff; color: #2563eb; font-weight: 700; box-shadow: 0 1px 2px rgba(37,99,235,0.2); }
        .dark .nav-tab.active { background-color: #1e293b; color: #60a5fa; }
        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .sim-input { @apply mt-1 block w-full rounded-md border-gray-300 dark:border-slate-600 shadow-sm p-2 border dark:bg-slate-700 focus:ring-indigo-500 focus:border-indigo-500 text-sm font-bold; }
        .num-font { font-variant-numeric: tabular-nums; }
        .guide-card { @apply p-4 rounded-xl border border-slate-100 dark:border-slate-700 bg-white dark:bg-slate-800 shadow-sm; }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-900 transition-colors duration-200">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, memo, useCallback } = React;

        // --- Global Constants ---
        const ONE_HUNDRED_MILLION = 100000000;
        const TAX_THRESHOLD = 20000000;
        
        const DEFAULT_EXCHANGE_RATES = { 
            'KRW': { krw: 1 }, 
            'USD': { krw: 1380 }, 
            'JPY': { krw: 8.90 }, 
            'EUR': { krw: 1480 }, 
            'CNY': { krw: 190 }, 
            'ARS': { krw: 1.35 }, 
            'INR': { krw: 16.5 }
        };

        // --- Helpers ---
        const formatNumber = (num) => {
            if (num === null || num === undefined || isNaN(num)) return '0';
            return Math.round(num).toLocaleString('ko-KR');
        };
        const parseFormattedNumber = (value) => {
            if (typeof value !== 'string') return value || 0;
            return parseInt(value.replace(/[^0-9]/g, '')) || 0;
        };

        const calculateProgressiveIncomeTax = (income, rates) => {
            if (income <= 0) return 0;
            const threshold1 = 40000000;
            const threshold2 = 80000000;
            let tax = 0;
            const income1 = Math.min(income, threshold1);
            tax += income1 * (rates.rate1 / 100);
            if (income > threshold1) {
                const income2 = Math.min(income, threshold2) - threshold1;
                tax += income2 * (rates.rate2 / 100);
            }
            if (income > threshold2) {
                const income3 = income - threshold2;
                tax += income3 * (rates.rate3 / 100);
            }
            return Math.max(0, tax);
        };

        // --- Widgets ---
        const TradingViewTicker = memo(({ theme }) => {
            const containerRef = useRef(null);
            useEffect(() => {
                if (!containerRef.current) return;
                containerRef.current.innerHTML = '';
                const innerContainer = document.createElement('div');
                innerContainer.className = 'tradingview-widget-container';
                const widgetDiv = document.createElement('div');
                widgetDiv.className = 'tradingview-widget-container__widget';
                innerContainer.appendChild(widgetDiv);
                const script = document.createElement('script');
                script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-ticker-tape.js';
                script.async = true;
                script.innerHTML = JSON.stringify({
                    "symbols": [
                        { "proName": "FOREXCOM:SPXUSD", "title": "S&P 500" },
                        { "proName": "NASDAQ:QQQ", "title": "ë‚˜ìŠ¤ë‹¥ QQQ" },
                        { "proName": "FX_IDC:USDKRW", "title": "ì›ë‹¬ëŸ¬ í™˜ìœ¨" },
                        { "proName": "FX_IDC:XAGUSD", "title": "ì€ í˜„ë¬¼ (XAG/USD)" },
                        { "proName": "BINANCE:BTCUSDT", "title": "ë¹„íŠ¸ì½”ì¸" },
                        { "proName": "TVC:GOLD", "title": "ê¸ˆ í˜„ë¬¼ (XAU/USD)" },
                        { "proName": "NASDAQ:NVDA", "title": "ì—”ë¹„ë””ì•„" },
                        { "proName": "NASDAQ:TSLA", "title": "í…ŒìŠ¬ë¼" },
                        { "proName": "FX_IDC:JPYKRW", "title": "ì—”í™” í™˜ìœ¨" },
                        { "proName": "KRX:005930", "title": "ì‚¼ì„±ì „ì" }
                    ],
                    "showSymbolLogo": true,
                    "colorTheme": theme,
                    "isTransparent": true,
                    "displayMode": "adaptive",
                    "locale": "kr"
                });
                innerContainer.appendChild(script);
                containerRef.current.appendChild(innerContainer);
            }, [theme]);
            return <div ref={containerRef} className="w-full h-full"></div>;
        });

        const TradingViewHeatmap = memo(({ theme }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (!ref.current) return;
                ref.current.innerHTML = '';
                const script = document.createElement('script');
                script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-stock-heatmap.js';
                script.async = true;
                script.innerHTML = JSON.stringify({
                    "dataSource": "SPX500", "grouping": "sector", "blockSize": "market_cap_basic", "blockColor": "change", "locale": "kr", "colorTheme": theme, "hasTopBar": false, "isTransparent": true, "width": "100%", "height": "100%"
                });
                ref.current.appendChild(script);
            }, [theme]);
            return <div ref={ref} className="h-full"></div>;
        });

        // --- Main Component ---
        function App() {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [isDark, setIsDark] = useState(false);
            const [linkMode, setLinkMode] = useState('investment');
            const [marketStatus, setMarketStatus] = useState({ text: 'ì¥ ë§ˆê°', color: 'bg-red-600' });
            
            const [exchangeRates, setExchangeRates] = useState(DEFAULT_EXCHANGE_RATES);
            const [lastUpdated, setLastUpdated] = useState('ì—°ê²° ì¤‘...');
            const [isFetching, setIsFetching] = useState(false);

            const [isRoutineEditMode, setIsRoutineEditMode] = useState(false);
            const [newFav, setNewFav] = useState({ name: '', code: '' });
            const [newRoutine, setNewRoutine] = useState({ category: '', name: '', url: '' });

            const [favorites, setFavorites] = useState([
                { code: "005930", name: "ì‚¼ì„±ì „ì" }, { code: "005380", name: "í˜„ëŒ€ì°¨" }, 
                { code: "237690", name: "ì—ìŠ¤í‹°íŒœ" }, { code: "445680", name: "íë¦¬ì˜¥ìŠ¤" }
            ]);

            const [routineLinks, setRoutineLinks] = useState({
                "ğŸŒ… ì•„ì¹¨ í•„ìˆ˜ ì²´í¬ (Morning Routine)": [
                    { name: "ë¯¸êµ­ ì‹œì¥ ì ê²€", url: "https://kr.investing.com/portfolio/?portfolioID=OT4%2BZDRrZTFjM2thYTthYg%3D%3D", icon: "fa-list-check", color: "bg-blue-100 text-blue-700" },
                    { name: "Finviz (ë¯¸êµ­ ë§µ)", url: "https://finviz.com/map.ashx", icon: "fa-map", color: "bg-emerald-100 text-emerald-700" },
                    { name: "í•„ë¼ë¸í”¼ì•„ ë°˜ë„ì²´", url: "https://kr.investing.com/indices/phlx-semiconductor", icon: "fa-microchip", color: "bg-teal-100 text-teal-700" },
                    { name: "ê³µí¬ íƒìš• ì§€ìˆ˜ (CNN)", url: "https://edition.cnn.com/markets/fear-and-greed", icon: "fa-gauge-high", color: "bg-orange-100 text-orange-700" },
                    { name: "í¬ë¦½í†  ì§€í‘œ (MVRV)", url: "https://www.bitcoinmagazinepro.com/charts/mvrv-zscore/", icon: "fa-chart-area", color: "bg-amber-100 text-amber-700" },
                    { name: "SILVER (ì€ ì‹¤ì‹œê°„)", url: "https://kr.investing.com/currencies/xag-usd", icon: "fa-coins", color: "bg-slate-100 text-slate-700" },
                    { name: "ì€ì‹œì„¸(ìˆœìˆ˜í•œê¸ˆ)", url: "https://blog.naver.com/wolfkickbox", icon: "fa-blog", color: "bg-yellow-100 text-yellow-700" }
                ],
                "ğŸ’° ê³µëª¨ì£¼ & ì‹¤ì  (IPO & Earnings)": [
                    { name: "38 ì»¤ë®¤ë‹ˆì¼€ì´ì…˜", url: "http://www.38.co.kr/html/fund/index.htm?gjbcd=1460", icon: "fa-building", color: "bg-purple-100 text-purple-700" },
                    { name: "DART (ì „ìê³µì‹œ)", url: "https://dart.fss.or.kr/", icon: "fa-file-signature", color: "bg-yellow-100 text-yellow-700" },
                    { name: "KIND (ê¸°ì—…ê³µì‹œ)", url: "https://kind.krx.co.kr/", icon: "fa-file-invoice", color: "bg-blue-50 text-blue-600" },
                    { name: "KRX ì •ë³´ë°ì´í„°ì‹œìŠ¤í…œ", url: "http://data.krx.co.kr/", icon: "fa-database", color: "bg-indigo-100 text-indigo-700" },
                    { name: "Seibro (ì¦ê¶Œì •ë³´í¬í„¸)", url: "https://seibro.or.kr/", icon: "fa-server", color: "bg-indigo-50 text-indigo-600" },
                    { name: "ì¢…ëª©ë³„ ì™¸êµ­ì¸ êµ­ì ë¶„ë¥˜", url: "https://data.krx.co.kr/contents/MDC/HARD/hardController/MDCHARD053.cmd", icon: "fa-globe", color: "bg-blue-50 text-blue-700" }
                ],
                "ğŸ“ˆ êµ­ë‚´ ì‹œì¥ ì‹¬ì¸µ (Korea Market)": [
                    { name: "ë„¤ì´ë²„ ê¸ˆìœµ", url: "https://finance.naver.com/", icon: "fa-n", color: "bg-green-50 text-green-600" },
                    { name: "ë²„í‹€ëŸ¬ (Butler)", url: "https://www.butler.works/ko/home", icon: "fa-chart-line", color: "bg-purple-50 text-purple-600" },
                    { name: "í•œê²½ ì»¨ì„¼ì„œìŠ¤", url: "https://markets.hankyung.com/consensus", icon: "fa-book-open", color: "bg-red-50 text-red-600" },
                    { name: "SMIC (ì„œìš¸ëŒ€ ë¦¬ì„œì¹˜)", url: "http://snusmic.com/research/", icon: "fa-graduation-cap", color: "bg-slate-200 text-slate-800" },
                    { name: "FDA ìŠ¹ì¸ ì‹¤ì‹œê°„", url: "https://www.youtube.com/user/USFoodandDrugAdmin", icon: "fa-video", color: "bg-red-100 text-red-700" },
                    { name: "ì£¼ì‹/ë¶€ë™ì‚° ëª¨ì•„ë´", url: "http://moabbs.com/blogs/lists", icon: "fa-users", color: "bg-orange-100 text-orange-700" },
                    { name: "ì „ìì¡ì§€ (ëª¨ì•„ì§„)", url: "https://lib.ice.go.kr/elib/module/elib/moazine.do?menu_idx=37", icon: "fa-book-open", color: "bg-yellow-100 text-yellow-700" }
                ],
                "ğŸ¡ ì¼ìƒ & ë¶€ë™ì‚° (Daily Life)": [
                    { name: "í˜¸ê°±ë…¸ë…¸", url: "https://hogangnono.com/", icon: "fa-map-pin", color: "bg-red-50 text-red-600" },
                    { name: "ë„¤ì´ë²„ ë¶€ë™ì‚°", url: "https://land.naver.com/", icon: "fa-building", color: "bg-green-50 text-green-600" },
                    { name: "ë„¤ì´ë²„ ì§€ë„", url: "https://map.naver.com/", icon: "fa-location-dot", color: "bg-blue-50 text-blue-600" },
                    { name: "êµ¬ê¸€ ì§€ë„", url: "https://maps.google.com/", icon: "fa-location-dot", color: "bg-amber-50 text-amber-600" }
                ]
            });

            const [blogInsightLinks, setBlogInsightLinks] = useState({
                "ğŸ§¬ íë¦¬ì˜¥ìŠ¤ë°”ì´ì˜¤ì‹œìŠ¤í…œì¦ˆ": [
                    {name: "í•œê³„ë¥¼ ê¹¨ëŠ” ì‚¬ëŒ", url: "https://blog.naver.com/unlimitedi"},
                    {name: "ë‚˜ëŠ” ì „ì„¤ì´ë‹¤", url: "https://blog.naver.com/legendyu"},
                    {name: "ì´ê³µê³„", url: "https://blog.naver.com/shyny38"},
                    {name: "ê³µëŒ€ìƒ ì£¼ì ‘ë…¸íŠ¸", url: "https://blog.naver.com/b_g-duck"}
                ],
                "ğŸ’Š ì—ìŠ¤í‹°íŒœ": [
                    {name: "ì˜¤ì¬ë³µ", url: "https://blog.naver.com/hym090206"},
                    {name: "ì™ ì§€ìƒì¾Œí•œì‚¬ëŒ", url: "https://blog.naver.com/aphorism86"},
                    {name: "Chan", url: "https://blog.naver.com/chany2do"}
                ]
            });

            const [targetInputs, setTargetInputs] = useState({ mode: 'cap', price: '', shares: '', currentCap: '', targetCap: '', targetRate: '' });
            const [ipoCalcInputs, setIpoCalcInputs] = useState({ price: '', qty: '', fee: '', rate: 50 });
            const [avgRows, setAvgRows] = useState([{ id: 1, q: '', p: '' }]);
            const [exchInputs, setExchInputs] = useState({ base: 'USD', target: 'KRW', amount: '' });
            const [divInputs, setDivInputs] = useState({ shares: '', perShare: '', tax: '15.4' });
            const [toolTaxInputs, setToolTaxInputs] = useState({ profit: '', type: 'dividend' });

            const [simInputs, setSimInputs] = useState({
                currentAge: 51, spouseCurrentAge: 47, simulationStartAge: 53, 
                pensionStartAgeUser: 65, pensionStartAgeSpouse: 65,
                highCostStartAge: 80,
                capUserNonISA: 3.0, capSpouseNonISA: 2.0, capUserISA: 3.0, capSpouseISA: 2.0, 
                returnUserNonISA: 3.0, returnSpouseNonISA: 3.0, 
                returnUserISA: 3.0, returnSpouseISA: 3.0, 
                inflationRate: 2.0, livingCostInflationRate: 1.5, taxRate1: 6.6, taxRate2: 16.5, taxRate3: 27.5,
                monthlyLiving: "5,000,000", pensionSelf: "1,000,000", pensionSpouse: "600,000", ipoProfit: "5,000,000", otherIncome: "4,500,000", stockLending: "0", rentalIncome: "850,000",
                targetLegacy: "200,000,000", extraReserve: "5,000,000"
            });
            const [simResult, setSimResult] = useState({ history: [], summary: null });
            
            const [finList, setFinList] = useState([]);
            const [otherIncomeList, setOtherIncomeList] = useState([]);

            const handleCommaChange = (e, callback) => {
                const val = e.target.value.replace(/[^0-9]/g, '');
                callback(val ? parseInt(val).toLocaleString('ko-KR') : '');
            };

            const fetchRealTimeRates = useCallback(async () => {
                setIsFetching(true);
                try {
                    const response = await fetch('https://open.er-api.com/v6/latest/KRW');
                    const data = await response.json();
                    if (data.result === 'success') {
                        const rates = data.rates;
                        const newRates = {
                            'KRW': { krw: 1 }, 
                            'USD': { krw: 1 / (rates.USD || 0.00072) }, 
                            'JPY': { krw: 1 / (rates.JPY || 0.11) },
                            'EUR': { krw: 1 / (rates.EUR || 0.00067) }, 
                            'CNY': { krw: 1 / (rates.CNY || 0.0052) },
                            'ARS': { krw: 1 / (rates.ARS || 0.65) }, 
                            'INR': { krw: 1 / (rates.INR || 0.06) }
                        };
                        setExchangeRates(newRates);
                        setLastUpdated(new Date().toLocaleString());
                    }
                } catch (error) {
                    console.error("í™˜ìœ¨ ë¡œë“œ ì‹¤íŒ¨:", error);
                    setLastUpdated("ì‹¤íŒ¨ (ê¸°ë³¸ê°’ ì‚¬ìš©)");
                } finally { setIsFetching(false); }
            }, []);

            useEffect(() => {
                fetchRealTimeRates();
                const timer = setInterval(() => {
                    const now = new Date();
                    const hours = now.getHours();
                    const day = now.getDay();
                    let status = { text: "ì¥ ë§ˆê°", color: "bg-red-600" };
                    if (hours >= 9 && hours < 16 && day !== 0 && day !== 6) status = { text: "êµ­ë‚´ ì¥ ìš´ì˜", color: "bg-green-600" };
                    else if (hours >= 22 || hours < 6) status = { text: "ë¯¸êµ­ ì¥ ìš´ì˜", color: "bg-blue-600" };
                    setMarketStatus(status);
                }, 1000);
                return () => clearInterval(timer);
            }, [fetchRealTimeRates]);

            useEffect(() => {
                if (isDark) document.documentElement.classList.add('dark');
                else document.documentElement.classList.remove('dark');
            }, [isDark]);

            const searchSymbol = (query) => {
                if(!query) return;
                const url = /[a-zA-Z]/.test(query) ? `https://finance.naver.com/world/sise.naver?symbol=${query.trim().toUpperCase()}` : `https://finance.naver.com/item/main.naver?code=${query.trim()}`;
                window.open(url, '_blank');
            };

            const runSimulation = useCallback(() => {
                const s = simInputs;
                const ageDiff = s.currentAge - s.spouseCurrentAge;
                let cUserNon = s.capUserNonISA * ONE_HUNDRED_MILLION;
                let cSpouseNon = s.capSpouseNonISA * ONE_HUNDRED_MILLION;
                let cUserISA = s.capUserISA * ONE_HUNDRED_MILLION;
                let cSpouseISA = s.capSpouseISA * ONE_HUNDRED_MILLION;
                
                const targetLegacyValue = parseFormattedNumber(s.targetLegacy);
                const extraReserveValue = parseFormattedNumber(s.extraReserve);
                
                const initLiving = parseFormattedNumber(s.monthlyLiving) * 12;
                const initPenSelf = parseFormattedNumber(s.pensionSelf) * 12;
                const initPenSpouse = parseFormattedNumber(s.pensionSpouse) * 12;
                const initOtherTotal = parseFormattedNumber(s.ipoProfit) + parseFormattedNumber(s.otherIncome) + parseFormattedNumber(s.stockLending) + parseFormattedNumber(s.rentalIncome);
                let history = []; let totalTax = 0; let depletionYear = null;
                const period = Math.max(1, 95 - s.simulationStartAge);
                
                for (let year = 1; year <= period; year++) {
                    const age = s.simulationStartAge + year - 1;
                    const spouseAge = age - ageDiff;
                    const pInf = Math.pow(1 + (s.inflationRate / 100), year - 1);
                    const lInf = Math.pow(1 + (s.livingCostInflationRate / 100), year - 1);
                    
                    let weight = 1.0;
                    let isHighCost = false;
                    if (age >= Math.min(s.pensionStartAgeUser, s.pensionStartAgeSpouse)) {
                        if (age < s.highCostStartAge - 5) weight = 1.1; 
                        else if (age < s.highCostStartAge) weight = 0.9; 
                        else { weight = 1.2; isHighCost = true; }
                    }
                    
                    const livingCost = (initLiving * lInf * weight) + extraReserveValue;
                    let pension = 0;
                    if (age >= s.pensionStartAgeUser) pension += initPenSelf; 
                    if (spouseAge >= s.pensionStartAgeSpouse) pension += initPenSpouse;
                    
                    const baseIncomeAtYear = (pension + initOtherTotal) * pInf;
                    
                    const profUserNon = cUserNon * (s.returnUserNonISA / 100) * 0.846;
                    const profSpouseNon = cSpouseNon * (s.returnSpouseNonISA / 100) * 0.846;
                    const profUserISA = cUserISA * (s.returnUserISA / 100) * 0.901;
                    const profSpouseISA = cSpouseISA * (s.returnSpouseISA / 100) * 0.901;
                    const profInvestmentTotal = profUserNon + profSpouseNon + profUserISA + profSpouseISA;
                    
                    const incTax = calculateProgressiveIncomeTax(baseIncomeAtYear, { rate1: s.taxRate1, rate2: s.taxRate2, rate3: s.taxRate3 });
                    totalTax += incTax;

                    const annualProfitTotal = profInvestmentTotal + baseIncomeAtYear;
                    const annualExpenseTotal = livingCost + incTax;
                    const netChange = annualProfitTotal - annualExpenseTotal;

                    let withdrawal = netChange < 0 ? Math.abs(netChange) : 0;
                    if (netChange >= 0) {
                        const tBefore = cUserNon + cSpouseNon + cUserISA + cSpouseISA;
                        if (tBefore > 0) {
                            const r1 = cUserNon / tBefore; const r2 = cSpouseNon / tBefore; const r3 = cUserISA / tBefore; const r4 = cSpouseISA / tBefore;
                            cUserNon += netChange * r1; cSpouseNon += netChange * r2; cUserISA += netChange * r3; cSpouseISA += netChange * r4;
                        } else {
                            cUserNon += netChange;
                        }
                    } else {
                        let rem = withdrawal;
                        let w1 = Math.min(rem, cUserNon); cUserNon -= w1; rem -= w1;
                        let w2 = Math.min(rem, cSpouseNon); cSpouseNon -= w2; rem -= w2;
                        let w3 = Math.min(rem, cSpouseISA); cSpouseISA -= w3; rem -= w3;
                        let w4 = Math.min(rem, cUserISA); cUserISA -= w4; rem -= w4;
                        if (rem > 0 && !depletionYear) depletionYear = age;
                    }

                    const currentTotal = cUserNon + cSpouseNon + cUserISA + cSpouseISA;

                    history.push({ 
                        age, 
                        total: currentTotal / ONE_HUNDRED_MILLION, 
                        tax: incTax, 
                        living: livingCost, 
                        profInvestment: profInvestmentTotal,
                        baseIncome: baseIncomeAtYear,
                        annualProfit: annualProfitTotal,
                        netChange: netChange,
                        un: cUserNon/ONE_HUNDRED_MILLION, 
                        sn: cSpouseNon/ONE_HUNDRED_MILLION, 
                        ui: cUserISA/ONE_HUNDRED_MILLION, 
                        si: cSpouseISA/ONE_HUNDRED_MILLION,
                        isHighCost,
                        isWarn: currentTotal < targetLegacyValue 
                    });
                    
                    if (currentTotal <= 0 && year > 1) break;
                }
                setSimResult({ history, summary: { initial: s.capUserNonISA + s.capSpouseNonISA + s.capUserISA + s.capSpouseISA, final: (history[history.length-1]?.total * ONE_HUNDRED_MILLION) || 0, tax: totalTax, depletion: depletionYear, isSuccess: (history[history.length-1]?.total * ONE_HUNDRED_MILLION) >= targetLegacyValue } });
            }, [simInputs]);

            useEffect(() => { runSimulation(); }, [runSimulation]);

            const SimulationChart = memo(({ history }) => {
                const canvasRef = useRef(null);
                const chartInstance = useRef(null);
                useEffect(() => {
                    if (!canvasRef.current || history.length === 0) return;
                    const ctx = canvasRef.current.getContext('2d');
                    if (chartInstance.current) chartInstance.current.destroy();
                    chartInstance.current = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: history.map(h => h.age + "ì„¸"),
                            datasets: [
                                { label: 'ì´ ìì‚°(ì–µ)', data: history.map(h => h.total), borderColor: '#4f46e5', fill: true, backgroundColor: 'rgba(79, 70, 229, 0.1)', tension: 0.3, pointRadius: 2 },
                                { label: 'ë³¸ì¸ ì¼ë°˜', data: history.map(h => h.un), borderColor: '#ef4444', borderDash: [2,2], pointRadius: 0 },
                                { label: 'ë°°ìš°ì ì¼ë°˜', data: history.map(h => h.sn), borderColor: '#f59e0b', borderDash: [2,2], pointRadius: 0 },
                                { label: 'ë³¸ì¸ ISA', data: history.map(h => h.ui), borderColor: '#10b981', pointRadius: 0 },
                                { label: 'ë°°ìš°ì ISA', data: history.map(h => h.si), borderColor: '#3b82f6', pointRadius: 0 }
                            ]
                        },
                        options: { 
                            responsive: true, maintainAspectRatio: false, animation: false,
                            scales: { y: { beginAtZero: true } },
                            plugins: { legend: { position: 'top', labels: { boxWidth: 10, font: { size: 10, weight: 'bold' } } } }
                        }
                    });
                    return () => { if (chartInstance.current) chartInstance.current.destroy(); };
                }, [history]);
                return <div className="h-64 md:h-80 w-full"><canvas ref={canvasRef}></canvas></div>;
            });

            // --- Other Tab Handlers ---
            const addFavorite = () => { if (!newFav.name || !newFav.code) return; setFavorites([...favorites, { name: newFav.name, code: newFav.code }]); setNewFav({ name: '', code: '' }); };
            const removeFavorite = (code) => { setFavorites(favorites.filter(f => f.code !== code)); };
            const addRoutineLink = () => { if (!newRoutine.category || !newRoutine.name || !newRoutine.url) return; const updated = { ...routineLinks }; updated[newRoutine.category] = [...updated[newRoutine.category], { name: newRoutine.name, url: newRoutine.url, icon: "fa-link", color: "bg-slate-100 text-slate-700" }]; setRoutineLinks(updated); setNewRoutine({ category: '', name: '', url: '' }); };
            const removeRoutineLink = (category, index) => { const updated = { ...routineLinks }; updated[category] = updated[category].filter((_, i) => i !== index); setRoutineLinks(updated); };

            const renderDashboard = () => (
                <div className="space-y-6 animate-fade-in pb-10">
                    <div className="bg-white dark:bg-slate-800 rounded-xl shadow h-16 overflow-hidden border dark:border-slate-700">
                        <TradingViewTicker theme={isDark ? 'dark' : 'light'} />
                    </div>
                    <div className="bg-white dark:bg-slate-800 p-1 rounded-xl shadow h-[400px] border dark:border-slate-700 flex flex-col">
                        <div className="p-3 border-b dark:border-slate-700 flex justify-between items-center font-bold">
                            <span>S&P 500 íˆíŠ¸ë§µ</span>
                            <span className={`px-2 py-0.5 rounded-full text-[10px] text-white ${marketStatus.color}`}>{marketStatus.text}</span>
                        </div>
                        <div className="flex-1 overflow-hidden">
                            <TradingViewHeatmap theme={isDark ? 'dark' : 'light'} />
                        </div>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div className="bg-white dark:bg-slate-800 rounded-xl shadow border p-5 font-bold">
                            <h3 className="text-xl font-bold mb-4 flex items-center gap-2 text-indigo-500"><i className="fa-solid fa-magnifying-glass-chart"></i> ì¢…ëª© ê²€ìƒ‰</h3>
                            <div className="flex gap-2 mb-4">
                                <input type="text" id="mainSearch" placeholder="ì¢…ëª©ëª… ë˜ëŠ” ì½”ë“œ" className="flex-1 p-3 border-2 border-indigo-200 rounded-lg dark:bg-slate-700 outline-none" onKeyPress={e=>e.key==='Enter'&&searchSymbol(e.target.value)} />
                                <button onClick={() => searchSymbol(document.getElementById('mainSearch').value)} className="bg-indigo-600 text-white px-6 rounded-lg font-bold">ê²€ìƒ‰</button>
                            </div>
                            <div className="flex flex-wrap gap-2 mb-6">
                                {favorites.map(s => (
                                    <div key={s.code} className="flex items-center group">
                                        <button onClick={() => searchSymbol(s.code)} className="px-3 py-1.5 bg-slate-50 dark:bg-slate-700 border border-r-0 rounded-l-lg text-xs hover:border-indigo-400 group-hover:border-indigo-400">
                                            {s.name}
                                        </button>
                                        <button onClick={() => removeFavorite(s.code)} className="px-2 py-1.5 bg-slate-50 dark:bg-slate-700 border rounded-r-lg text-[10px] text-red-400 hover:text-red-600 hover:border-indigo-400 group-hover:border-indigo-400">
                                            <i className="fa-solid fa-xmark"></i>
                                        </button>
                                    </div>
                                ))}
                            </div>
                            <div className="p-4 bg-slate-50 dark:bg-slate-900 rounded-xl border-2 border-dashed border-slate-200 dark:border-slate-700">
                                <h4 className="text-xs text-indigo-500 mb-2 font-black">ìƒˆ ì¦ê²¨ì°¾ê¸° ì¶”ê°€</h4>
                                <div className="flex gap-2">
                                    <input type="text" placeholder="ì¢…ëª©ëª…" className="flex-1 sim-input !mt-0 !p-1 text-xs" value={newFav.name} onChange={e=>setNewFav({...newFav, name:e.target.value})} />
                                    <input type="text" placeholder="ì½”ë“œ" className="w-24 sim-input !mt-0 !p-1 text-xs" value={newFav.code} onChange={e=>setNewFav({...newFav, code:e.target.value})} />
                                    <button onClick={addFavorite} className="bg-indigo-600 text-white px-3 rounded text-xs font-black">ì¶”ê°€</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );

            const renderRoutine = () => (
                <div className="space-y-6 animate-fade-in pb-10">
                    <div className="flex justify-between items-center pb-4 border-b dark:border-slate-700 font-bold">
                        <div className="flex items-center gap-4">
                            <h2 className="text-2xl font-black">ì˜¤ëŠ˜ì˜ ë£¨í‹´</h2>
                            <button onClick={() => setIsRoutineEditMode(!isRoutineEditMode)} className={`px-3 py-1 rounded text-xs transition-all ${isRoutineEditMode ? 'bg-indigo-600 text-white shadow-lg' : 'bg-slate-200 dark:bg-slate-700 text-slate-500'}`}>
                                <i className="fa-solid fa-pen-to-square mr-1"></i> {isRoutineEditMode ? 'í¸ì§‘ ì™„ë£Œ' : 'ë§í¬ í¸ì§‘'}
                            </button>
                        </div>
                        <div className="flex bg-slate-100 dark:bg-slate-700 p-1 rounded-lg">
                            <button onClick={() => setLinkMode('investment')} className={`px-4 py-1.5 text-xs font-bold rounded-lg ${linkMode === 'investment' ? 'bg-white shadow text-blue-600' : 'text-slate-500'}`}>íˆ¬ì & ì¼ìƒ</button>
                            <button onClick={() => setLinkMode('blogs')} className={`px-4 py-1.5 text-xs font-bold rounded-lg ${linkMode === 'blogs' ? 'bg-white shadow text-blue-600' : 'text-slate-500'}`}>ì¸ì‚¬ì´íŠ¸</button>
                        </div>
                    </div>
                    {isRoutineEditMode && (
                        <div className="p-6 bg-indigo-50 dark:bg-indigo-900/10 rounded-2xl border-2 border-indigo-200 dark:border-indigo-800 animate-fade-in mb-6">
                            <h3 className="font-black text-indigo-600 mb-4 text-sm"><i className="fa-solid fa-plus-circle mr-2"></i>ìƒˆ ë£¨í‹´ ë§í¬ ì¶”ê°€</h3>
                            <div className="grid grid-cols-1 md:grid-cols-4 gap-3">
                                <select className="sim-input !mt-0 text-xs" value={newRoutine.category} onChange={e=>setNewRoutine({...newRoutine, category:e.target.value})}>
                                    <option value="">ì¹´í…Œê³ ë¦¬ ì„ íƒ</option>
                                    {Object.keys(routineLinks).map(cat => <option key={cat} value={cat}>{cat}</option>)}
                                </select>
                                <input type="text" placeholder="ì‚¬ì´íŠ¸ëª…" className="sim-input !mt-0 text-xs" value={newRoutine.name} onChange={e=>setNewRoutine({...newRoutine, name:e.target.value})} />
                                <input type="text" placeholder="URL" className="flex-1 sim-input !mt-0 text-xs md:col-span-1" value={newRoutine.url} onChange={e=>setNewRoutine({...newRoutine, url:e.target.value})} />
                                <button onClick={addRoutineLink} className="bg-indigo-600 text-white rounded font-black text-xs h-10">ì¶”ê°€í•˜ê¸°</button>
                            </div>
                        </div>
                    )}
                    {linkMode === 'blogs' ? (
                        <div className="flex flex-col gap-8 p-6 bg-white dark:bg-slate-800 rounded-2xl shadow-inner min-h-[400px]">
                            {Object.entries(blogInsightLinks).map(([cat, links]) => (
                                <div key={cat} className="flex flex-col md:flex-row items-center gap-4">
                                    <div className="bg-indigo-600 text-white px-4 py-2 rounded-xl font-bold min-w-[150px] text-center">{cat}</div>
                                    <div className="flex flex-wrap gap-2 flex-1 justify-center md:justify-start">
                                        {links.map((l, i) => <a key={i} href={l.url} target="_blank" className="px-4 py-2 bg-slate-50 dark:bg-slate-900 border rounded-full text-xs font-bold shadow-sm hover:shadow-md transition">{l.name}</a>)}
                                    </div>
                                </div>
                            ))}
                        </div>
                    ) : (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-6 font-bold">
                            {Object.entries(routineLinks).map(([cat, links]) => (
                                <div key={cat} className="bg-white dark:bg-slate-800 rounded-2xl p-6 shadow-lg border dark:border-slate-700">
                                    <h3 className="text-lg font-bold mb-4 border-b pb-2 text-indigo-600">{cat}</h3>
                                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                        {links.map((l, i) => (
                                            <div key={i} className="relative group">
                                                <a href={l.url} target="_blank" className="block p-3 rounded-xl bg-slate-50 dark:bg-slate-700 hover:shadow-md flex items-center gap-3 group transition-all">
                                                    <div className={`w-8 h-8 rounded flex items-center justify-center ${l.color} bg-opacity-20 group-hover:scale-110 transition`}><i className={`fa-solid ${l.icon}`}></i></div>
                                                    <span className="text-sm truncate pr-6">{l.name}</span>
                                                </a>
                                                {isRoutineEditMode && (
                                                    <button onClick={() => removeRoutineLink(cat, i)} className="absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center shadow-lg hover:bg-red-600 transition">
                                                        <i className="fa-solid fa-xmark text-[10px]"></i>
                                                    </button>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );

            const renderTools = () => {
                const targetRes = (() => {
                    const currentPrice = parseFormattedNumber(targetInputs.price); 
                    const shares = parseFormattedNumber(targetInputs.shares);
                    let targetPrice = 0, rate = 0;
                    if(targetInputs.mode === 'cap') {
                        const currentCap = parseFloat(targetInputs.currentCap) || 1; 
                        const targetCap = parseFloat(targetInputs.targetCap) || 0;
                        targetPrice = currentPrice * (targetCap / currentCap); 
                        rate = ((targetCap / currentCap) - 1) * 100;
                    } else {
                        targetPrice = parseFormattedNumber(targetInputs.targetRate); 
                        if(currentPrice > 0) rate = ((targetPrice - currentPrice) / currentPrice) * 100;
                    }
                    return { targetPrice, rate, totalAmount: targetPrice * shares, profit: (targetPrice - currentPrice) * shares };
                })();
                const exchRes = (parseFormattedNumber(exchInputs.amount) * (exchangeRates[exchInputs.base]?.krw || 1)) / (exchangeRates[exchInputs.target]?.krw || 1);
                let avgCost = 0, avgQ = 0;
                avgRows.forEach(r => { const q = parseFormattedNumber(r.q); const p = parseFormattedNumber(r.p); avgQ += q; avgCost += q * p; });
                const ipoNeeded = (parseFormattedNumber(ipoCalcInputs.price) * parseFormattedNumber(ipoCalcInputs.qty) * (ipoCalcInputs.rate/100)) + parseFormattedNumber(ipoCalcInputs.fee);
                const toolTaxRes = toolTaxInputs.type === 'dividend' ? parseFormattedNumber(toolTaxInputs.profit) * 0.154 : parseFormattedNumber(toolTaxInputs.profit) * 0.22;
                const divPreTax = parseFormattedNumber(divInputs.shares) * parseFormattedNumber(divInputs.perShare);
                const divPostTax = divPreTax * (1 - (parseFloat(divInputs.tax) / 100));

                return (
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 animate-fade-in pb-10 font-bold">
                        <div className="bg-white dark:bg-slate-800 p-5 rounded-xl shadow border dark:border-slate-700 flex flex-col">
                            <h3 className="font-bold mb-4 text-indigo-600 font-black"><i className="fa-solid fa-bullseye mr-2"></i>ëª©í‘œ ë‹¨ê°€ ë¶„ì„</h3>
                            <div className="flex bg-slate-100 dark:bg-slate-900 p-1 rounded mb-3 text-[10px]">
                                <button onClick={() => setTargetInputs({...targetInputs, mode:'cap'})} className={`flex-1 py-1 rounded ${targetInputs.mode==='cap'?'bg-white shadow text-indigo-600':'text-slate-500'}`}>ì‹œì´ ë¹„ë¡€</button>
                                <button onClick={() => setTargetInputs({...targetInputs, mode:'rate'})} className={`flex-1 py-1 rounded ${targetInputs.mode==='rate'?'bg-white shadow text-indigo-600':'text-slate-500'}`}>ê°€ê²© ì§ì ‘</button>
                            </div>
                            <div className="space-y-4 flex-1">
                                <div className="grid grid-cols-2 gap-3">
                                    <div className="flex flex-col"><label className="text-[10px] text-slate-500 mb-1">í˜„ì¬ê°€</label><input type="text" className="sim-input text-right" placeholder="0" value={targetInputs.price} onChange={e=>handleCommaChange(e, v=>setTargetInputs({...targetInputs, price:v}))} /></div>
                                    <div className="flex flex-col"><label className="text-[10px] text-slate-500 mb-1">ë³´ìœ  ìˆ˜ëŸ‰</label><input type="text" className="sim-input text-right" placeholder="0" value={targetInputs.shares} onChange={e=>handleCommaChange(e, v=>setTargetInputs({...targetInputs, shares:v}))} /></div>
                                </div>
                                {targetInputs.mode === 'cap' ? (
                                    <div className="grid grid-cols-2 gap-3">
                                        <div className="flex flex-col"><label className="text-[10px] text-slate-500 mb-1 truncate">í˜„ì¬ ì‹œì´(ì¡°)</label><input type="number" step="0.1" className="sim-input" value={targetInputs.currentCap} onChange={e=>setTargetInputs({...targetInputs, currentCap:e.target.value})} /></div>
                                        <div className="flex flex-col"><label className="text-[10px] text-slate-500 mb-1 truncate">ëª©í‘œ ì‹œì´(ì¡°)</label><input type="number" step="0.1" className="sim-input" value={targetInputs.targetCap} onChange={e=>setTargetInputs({...targetInputs, targetCap:e.target.value})} /></div>
                                    </div>
                                ) : (
                                    <div className="flex flex-col"><label className="text-[10px] text-slate-500 mb-1">ëª©í‘œ ë‹¨ê°€ ì§ì ‘ ì…ë ¥</label><input type="text" className="sim-input text-right" placeholder="0" value={targetInputs.targetRate} onChange={e=>handleCommaChange(e, v=>setTargetInputs({...targetInputs, targetRate:v}))} /></div>
                                )}
                            </div>
                            <div className="mt-4 p-4 bg-indigo-50 dark:bg-indigo-900/20 rounded space-y-2 text-right text-indigo-600 num-font font-black">
                                <div className="flex justify-between items-center text-xs opacity-70 border-b border-indigo-100 pb-1"><span>ëª©í‘œ ë„ë‹¬ ë‹¨ê°€</span><span>{formatNumber(targetRes.targetPrice)}ì› ({targetRes.rate.toFixed(1)}%)</span></div>
                                <div className="flex justify-between items-center text-xs opacity-70 border-b border-indigo-100 pb-1"><span>ì˜ˆìƒ ì´ì•¡</span><span>{formatNumber(targetRes.totalAmount)}ì›</span></div>
                                <div className="flex justify-between items-center text-sm border-t border-indigo-200 pt-1"><span>ì´ ì˜ˆìƒ ìˆ˜ìµê¸ˆ</span><span className="text-base">{formatNumber(targetRes.profit)}ì›</span></div>
                            </div>
                        </div>

                        <div className="bg-white dark:bg-slate-800 p-5 rounded-xl shadow border dark:border-slate-700">
                            <div className="flex justify-between items-center mb-4"><h3 className="font-bold text-blue-600 font-black"><i className="fa-solid fa-money-bill-transfer mr-2"></i>í™˜ìœ¨ ê³„ì‚°ê¸°</h3><button onClick={fetchRealTimeRates} className={`text-slate-400 ${isFetching ? 'animate-spin' : ''}`}><i className="fa-solid fa-arrows-rotate text-xs"></i></button></div>
                            <div className="space-y-4">
                                <div className="flex gap-2">
                                    <select className="w-1/3 sim-input" value={exchInputs.base} onChange={e=>setExchInputs({...exchInputs, base:e.target.value})}>{Object.keys(exchangeRates).map(k=><option key={k} value={k}>{k}</option>)}</select>
                                    <input type="text" className="flex-1 sim-input text-right" value={exchInputs.amount} onChange={e=>handleCommaChange(e, v=>setExchInputs({...exchInputs, amount:v}))} />
                                </div>
                                <div className="flex gap-2">
                                    <select className="w-1/3 sim-input" value={exchInputs.target} onChange={e=>setExchInputs({...exchInputs, target:e.target.value})}>{Object.keys(exchangeRates).map(k=><option key={k} value={k}>{k}</option>)}</select>
                                    <div className="flex-1 p-2 border rounded bg-slate-50 dark:bg-slate-900 text-right text-blue-600 font-black num-font">{formatNumber(exchRes)}</div>
                                </div>
                            </div>
                        </div>

                        <div className="bg-white dark:bg-slate-800 p-5 rounded-xl shadow border dark:border-slate-700 font-bold">
                            <h3 className="mb-4 text-rose-600 font-black"><i className="fa-solid fa-receipt mr-2"></i>ê°„ì´ ì„¸ê¸ˆ ê³„ì‚°ê¸°</h3>
                            <div className="space-y-2">
                                <div className="flex bg-slate-100 dark:bg-slate-900 p-1 rounded mb-2 text-[10px]">
                                    <button onClick={() => setToolTaxInputs({...toolTaxInputs, type:'dividend'})} className={`flex-1 py-1 rounded ${toolTaxInputs.type==='dividend'?'bg-white shadow text-rose-600':'text-slate-500'}`}>ë°°ë‹¹/ì´ì(15.4%)</button>
                                    <button onClick={() => setToolTaxInputs({...toolTaxInputs, type:'capital'})} className={`flex-1 py-1 rounded ${toolTaxInputs.type==='capital'?'bg-white shadow text-rose-600':'text-slate-500'}`}>ì–‘ë„ì†Œë“(22%)</button>
                                </div>
                                <div><label className="text-[10px] text-slate-500 block mb-1">ìˆ˜ìµ ì´ì•¡</label><input type="text" className="sim-input text-right" placeholder="0" value={toolTaxInputs.profit} onChange={e=>handleCommaChange(e, v=>setToolTaxInputs({...toolTaxInputs, profit:v}))} /></div>
                                <div className="p-3 bg-rose-50 dark:bg-rose-900/20 rounded text-center text-rose-600 mt-2 num-font font-black">ì˜ˆìƒ ì„¸ê¸ˆ: {formatNumber(toolTaxRes)}ì›</div>
                            </div>
                        </div>

                        <div className="bg-white dark:bg-slate-800 p-5 rounded-xl shadow border dark:border-slate-700 font-bold">
                            <h3 className="mb-4 text-purple-600 font-black"><i className="fa-solid fa-piggy-bank mr-2"></i>ê³µëª¨ì£¼ ì²­ì•½ ê³„ì‚°</h3>
                            <div className="grid grid-cols-2 gap-3 mb-4">
                                <div className="flex flex-col"><label className="text-[10px] text-slate-500 mb-1">ê³µëª¨ê°€</label><input type="text" className="sim-input text-right" value={ipoCalcInputs.price} onChange={e=>handleCommaChange(e, v=>setIpoCalcInputs({...ipoCalcInputs, price:v}))} /></div>
                                <div className="flex flex-col"><label className="text-[10px] text-slate-500 mb-1">ì²­ì•½ìˆ˜ëŸ‰</label><input type="text" className="sim-input text-right" value={ipoCalcInputs.qty} onChange={e=>handleCommaChange(e, v=>setIpoCalcInputs({...ipoCalcInputs, qty:v}))} /></div>
                                <div className="flex flex-col"><label className="text-[10px] text-slate-500 mb-1">ì¦ê±°ê¸ˆìœ¨</label><select className="sim-input" value={ipoCalcInputs.rate} onChange={e=>setIpoCalcInputs({...ipoCalcInputs, rate:parseInt(e.target.value)})}><option value={50}>50%</option><option value={100}>100%</option></select></div>
                                <div className="flex flex-col"><label className="text-[10px] text-slate-500 mb-1">ìˆ˜ìˆ˜ë£Œ</label><input type="text" className="sim-input text-right" value={ipoCalcInputs.fee} onChange={e=>handleCommaChange(e, v=>setIpoCalcInputs({...ipoCalcInputs, fee:v}))} /></div>
                            </div>
                            <div className="p-3 bg-purple-50 dark:bg-purple-900/20 rounded-lg text-right text-purple-600 num-font font-black">ì´ í•„ìš”ì•¡: {formatNumber(ipoNeeded)}ì›</div>
                        </div>

                        <div className="bg-white dark:bg-slate-800 p-5 rounded-xl shadow border dark:border-slate-700 font-bold flex flex-col">
                            <h3 className="mb-3 text-emerald-600 flex justify-between items-center font-black">
                                <span><i className="fa-solid fa-scale-balanced mr-2"></i>í‰ë‹¨ê°€ ê³„ì‚°ê¸°</span>
                                <button onClick={()=>setAvgRows([...avgRows, {id:Date.now(), q:'', p:''}])} className="bg-emerald-100 text-emerald-600 px-2 py-0.5 rounded text-[10px]">+ ì¶”ê°€</button>
                            </h3>
                            <div className="space-y-2 overflow-y-auto max-h-40 mb-3 pr-1">
                                {avgRows.map((r, i) => (
                                    <div key={r.id} className="grid grid-cols-12 gap-1 items-center">
                                        <input type="text" placeholder="ìˆ˜ëŸ‰" className="col-span-5 sim-input text-right !p-1" value={r.q} onChange={e=>handleCommaChange(e, v=>{const n=[...avgRows]; n[i].q=v; setAvgRows(n);})} />
                                        <input type="text" placeholder="ë‹¨ê°€" className="col-span-5 sim-input text-right !p-1" value={r.p} onChange={e=>handleCommaChange(e, v=>{const n=[...avgRows]; n[i].p=v; setAvgRows(n);})} />
                                        <button onClick={()=>{const n=avgRows.filter(row=>row.id!==r.id); setAvgRows(n.length?n:[{id:Date.now(),q:'',p:''}]);}} className="col-span-2 text-red-400"><i className="fa-solid fa-trash-can text-xs"></i></button>
                                    </div>
                                ))}
                            </div>
                            <div className="mt-auto p-3 bg-emerald-50 dark:bg-emerald-900/20 rounded text-right text-emerald-600 font-black num-font">
                                <div className="text-[10px] opacity-70">ìµœì¢… í‰ë‹¨ê°€</div>
                                <div className="text-base">{avgQ ? formatNumber(avgCost/avgQ) : 0}ì›</div>
                            </div>
                        </div>

                        <div className="bg-white dark:bg-slate-800 p-5 rounded-xl shadow border dark:border-slate-700 font-bold">
                            <h3 className="mb-4 text-amber-600 font-black"><i className="fa-solid fa-sack-dollar mr-2"></i>ë°°ë‹¹ê¸ˆ ê³„ì‚°ê¸°</h3>
                            <div className="space-y-3">
                                <div className="grid grid-cols-2 gap-3">
                                    <div className="flex flex-col"><label className="text-[10px] text-slate-500 mb-1">ë³´ìœ  ìˆ˜ëŸ‰</label><input type="text" className="sim-input text-right" placeholder="0" value={divInputs.shares} onChange={e=>handleCommaChange(e, v=>setDivInputs({...divInputs, shares:v}))} /></div>
                                    <div className="flex flex-col"><label className="text-[10px] text-slate-500 mb-1">ì£¼ë‹¹ ë°°ë‹¹ê¸ˆ</label><input type="text" className="sim-input text-right" placeholder="0" value={divInputs.perShare} onChange={e=>handleCommaChange(e, v=>setDivInputs({...divInputs, perShare:v}))} /></div>
                                </div>
                                <div className="p-4 bg-amber-50 dark:bg-amber-900/20 rounded text-right text-amber-600 num-font font-black space-y-2">
                                    <div className="flex justify-between items-center text-xs opacity-70 border-b border-amber-100 pb-1"><span>ì„¸ì „ ì´ì•¡</span><span>{formatNumber(divPreTax)}ì›</span></div>
                                    <div className="flex justify-between items-center text-sm pt-1"><span>ì„¸í›„ ì‹¤ìˆ˜ë ¹</span><span className="text-base">{formatNumber(divPostTax)}ì›</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            return (
                <div className={`min-h-screen flex flex-col transition-colors duration-200 ${isDark ? 'dark bg-slate-900 text-slate-100' : 'bg-slate-50 text-slate-800'}`}>
                    <header className="sticky top-0 z-50 bg-white dark:bg-slate-800 border-b dark:border-slate-700 shadow h-16">
                        <div className="max-w-7xl mx-auto px-4 h-full flex items-center justify-between">
                            <div className="flex items-center gap-2 font-black text-lg"><i className="fa-solid fa-compass text-blue-600"></i> Navigator</div>
                            <nav className="flex bg-slate-100 dark:bg-slate-700 p-1 rounded-xl gap-1">
                                {[{id:'dashboard',l:'ëŒ€ì‹œë³´ë“œ'},{id:'routine',l:'ë£¨í‹´'},{id:'tools',l:'ë„êµ¬'},{id:'simulation',l:'ë…¸í›„ìê¸ˆ'},{id:'tax',l:'ê¸ˆìœµê³¼ì„¸'}].map(t => (
                                    <button key={t.id} onClick={()=>setActiveTab(t.id)} className={`nav-tab px-3 md:px-5 py-1.5 text-xs rounded-lg transition-all ${activeTab === t.id ? 'active' : 'text-slate-500 font-bold'}`}>{t.l}</button>
                                ))}
                            </nav>
                            <button onClick={()=>setIsDark(!isDark)} className="p-2 rounded-full hover:bg-slate-200 transition"><i className={`fa-solid ${isDark?'fa-sun text-amber-400':'fa-moon'}`}></i></button>
                        </div>
                    </header>
                    <main className="max-w-7xl w-full mx-auto px-4 py-6 flex-1">
                        {activeTab === 'dashboard' && renderDashboard()}
                        {activeTab === 'routine' && renderRoutine()}
                        {activeTab === 'tools' && renderTools()}
                        {activeTab === 'simulation' && (
                            <div className="animate-fade-in pb-10 font-bold space-y-6">
                                <h2 className="text-2xl font-black mb-4 border-b dark:border-slate-700 pb-2 flex items-center gap-3">
                                    ë…¸í›„ ìê¸ˆ ì‹œë®¬ë ˆì´ì…˜
                                    <span className="text-xs bg-indigo-100 text-indigo-600 px-2 py-1 rounded font-black">v2.1 ì •ë°€ ì‹œë®¬ë ˆì´ì…˜</span>
                                </h2>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 font-bold">
                                    {/* Inputs are kept exactly as previous but used in the refined table */}
                                    <div className="bg-white dark:bg-slate-800 p-5 rounded-xl border shadow-sm space-y-4">
                                        <h3 className="text-indigo-600 text-sm border-b pb-1 font-black"><i className="fa-solid fa-calendar-day mr-1"></i> 1. ì—°ë ¹ ë° ìˆ˜ë ¹ ì‹œê¸°</h3>
                                        <div className="grid grid-cols-2 gap-2">
                                            <div className="flex flex-col"><label className="text-[10px] text-slate-500">ë³¸ì¸ í˜„ì¬ ë‚˜ì´</label><input type="number" className="sim-input" value={simInputs.currentAge} onChange={e=>setSimInputs({...simInputs, currentAge:parseInt(e.target.value)})}/></div>
                                            <div className="flex flex-col"><label className="text-[10px] text-slate-500">ë°°ìš°ì í˜„ì¬ ë‚˜ì´</label><input type="number" className="sim-input" value={simInputs.spouseCurrentAge} onChange={e=>setSimInputs({...simInputs, spouseCurrentAge:parseInt(e.target.value)})}/></div>
                                            <div className="flex flex-col"><label className="text-[10px] text-indigo-500 font-black">ì—°ê¸ˆ ìˆ˜ë ¹(ë³¸ì¸)</label><input type="number" className="sim-input border-indigo-300" value={simInputs.pensionStartAgeUser} onChange={e=>setSimInputs({...simInputs, pensionStartAgeUser:parseInt(e.target.value)})}/></div>
                                            <div className="flex flex-col"><label className="text-[10px] text-indigo-500 font-black">ì—°ê¸ˆ ìˆ˜ë ¹(ë°°ìš°ì)</label><input type="number" className="sim-input border-indigo-300" value={simInputs.pensionStartAgeSpouse} onChange={e=>setSimInputs({...simInputs, pensionStartAgeSpouse:parseInt(e.target.value)})}/></div>
                                            <div className="flex flex-col col-span-2"><label className="text-[10px] text-slate-500">ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘(ë‚˜ì´)</label><input type="number" className="sim-input" value={simInputs.simulationStartAge} onChange={e=>setSimInputs({...simInputs, simulationStartAge:parseInt(e.target.value)})}/></div>
                                        </div>
                                    </div>
                                    <div className="bg-white dark:bg-slate-800 p-5 rounded-xl border shadow-sm space-y-4">
                                        <h3 className="text-emerald-600 text-sm border-b pb-1 font-black"><i className="fa-solid fa-vault mr-1"></i> 2. ê¸°ì´ˆ ìì‚°(ì–µ) ë° ìˆ˜ìµë¥ (%)</h3>
                                        <div className="grid grid-cols-2 gap-x-2 gap-y-3">
                                            <div className="flex flex-col"><label className="text-[9px] text-blue-500">ë³¸ì¸ ì¼ë°˜(ì–µ)</label><input type="number" step="0.1" className="sim-input" value={simInputs.capUserNonISA} onChange={e=>setSimInputs({...simInputs, capUserNonISA:parseFloat(e.target.value)})}/></div>
                                            <div className="flex flex-col"><label className="text-[9px] text-blue-400">ì¼ë°˜ ìˆ˜ìµë¥ (%)</label><input type="number" step="0.1" className="sim-input" value={simInputs.returnUserNonISA} onChange={e=>setSimInputs({...simInputs, returnUserNonISA:parseFloat(e.target.value)})}/></div>
                                            <div className="flex flex-col"><label className="text-[9px] text-blue-500">ë°°ìš°ì ì¼ë°˜(ì–µ)</label><input type="number" step="0.1" className="sim-input" value={simInputs.capSpouseNonISA} onChange={e=>setSimInputs({...simInputs, capSpouseNonISA:parseFloat(e.target.value)})}/></div>
                                            <div className="flex flex-col"><label className="text-[9px] text-blue-400">ì¼ë°˜ ìˆ˜ìµë¥ (%)</label><input type="number" step="0.1" className="sim-input" value={simInputs.returnSpouseNonISA} onChange={e=>setSimInputs({...simInputs, returnSpouseNonISA:parseFloat(e.target.value)})}/></div>
                                            <div className="flex flex-col border-t pt-2 mt-1"><label className="text-[9px] text-emerald-500">ë³¸ì¸ ISA(ì–µ)</label><input type="number" step="0.1" className="sim-input" value={simInputs.capUserISA} onChange={e=>setSimInputs({...simInputs, capUserISA:parseFloat(e.target.value)})}/></div>
                                            <div className="flex flex-col border-t pt-2 mt-1"><label className="text-[9px] text-emerald-400">ISA ìˆ˜ìµë¥ (%)</label><input type="number" step="0.1" className="sim-input" value={simInputs.returnUserISA} onChange={e=>setSimInputs({...simInputs, returnUserISA:parseFloat(e.target.value)})}/></div>
                                            <div className="flex flex-col"><label className="text-[9px] text-emerald-500">ë°°ìš°ì ISA(ì–µ)</label><input type="number" step="0.1" className="sim-input" value={simInputs.capSpouseISA} onChange={e=>setSimInputs({...simInputs, capSpouseISA:parseFloat(e.target.value)})}/></div>
                                            <div className="flex flex-col"><label className="text-[9px] text-emerald-400">ISA ìˆ˜ìµë¥ (%)</label><input type="number" step="0.1" className="sim-input" value={simInputs.returnSpouseISA} onChange={e=>setSimInputs({...simInputs, returnSpouseISA:parseFloat(e.target.value)})}/></div>
                                        </div>
                                    </div>
                                    <div className="bg-white dark:bg-slate-800 p-5 rounded-xl border shadow-sm space-y-4">
                                        <h3 className="text-orange-600 text-sm border-b pb-1 font-black"><i className="fa-solid fa-chart-line mr-1"></i> 3. ë¬¼ê°€ ë° ì„¸ìœ¨ ì„¤ì •(%)</h3>
                                        <div className="grid grid-cols-2 gap-2">
                                            <div className="flex flex-col"><label className="text-[10px] text-slate-500">ì „ì²´ ë¬¼ê°€ ìƒìŠ¹ë¥ </label><input type="number" step="0.1" className="sim-input" value={simInputs.inflationRate} onChange={e=>setSimInputs({...simInputs, inflationRate:parseFloat(e.target.value)})}/></div>
                                            <div className="flex flex-col"><label className="text-[10px] text-slate-500">ìƒí™œë¹„ ìƒìŠ¹ë¥ </label><input type="number" step="0.1" className="sim-input" value={simInputs.livingCostInflationRate} onChange={e=>setSimInputs({...simInputs, livingCostInflationRate:parseFloat(e.target.value)})}/></div>
                                            <div className="flex flex-col"><label className="text-[10px] text-red-500">ì†Œë“ì„¸ìœ¨1(ê¸°ë³¸)</label><input type="number" step="0.1" className="sim-input" value={simInputs.taxRate1} onChange={e=>setSimInputs({...simInputs, taxRate1:parseFloat(e.target.value)})}/></div>
                                            <div className="flex flex-col"><label className="text-[10px] text-red-700">ì†Œë“ì„¸ìœ¨2(ëˆ„ì§„)</label><input type="number" step="0.1" className="sim-input" value={simInputs.taxRate2} onChange={e=>setSimInputs({...simInputs, taxRate2:parseFloat(e.target.value)})}/></div>
                                        </div>
                                        <div className="flex flex-col border-t pt-3 mt-1">
                                            <label className="text-[10px] text-indigo-500 font-black">95ì„¸ ëª©í‘œ ì”ì•¡ (ìƒì† ë“±)</label>
                                            <input type="text" className="sim-input border-indigo-200" value={simInputs.targetLegacy} onChange={e=>handleCommaChange(e, v=>setSimInputs({...simInputs, targetLegacy:v}))}/>
                                        </div>
                                    </div>
                                    <div className="bg-white dark:bg-slate-800 p-5 rounded-xl border shadow-sm space-y-4">
                                        <h3 className="text-rose-600 text-sm border-b pb-1 font-black"><i className="fa-solid fa-money-check-dollar mr-1"></i> 4. ì›” ìˆ˜ì… ë° ì§€ì¶œ(ì›)</h3>
                                        <div className="flex flex-col"><label className="text-[11px] text-red-600 font-black">ëª©í‘œ ìƒí™œë¹„(ì›”)</label><input type="text" className="sim-input text-right text-red-600" value={simInputs.monthlyLiving} onChange={e=>handleCommaChange(e, v=>setSimInputs({...simInputs, monthlyLiving:v}))}/></div>
                                        <div className="grid grid-cols-2 gap-2">
                                            <div className="flex flex-col"><label className="text-[10px] text-slate-500">ë³¸ì¸ ì›” ì—°ê¸ˆ</label><input type="text" className="sim-input text-right" value={simInputs.pensionSelf} onChange={e=>handleCommaChange(e, v=>setSimInputs({...simInputs, pensionSelf:v}))}/></div>
                                            <div className="flex flex-col"><label className="text-[10px] text-slate-500">ë°°ìš°ì ì›” ì—°ê¸ˆ</label><input type="text" className="sim-input text-right" value={simInputs.pensionSpouse} onChange={e=>handleCommaChange(e, v=>setSimInputs({...simInputs, pensionSpouse:v}))}/></div>
                                        </div>
                                        <div className="flex flex-col bg-rose-50 dark:bg-rose-900/10 p-2 rounded">
                                            <label className="text-[10px] text-rose-500 font-black">ì—°ê°„ ê³ ì • ì˜ˆë¹„ë¹„ (ë¹„ìƒê¸ˆ)</label>
                                            <input type="text" className="sim-input !mt-0 !p-1 text-right" value={simInputs.extraReserve} onChange={e=>handleCommaChange(e, v=>setSimInputs({...simInputs, extraReserve:v}))}/>
                                        </div>
                                    </div>
                                    <div className="bg-white dark:bg-slate-800 p-5 rounded-xl border shadow-sm space-y-4">
                                        <h3 className="text-blue-600 text-sm border-b pb-1 font-black"><i className="fa-solid fa-hand-holding-dollar mr-1"></i> 5. ê¸°íƒ€ ì—°ê°„ ìˆ˜ì…(ì›)</h3>
                                        <div className="grid grid-cols-2 gap-2">
                                            <div className="flex flex-col"><label className="text-[10px] text-slate-500">ê³µëª¨ì£¼ ìˆ˜ìµ</label><input type="text" className="sim-input text-right" value={simInputs.ipoProfit} onChange={e=>handleCommaChange(e, v=>setSimInputs({...simInputs, ipoProfit:v}))}/></div>
                                            <div className="flex flex-col"><label className="text-[10px] text-slate-500">ì„ëŒ€ ì†Œë“</label><input type="text" className="sim-input text-right" value={simInputs.rentalIncome} onChange={e=>handleCommaChange(e, v=>setSimInputs({...simInputs, rentalIncome:v}))}/></div>
                                            <div className="flex flex-col"><label className="text-[10px] text-slate-500">ê¸°íƒ€ ì‚¬ì—…/ê·¼ë¡œ</label><input type="text" className="sim-input text-right" value={simInputs.otherIncome} onChange={e=>handleCommaChange(e, v=>setSimInputs({...simInputs, otherIncome:v}))}/></div>
                                            <div className="flex flex-col"><label className="text-[10px] text-slate-500">ì£¼ì‹ ëŒ€ì—¬ ìˆ˜ìˆ˜ë£Œ</label><input type="text" className="sim-input text-right" value={simInputs.stockLending} onChange={e=>handleCommaChange(e, v=>setSimInputs({...simInputs, stockLending:v}))}/></div>
                                        </div>
                                    </div>
                                    <div className={`${simResult.summary?.isSuccess ? 'bg-indigo-600' : 'bg-rose-600'} text-white p-5 rounded-xl shadow-lg flex flex-col justify-center text-center transition-colors duration-500`}>
                                        <p className="text-xs opacity-80 mb-2">95ì„¸ ì˜ˆì¸¡ ê²°ê³¼</p>
                                        <h3 className={`text-2xl font-black ${simResult.summary?.depletion ? 'text-yellow-300' : 'text-white'}`}>
                                            {simResult.summary?.depletion ? `${simResult.summary.depletion}ì„¸ ìì‚° ê³ ê°ˆ` : formatNumber(simResult.summary?.final) + 'ì›'}
                                        </h3>
                                        <div className="mt-3 py-1 px-3 bg-white/20 rounded-full text-[10px] inline-block mx-auto font-black">
                                            {simResult.summary?.isSuccess ? "âœ… ì„¤ê³„ ëª©í‘œ ë‹¬ì„± ì„±ê³µ" : "âš ï¸ ì„¤ê³„ ëª©í‘œ ë¯¸ë‹¬ (ì¡°ì • í•„ìš”)"}
                                        </div>
                                    </div>
                                </div>
                                <div className="mt-6 bg-white dark:bg-slate-800 p-6 rounded-xl border shadow-sm">
                                    <SimulationChart history={simResult.history} />
                                </div>
                                <div className="mt-6 bg-white dark:bg-slate-800 p-4 rounded-xl border shadow-sm overflow-x-auto">
                                    <h3 className="text-sm font-black mb-4"><i className="fa-solid fa-table mr-2"></i>ì—°ë ¹ë³„ ìì‚° ë³€í™” ìƒì„¸ ë‚´ì—­ (ê³„ì¢Œë³„ ì •ë°€ ë¶„ì„)</h3>
                                    <table className="w-full text-[10px] text-left border-collapse min-w-[1000px]">
                                        <thead className="bg-slate-50 dark:bg-slate-900">
                                            <tr>
                                                <th className="p-2 border-b">ë‚˜ì´</th>
                                                <th className="p-2 border-b">ì´ìì‚°(ì–µ)</th>
                                                <th className="p-2 border-b text-indigo-500">í•©ê³„ ìˆ˜ìµ(ì›)</th>
                                                <th className="p-2 border-b text-blue-500 text-center">ìˆ˜ìµ ìƒì„¸ (íˆ¬ì + ê¸°ë³¸)</th>
                                                <th className="p-2 border-b text-rose-500 text-center">ì¦ê°ë¶„(ì›)</th>
                                                <th className="p-2 border-b text-center">ê³„ì¢Œë³„ ìì‚° í˜„í™©(ë‹¨ìœ„: ì–µ)</th>
                                                <th className="p-2 border-b text-right">ì„¸ê¸ˆ+ìƒí™œë¹„(ì›)</th>
                                                <th className="p-2 border-b text-center">ìƒíƒœ</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {simResult.history.map((h, idx) => (
                                                <tr key={idx} className={`hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors ${h.isWarn ? 'bg-rose-50/50 dark:bg-rose-900/5' : ''}`}>
                                                    <td className="p-2 border-b font-medium">{h.age}ì„¸</td>
                                                    <td className={`p-2 border-b font-black ${h.isWarn ? 'text-rose-600' : 'text-indigo-600'}`}>{h.total.toFixed(2)}</td>
                                                    <td className="p-2 border-b text-indigo-600 font-black num-font">{formatNumber(h.annualProfit)}</td>
                                                    <td className="p-2 border-b text-center">
                                                        <div className="flex justify-center gap-3">
                                                            <span className="text-blue-500 font-bold num-font">íˆ¬ì:{formatNumber(h.profInvestment)}</span>
                                                            <span className="text-slate-400 font-medium num-font">ê¸°ë³¸:{formatNumber(h.baseIncome)}</span>
                                                        </div>
                                                    </td>
                                                    <td className={`p-2 border-b text-center font-bold num-font ${h.netChange >= 0 ? 'text-emerald-600' : 'text-rose-500'}`}>
                                                        {h.netChange >= 0 ? '+' : ''}{formatNumber(h.netChange)}
                                                    </td>
                                                    <td className="p-2 border-b">
                                                        {/* ê°œì„ : ë³¸ì¸/ë°°ìš°ì ISAë¥¼ êµ¬ë¶„í•˜ì—¬ 4ê°œ ê³„ì¢Œ ëª¨ë‘ í‘œì‹œ */}
                                                        <div className="grid grid-cols-2 gap-x-3 gap-y-0.5 text-[9px] opacity-80 leading-tight">
                                                            <div className="flex justify-between"><span>ë³¸ì¸ì¼ë°˜:</span><span className="font-bold">{h.un.toFixed(1)}</span></div>
                                                            <div className="flex justify-between text-emerald-600"><span>ë³¸ì¸ISA:</span><span className="font-bold">{h.ui.toFixed(1)}</span></div>
                                                            <div className="flex justify-between"><span>ë°°ìš°ì¼ë°˜:</span><span className="font-bold">{h.sn.toFixed(1)}</span></div>
                                                            <div className="flex justify-between text-emerald-600"><span>ë°°ìš°ISA:</span><span className="font-bold">{h.si.toFixed(1)}</span></div>
                                                        </div>
                                                    </td>
                                                    <td className="p-2 border-b num-font opacity-60 text-right">
                                                        {formatNumber(h.tax + h.living)}
                                                    </td>
                                                    <td className="p-2 border-b text-center">
                                                        <div className="flex flex-col items-center gap-1">
                                                            {h.isHighCost && <span className="px-1.5 py-0.5 bg-orange-100 text-orange-600 rounded-sm text-[8px] font-black">ê³ ë¹„ìš©ê¸°</span>}
                                                            {h.isWarn ? <i className="fa-solid fa-triangle-exclamation text-rose-500 animate-pulse"></i> : <i className="fa-solid fa-check text-emerald-500 opacity-30"></i>}
                                                        </div>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}
                        {activeTab === 'tax' && (
                            <div className="space-y-6 animate-fade-in pb-10 font-bold">
                                <h2 className="text-2xl font-black mb-4 border-b dark:border-slate-700 pb-2">ê¸ˆìœµ ì†Œë“ ë° ê³¼ì„¸ ê´€ë¦¬</h2>
                                <div className="guide-card border-l-4 border-l-blue-500 flex gap-4 items-start mb-6">
                                    <div className="bg-blue-100 text-blue-600 p-3 rounded-lg"><i className="fa-solid fa-circle-info text-xl"></i></div>
                                    <div>
                                        <h3 className="font-black text-blue-600 mb-1">ì´ˆë³´ìë¥¼ ìœ„í•œ ê¸ˆìœµê³¼ì„¸ í•µì‹¬ ìš”ì•½</h3>
                                        <ul className="text-xs text-slate-500 space-y-1 list-disc pl-4">
                                            <li>ì—°ê°„ ê¸ˆìœµì†Œë“(ì´ì+ë°°ë‹¹)ì´ <strong>2,000ë§Œ ì›</strong> ì´í•˜ì´ë©´ 15.4%ë¡œ ê³¼ì„¸ê°€ ëë‚©ë‹ˆë‹¤.</li>
                                            <li>2,000ë§Œ ì›ì„ ì´ˆê³¼í•˜ë©´ ì¢…í•©ê³¼ì„¸ ëŒ€ìƒì´ ë˜ì–´ í•©ì‚° ê³¼ì„¸ë©ë‹ˆë‹¤.</li>
                                            <li>ê³µëª¨ì£¼ ìˆ˜ìµ, í•´ì™¸ì£¼ì‹ ì–‘ë„ì°¨ìµ ë“±ì€ ë³„ë„ì˜ ê³¼ì„¸ ì²´ê³„ë¥¼ ë”°ë¥´ë¯€ë¡œ ì£¼ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤.</li>
                                        </ul>
                                    </div>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 font-black text-center gap-6">
                                    <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow border dark:border-slate-700">
                                        <p className="text-xs text-slate-500 mb-1">ì´ì/ë°°ë‹¹ ì†Œë“ í•©ê³„</p>
                                        <h3 className="text-2xl text-blue-600">{formatNumber(finList.reduce((a,c)=>a+c.amount,0))}ì›</h3>
                                    </div>
                                    <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow border dark:border-slate-700">
                                        <p className="text-xs text-slate-500 mb-1">ê¸°íƒ€ ê¸ˆìœµ ìˆ˜ìµ í•©ê³„</p>
                                        <h3 className="text-2xl text-emerald-600">{formatNumber(otherIncomeList.reduce((a,c)=>a+c.amount,0))}ì›</h3>
                                    </div>
                                    <div className="bg-indigo-600 text-white p-6 rounded-xl shadow">
                                        <p className="text-xs opacity-70 mb-1">ì´ì/ë°°ë‹¹ ë¶„ë¦¬ê³¼ì„¸ ì˜ˆìƒ ì„¸ì•¡(15.4%)</p>
                                        <h3 className="text-2xl">{formatNumber(finList.reduce((a,c)=>a+c.amount,0) * 0.154)}ì›</h3>
                                    </div>
                                </div>
                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
                                    <div className="bg-white dark:bg-slate-800 p-5 rounded-xl border shadow font-bold">
                                        <h4 className="font-black mb-4 flex justify-between items-center text-blue-600 border-b pb-2">
                                            <span><i className="fa-solid fa-piggy-bank mr-1"></i> ì´ì/ë°°ë‹¹ ë‚´ì—­ ë“±ë¡</span>
                                            <div className="flex gap-1">
                                                <input id="fD" type="text" placeholder="í•­ëª©" className="w-24 sim-input !mt-0 !p-1 text-xs" />
                                                <input id="fA" type="number" placeholder="ê¸ˆì•¡" className="w-24 sim-input !mt-0 !p-1 text-xs" />
                                                <button onClick={()=>{const d=document.getElementById('fD').value, a=parseInt(document.getElementById('fA').value); if(d&&a){setFinList([...finList,{id:Date.now(),desc:d,amount:a}]); document.getElementById('fD').value=''; document.getElementById('fA').value='';}}} className="bg-blue-600 text-white px-3 rounded text-xs font-black">ì¶”ê°€</button>
                                            </div>
                                        </h4>
                                        <div className="max-h-60 overflow-y-auto space-y-1 font-bold">
                                            {finList.length === 0 ? <p className="text-xs text-slate-400 text-center py-4">ë“±ë¡ëœ ì´ì/ë°°ë‹¹ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p> : finList.map(f => (
                                                <div key={f.id} className="flex justify-between items-center text-xs border-b py-2 dark:border-slate-700">
                                                    <span>{f.desc}</span>
                                                    <div className="flex items-center gap-3">
                                                        <span className="num-font font-black">{formatNumber(f.amount)}ì›</span>
                                                        <button onClick={()=>setFinList(finList.filter(item=>item.id!==f.id))} className="text-red-400 hover:text-red-600"><i className="fa-solid fa-xmark"></i></button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                    <div className="bg-white dark:bg-slate-800 p-5 rounded-xl border shadow font-bold">
                                        <h4 className="font-black mb-4 flex justify-between items-center text-emerald-600 border-b pb-2">
                                            <span><i className="fa-solid fa-coins mr-1"></i> ê¸°íƒ€ ê¸ˆìœµ ìˆ˜ìµ(ê³µëª¨ì£¼ ë“±)</span>
                                            <div className="flex gap-1">
                                                <input id="oD" type="text" placeholder="í•­ëª©" className="w-24 sim-input !mt-0 !p-1 text-xs" />
                                                <input id="oA" type="number" placeholder="ìˆ˜ìµ" className="w-24 sim-input !mt-0 !p-1 text-xs" />
                                                <button onClick={()=>{const d=document.getElementById('oD').value, a=parseInt(document.getElementById('oA').value); if(d&&a){setOtherIncomeList([...otherIncomeList,{id:Date.now(),desc:d,amount:a}]); document.getElementById('oD').value=''; document.getElementById('oA').value='';}}} className="bg-emerald-600 text-white px-3 rounded text-xs font-black">ì¶”ê°€</button>
                                            </div>
                                        </h4>
                                        <div className="max-h-60 overflow-y-auto space-y-1 font-bold">
                                            {otherIncomeList.length === 0 ? <p className="text-xs text-slate-400 text-center py-4">ë“±ë¡ëœ ê¸°íƒ€ ìˆ˜ìµì´ ì—†ìŠµë‹ˆë‹¤.</p> : otherIncomeList.map(f => (
                                                <div key={f.id} className="flex justify-between items-center text-xs border-b py-2 dark:border-slate-700">
                                                    <span>{f.desc}</span>
                                                    <div className="flex items-center gap-3">
                                                        <span className="num-font font-black">{formatNumber(f.amount)}ì›</span>
                                                        <button onClick={()=>setOtherIncomeList(otherIncomeList.filter(item=>item.id!==f.id))} className="text-red-400 hover:text-red-600"><i className="fa-solid fa-xmark"></i></button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                    <div className="lg:col-span-2 bg-slate-50 dark:bg-slate-900 p-5 rounded-xl border-2 border-dashed border-slate-200 dark:border-slate-700 flex flex-col mt-4">
                                        <h4 className="font-black mb-4 border-b pb-2 text-slate-700 dark:text-slate-200"><i className="fa-solid fa-calculator mr-2"></i>ì˜ˆìƒ ì„¸ì•¡ ë„ì¶œ ê³¼ì • ì‹œë®¬ë ˆì´ì…˜</h4>
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6 text-xs font-bold">
                                            <div className="flex items-start gap-3 bg-white dark:bg-slate-800 p-3 rounded-lg shadow-sm">
                                                <div className="w-6 h-6 bg-slate-200 dark:bg-slate-700 rounded-full flex items-center justify-center text-[10px]">1</div>
                                                <div><p className="text-slate-500">ê¸ˆìœµì†Œë“ í•©ì‚°</p><p className="mt-1">í•©ê³„: {formatNumber(finList.reduce((a,c)=>a+c.amount,0))}ì›</p></div>
                                            </div>
                                            <div className="flex items-start gap-3 bg-white dark:bg-slate-800 p-3 rounded-lg shadow-sm">
                                                <div className="w-6 h-6 bg-slate-200 dark:bg-slate-700 rounded-full flex items-center justify-center text-[10px]">2</div>
                                                <div><p className="text-slate-500">ì¢…í•©ê³¼ì„¸ íŒë‹¨</p><p className="mt-1">{finList.reduce((a,c)=>a+c.amount,0) > TAX_THRESHOLD ? <span className="text-red-500">ì´ˆê³¼(ì¢…í•©ê³¼ì„¸)</span> : <span className="text-emerald-600">ì´í•˜(ë¶„ë¦¬ê³¼ì„¸)</span>}</p></div>
                                            </div>
                                            <div className="flex items-start gap-3 bg-indigo-100 text-indigo-600 dark:bg-indigo-900/30 p-3 rounded-lg shadow-sm">
                                                <div className="w-6 h-6 bg-indigo-200 text-indigo-600 dark:bg-indigo-900 rounded-full flex items-center justify-center text-[10px]">3</div>
                                                <div><p className="text-indigo-600 font-black">ì›ì²œì§•ìˆ˜ì•¡</p><p className="mt-1 font-black text-sm">{formatNumber(finList.reduce((a,c)=>a+c.amount,0) * 0.154)}ì›</p></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>