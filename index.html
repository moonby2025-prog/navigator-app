<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investment Navigator (Ìà¨Ïûê ÎπÑÏÑú)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome (Icons) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <!-- React, ReactDOM, Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; letter-spacing: -0.02em; overflow-x: hidden; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        .nav-tab.active { background-color: #eff6ff; color: #2563eb; font-weight: 700; box-shadow: 0 1px 2px rgba(37,99,235,0.2); }
        .dark .nav-tab.active { background-color: #1e293b; color: #60a5fa; }
        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .sim-input { 
            @apply mt-1 block w-full rounded-md border-gray-300 dark:border-slate-500 shadow-sm p-2 border bg-white dark:bg-slate-100 focus:ring-indigo-500 focus:border-indigo-500 text-sm font-bold !text-black dark:!text-black dark:placeholder-slate-500; 
        }
        .num-font { font-variant-numeric: tabular-nums; }
        .guide-card { @apply p-4 rounded-xl border border-slate-100 dark:border-slate-600 bg-white dark:bg-slate-800 shadow-sm; }
        
        .nav-container { overflow-x: auto; white-space: nowrap; -webkit-overflow-scrolling: touch; }
        .nav-container::-webkit-scrollbar { display: none; }

        .ticker-fallback {
            display: flex;
            white-space: nowrap;
            overflow: hidden;
            align-items: center;
            height: 100%;
            width: 100%;
        }
        .ticker-scroll {
            display: inline-flex;
            gap: 2rem;
            animation: tickerScroll 40s linear infinite;
            padding-left: 20px;
            white-space: nowrap;
        }
        @keyframes tickerScroll {
            0% { transform: translateX(0); }
            100% { transform: translateX(-100%); }
        }

        .tool-input { 
            @apply !bg-slate-100 dark:!bg-slate-100 border border-slate-300 dark:border-slate-500 shadow-sm focus:!bg-white dark:focus:!bg-white focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/10 transition-all !text-black dark:!text-black placeholder-slate-400 dark:placeholder-slate-500 font-bold; 
        }
        
        .dark input.sim-input, .dark input.tool-input, .dark select.sim-input, .dark select.tool-input, .dark .fav-item-btn {
            color: #000000 !important;
        }

        .fav-item-btn {
            @apply bg-slate-100 dark:bg-slate-100 border-slate-300 dark:border-slate-400 !text-black;
        }

        .tool-result-container {
            @apply mt-4 p-4 rounded-xl border-2 transition-all text-right shadow-sm;
        }

        .tool-input:hover { @apply border-slate-400 dark:border-slate-400 bg-slate-200 dark:bg-slate-200; }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-900 transition-colors duration-200">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, memo, useCallback, useMemo } = React;

        const ONE_HUNDRED_MILLION = 100000000;
        const TAX_THRESHOLD = 20000000;
        
        const DEFAULT_EXCHANGE_RATES = { 
            'KRW': { krw: 1 }, 
            'USD': { krw: 1380 }, 
            'JPY': { krw: 8.90 }, 
            'EUR': { krw: 1480 }, 
            'CNY': { krw: 190 }, 
            'ARS': { krw: 1.35 }, 
            'INR': { krw: 16.5 }
        };

        const DEFAULT_FAVORITES = [
            { code: "005930", name: "ÏÇºÏÑ±Ï†ÑÏûê" }, { code: "005380", name: "ÌòÑÎåÄÏ∞®" }, 
            { code: "237690", name: "ÏóêÏä§Ìã∞Ìåú" }, { code: "445680", name: "ÌÅêÎ¶¨Ïò•Ïä§" }
        ];

        const DEFAULT_ROUTINE_LINKS = {
            "üåÖ ÏïÑÏπ® ÌïÑÏàò Ï≤¥ÌÅ¨ (Morning Routine)": [
                { name: "ÎØ∏Íµ≠ ÏãúÏû• Ï†êÍ≤Ä", url: "https://kr.investing.com/portfolio/?portfolioID=OT4%2BZDRrZTFjM2thYTthYg%3D%3D", icon: "fa-list-check", color: "bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300" },
                { name: "Finviz (ÎØ∏Íµ≠ Îßµ)", url: "https://finviz.com/map.ashx", icon: "fa-map", color: "bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-300" },
                { name: "Í∏ÄÎ°úÎ≤åÎßàÏºìÏ∫°", url: "https://companiesmarketcap.com/", icon: "fa-chart-pie", color: "bg-indigo-100 text-indigo-700 dark:bg-indigo-900/30 dark:text-indigo-300" },
                { name: "ÌïÑÎùºÎç∏ÌîºÏïÑ Î∞òÎèÑÏ≤¥", url: "https://kr.investing.com/indices/phlx-semiconductor", icon: "fa-microchip", color: "bg-teal-100 text-teal-700 dark:bg-teal-900/30 dark:text-teal-300" },
                { name: "Í≥µÌè¨ ÌÉêÏöï ÏßÄÏàò (CNN)", url: "https://edition.cnn.com/markets/fear-and-greed", icon: "fa-gauge-high", color: "bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-300" },
                { name: "ÌÅ¨Î¶ΩÌÜ† ÏßÄÌëú (MVRV)", url: "https://www.bitcoinmagazinepro.com/charts/mvrv-zscore/", icon: "fa-chart-area", color: "bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-300" },
                { name: "SILVER (ÏùÄ Ïã§ÏãúÍ∞Ñ)", url: "https://kr.investing.com/currencies/xag-usd", icon: "fa-coins", color: "bg-slate-100 text-slate-700 dark:bg-slate-700 dark:text-slate-100" },
                { name: "ÏùÄÏãúÏÑ∏(ÏàúÏàòÌïúÍ∏à)", url: "https://blog.naver.com/wolfkickbox", icon: "fa-blog", color: "bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-300" },
                { name: "Ïã§Î≤ÑÌå©ÌÜ†Î¶¨ (Ïπ¥Ìéò)", url: "https://cafe.naver.com/7silverfactory7", icon: "fa-comments", color: "bg-slate-200 text-slate-700 dark:bg-slate-700 dark:text-slate-100" }
            ],
            "üí∞ Í≥µÎ™®Ï£º & Ïã§Ï†Å (IPO & Earnings)": [
                { name: "38 Ïª§ÎÆ§ÎãàÏºÄÏù¥ÏÖò", url: "http://www.38.co.kr/html/fund/index.htm?gjbcd=1460", icon: "fa-building", color: "bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-blue-300" },
                { name: "DART (Ï†ÑÏûêÍ≥µÏãú)", url: "https://dart.fss.or.kr/", icon: "fa-file-signature", color: "bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-300" },
                { name: "KIND (Í∏∞ÏóÖÍ≥µÏãú)", url: "https://kind.krx.co.kr/", icon: "fa-file-invoice", color: "bg-blue-50 text-blue-600 dark:bg-blue-900/20 dark:text-blue-300" },
                { name: "KRX Ï†ïÎ≥¥Îç∞Ïù¥ÌÑ∞ÏãúÏä§ÌÖú", url: "http://data.krx.co.kr/", icon: "fa-database", color: "bg-indigo-100 text-indigo-700 dark:bg-indigo-900/30 dark:text-indigo-300" },
                { name: "Seibro (Ï¶ùÍ∂åÏ†ïÎ≥¥Ìè¨ÌÑ∏)", url: "https://seibro.or.kr/", icon: "fa-server", color: "bg-indigo-50 text-indigo-600 dark:bg-indigo-900/20 dark:text-blue-300" },
                { name: "Ï¢ÖÎ™©Î≥Ñ Ïô∏Íµ≠Ïù∏ Íµ≠Ï†ÅÎ∂ÑÎ•ò", url: "https://data.krx.co.kr/contents/MDC/HARD/hardController/MDCHARD053.cmd", icon: "fa-globe", color: "bg-blue-50 text-blue-700 dark:bg-blue-900/20 dark:text-blue-300" }
            ],
            "üìà Íµ≠ÎÇ¥ ÏãúÏû• Ïã¨Ï∏µ (Korea Market)": [
                { name: "Npay Ï¶ùÍ∂å", url: "https://stock.naver.com/", icon: "fa-n", color: "bg-green-50 text-green-600 dark:bg-green-900/20 dark:text-green-300" },
                { name: "Î≤ÑÌãÄÎü¨ (Butler)", url: "https://www.butler.works/ko/home", icon: "fa-chart-line", color: "bg-purple-50 text-purple-600 dark:bg-purple-900/20 dark:text-purple-300" },
                { name: "ÌïúÍ≤Ω Ïª®ÏÑºÏÑúÏä§", url: "https://markets.hankyung.com/consensus", icon: "fa-book-open", color: "bg-red-50 text-red-600 dark:bg-red-900/20 dark:text-red-300" },
                { name: "SMIC (ÏÑúÏö∏ÎåÄ Î¶¨ÏÑúÏπò)", url: "http://snusmic.com/research/", icon: "fa-graduation-cap", color: "bg-slate-200 text-slate-800 dark:bg-slate-700 dark:text-slate-100" },
                { name: "FDA ÏäπÏù∏ Ïã§ÏãúÍ∞Ñ", url: "https://www.youtube.com/user/USFoodandDrugAdmin", icon: "fa-video", color: "bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-300" },
                { name: "Ï£ºÏãù/Î∂ÄÎèôÏÇ∞ Î™®ÏïÑÎ¥ê", url: "http://moabbs.com/blogs/lists", icon: "fa-users", color: "bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-300" },
                { name: "Ï†ÑÏûêÏû°ÏßÄ (Î™®ÏïÑÏßÑ)", url: "https://lib.ice.go.kr/elib/module/elib/moazine.do?menu_idx=37", icon: "fa-book-open", color: "bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-300" }
            ],
            "üè° ÏùºÏÉÅ & Î∂ÄÎèôÏÇ∞ (Daily Life)": [
                { name: "Ìò∏Í∞±ÎÖ∏ÎÖ∏", url: "https://hogangnono.com/", icon: "fa-map-pin", color: "bg-red-50 text-red-600 dark:bg-red-900/20 dark:text-red-300" },
                { name: "ÎÑ§Ïù¥Î≤Ñ Î∂ÄÎèôÏÇ∞", url: "https://land.naver.com/", icon: "fa-building", color: "bg-green-50 text-green-600 dark:bg-green-900/20 dark:text-green-300" },
                { name: "Î∞∏Î•òÎßµ (ÌÜ†ÏßÄ/Í±¥Î¨º)", url: "https://www.valueupmap.com/", icon: "fa-map", color: "bg-orange-50 text-orange-600 dark:bg-orange-900/20 dark:text-orange-300" },
                { name: "ÎåÄÎ≤ïÏõê Ïù∏ÌÑ∞ÎÑ∑Îì±Í∏∞ÏÜå", url: "http://www.iros.go.kr/", icon: "fa-scale-balanced", color: "bg-slate-200 text-slate-800 dark:bg-slate-700 dark:text-slate-100" },
                { name: "ÎØºÏõê24 (Ï†ïÎ∂Ä24)", url: "https://www.gov.kr/", icon: "fa-id-card", color: "bg-blue-50 text-blue-600 dark:bg-blue-900/20 dark:text-blue-300" },
                { name: "Íµ≠ÏÑ∏Ï≤≠ ÌôàÌÉùÏä§", url: "https://www.hometax.go.kr/", icon: "fa-file-invoice-dollar", color: "bg-blue-100 text-blue-700 dark:bg-blue-800 dark:text-blue-100" },
                { name: "ÎÑ§Ïù¥Î≤Ñ ÏßÄÎèÑ", url: "https://map.naver.com/", icon: "fa-location-dot", color: "bg-green-50 text-green-600 dark:bg-green-900/20 dark:text-green-300" },
                { name: "Íµ¨Í∏Ä ÏßÄÎèÑ", url: "https://maps.google.com/", icon: "fa-location-dot", color: "bg-amber-50 text-amber-600 dark:bg-amber-900/20 dark:text-amber-300" }
            ]
        };

        const DEFAULT_BLOG_LINKS = {
            "üß¨ ÌÅêÎ¶¨Ïò•Ïä§Î∞îÏù¥Ïò§ÏãúÏä§ÌÖúÏ¶à": [
                {name: "ÌïúÍ≥ÑÎ•º Íπ®Îäî ÏÇ¨Îûå", url: "https://blog.naver.com/unlimitedi", icon: "fa-dna", color: "bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-300"},
                {name: "ÎÇòÎäî Ï†ÑÏÑ§Ïù¥Îã§", url: "https://blog.naver.com/legendyu", icon: "fa-star", color: "bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-300"},
                {name: "Ïù¥Í≥µÍ≥Ñ", url: "https://blog.naver.com/shyny38", icon: "fa-flask", color: "bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-300"},
                {name: "Í≥µÎåÄÏÉù Ï£ºÏ†ëÎÖ∏Ìä∏", url: "https://blog.naver.com/b_g-duck", icon: "fa-pen-clip", color: "bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-300"}
            ],
            "üíä ÏóêÏä§Ìã∞Ìåú": [
                {name: "Ïò§Ïû¨Î≥µ", url: "https://blog.naver.com/hym090206", icon: "fa-user-tie", color: "bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300"},
                {name: "Ïô†ÏßÄÏÉÅÏæåÌïúÏÇ¨Îûå", url: "https://blog.naver.com/aphorism86", icon: "fa-wind", color: "bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300"},
                {name: "Chan", url: "https://blog.naver.com/chany2do", icon: "fa-bolt", color: "bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300"}
            ]
        };

        const formatNumber = (num) => {
            if (num === null || num === undefined || isNaN(num)) return '0';
            return Math.round(num).toLocaleString('ko-KR');
        };
        const parseFormattedNumber = (value) => {
            if (typeof value !== 'string') return value || 0;
            return parseInt(value.replace(/[^0-9]/g, '')) || 0;
        };

        const calculateProgressiveIncomeTax = (income, rates) => {
            if (income <= 0) return 0;
            const threshold1 = 40000000;
            const threshold2 = 80000000;
            let tax = 0;
            const income1 = Math.min(income, threshold1);
            tax += income1 * (rates.rate1 / 100);
            if (income > threshold1) {
                const income2 = Math.min(income, threshold2) - threshold1;
                tax += income2 * (rates.rate2 / 100);
            }
            if (income > threshold2) {
                const income3 = income - threshold2;
                tax += income3 * (rates.rate3 / 100);
            }
            return Math.max(0, tax);
        };

        const TradingViewTicker = memo(({ theme }) => {
            const containerRef = useRef(null);
            const [isLoaded, setIsLoaded] = useState(false);

            useEffect(() => {
                const container = containerRef.current;
                if (!container) return;
                
                container.innerHTML = '';
                const widgetDiv = document.createElement('div');
                widgetDiv.className = 'tradingview-widget-container__widget';
                container.appendChild(widgetDiv);

                const script = document.createElement('script');
                script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-ticker-tape.js';
                script.async = true;
                script.innerHTML = JSON.stringify({
                    "symbols": [
                        { "proName": "FOREXCOM:SPXUSD", "title": "S&P 500" },
                        { "proName": "NASDAQ:QQQ", "title": "ÎÇòÏä§Îã• QQQ" },
                        { "proName": "FX_IDC:USDKRW", "title": "ÏõêÎã¨Îü¨ ÌôòÏú®" },
                        { "proName": "FX_IDC:XAGUSD", "title": "ÏùÄ ÌòÑÎ¨º (XAG/USD)" },
                        { "proName": "BINANCE:BTCUSDT", "title": "ÎπÑÌä∏ÏΩîÏù∏" },
                        { "proName": "TVC:GOLD", "title": "Í∏à ÌòÑÎ¨º (XAU/USD)" },
                        { "proName": "FX_IDC:JPYKRW", "title": "ÏóîÌôî ÌôòÏú®" }
                    ],
                    "showSymbolLogo": true,
                    "colorTheme": theme,
                    "isTransparent": true,
                    "displayMode": "adaptive",
                    "locale": "kr"
                });

                script.onload = () => setIsLoaded(true);
                container.appendChild(script);

                const checkTimer = setTimeout(() => {
                    if (container.querySelector('iframe')) setIsLoaded(true);
                }, 2500);

                return () => clearTimeout(checkTimer);
            }, [theme]);

            return (
                <div className="relative w-full h-full overflow-hidden flex items-center">
                    <div className={`tradingview-widget-container w-full ${isLoaded ? 'opacity-100' : 'opacity-0'} transition-opacity duration-500`} ref={containerRef}></div>
                    {!isLoaded && (
                        <div className="absolute inset-0 ticker-fallback text-[11px] font-bold text-slate-500 dark:text-slate-300">
                            <div className="ticker-scroll">
                                <span><i className="fa-solid fa-chart-line mr-1 text-blue-500"></i> S&P 500: ÏßÄÏàò Î°úÎî© Ï§ë...</span>
                                <span><i className="fa-solid fa-money-bill-1-wave mr-1 text-emerald-500"></i> USD/KRW: 1,380.00</span>
                                <span><i className="fa-brands fa-bitcoin mr-1 text-orange-500"></i> BTC/USDT: Ïã§ÏãúÍ∞Ñ Ïó∞Í≤∞ Ï§ë</span>
                                <span><i className="fa-solid fa-coins mr-1 text-yellow-500"></i> GOLD: ÏãúÏÑ∏ ÏàòÏã† Ï§ë...</span>
                                <span><i className="fa-solid fa-chart-line mr-1 text-red-500"></i> KOSPI: Ï†ïÎ≥¥ Î°úÎî© Ï§ë...</span>
                            </div>
                        </div>
                    )}
                </div>
            );
        });

        const TradingViewHeatmap = memo(({ theme }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (!ref.current) return;
                ref.current.innerHTML = '';
                const script = document.createElement('script');
                script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-stock-heatmap.js';
                script.async = true;
                script.innerHTML = JSON.stringify({
                    "dataSource": "SPX500", "grouping": "sector", "blockSize": "market_cap_basic", "blockColor": "change", "locale": "kr", "colorTheme": theme, "hasTopBar": false, "isTransparent": true, "width": "100%", "height": "100%"
                });
                ref.current.appendChild(script);
            }, [theme]);
            return <div ref={ref} className="h-full"></div>;
        });

        function App() {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [isDark, setIsDark] = useState(false);
            const [linkMode, setLinkMode] = useState('investment');
            const [marketStatus, setMarketStatus] = useState({ text: 'Ïû• ÎßàÍ∞ê', color: 'bg-red-600' });
            
            const [exchangeRates, setExchangeRates] = useState(DEFAULT_EXCHANGE_RATES);
            const [lastUpdated, setLastUpdated] = useState('Ïó∞Í≤∞ Ï§ë...');
            const [isFetching, setIsFetching] = useState(false);

            const [isRoutineEditMode, setIsRoutineEditMode] = useState(false);
            const [newFav, setNewFav] = useState({ name: '', code: '' });
            const [newRoutine, setNewRoutine] = useState({ category: '', name: '', url: '' });

            // LocalStorageÏóêÏÑú Îç∞Ïù¥ÌÑ∞ Î∂àÎü¨Ïò§Í∏∞
            const [favorites, setFavorites] = useState(() => {
                try {
                    const saved = localStorage.getItem('invNav_favorites');
                    return saved ? JSON.parse(saved) : DEFAULT_FAVORITES;
                } catch (e) { return DEFAULT_FAVORITES; }
            });

            const [routineLinks, setRoutineLinks] = useState(() => {
                try {
                    const saved = localStorage.getItem('invNav_routineLinks');
                    return saved ? JSON.parse(saved) : DEFAULT_ROUTINE_LINKS;
                } catch (e) { return DEFAULT_ROUTINE_LINKS; }
            });

            const [blogInsightLinks, setBlogInsightLinks] = useState(() => {
                try {
                    const saved = localStorage.getItem('invNav_blogLinks');
                    return saved ? JSON.parse(saved) : DEFAULT_BLOG_LINKS;
                } catch (e) { return DEFAULT_BLOG_LINKS; }
            });

            useEffect(() => { localStorage.setItem('invNav_favorites', JSON.stringify(favorites)); }, [favorites]);
            useEffect(() => { localStorage.setItem('invNav_routineLinks', JSON.stringify(routineLinks)); }, [routineLinks]);
            useEffect(() => { localStorage.setItem('invNav_blogLinks', JSON.stringify(blogInsightLinks)); }, [blogInsightLinks]);

            const [targetInputs, setTargetInputs] = useState({ mode: 'cap', price: '', shares: '', currentCap: '', targetCap: '', targetRate: '' });
            const [ipoCalcInputs, setIpoCalcInputs] = useState({ price: '', qty: '', fee: '', rate: 50 });
            const [avgRows, setAvgRows] = useState([{ id: 1, q: '', p: '' }]);
            const [exchInputs, setExchInputs] = useState({ base: 'USD', target: 'KRW', amount: '' });
            const [divInputs, setDivInputs] = useState({ shares: '', perShare: '', tax: '15.4' });
            const [toolTaxInputs, setToolTaxInputs] = useState({ profit: '', type: 'dividend' });

            const [simInputs, setSimInputs] = useState({
                currentAge: 52, spouseCurrentAge: 48, simulationStartAge: 53, 
                pensionStartAgeUser: 65, pensionStartAgeSpouse: 65,
                pensionStrategyUser: "normal", pensionStrategySpouse: "normal",
                highCostStartAge: 80,
                capUserNonISA: 0.0, capSpouseNonISA: 0.0, capUserISA: 2.0, capSpouseISA: 1.0, 
                capIPO: 5.0,
                returnUserNonISA: 0.0, returnSpouseNonISA: 0.0, 
                returnUserISA: 5.0, returnSpouseISA: 5.0, 
                returnIPO: 4.0, returnCMA: 2.0, 
                inflationRate: 2.0, livingCostInflationRate: 1.5, taxRate1: 6.6, taxRate2: 16.5, taxRate3: 27.5,
                monthlyLiving: "4,000,000", pensionSelf: "1,000,000", pensionSpouse: "600,000", 
                ipoProfit: "5,000,000", 
                otherIncome: "4,500,000", stockLending: "0", rentalIncome: "850,000",
                targetLegacy: "200,000,000", 
                extraReserve: "5,000,000", 
                monthlyMedical: "1,000,000"
            });
            const [simResult, setSimResult] = useState({ history: [], summary: null });
            const [simTableVisibleCols, setSimTableVisibleCols] = useState({
                taxable: true, exempt: true, income: true, expense: true, flow: true, status: true
            });
            const [isSimColMenuOpen, setIsSimColMenuOpen] = useState(false);

            const [earnedIncome, setEarnedIncome] = useState("20,000,000"); 
            const [finList, setFinList] = useState([{ id: 1, source: 'Î∞∞ÎãπÍ∏à Ìï©Í≥Ñ', amount: 35000000 }]);

            const handleCommaChange = (e, callback) => {
                const val = e.target.value.replace(/[^0-9]/g, '');
                callback(val ? parseInt(val).toLocaleString('ko-KR') : '');
            };

            const fetchRealTimeRates = useCallback(async () => {
                setIsFetching(true);
                try {
                    const response = await fetch('https://open.er-api.com/v6/latest/KRW');
                    const data = await response.json();
                    if (data.result === 'success') {
                        const rates = data.rates;
                        const newRates = {
                            'KRW': { krw: 1 }, 
                            'USD': { krw: 1 / (rates.USD || 0.00072) }, 
                            'JPY': { krw: 1 / (rates.JPY || 0.11) },
                            'EUR': { krw: 1 / (rates.EUR || 0.00067) }, 
                            'CNY': { krw: 1 / (rates.CNY || 0.0052) },
                            'ARS': { krw: 1 / (rates.ARS || 0.65) }, 
                            'INR': { krw: 1 / (rates.INR || 0.06) }
                        };
                        setExchangeRates(newRates);
                        setLastUpdated(new Date().toLocaleString());
                    }
                } catch (error) { setLastUpdated("Ïã§Ìå® (Í∏∞Î≥∏Í∞í ÏÇ¨Ïö©)"); } finally { setIsFetching(false); }
            }, []);

            useEffect(() => {
                fetchRealTimeRates();
                const timer = setInterval(() => {
                    const now = new Date(); const hours = now.getHours(); const day = now.getDay();
                    let status = { text: "Ïû• ÎßàÍ∞ê", color: "bg-red-600" };
                    if (hours >= 9 && hours < 16 && day !== 0 && day !== 6) status = { text: "Íµ≠ÎÇ¥ Ïû• Ïö¥ÏòÅ", color: "bg-green-600" };
                    else if (hours >= 22 || hours < 6) status = { text: "ÎØ∏Íµ≠ Ïû• Ïö¥ÏòÅ", color: "bg-blue-600" };
                    setMarketStatus(status);
                }, 1000);
                return () => clearInterval(timer);
            }, [fetchRealTimeRates]);

            useEffect(() => {
                if (isDark) document.documentElement.classList.add('dark');
                else document.documentElement.classList.remove('dark');
            }, [isDark]);

            const searchSymbol = (query) => {
                if(!query || query.trim() === "") { window.open('https://stock.naver.com/', '_blank'); return; }
                const trimmed = query.trim();
                const url = /[a-zA-Z]/.test(trimmed) ? `https://finance.naver.com/world/sise.naver?symbol=${trimmed.toUpperCase()}` : `https://finance.naver.com/item/main.naver?code=${trimmed}`;
                window.open(url, '_blank');
            };

            const getAdjustedPensionAmount = (baseAmount, strategy) => {
                let ageAdj = 0;
                let amountMult = 1.0;
                if (strategy.startsWith('early')) {
                    const years = parseInt(strategy.replace('early', ''));
                    ageAdj = -years;
                    amountMult = 1 - (years * 0.06);
                } else if (strategy.startsWith('defer')) {
                    const years = parseInt(strategy.replace('early', '')); // Fixed logic: should handle defer properly
                    const deferYears = parseInt(strategy.replace('defer', ''));
                    ageAdj = deferYears;
                    amountMult = 1 + (deferYears * 0.072);
                }
                return { startAge: 65 + ageAdj, monthlyAmount: baseAmount * amountMult };
            };

            const runSimulation = useCallback(() => {
                const s = simInputs;
                const ageDiff = s.currentAge - s.spouseCurrentAge;
                let cUserNon = s.capUserNonISA * ONE_HUNDRED_MILLION;
                let cSpouseNon = s.capSpouseNonISA * ONE_HUNDRED_MILLION;
                let cUserISA = s.capUserISA * ONE_HUNDRED_MILLION;
                let cSpouseISA = s.capSpouseISA * ONE_HUNDRED_MILLION;
                let cIPO = (s.capIPO || 0) * ONE_HUNDRED_MILLION;
                
                const targetLegacyValue = parseFormattedNumber(s.targetLegacy);
                const extraReserveValue = parseFormattedNumber(s.extraReserve);
                const medicalCostMonthly = parseFormattedNumber(s.monthlyMedical);
                
                const initLiving = parseFormattedNumber(s.monthlyLiving) * 12;
                
                const userPenInfo = getAdjustedPensionAmount(parseFormattedNumber(s.pensionSelf), s.pensionStrategyUser);
                const spousePenInfo = getAdjustedPensionAmount(parseFormattedNumber(s.pensionSpouse), s.pensionStrategySpouse);
                
                const initOtherTotal = parseFormattedNumber(s.ipoProfit) + parseFormattedNumber(s.otherIncome) + parseFormattedNumber(s.stockLending) + parseFormattedNumber(s.rentalIncome);
                let history = []; let totalTax = 0; let depletionYear = null;
                const period = Math.max(1, 101 - s.simulationStartAge);
                
                for (let year = 1; year <= period; year++) {
                    const age = s.simulationStartAge + year - 1;
                    const spouseAge = age - ageDiff;
                    const pInf = Math.pow(1 + (s.inflationRate / 100), year - 1);
                    const lInf = Math.pow(1 + (s.livingCostInflationRate / 100), year - 1);
                    
                    let weight = 1.0; let isHighCost = false; let lateLifeMedicalAnnual = 0;
                    if (age >= Math.min(userPenInfo.startAge, spousePenInfo.startAge)) {
                        if (age < s.highCostStartAge - 5) weight = 1.1; 
                        else if (age < s.highCostStartAge) weight = 0.9; 
                        else { weight = 0.7; lateLifeMedicalAnnual = medicalCostMonthly * 12 * lInf; isHighCost = true; }
                    }
                    
                    const livingCost = (initLiving * lInf * weight) + lateLifeMedicalAnnual + extraReserveValue;
                    
                    let pension = 0;
                    if (age >= userPenInfo.startAge) pension += userPenInfo.monthlyAmount * 12; 
                    if (spouseAge >= spousePenInfo.startAge) pension += spousePenInfo.monthlyAmount * 12;
                    
                    const annualPension = pension * pInf;
                    const annualOthers = initOtherTotal * pInf;
                    const baseIncomeAtYear = annualPension + annualOthers;
                    
                    const grossUserNon = cUserNon * (s.returnUserNonISA / 100);
                    const grossSpouseNon = cSpouseNon * (s.returnSpouseNonISA / 100);
                    const ipoCmaProfit = cIPO * (s.returnCMA / 100); 
                    const ipoCapitalProfit = cIPO * (s.returnIPO / 100); 
                    const grossIPO = ipoCmaProfit + ipoCapitalProfit;
                    const grossUserISA = cUserISA * (s.returnUserISA / 100);
                    const grossSpouseISA = cSpouseISA * (s.returnSpouseISA / 100);

                    const taxableProfitAtYear = grossUserNon + grossSpouseNon + ipoCmaProfit;
                    const separateExemptProfitAtYear = ipoCapitalProfit + grossUserISA + grossSpouseISA;

                    const profUserNon = grossUserNon * 0.846;
                    const profSpouseNon = grossSpouseNon * 0.846;
                    const profUserISA = grossUserISA * 0.901;
                    const profSpouseISA = grossSpouseISA * 0.901;
                    const profIPO = grossIPO * 0.846;
                    
                    const profInvestmentTotal = profUserNon + profSpouseNon + profUserISA + profSpouseISA + profIPO;
                    const incTax = calculateProgressiveIncomeTax(baseIncomeAtYear, { rate1: s.taxRate1, rate2: s.taxRate2, rate3: s.taxRate3 });
                    totalTax += incTax;

                    const annualProfitTotal = profInvestmentTotal + baseIncomeAtYear;
                    const annualExpenseTotal = livingCost + incTax;
                    const netChange = annualProfitTotal - annualExpenseTotal;

                    if (netChange >= 0) {
                        const tBefore = cUserNon + cSpouseNon + cUserISA + cSpouseISA + cIPO;
                        if (tBefore > 0) {
                            const r1 = cUserNon / tBefore; const r2 = cSpouseNon / tBefore; const r3 = cUserISA / tBefore; const r4 = cSpouseISA / tBefore; const r5 = cIPO / tBefore;
                            cUserNon += netChange * r1; cSpouseNon += netChange * r2; cUserISA += netChange * r3; cSpouseISA += netChange * r4; cIPO += netChange * r5;
                        } else { cUserNon += netChange; }
                    } else {
                        let rem = Math.abs(netChange);
                        let wIPO = Math.min(rem, cIPO); cIPO -= wIPO; rem -= wIPO;
                        let w2 = Math.min(rem, cSpouseNon); cSpouseNon -= w2; rem -= w2;
                        let w1 = Math.min(rem, cUserNon); cUserNon -= w1; rem -= w1;
                        let w3 = Math.min(rem, cSpouseISA); cSpouseISA -= w3; rem -= w3;
                        let w4 = Math.min(rem, cUserISA); cUserISA -= w4; rem -= w4;
                        if (rem > 0 && !depletionYear) depletionYear = age;
                    }

                    const currentTotal = cUserNon + cSpouseNon + cUserISA + cSpouseISA + cIPO;
                    history.push({ 
                        age, total: currentTotal / ONE_HUNDRED_MILLION, tax: incTax, living: livingCost, 
                        profInvestment: profInvestmentTotal, taxableProfit: taxableProfitAtYear,
                        separateExemptProfit: separateExemptProfitAtYear, baseIncome: baseIncomeAtYear,
                        annualProfit: annualProfitTotal, netChange: netChange, un: cUserNon, sn: cSpouseNon, 
                        ui: cUserISA, si: cSpouseISA, cip: cIPO, isHighCost,
                        medicalShare: (lateLifeMedicalAnnual / livingCost) * 100, isWarn: currentTotal < targetLegacyValue,
                        details: {
                            taxable: { u: grossUserNon, s: grossSpouseNon, c: ipoCmaProfit },
                            exempt: { i: ipoCapitalProfit, ui: grossUserISA, si: grossSpouseISA },
                            income: { p: annualPension, o: annualOthers }
                        }
                    });
                    if (currentTotal <= 0 && year > 1) break;
                }
                setSimResult({ history, summary: { initial: s.capUserNonISA + s.capSpouseNonISA + s.capUserISA + s.capSpouseISA + s.capIPO, final: (history[history.length-1]?.total * ONE_HUNDRED_MILLION) || 0, tax: totalTax, depletion: depletionYear, isSuccess: (history[history.length-1]?.total * ONE_HUNDRED_MILLION) >= targetLegacyValue } });
            }, [simInputs]);

            useEffect(() => { runSimulation(); }, [runSimulation]);

            const SimulationChart = memo(({ history }) => {
                const canvasRef = useRef(null);
                const chartInstance = useRef(null);
                useEffect(() => {
                    if (!canvasRef.current || history.length === 0) return;
                    const ctx = canvasRef.current.getContext('2d');
                    if (chartInstance.current) chartInstance.current.destroy();
                    chartInstance.current = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: history.map(h => h.age + "ÏÑ∏"),
                            datasets: [
                                { label: 'Ï¥ù ÏûêÏÇ∞(Ïñµ)', data: history.map(h => h.total), borderColor: '#4f46e5', fill: true, backgroundColor: 'rgba(79, 70, 229, 0.1)', tension: 0.3, pointRadius: 2 },
                                { label: 'Î≥∏Ïù∏ ÏùºÎ∞ò', data: history.map(h => h.un / ONE_HUNDRED_MILLION), borderColor: '#ef4444', borderDash: [2,2], pointRadius: 0 },
                                { label: 'Î∞∞Ïö∞Ïûê ÏùºÎ∞ò', data: history.map(h => h.sn / ONE_HUNDRED_MILLION), borderColor: '#f59e0b', borderDash: [2,2], pointRadius: 0 },
                                { label: 'Í≥µÎ™®Ï£º', data: history.map(h => h.cip / ONE_HUNDRED_MILLION), borderColor: '#8b5cf6', borderDash: [4,2], pointRadius: 0 },
                                { label: 'Î≥∏Ïù∏ ISA', data: history.map(h => h.ui / ONE_HUNDRED_MILLION), borderColor: '#10b981', pointRadius: 0 },
                                { label: 'Î∞∞Ïö∞Ïûê ISA', data: history.map(h => h.si / ONE_HUNDRED_MILLION), borderColor: '#3b82f6', pointRadius: 0 }
                            ]
                        },
                        options: { 
                            responsive: true, maintainAspectRatio: false, animation: false,
                            scales: { y: { beginAtZero: true } },
                            plugins: { legend: { position: 'top', labels: { boxWidth: 10, font: { size: 10, weight: 'bold' } } } }
                        }
                    });
                    return () => { if (chartInstance.current) chartInstance.current.destroy(); };
                }, [history]);
                return <div className="h-64 md:h-80 w-full"><canvas ref={canvasRef}></canvas></div>;
            });

            const addFavorite = () => { if (!newFav.name || !newFav.code) return; setFavorites([...favorites, { name: newFav.name, code: newFav.code }]); setNewFav({ name: '', code: '' }); };
            const removeFavorite = (code) => { setFavorites(favorites.filter(f => f.code !== code)); };
            const addRoutineLink = () => { if (!newRoutine.category || !newRoutine.name || !newRoutine.url) return; const updated = { ...routineLinks }; updated[newRoutine.category] = [...updated[newRoutine.category], { name: newRoutine.name, url: newRoutine.url, icon: "fa-link", color: "bg-slate-100 text-slate-700 dark:bg-slate-700 dark:text-slate-100" }]; setRoutineLinks(updated); setNewRoutine({ category: '', name: '', url: '' }); };
            const removeRoutineLink = (category, index) => { const updated = { ...routineLinks }; updated[category] = updated[category].filter((_, i) => i !== index); setRoutineLinks(updated); };

            const renderDashboard = () => (
                <div className="space-y-6 animate-fade-in pb-10">
                    <div className="bg-white dark:bg-slate-800 rounded-xl shadow h-[120px] sm:h-24 overflow-hidden border dark:border-slate-700 relative flex items-center">
                        <TradingViewTicker theme={isDark ? 'dark' : 'light'} />
                    </div>
                    <div className="bg-white dark:bg-slate-800 p-1 rounded-xl shadow h-[400px] border dark:border-slate-700 flex flex-col">
                        <div className="p-3 border-b dark:border-slate-700 flex justify-between items-center font-bold">
                            <span className="dark:text-white">S&P 500 ÌûàÌä∏Îßµ</span>
                            <span className={`px-2 py-0.5 rounded-full text-[10px] text-white ${marketStatus.color}`}>{marketStatus.text}</span>
                        </div>
                        <div className="flex-1 overflow-hidden">
                            <TradingViewHeatmap theme={isDark ? 'dark' : 'light'} />
                        </div>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div className="bg-white dark:bg-slate-800 rounded-xl shadow border dark:border-slate-700 p-5 font-bold">
                            <h3 className="text-xl font-bold mb-4 flex items-center gap-2 text-indigo-500 dark:text-indigo-400"><i className="fa-solid fa-magnifying-glass-chart"></i> Ï¢ÖÎ™© Í≤ÄÏÉâ</h3>
                            <div className="flex flex-col sm:flex-row gap-2 mb-4">
                                <input type="text" id="mainSearch" placeholder="Ï¢ÖÎ™©Î™Ö ÎòêÎäî ÏΩîÎìú (Í≥µÎ∞± Ïãú ÎÑ§Ïù¥Î≤Ñ Ï¶ùÍ∂å)" className="flex-1 p-3 border-2 border-indigo-200 dark:border-indigo-900 rounded-lg dark:bg-slate-700 outline-none w-full dark:text-white dark:placeholder-slate-300" onKeyPress={e=>e.key==='Enter'&&searchSymbol(e.target.value)} />
                                <button onClick={() => searchSymbol(document.getElementById('mainSearch').value)} className="bg-indigo-600 text-white px-6 py-3 sm:py-0 rounded-lg font-bold w-full sm:w-auto">Í≤ÄÏÉâ</button>
                            </div>
                            <div className="flex flex-wrap gap-2 mb-6">
                                {favorites.map(s => (
                                    <div key={s.code} className="flex items-center group">
                                        <button onClick={() => searchSymbol(s.code)} className="px-3 py-1.5 bg-slate-50 dark:bg-slate-100 border dark:border-slate-500 border-r-0 rounded-l-lg text-xs hover:border-indigo-400 group-hover:border-indigo-400 text-slate-800 !font-black fav-item-btn">
                                            {s.name}
                                        </button>
                                        <button onClick={() => removeFavorite(s.code)} className="px-2 py-1.5 bg-slate-50 dark:bg-slate-100 border dark:border-slate-500 rounded-r-lg text-[10px] text-red-400 hover:text-red-600 hover:border-indigo-400 group-hover:border-indigo-400">
                                            <i className="fa-solid fa-xmark"></i>
                                        </button>
                                    </div>
                                ))}
                            </div>
                            <div className="p-4 bg-slate-50 dark:bg-slate-900 rounded-xl border-2 border-dashed border-slate-200 dark:border-slate-600">
                                <h4 className="text-xs text-indigo-500 dark:text-indigo-300 mb-2 font-black">ÏÉà Ï¶êÍ≤®Ï∞æÍ∏∞ Ï∂îÍ∞Ä</h4>
                                <div className="flex flex-col sm:flex-row gap-2">
                                    <input type="text" placeholder="Ï¢ÖÎ™©Î™Ö" className="flex-1 sim-input !mt-0 !p-1 text-xs" value={newFav.name} onChange={e=>setNewFav({...newFav, name:e.target.value})} />
                                    <input type="text" placeholder="ÏΩîÎìú" className="sm:w-24 sim-input !mt-0 !p-1 text-xs" value={newFav.code} onChange={e=>setNewFav({...newFav, code:e.target.value})} />
                                    <button onClick={addFavorite} className="bg-indigo-600 text-white px-3 py-2 sm:py-0 rounded text-xs font-black w-full sm:w-auto">Ï∂îÍ∞Ä</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );

            const renderRoutine = () => (
                <div className="space-y-6 animate-fade-in pb-10 overflow-x-hidden">
                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 pb-4 border-b dark:border-slate-700 font-bold">
                        <div className="flex items-center gap-4">
                            <h2 className="text-2xl font-black dark:text-white">Ïò§ÎäòÏùò Î£®Ìã¥</h2>
                            <button onClick={() => setIsRoutineEditMode(!isRoutineEditMode)} className={`px-3 py-1 rounded text-xs transition-all ${isRoutineEditMode ? 'bg-indigo-600 text-white shadow-lg' : 'bg-slate-200 dark:bg-slate-700 text-slate-500 dark:text-white'}`}>
                                <i className="fa-solid fa-pen-to-square mr-1"></i> {isRoutineEditMode ? 'Ìé∏Ïßë ÏôÑÎ£å' : 'ÎßÅÌÅ¨ Ìé∏Ïßë'}
                            </button>
                        </div>
                        <div className="flex bg-slate-100 dark:bg-slate-700 p-1 rounded-lg w-full sm:w-auto shadow-inner">
                            <button onClick={() => setLinkMode('investment')} className={`flex-1 sm:flex-none px-6 py-2 text-xs font-black rounded-lg transition-all ${linkMode === 'investment' ? 'bg-white shadow text-blue-600 dark:bg-slate-600 dark:text-blue-200' : 'text-slate-500 dark:text-slate-400'}`}>Ìà¨Ïûê & ÏùºÏÉÅ</button>
                            <button onClick={() => setLinkMode('blogs')} className={`flex-1 sm:flex-none px-6 py-2 text-xs font-black rounded-lg transition-all ${linkMode === 'blogs' ? 'bg-white shadow text-emerald-600 dark:bg-slate-600 dark:text-emerald-300' : 'text-slate-500 dark:text-slate-400'}`}>Ïù∏ÏÇ¨Ïù¥Ìä∏ Î∏îÎ°úÍ∑∏</button>
                        </div>
                    </div>

                    {isRoutineEditMode && (
                        <div className="p-6 bg-indigo-50 dark:bg-indigo-900/10 rounded-2xl border-2 border-indigo-200 dark:border-indigo-800 animate-fade-in mb-6">
                            <h3 className="font-black text-indigo-600 dark:text-indigo-400 mb-4 text-sm"><i className="fa-solid fa-plus-circle mr-2"></i>ÏÉà Î£®Ìã¥ ÎßÅÌÅ¨ Ï∂îÍ∞Ä</h3>
                            <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-3">
                                <select className="sim-input !mt-0 text-xs" value={newRoutine.category} onChange={e=>setNewRoutine({...newRoutine, category:e.target.value})}>
                                    <option value="">Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÑ†ÌÉù</option>
                                    {Object.keys(linkMode === 'blogs' ? blogInsightLinks : routineLinks).map(cat => <option key={cat} value={cat}>{cat}</option>)}
                                </select>
                                <input type="text" placeholder="ÏÇ¨Ïù¥Ìä∏Î™Ö" className="sim-input !mt-0 text-xs" value={newRoutine.name} onChange={e=>setNewRoutine({...newRoutine, name:e.target.value})} />
                                <input type="text" placeholder="URL" className="sim-input !mt-0 text-xs" value={newRoutine.url} onChange={e=>setNewRoutine({...newRoutine, url:e.target.value})} />
                                <button onClick={() => {
                                    if(linkMode === 'blogs') {
                                        if (!newRoutine.category || !newRoutine.name || !newRoutine.url) return;
                                        const updated = { ...blogInsightLinks };
                                        updated[newRoutine.category] = [...updated[newRoutine.category], { name: newRoutine.name, url: newRoutine.url, icon: "fa-link", color: "bg-slate-100 text-slate-700 dark:bg-slate-700 dark:text-slate-100" }];
                                        setBlogInsightLinks(updated);
                                        setNewRoutine({ category: '', name: '', url: '' });
                                    } else { addRoutineLink(); }
                                }} className="bg-indigo-600 text-white rounded font-black text-xs h-10">Ï∂îÍ∞ÄÌïòÍ∏∞</button>
                            </div>
                        </div>
                    )}
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 font-bold">
                        {Object.entries(linkMode === 'blogs' ? blogInsightLinks : routineLinks).map(([cat, links]) => (
                            <div key={cat} className="bg-white dark:bg-slate-800 rounded-2xl p-6 shadow-lg border dark:border-slate-700 transition-all hover:shadow-xl">
                                <h3 className={`text-lg font-black mb-4 border-b dark:border-slate-700 pb-2 flex items-center gap-2 ${linkMode === 'blogs' ? 'text-emerald-600 dark:text-emerald-400' : 'text-indigo-600 dark:text-indigo-400'}`}>
                                    {cat}
                                </h3>
                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                    {links.map((l, i) => (
                                        <div key={i} className="relative group">
                                            <a href={l.url} target="_blank" className="block p-3 rounded-xl bg-slate-50 dark:bg-slate-900/40 hover:shadow-md flex items-center gap-3 group transition-all border border-transparent dark:border-slate-700 dark:hover:border-emerald-500/50">
                                                <div className={`w-8 h-8 rounded flex items-center justify-center ${l.color || 'bg-slate-100 text-slate-700 dark:bg-slate-700 dark:text-slate-100'} bg-opacity-20 group-hover:scale-110 transition`}><i className={`fa-solid ${l.icon || 'fa-link'}`}></i></div>
                                                <span className="text-sm truncate pr-6 text-slate-900 dark:text-slate-100 font-bold">{l.name}</span>
                                            </a>
                                            {isRoutineEditMode && (
                                                <button onClick={() => {
                                                    if(linkMode === 'blogs') { const updated = { ...blogInsightLinks }; updated[cat] = updated[cat].filter((_, index) => index !== i); setBlogInsightLinks(updated); }
                                                    else { removeRoutineLink(cat, i); }
                                                }} className="absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center shadow-lg hover:bg-red-600 transition"><i className="fa-solid fa-xmark text-[10px]"></i></button>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );

            const renderTools = () => {
                const targetRes = (() => {
                    const currentPrice = parseFormattedNumber(targetInputs.price); const shares = parseFormattedNumber(targetInputs.shares);
                    let targetPrice = 0, rate = 0;
                    if(targetInputs.mode === 'cap') { const currentCap = parseFloat(targetInputs.currentCap) || 1; const targetCap = parseFloat(targetInputs.targetCap) || 0; targetPrice = currentPrice * (targetCap / currentCap); rate = ((targetCap / currentCap) - 1) * 100; }
                    else { targetPrice = parseFormattedNumber(targetInputs.targetRate); if(currentPrice > 0) rate = ((targetPrice - currentPrice) / currentPrice) * 100; }
                    return { targetPrice, rate, totalAmount: targetPrice * shares, profit: (targetPrice - currentPrice) * shares };
                })();
                const exchRes = (parseFormattedNumber(exchInputs.amount) * (exchangeRates[exchInputs.base]?.krw || 1)) / (exchangeRates[exchInputs.target]?.krw || 1);
                let avgCost = 0, avgQ = 0; avgRows.forEach(r => { const q = parseFormattedNumber(r.q); const p = parseFormattedNumber(r.p); avgQ += q; avgCost += q * p; });
                const ipoNeeded = (parseFormattedNumber(ipoCalcInputs.price) * parseFormattedNumber(ipoCalcInputs.qty) * (ipoCalcInputs.rate/100)) + parseFormattedNumber(ipoCalcInputs.fee);
                const toolTaxRes = toolTaxInputs.type === 'dividend' ? parseFormattedNumber(toolTaxInputs.profit) * 0.154 : parseFormattedNumber(toolTaxInputs.profit) * 0.22;
                const divPreTax = parseFormattedNumber(divInputs.shares) * parseFormattedNumber(divInputs.perShare);
                const divPostTax = divPreTax * (1 - (parseFloat(divInputs.tax) / 100));

                return (
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 animate-fade-in pb-10 font-bold">
                        <div className="bg-white dark:bg-slate-800 p-5 rounded-2xl shadow-sm border dark:border-slate-700 flex flex-col">
                            <h3 className="font-bold mb-4 text-indigo-600 dark:text-indigo-400 font-black flex items-center gap-2"><i className="fa-solid fa-bullseye"></i> Î™©Ìëú Îã®Í∞Ä Î∂ÑÏÑù</h3>
                            <div className="flex bg-slate-100 dark:bg-slate-900 p-1 rounded-lg mb-4 text-[10px]">
                                <button onClick={() => setTargetInputs({...targetInputs, mode:'cap'})} className={`flex-1 py-1.5 rounded-md transition-all ${targetInputs.mode==='cap'?'bg-white dark:bg-slate-600 shadow text-indigo-600 dark:text-indigo-100':'text-slate-500 dark:text-slate-300'}`}>ÏãúÏ¥ù ÎπÑÎ°Ä</button>
                                <button onClick={() => setTargetInputs({...targetInputs, mode:'rate'})} className={`flex-1 py-1.5 rounded-md transition-all ${targetInputs.mode==='rate'?'bg-white shadow text-indigo-600 dark:text-indigo-100':'text-slate-500 dark:text-slate-300'}`}>Í∞ÄÍ≤© ÏßÅÏ†ë</button>
                            </div>
                            <div className="space-y-4 flex-1">
                                <div className="grid grid-cols-2 gap-3">
                                    <div className="flex flex-col"><label className="text-[10px] text-slate-500 dark:text-slate-100 mb-1 font-bold">ÌòÑÏû¨Í∞Ä</label><input type="text" className="sim-input tool-input text-right" placeholder="0" value={targetInputs.price} onChange={e=>handleCommaChange(e, v=>setTargetInputs({...targetInputs, price:v}))} /></div>
                                    <div className="flex flex-col"><label className="text-[10px] text-slate-500 dark:text-slate-100 mb-1 font-bold">Î≥¥Ïú† ÏàòÎüâ</label><input type="text" className="sim-input tool-input text-right" placeholder="0" value={targetInputs.shares} onChange={e=>handleCommaChange(e, v=>setTargetInputs({...targetInputs, shares:v}))} /></div>
                                </div>
                                {targetInputs.mode === 'cap' ? (
                                    <div className="grid grid-cols-2 gap-3">
                                        <div className="flex flex-col"><label className="text-[10px] text-slate-500 dark:text-slate-100 mb-1 truncate font-bold">ÌòÑÏû¨ ÏãúÏ¥ù(Ï°∞)</label><input type="number" step="0.1" className="sim-input tool-input" value={targetInputs.currentCap} onChange={e=>setTargetInputs({...targetInputs, currentCap:e.target.value})} /></div>
                                        <div className="flex flex-col"><label className="text-[10px] text-slate-500 dark:text-slate-100 mb-1 truncate font-bold">Î™©Ìëú ÏãúÏ¥ù(Ï°∞)</label><input type="number" step="0.1" className="sim-input tool-input" value={targetInputs.targetCap} onChange={e=>setTargetInputs({...targetInputs, targetCap:e.target.value})} /></div>
                                    </div>
                                ) : (
                                    <div className="flex flex-col"><label className="text-[10px] text-slate-500 dark:text-slate-100 mb-1 font-bold">Î™©Ìëú Îã®Í∞Ä ÏßÅÏ†ë ÏûÖÎ†•</label><input type="text" className="sim-input tool-input text-right" placeholder="0" value={targetInputs.targetRate} onChange={e=>handleCommaChange(e, v=>setTargetInputs({...targetInputs, targetRate:v}))} /></div>
                                )}
                            </div>
                            <div className="tool-result-container bg-indigo-50/50 dark:bg-indigo-900/40 border-indigo-200 dark:border-indigo-700 text-indigo-700 dark:text-white num-font font-black">
                                <div className="flex justify-between items-center text-xs opacity-90 border-b border-indigo-100 dark:border-indigo-700 pb-2 mb-2"><span>Î™©Ìëú ÎèÑÎã¨ Îã®Í∞Ä</span><span>{formatNumber(targetRes.targetPrice)}Ïõê ({targetRes.rate.toFixed(1)}%)</span></div>
                                <div className="flex justify-between items-center text-xs opacity-90 mb-1"><span>ÏòàÏÉÅ Ï¥ùÏï°</span><span>{formatNumber(targetRes.totalAmount)}Ïõê</span></div>
                                <div className="flex justify-between items-center text-sm border-t border-indigo-200 dark:border-indigo-700 pt-2 mt-2"><span>Ï¥ù ÏòàÏÉÅ ÏàòÏùµÍ∏à</span><span className="text-lg text-indigo-700 dark:text-indigo-300">{formatNumber(targetRes.profit)}Ïõê</span></div>
                            </div>
                        </div>

                        <div className="bg-white dark:bg-slate-800 p-5 rounded-2xl shadow-sm border dark:border-slate-700 overflow-hidden flex flex-col">
                            <div className="flex justify-between items-center mb-4 text-blue-600 dark:text-blue-400">
                                <h3 className="font-bold font-black flex items-center gap-2 flex-shrink-0"><i className="fa-solid fa-money-bill-transfer"></i> ÌôòÏú® Í≥ÑÏÇ∞Í∏∞</h3>
                                <button onClick={fetchRealTimeRates} className={`text-slate-400 dark:text-white hover:text-blue-500 transition-colors ${isFetching ? 'animate-spin' : ''}`}><i className="fa-solid fa-arrows-rotate text-xs"></i></button>
                            </div>
                            <div className="space-y-4 flex-1">
                                <div className="flex flex-wrap sm:flex-nowrap gap-2 w-full">
                                    <select className="w-full sm:w-24 md:w-1/3 sim-input tool-input flex-shrink-0" value={exchInputs.base} onChange={e=>setExchInputs({...exchInputs, base:e.target.value})}>{Object.keys(exchangeRates).map(k=><option key={k} value={k}>{k}</option>)}</select>
                                    <input type="text" className="w-full flex-1 min-w-0 sim-input tool-input text-right" value={exchInputs.amount} onChange={e=>handleCommaChange(e, v=>setExchInputs({...exchInputs, amount:v}))} />
                                </div>
                                <div className="flex flex-wrap sm:flex-nowrap gap-2 w-full">
                                    <select className="w-full sm:w-24 md:w-1/3 sim-input tool-input flex-shrink-0" value={exchInputs.target} onChange={e=>setExchInputs({...exchInputs, target:e.target.value})}>{Object.keys(exchangeRates).map(k=><option key={k} value={k}>{k}</option>)}</select>
                                    <div className="w-full flex-1 min-w-0 flex items-center justify-end px-3 py-2 rounded-md bg-white dark:bg-slate-700 border-2 border-blue-200 dark:border-blue-900 text-blue-600 dark:text-white font-black text-lg num-font shadow-inner overflow-hidden">
                                        <span className="break-all text-right leading-tight">{formatNumber(exchRes)}</span>
                                    </div>
                                </div>
                            </div>
                            <div className="mt-4 p-3 rounded-xl bg-blue-50/50 dark:bg-blue-900/30 text-[10px] text-blue-600 dark:text-white text-center font-bold">Ïã§ÏãúÍ∞Ñ ÌôòÏú® Ï†ïÎ≥¥Î•º Î∞îÌÉïÏúºÎ°ú ÏûêÎèô Í≥ÑÏÇ∞Îê©ÎãàÎã§.</div>
                        </div>

                        <div className="bg-white dark:bg-slate-800 p-5 rounded-2xl shadow-sm border dark:border-slate-700 font-bold">
                            <h3 className="mb-4 text-rose-600 dark:text-rose-400 font-black flex items-center gap-2"><i className="fa-solid fa-receipt"></i> Í∞ÑÏù¥ ÏÑ∏Í∏à Í≥ÑÏÇ∞Í∏∞</h3>
                            <div className="space-y-3">
                                <div className="flex bg-slate-100 dark:bg-slate-900 p-1 rounded-lg mb-2 text-[10px]">
                                    <button onClick={() => setToolTaxInputs({...toolTaxInputs, type:'dividend'})} className={`flex-1 py-1.5 rounded-md transition-all ${toolTaxInputs.type==='dividend'?'bg-white dark:bg-slate-600 shadow text-rose-600 dark:text-rose-100':'text-slate-500 dark:text-slate-300'}`}>Î∞∞Îãπ/Ïù¥Ïûê(15.4%)</button>
                                    <button onClick={() => setToolTaxInputs({...toolTaxInputs, type:'capital'})} className={`flex-1 py-1.5 rounded-md transition-all ${toolTaxInputs.type==='capital'?'bg-white shadow text-rose-600 dark:text-rose-100':'text-slate-500 dark:text-slate-300'}`}>ÏñëÎèÑÏÜåÎìù(22%)</button>
                                </div>
                                <div><label className="text-[10px] text-slate-500 dark:text-slate-100 block mb-1 px-1 font-bold">ÏàòÏùµ Ï¥ùÏï°</label><input type="text" className="sim-input tool-input text-right" placeholder="0" value={toolTaxInputs.profit} onChange={e=>handleCommaChange(e, v=>setToolTaxInputs({...toolTaxInputs, profit:v}))} /></div>
                                <div className="tool-result-container bg-rose-50/50 dark:bg-rose-900/40 border-rose-200 dark:border-rose-800 text-rose-600 dark:text-white mt-2 num-font font-black"><span className="text-xs opacity-90 block mb-1">ÏòàÏÉÅ ÏÑ∏Í∏à Ìï©Í≥Ñ</span><span className="text-xl text-rose-700 dark:text-rose-300">{formatNumber(toolTaxRes)}Ïõê</span></div>
                            </div>
                        </div>

                        <div className="bg-white dark:bg-slate-800 p-5 rounded-2xl shadow-sm border dark:border-slate-700 font-bold">
                            <h3 className="mb-4 text-purple-600 dark:text-purple-400 font-black flex items-center gap-2"><i className="fa-solid fa-piggy-bank"></i> Í≥µÎ™®Ï£º Ï≤≠ÏïΩ Í≥ÑÏÇ∞</h3>
                            <div className="grid grid-cols-2 gap-3 mb-4">
                                <div className="flex flex-col"><label className="text-[10px] text-slate-500 dark:text-white font-black">Í≥µÎ™®Í∞Ä</label><input type="text" className="sim-input tool-input text-right" value={ipoCalcInputs.price} onChange={e=>handleCommaChange(e, v=>setIpoCalcInputs({...ipoCalcInputs, price:v}))} /></div>
                                <div className="flex flex-col"><label className="text-[10px] text-slate-500 dark:text-white font-black">Ï≤≠ÏïΩÏàòÎüâ</label><input type="text" className="sim-input tool-input text-right" value={ipoCalcInputs.qty} onChange={e=>setIpoCalcInputs({...ipoCalcInputs, qty:parseFormattedNumber(e.target.value).toLocaleString()})} /></div>
                                <div className="flex flex-col"><label className="text-[10px] text-slate-500 dark:text-white font-black">Ï¶ùÍ±∞Í∏àÏú®</label><select className="sim-input tool-input" value={ipoCalcInputs.rate} onChange={e=>setIpoCalcInputs({...ipoCalcInputs, rate:parseInt(e.target.value)})}><option value={50}>50%</option><option value={100}>100%</option></select></div>
                                <div className="flex flex-col"><label className="text-[10px] text-slate-500 dark:text-white font-black">ÏàòÏàòÎ£å</label><input type="text" className="sim-input tool-input text-right" value={ipoCalcInputs.fee} onChange={e=>handleCommaChange(e, v=>setIpoCalcInputs({...ipoCalcInputs, fee:v}))} /></div>
                            </div>
                            <div className="tool-result-container bg-purple-50/50 dark:bg-purple-900/40 border-purple-200 dark:border-purple-800 text-purple-600 dark:text-white num-font font-black">
                                <span className="text-xs opacity-90 block mb-1">Ï¥ù ÌïÑÏöî Ï¶ùÍ±∞Í∏à</span>
                                <span className="text-xl text-purple-700 dark:text-purple-300">{formatNumber(ipoNeeded)}Ïõê</span>
                            </div>
                        </div>

                        <div className="bg-white dark:bg-slate-800 p-5 rounded-2xl shadow-sm border dark:border-slate-700 font-bold flex flex-col">
                            <h3 className="mb-3 text-emerald-600 dark:text-emerald-400 flex justify-between items-center font-black">
                                <span className="flex items-center gap-2"><i className="fa-solid fa-scale-balanced"></i> ÌèâÎã®Í∞Ä Í≥ÑÏÇ∞Í∏∞</span>
                                <button onClick={()=>setAvgRows([...avgRows, {id:Date.now(), q:'', p:''}])} className="bg-emerald-100 dark:bg-emerald-900/50 text-emerald-600 dark:text-white px-2 py-0.5 rounded text-[10px] hover:bg-emerald-200 transition-colors">+ Ï∂îÍ∞Ä</button>
                            </h3>
                            <div className="space-y-2 overflow-y-auto max-h-40 mb-3 pr-1 scrollbar-thin">
                                {avgRows.map((r, i) => (
                                    <div key={r.id} className="grid grid-cols-12 gap-1 items-center animate-fade-in">
                                        <input type="text" placeholder="ÏàòÎüâ" className="col-span-5 sim-input tool-input text-right !p-1.5" value={r.q} onChange={e=>handleCommaChange(e, v=>{const n=[...avgRows]; n[i].q=v; setAvgRows(n);})} />
                                        <input type="text" placeholder="Îã®Í∞Ä" className="col-span-5 sim-input tool-input text-right !p-1.5" value={r.p} onChange={e=>handleCommaChange(e, v=>{const n=[...avgRows]; n[i].p=v; setAvgRows(n);})} />
                                        <button onClick={()=>{const n=avgRows.filter(row=>row.id!==r.id); setAvgRows(n.length?n:[{id:Date.now(),q:'',p:''}]);}} className="col-span-2 text-rose-400 hover:text-rose-500"><i className="fa-solid fa-trash-can text-xs"></i></button>
                                    </div>
                                ))}
                            </div>
                            <div className="tool-result-container bg-emerald-50/50 dark:bg-emerald-900/40 border-emerald-200 dark:border-emerald-700/50 pb-1 mb-2">
                                <div className="flex justify-between items-center text-[10px] border-b dark:border-slate-700 pb-1 mb-2"><span className="text-slate-500 dark:text-slate-200 font-bold">Ìï©Í≥Ñ ÏàòÎüâ</span><span className="text-slate-900 dark:text-white font-black">{formatNumber(avgQ)}</span></div>
                                <div className="text-[10px] text-slate-500 dark:text-slate-200 font-bold">ÏµúÏ¢Ö ÌèâÎã®Í∞Ä</div>
                                <div className="text-xl text-emerald-700 dark:text-emerald-400 font-black">{avgQ ? formatNumber(avgCost/avgQ) : 0}Ïõê</div>
                            </div>
                        </div>

                        <div className="bg-white dark:bg-slate-800 p-5 rounded-2xl shadow-sm border dark:border-slate-700 font-bold">
                            <h3 className="mb-4 text-amber-600 dark:text-amber-400 font-black flex items-center gap-2"><i className="fa-solid fa-sack-dollar"></i> Î∞∞ÎãπÍ∏à Í≥ÑÏÇ∞Í∏∞</h3>
                            <div className="space-y-3">
                                <div className="grid grid-cols-2 gap-3">
                                    <div className="flex flex-col"><label className="text-[10px] text-slate-500 dark:text-slate-100 mb-1 font-bold">Î≥¥Ïú† ÏàòÎüâ</label><input type="text" className="sim-input tool-input text-right" placeholder="0" value={divInputs.shares} onChange={e=>handleCommaChange(e, v=>setDivInputs({...divInputs, shares:v}))} /></div>
                                    <div className="flex flex-col"><label className="text-[10px] text-slate-500 dark:text-slate-100 mb-1 font-bold">Ï£ºÎãπ Î∞∞ÎãπÍ∏à</label><input type="text" className="sim-input tool-input text-right" placeholder="0" value={divInputs.perShare} onChange={e=>handleCommaChange(e, v=>setDivInputs({...divInputs, perShare:v}))} /></div>
                                </div>
                                <div className="tool-result-container bg-amber-50/50 dark:bg-amber-900/40 border-amber-200 dark:border-amber-800 text-amber-600 dark:text-white num-font font-black space-y-1">
                                    <div className={`flex justify-between items-center text-xs opacity-90 border-b border-amber-100 dark:border-amber-700 pb-2 mb-2`}><span>ÏÑ∏Ï†Ñ Ï¥ùÏï°</span><span>{formatNumber(divPreTax)}Ïõê</span></div>
                                    <div className="flex justify-between items-center text-[10px] opacity-90"><span>Ïã§Ìö®ÏÑ∏Ïú® {divInputs.tax}% Ï†ÅÏö©</span></div>
                                    <div className="flex justify-between items-center text-sm"><span>ÏÑ∏ÌõÑ Ïã§ÏàòÎ†π</span><span className="text-xl text-amber-700 dark:text-amber-300">{formatNumber(divPostTax)}Ïõê</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            const renderFinancialTax = () => {
                const totalFinIncome = finList.reduce((a, c) => a + c.amount, 0);
                const earnedIncomeValue = parseFormattedNumber(earnedIncome);
                const calculateTaxFlow = (earned, find) => {
                    const brackets = [ { limit: 14000000, rate: 0.06 }, { limit: 50000000, rate: 0.15 }, { limit: 88000000, rate: 0.24 }, { limit: 150000000, rate: 0.35 }, { limit: 300000000, rate: 0.38 }, { limit: 500000000, rate: 0.40 }, { limit: 1000000000, rate: 0.42 }, { limit: Infinity, rate: 0.45 } ];
                    const isTarget = find > TAX_THRESHOLD; const finTaxable = isTarget ? (find - TAX_THRESHOLD) : 0; const combinedBase = earned + finTaxable;
                    let rem = combinedBase; let calculatedTax = 0; let lastLimit = 0; const breakdown = [];
                    for (const b of brackets) { if (rem <= 0) break; const chunk = Math.min(rem, b.limit - lastLimit); const tax = chunk * b.rate; breakdown.push({ label: `${formatNumber(lastLimit/10000)}Îßå~${isFinite(b.limit) ? formatNumber(b.limit/10000)+'Îßå' : 'Ï¥àÍ≥º'}`, income: chunk, rate: b.rate * 100, tax: tax }); calculatedTax += tax; rem -= chunk; lastLimit = b.limit; }
                    const separateFinTax = isTarget ? TAX_THRESHOLD * 0.14 : find * 0.14; 
                    const totalDecided = (calculatedTax + separateFinTax) * 1.1; 
                    let remE = earned; let lastLE = 0; let taxEOnly = 0; for (const b of brackets) { if (remE <= 0) break; const chunk = Math.min(remE, b.limit - lastLE); taxEOnly += chunk * b.rate; remE -= chunk; lastLE = b.limit; }
                    const prepaidEarned = taxEOnly * 1.1; const prepaidFin = find * 0.154; 
                    const additionalPayable = totalDecided - (prepaidEarned + prepaidFin); 
                    const nhiAnnual = Math.max(0, find - 20000000) * 0.0709 * 1.1281;
                    return { totalDecided, additionalPayable, nhiAnnual, isTarget, breakdown, totalPrepaid: prepaidEarned + prepaidFin };
                };
                const resCurrent = calculateTaxFlow(earnedIncomeValue, totalFinIncome); const resNoEarned = calculateTaxFlow(0, totalFinIncome);
                const taxImpact = resCurrent.additionalPayable - resNoEarned.additionalPayable; const finalTotalBurden = resCurrent.additionalPayable + resCurrent.nhiAnnual;

                return (
                    <div className="space-y-6 animate-fade-in pb-10 font-bold w-full max-w-full overflow-hidden">
                        <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center border-b dark:border-slate-700 pb-2 gap-2"><h2 className="text-xl sm:text-2xl font-black text-black dark:text-white">Í∏àÏúµÏÜåÎìù Ï¢ÖÌï©Í≥ºÏÑ∏ & Í∏∞ÎÇ©Î∂Ä ÏÑ∏Ïï° Ï†ïÏÇ∞</h2><div className="text-[10px] text-white font-black bg-indigo-600 px-3 py-1 rounded-full whitespace-nowrap">Ïã§Ï†ú Ï∂îÍ∞Ä ÎÇ©Î∂ÄÏï° Î∂ÑÏÑù</div></div>
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div className="lg:col-span-1 space-y-4">
                                <div className="bg-white dark:bg-slate-800 p-4 sm:p-5 rounded-2xl border-2 border-slate-200 dark:border-slate-700 shadow-sm"><h3 className="text-sm font-black text-indigo-600 dark:text-indigo-300 mb-4 flex items-center gap-2"><i className="fa-solid fa-briefcase"></i> Í∑ºÎ°úÏÜåÎìù Ï†ïÎ≥¥</h3><div className="flex flex-col"><label className="text-[11px] text-black dark:text-black mb-1 font-black">Ïó∞Í∞Ñ Í∑ºÎ°úÏÜåÎìù Í≥ºÏÑ∏ÌëúÏ§Ä (Ïõê)</label><input type="text" className="sim-input text-right !bg-slate-100 border-2" value={earnedIncome} onChange={e=>handleCommaChange(e, setEarnedIncome)} /><p className="mt-2 text-[10px] text-indigo-700 dark:text-indigo-300 leading-relaxed font-bold">‚Ä¢ Îß§Îã¨ Í∏âÏó¨ÏóêÏÑú Í∏∞ÎÇ©Î∂ÄÌïú ÏÑ∏Ïï°ÏùÑ ÏûêÎèôÏúºÎ°ú Ï∂îÏÇ∞ÌïòÏó¨ Ï†ïÏÇ∞Ïóê Î∞òÏòÅÌï©ÎãàÎã§.</p></div></div>
                                <div className="bg-white dark:bg-slate-800 p-4 sm:p-5 rounded-2xl border-2 border-slate-200 dark:border-slate-700 shadow-sm"><div className="flex justify-between items-center mb-4"><h3 className="text-sm font-black text-amber-600 dark:text-amber-300 flex items-center gap-2"><i className="fa-solid fa-hand-holding-dollar"></i> Í∏àÏúµÏÜåÎìù ÎÇ¥Ïó≠</h3><button onClick={()=>setFinList([...finList, {id:Date.now(), source:'', amount:0}])} className="text-[10px] bg-amber-500 text-white px-2 py-1 rounded font-black">+ Ï∂îÍ∞Ä</button></div><div className="space-y-3 max-h-60 overflow-y-auto pr-1">{finList.map((f, i) => (<div key={f.id} className="flex gap-2 items-center"><input type="text" placeholder="Ìï≠Î™©Î™Ö" className="flex-1 sim-input !p-2 text-xs !bg-slate-100" value={f.source} onChange={e=>{const n=[...finList]; n[i].source=e.target.value; setFinList(n);}} /><input type="text" placeholder="Í∏àÏï°" className="w-24 sm:w-28 sim-input !p-2 text-xs text-right !bg-slate-100" value={f.amount.toLocaleString()} onChange={e=>{const n=[...finList]; n[i].amount=parseFormattedNumber(e.target.value); setFinList(n);}} /><button onClick={()=>{const n=finList.filter(row=>row.id!==f.id); setFinList(n.length?n:[{id:Date.now(),source:'',amount:0}]);}} className="text-red-500 p-1 hover:bg-red-50 rounded"><i className="fa-solid fa-trash-can"></i></button></div>))}</div><div className="mt-4 pt-4 border-t-2 dark:border-slate-700 flex justify-between items-center"><span className="text-xs font-black text-black dark:text-white">Í∏àÏúµÏÜåÎìù Ìï©Í≥Ñ</span><span className={`text-lg sm:text-xl font-black ${totalFinIncome > 20000000 ? 'text-rose-600' : 'text-blue-600'}`}>{formatNumber(totalFinIncome)}Ïõê</span></div></div>
                                <div className="bg-slate-50 dark:bg-slate-900/50 p-4 sm:p-5 rounded-2xl border border-slate-200 dark:border-slate-700 space-y-4"><h3 className="text-sm font-black text-emerald-600 dark:text-emerald-300 flex items-center gap-2"><i className="fa-solid fa-circle-info"></i> Ï†àÏÑ∏ Í∞ÄÏù¥Îìú</h3><div className="space-y-3"><div className="p-3 bg-white dark:bg-slate-800 rounded-xl border dark:border-slate-700 shadow-sm"><h4 className="text-[11px] font-black mb-1 text-black dark:text-white">ISA Í≥ÑÏ¢å ÌôúÏö©</h4><p className="text-[10px] text-slate-500 dark:text-slate-200 leading-normal font-bold">Î∞∞Îãπ/Ïù¥Ïûê ÏÜåÎìù 200/400ÎßåÏõêÍπåÏßÄ ÎπÑÍ≥ºÏÑ∏, Ï¥àÍ≥ºÎ∂ÑÏùÄ 9.9% Î∂ÑÎ¶¨Í≥ºÏÑ∏ÎêòÏñ¥ Ï¢ÖÌï©Í≥ºÏÑ∏ ÎåÄÏÉÅÏóêÏÑú Ï†úÏô∏Îê©ÎãàÎã§.</p></div><div className="p-3 bg-white dark:bg-slate-800 rounded-xl border dark:border-slate-700 shadow-sm"><h4 className="text-[11px] font-black mb-1 text-black dark:text-white">Ìï¥Ïô∏Ï£ºÏãù/ETF</h4><p className="text-[10px] text-slate-500 dark:text-slate-200 leading-normal font-bold">ÏßÅÏ†ë Ìà¨ÏûêÎäî ÏñëÎèÑÏ∞®Ïùµ 250ÎßåÏõê Í≥µÏ†ú ÌõÑ 22% Î∂ÑÎ•òÍ≥ºÏÑ∏ÎêòÏñ¥ Ï¢ÖÌï©ÏÜåÎìùÏóê Ìï©ÏÇ∞ÎêòÏßÄ ÏïäÏäµÎãàÎã§.</p></div></div></div>
                            </div>
                            <div className="lg:col-span-2 space-y-6">
                                <div className="bg-white dark:bg-slate-800 rounded-3xl p-5 sm:p-6 border-4 border-indigo-500 shadow-2xl animate-fade-in relative overflow-hidden"><h3 className="text-lg font-black text-indigo-800 dark:text-indigo-300 mb-6 flex items-center gap-2"><i className="fa-solid fa-scale-unbalanced-flip"></i> Í∑ºÎ°úÏÜåÎìù Ìï©ÏÇ∞ Ïãú Ïã§Ï†ú ÏÑ∏Í∏à Ï¶ùÍ∞ÄÎ∂Ñ</h3><div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6"><div className="p-4 rounded-2xl bg-slate-50 dark:bg-slate-900 border-2 border-slate-200 dark:border-slate-700 shadow-sm"><p className="text-[11px] font-black text-black dark:text-white mb-2 flex items-center gap-1"><i className="fa-solid fa-circle text-[6px] text-slate-400"></i> Í∏àÏúµÏÜåÎìùÎßå ÏûàÏùÑ Îïå Ï†ïÏÇ∞Ïï°</p><p className="text-lg font-black text-black dark:text-white">{formatNumber(resNoEarned.additionalPayable)}Ïõê</p><p className="text-[9px] text-slate-500 dark:text-slate-400 mt-1 font-bold">‚Äª Í∏àÏúµ ÏõêÏ≤úÏßïÏàòÎ∂Ñ(15.4%) Ï∞®Í∞ê ÌõÑ Ï†ïÏÇ∞Ïï°</p></div><div className="p-4 rounded-2xl bg-indigo-50 dark:bg-indigo-900 border-2 border-indigo-200 dark:border-indigo-800"><p className="text-[11px] font-black text-indigo-700 dark:text-indigo-300 mb-2 flex items-center gap-1"><i className="fa-solid fa-circle text-[6px] text-indigo-500"></i> Í∑ºÎ°ú+Í∏àÏúµ Ìï©ÏÇ∞ Ïãú Ï†ïÏÇ∞Ïï°</p><p className="text-lg font-black text-indigo-700 dark:text-white">{formatNumber(resCurrent.additionalPayable)}Ïõê</p><p className="text-[9px] text-indigo-400 dark:text-indigo-300 mt-1 font-bold">‚Äª Í∑ºÎ°ú/Í∏àÏúµ Í∏∞ÎÇ©Î∂Ä ÏÑ∏Ïï° Î™®Îëê Ï∞®Í∞ê ÌõÑ Ï†ïÏÇ∞Ïï°</p></div></div><div className="bg-rose-600 p-5 rounded-2xl text-white shadow-lg text-center transform hover:scale-[1.01] transition-transform"><p className="text-xs font-black opacity-90 mb-2">Í∑ºÎ°úÏÜåÎìù Î≥¥Ïú†Î°ú Ïù∏Ìïú ÏàúÏàò ÏÑ∏Í∏à Ï¶ùÍ∞ÄÎ∂Ñ</p><h4 className="text-3xl sm:text-4xl font-black mb-1">+{formatNumber(taxImpact)}Ïõê</h4><p className="text-[10px] font-bold opacity-80 leading-normal">‚Äª Í±¥Î≥¥Î£åÎ•º Ï†úÏô∏ÌïòÍ≥†, Í∑ºÎ°úÏÜåÎìùÍ≥ºÏùò Ìï©ÏÇ∞ÏúºÎ°ú Ïù∏Ìï¥ ÎàÑÏßÑÏÑ∏Ïú®Ïù¥ Ïò¨ÎùºÍ∞Ä Í∏àÏúµÏÜåÎìùÏù¥ ÎÜíÏùÄ ÏÑ∏Ïú®ÏùÑ Ï†ÅÏö©Î∞õÏïÑ Î∞úÏÉùÌïòÎäî Ï∂îÍ∞Ä ÏÑ∏Î∂ÄÎã¥ÏûÖÎãàÎã§.</p></div></div>
                                <div className="bg-indigo-700 p-6 sm:p-8 rounded-3xl text-white shadow-2xl text-center animate-fade-in border-4 border-indigo-300"><p className="text-sm font-black opacity-90 mb-3 flex items-center justify-center gap-2"><i className="fa-solid fa-wallet"></i> ÏµúÏ¢Ö Ïã§Ïßà Ï∂îÍ∞Ä Î∂ÄÎã¥Ïï° (ÏÑ∏Í∏àÏ†ïÏÇ∞ + Í±¥Î≥¥Î£åÏù∏ÏÉÅ)</p><h4 className="text-4xl sm:text-6xl font-black mb-3 tracking-tight break-all">{formatNumber(finalTotalBurden)}Ïõê</h4><div className="flex flex-wrap justify-center gap-2 sm:gap-6 text-[10px] sm:text-xs font-bold opacity-80 mt-2"><span className="bg-white/10 px-2 py-1 rounded">Ïã§Ïßà ÏàòÏùµ ÎåÄÎπÑ ÎπÑÏ§ë: {((finalTotalBurden / (totalFinIncome || 1)) * 100).toFixed(1)}%</span><span className="bg-white/10 px-2 py-1 rounded">ÏõîÌèâÍ∑† Ï∂îÍ∞Ä Î∂ÄÎã¥: {formatNumber(finalTotalBurden / 12)}Ïõê</span></div><p className="text-[9px] font-bold mt-4 opacity-70 underline underline-offset-2">Ïù¥ Í∏àÏï°ÏùÄ ÏõêÏ≤úÏßïÏàòÎêú 15.4%Î•º Ï†úÏô∏ÌïòÍ≥† ÏÇ¨Ïö©ÏûêÎãòÏù¥ Ï£ºÎ®∏ÎãàÏóêÏÑú Ïã§Ï†úÎ°ú Îçî ÎÇòÍ∞ÄÏïº ÌïòÎäî ÏµúÏ¢Ö Ï¥ùÏï°ÏûÖÎãàÎã§.</p></div>
                                <div className="bg-white dark:bg-slate-800 p-4 sm:p-6 rounded-2xl border-2 border-slate-200 dark:border-slate-700 shadow-sm overflow-hidden"><h3 className="text-sm font-black mb-4 flex items-center gap-2 text-black dark:text-white"><i className="fa-solid fa-list-check text-indigo-500"></i> ÏÑ∏Ïï° ÏÇ∞Ï∂ú Íµ¨Í∞ÑÎ≥Ñ ÏÉÅÏÑ∏ (Ìï©ÏÇ∞ Í∏∞Ï§Ä)</h3><div className="overflow-x-auto -mx-4 sm:mx-0"><table className="w-full text-[10px] sm:text-[11px] text-left border-collapse min-w-[300px]"><thead><tr className="border-b-2 dark:border-slate-700 text-black dark:text-white font-black"><th className="py-2 px-1">Í≥ºÏÑ∏ Íµ¨Í∞Ñ</th><th className="py-2 px-1 text-right">Íµ¨Í∞Ñ ÏÜåÎìù</th><th className="py-2 px-1 text-center">ÏÑ∏Ïú®</th><th className="py-2 px-1 text-right">Íµ¨Í∞Ñ ÏÑ∏Ïï°</th></tr></thead><tbody className="num-font text-black dark:text-white font-bold">{resCurrent.breakdown.map((b, idx) => (<tr key={idx} className="border-b dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700/50"><td className="py-2 px-1">{b.label}</td><td className="py-2 px-1 text-right whitespace-nowrap">{formatNumber(b.income)}Ïõê</td><td className="py-2 px-1 text-center text-indigo-600 dark:text-indigo-400">{b.rate}%</td><td className="py-2 px-1 text-right whitespace-nowrap">{formatNumber(b.tax)}Ïõê</td></tr>))}<tr className="bg-indigo-50 dark:bg-indigo-900/30 font-black"><td className="p-3" colSpan="3">Ï¢ÖÌï©ÏÜåÎìù ÏÇ∞Ï∂úÏÑ∏Ïï° Ìï©Í≥Ñ (ÎàÑÏßÑÎ∂Ñ)</td><td className="p-3 text-right whitespace-nowrap">{formatNumber(resCurrent.breakdown.reduce((a,c)=>a+c.tax, 0))}Ïõê</td></tr></tbody></table></div></div>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4"><div className="bg-white dark:bg-slate-800 p-5 rounded-2xl border-2 border-slate-200 dark:border-slate-700 shadow-sm"><h4 className="text-xs font-black text-black dark:text-white mb-4"><i className="fa-solid fa-receipt mr-2 text-indigo-500"></i>Ï†ïÏÇ∞ ÏÑ∏Î∂Ä ÎÇ¥Ïó≠</h4><div className="space-y-3 text-xs font-bold text-black dark:text-white"><div className="flex justify-between border-b pb-2 dark:border-slate-700"><span>Í≤∞Ï†ïÏÑ∏Ïï° (ÏßÄÎ∞©ÏÑ∏ Ìè¨Ìï®)</span><span className="whitespace-nowrap">{formatNumber(resCurrent.totalDecided)}Ïõê</span></div><div className="flex justify-between border-b pb-2 dark:border-slate-700"><span>Í∏∞ÎÇ©Î∂Ä ÏÑ∏Ïï° Ìï©Í≥Ñ</span><span className="text-rose-600 whitespace-nowrap">-{formatNumber(resCurrent.totalPrepaid)}Ïõê</span></div><div className="flex justify-between items-center pt-2"><span className="text-sm font-black">ÏÑ∏Í∏à Ïã§Ï†ïÏÇ∞Ïï°</span><span className={`text-xl font-black ${resCurrent.additionalPayable > 0 ? 'text-rose-600' : 'text-blue-600'} whitespace-nowrap`}>{resCurrent.additionalPayable > 0 ? '+' : ''}{formatNumber(resCurrent.additionalPayable)}Ïõê</span></div></div></div><div className="bg-white dark:bg-slate-800 p-5 rounded-2xl border-2 border-slate-200 dark:border-slate-700 shadow-sm"><h4 className="text-xs font-black text-black dark:text-white mb-4"><i className="fa-solid fa-shield-heart mr-2 text-amber-500"></i>Í±¥Í∞ïÎ≥¥ÌóòÎ£å Ï∂îÍ∞Ä Î∂ÄÎã¥</h4><div className="space-y-3 text-xs font-bold text-black dark:text-white"><div className="flex justify-between border-b pb-2 dark:border-slate-700"><span>Ïó∞Í∞Ñ Ï¥ù Ïù∏ÏÉÅÎ∂Ñ</span><span className="text-amber-600 font-black whitespace-nowrap">+{formatNumber(resCurrent.nhiAnnual)}Ïõê</span></div><div className="flex justify-between items-center pt-2"><span className="text-sm font-black">ÏõîÌèâÍ∑† Ï∂îÍ∞Ä Î∂ÄÎã¥</span><span className="text-xl font-black text-amber-600 whitespace-nowrap">{formatNumber(resCurrent.nhiAnnual / 12)}Ïõê</span></div><p className="text-[10px] text-slate-500 dark:text-white mt-4 font-bold leading-tight">‚Ä¢ Í∏àÏúµÏÜåÎìù 2,000ÎßåÏõê Ï¥àÍ≥ºÎ∂ÑÏóê ÎåÄÌï¥ 7.09% Î∂ÄÍ≥º</p></div></div></div>
                            </div>
                        </div>
                    </div>
                );
            };

            return (
                <div className={`min-h-screen flex flex-col transition-colors duration-200 ${isDark ? 'dark bg-slate-900 text-slate-100' : 'bg-slate-50 text-slate-800'}`}>
                    <header className="sticky top-0 z-50 bg-white dark:bg-slate-800 border-b dark:border-slate-700 shadow h-16">
                        <div className="max-w-7xl mx-auto px-4 h-full flex items-center justify-between">
                            <div className="flex items-center gap-2 font-black text-lg flex-shrink-0"><i className="fa-solid fa-compass text-blue-600"></i> <span className="hidden sm:inline text-black font-black">Navigator</span></div>
                            <div className="nav-container flex-1 mx-4">
                                <nav className="inline-flex bg-slate-100 dark:bg-slate-700 p-1 rounded-xl gap-1">
                                    {[{id:'dashboard',l:'ÎåÄÏãúÎ≥¥Îìú'},{id:'routine',l:'Î£®Ìã¥'},{id:'tools',l:'ÎèÑÍµ¨'},{id:'simulation',l:'ÎÖ∏ÌõÑÏûêÍ∏à'},{id:'tax',l:'Í∏àÏúµÍ≥ºÏÑ∏'}].map(t => (
                                        <button key={t.id} onClick={()=>setActiveTab(t.id)} className={`nav-tab px-3 sm:px-5 py-1.5 text-xs rounded-lg transition-all ${activeTab === t.id ? 'active' : 'text-slate-500 dark:text-white font-black'}`}>{t.l}</button>
                                    ))}
                                </nav>
                            </div>
                            <button onClick={()=>setIsDark(!isDark)} className="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 transition flex-shrink-0"><i className={`fa-solid ${isDark?'fa-sun text-amber-400':'fa-moon dark:text-white'}`}></i></button>
                        </div>
                    </header>
                    <main className="max-w-7xl w-full mx-auto px-4 py-6 flex-1 overflow-x-hidden">
                        {activeTab === 'dashboard' && renderDashboard()}
                        {activeTab === 'routine' && renderRoutine()}
                        {activeTab === 'tools' && renderTools()}
                        {activeTab === 'simulation' && (
                            <div className="animate-fade-in pb-10 font-bold space-y-6">
                                <h2 className="text-xl sm:text-2xl font-black mb-4 border-b dark:border-slate-700 pb-2 flex flex-col sm:flex-row sm:items-center gap-3 dark:text-white">
                                    ÎÖ∏ÌõÑ ÏûêÍ∏à ÏãúÎÆ¨Î†àÏù¥ÏÖò
                                    <span className="text-[10px] sm:text-xs bg-indigo-100 dark:bg-indigo-900/40 text-indigo-600 dark:text-indigo-200 px-2 py-1 rounded font-black w-max">v3.5 ÏàòÏùµ Î∂ÑÏÑù Ï≤¥Í≥Ñ Í≥†ÎèÑÌôî</span>
                                </h2>

                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                                    <div className="guide-card border-l-4 border-l-blue-500 bg-blue-50 dark:bg-blue-900/10 flex gap-4 items-start h-full">
                                        <div className="bg-blue-100 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400 p-3 rounded-lg flex-shrink-0"><i className="fa-solid fa-clock-rotate-left text-xl"></i></div>
                                        <div className="text-[10px] sm:text-xs space-y-1">
                                            <h3 className="font-black text-blue-700 dark:text-blue-300 mb-1">Íµ≠ÎØºÏó∞Í∏à ÏàòÎ†π Ï†ÑÎûµ</h3>
                                            <p className="text-slate-500 dark:text-white font-bold">‚Ä¢ <strong>Ï°∞Í∏∞ ÏàòÎ†π:</strong> 1ÎÖÑÎãπ 6% Í∞êÏï° (ÏµúÎåÄ -30%)</p>
                                            <p className="text-slate-500 dark:text-white font-bold">‚Ä¢ <strong>Ïó∞Í∏∞ ÏàòÎ†π:</strong> 1ÎÖÑÎãπ 7.2% Ï¶ùÏï° (ÏµúÎåÄ +36%)</p>
                                            <p className="text-slate-500 dark:text-white font-bold">‚Ä¢ ÌïòÎã® ÏûÖÎ†•Ï∞ΩÏóêÏÑú Î≥∏Ïù∏/Î∞∞Ïö∞Ïûê Ï†ÑÎûµÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.</p>
                                        </div>
                                    </div>
                                    <div className="guide-card border-l-4 border-l-amber-500 flex gap-4 items-start h-full">
                                        <div className="bg-amber-100 dark:bg-amber-900/20 text-amber-600 dark:text-amber-400 p-3 rounded-lg flex-shrink-0"><i className="fa-solid fa-lightbulb text-xl"></i></div>
                                        <div className="text-[10px] sm:text-xs space-y-1">
                                            <h3 className="font-black text-amber-700 dark:text-amber-300 mb-1">ÏßÄÏ∂ú Í≥°ÏÑ† (U-Shape)</h3>
                                            <p className="text-slate-500 dark:text-white font-bold">‚Ä¢ <strong>ÌôúÎèôÍ∏∞:</strong> ÏÉùÌôúÎπÑ 110% / <strong>Ïá†Ìá¥Í∏∞:</strong> 90% ÌïòÎùΩ</p>
                                            <p className="text-slate-500 dark:text-white font-bold">‚Ä¢ <strong>Í∞ÑÎ≥ëÍ∏∞:</strong> ÏÉùÌôúÎπÑ 70% + <strong>ÏùòÎ£å/Í∞ÑÎ≥ëÎπÑ</strong> Ï∂îÍ∞Ä</p>
                                            <p className="text-slate-500 dark:text-white font-bold">‚Ä¢ ÌÖåÏù¥Î∏îÏóêÏÑú Ìô©Í∏àÏÉâ Î∞∞Í≤ΩÏúºÎ°ú ÏûêÎèô ÌëúÏãúÎê©ÎãàÎã§.</p>
                                        </div>
                                    </div>
                                    {/* Ïã†Í∑ú Ï∂îÍ∞Ä: ÏàòÏùµ Íµ¨ÏÑ± ÏöîÏÜå Í∞ÄÏù¥Îìú */}
                                    <div className="guide-card border-l-4 border-l-indigo-500 flex gap-4 items-start h-full">
                                        <div className="bg-indigo-100 dark:bg-indigo-900/20 text-indigo-600 dark:text-indigo-400 p-3 rounded-lg flex-shrink-0"><i className="fa-solid fa-layer-group text-xl"></i></div>
                                        <div className="text-[10px] sm:text-xs space-y-1">
                                            <h3 className="font-black text-indigo-700 dark:text-indigo-300 mb-1">ÏàòÏùµ Íµ¨ÏÑ± ÏöîÏÜå Í∞ÄÏù¥Îìú</h3>
                                            <p className="font-bold flex items-center gap-1.5"><span className="w-1.5 h-1.5 rounded-full bg-indigo-500"></span> <strong>Ï¢ÖÌï©Í≥ºÏÑ∏:</strong> ÏùºÎ∞ò ÏûêÏÇ∞ ÏàòÏùµ + CMA Ïù¥Ïûê</p>
                                            <p className="font-bold flex items-center gap-1.5"><span className="w-1.5 h-1.5 rounded-full bg-emerald-500"></span> <strong>ÎπÑÍ≥ºÏÑ∏:</strong> Í≥µÎ™®Ï£º Îß§Í∞Å Ï∞®Ïùµ + ISA Í≥ÑÏ¢å Ï†ÑÏ≤¥</p>
                                            <p className="font-bold flex items-center gap-1.5"><span className="w-1.5 h-1.5 rounded-full bg-blue-500"></span> <strong>Í∏∞ÌÉÄ:</strong> Íµ≠ÎØºÏó∞Í∏à + Ïó∞Í∞Ñ Í∏∞ÌÉÄ ÏÜåÎìù(ÏûÑÎåÄ Îì±)</p>
                                        </div>
                                    </div>
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 font-bold">
                                    <div className="bg-white dark:bg-slate-800 p-5 rounded-xl border dark:border-slate-700 shadow-sm space-y-4">
                                        <h3 className="text-indigo-600 dark:text-indigo-300 text-sm border-b dark:border-slate-700 pb-1 font-black"><i className="fa-solid fa-calendar-day mr-1"></i> 1. Ïó∞Î†π Î∞è ÏàòÎ†π Ï†ÑÎûµ</h3>
                                        <div className="grid grid-cols-2 gap-3">
                                            <div className="flex flex-col"><label className="text-[10px] text-slate-500 dark:text-white font-black">Î≥∏Ïù∏ ÌòÑÏû¨</label><input type="number" className="sim-input" value={simInputs.currentAge} onChange={e=>setSimInputs({...simInputs, currentAge:parseInt(e.target.value)})}/></div>
                                            <div className="flex flex-col"><label className="text-[10px] text-slate-500 dark:text-white font-black">Î∞∞Ïö∞Ïûê ÌòÑÏû¨</label><input type="number" className="sim-input" value={simInputs.spouseCurrentAge} onChange={e=>setSimInputs({...simInputs, spouseCurrentAge:parseInt(e.target.value)})}/></div>
                                            <div className="flex flex-col col-span-2"><label className="text-[10px] text-indigo-500 dark:text-indigo-300 font-bold">ÏãúÎÆ¨Î†àÏù¥ÏÖò ÏãúÏûë ÎÇòÏù¥</label><input type="number" className="sim-input border-indigo-300 dark:border-indigo-600" value={simInputs.simulationStartAge} onChange={e=>setSimInputs({...simInputs, simulationStartAge:parseInt(e.target.value)})}/></div>
                                            <div className="flex flex-col"><label className="text-[10px] text-slate-500 dark:text-white font-black">Í∞ÑÎ≥ëÍ∏∞ Ï†ÑÌôò</label><input type="number" className="sim-input" value={simInputs.highCostStartAge} onChange={e=>setSimInputs({...simInputs, highCostStartAge:parseInt(e.target.value)})}/></div>
                                            <div className="flex flex-col"><label className="text-[10px] text-slate-500 dark:text-white font-black">Ïó∞Í∏à Í∏∞Ï§ÄÏ†ê</label><div className="sim-input bg-slate-100 dark:bg-slate-100 border-none flex items-center justify-center text-xs !text-black font-bold">65ÏÑ∏</div></div>
                                            
                                            <div className="flex flex-col col-span-2 border-t dark:border-slate-700 pt-2">
                                                <label className="text-[10px] text-blue-600 dark:text-blue-400 font-black">Î≥∏Ïù∏ ÏàòÎ†π Ï†ÑÎûµ</label>
                                                <select className="sim-input border-blue-200 text-xs" value={simInputs.pensionStrategyUser} onChange={e=>setSimInputs({...simInputs, pensionStrategyUser: e.target.value})}>
                                                    <option value="early5">5ÎÖÑ Ï°∞Í∏∞ (60ÏÑ∏ ÏàòÎ†π, -30%)</option>
                                                    <option value="early4">4ÎÖÑ Ï°∞Í∏∞ (61ÏÑ∏ ÏàòÎ†π, -24%)</option>
                                                    <option value="early3">3ÎÖÑ Ï°∞Í∏∞ (62ÏÑ∏ ÏàòÎ†π, -18%)</option>
                                                    <option value="early2">2ÎÖÑ Ï°∞Í∏∞ (63ÏÑ∏ ÏàòÎ†π, -12%)</option>
                                                    <option value="early1">1ÎÖÑ Ï°∞Í∏∞ (64ÏÑ∏ ÏàòÎ†π, -6%)</option>
                                                    <option value="normal">Ï†ïÏÉÅ ÏàòÎ†π (65ÏÑ∏ ÏàòÎ†π, 100%)</option>
                                                    <option value="defer1">1ÎÖÑ Ïó∞Í∏∞ (66ÏÑ∏ ÏàòÎ†π, +7.2%)</option>
                                                    <option value="defer2">2ÎÖÑ Ïó∞Í∏∞ (67ÏÑ∏ ÏàòÎ†π, +14.4%)</option>
                                                    <option value="defer3">3ÎÖÑ Ïó∞Í∏∞ (68ÏÑ∏ ÏàòÎ†π, +21.6%)</option>
                                                    <option value="defer4">4ÎÖÑ Ïó∞Í∏∞ (69ÏÑ∏ ÏàòÎ†π, +28.8%)</option>
                                                    <option value="defer5">5ÎÖÑ Ïó∞Í∏∞ (70ÏÑ∏ ÏàòÎ†π, +36.0%)</option>
                                                </select>
                                            </div>
                                            <div className="flex flex-col col-span-2">
                                                <label className="text-[10px] text-blue-600 dark:text-blue-400 font-black">Î∞∞Ïö∞Ïûê ÏàòÎ†π Ï†ÑÎûµ</label>
                                                <select className="sim-input border-blue-200 text-xs" value={simInputs.pensionStrategySpouse} onChange={e=>setSimInputs({...simInputs, pensionStrategySpouse: e.target.value})}>
                                                    <option value="early5">5ÎÖÑ Ï°∞Í∏∞ (60ÏÑ∏ ÏàòÎ†π, -30%)</option>
                                                    <option value="early4">4ÎÖÑ Ï°∞Í∏∞ (61ÏÑ∏ ÏàòÎ†π, -24%)</option>
                                                    <option value="early3">3ÎÖÑ Ï°∞Í∏∞ (62ÏÑ∏ ÏàòÎ†π, -18%)</option>
                                                    <option value="early2">2ÎÖÑ Ï°∞Í∏∞ (63ÏÑ∏ ÏàòÎ†π, -12%)</option>
                                                    <option value="early1">1ÎÖÑ Ï°∞Í∏∞ (64ÏÑ∏ ÏàòÎ†π, -6%)</option>
                                                    <option value="normal">Ï†ïÏÉÅ ÏàòÎ†π (65ÏÑ∏ ÏàòÎ†π, 100%)</option>
                                                    <option value="defer1">1ÎÖÑ Ïó∞Í∏∞ (66ÏÑ∏ ÏàòÎ†π, +7.2%)</option>
                                                    <option value="defer2">2ÎÖÑ Ïó∞Í∏∞ (67ÏÑ∏ ÏàòÎ†π, +14.4%)</option>
                                                    <option value="defer3">3ÎÖÑ Ïó∞Í∏∞ (68ÏÑ∏ ÏàòÎ†π, +21.6%)</option>
                                                    <option value="defer4">4ÎÖÑ Ïó∞Í∏∞ (69ÏÑ∏ ÏàòÎ†π, +28.8%)</option>
                                                    <option value="defer5">5ÎÖÑ Ïó∞Í∏∞ (70ÏÑ∏ ÏàòÎ†π, +36.0%)</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div className="bg-white dark:bg-slate-800 p-5 rounded-xl border dark:border-slate-700 shadow-sm space-y-4">
                                        <h3 className="text-emerald-600 dark:text-emerald-300 text-sm border-b dark:border-slate-700 pb-1 font-black"><i className="fa-solid fa-vault mr-1"></i> 2. Í∏∞Ï¥à ÏûêÏÇ∞ Î∞è ÏàòÏùµÎ•†</h3>
                                        <div className="grid grid-cols-2 gap-x-3 gap-y-4">
                                            <div className="flex flex-col"><label className="text-[9px] text-blue-500 font-black">Î≥∏Ïù∏ ÏùºÎ∞ò(Ïñµ)</label><input type="number" step="0.1" className="sim-input" value={simInputs.capUserNonISA} onChange={e=>setSimInputs({...simInputs, capUserNonISA:parseFloat(e.target.value)})}/></div>
                                            <div className="flex flex-col"><label className="text-[9px] text-blue-400 font-black">ÏàòÏùµÎ•†(%)</label><input type="number" step="0.1" className="sim-input" value={simInputs.returnUserNonISA} onChange={e=>setSimInputs({...simInputs, returnUserNonISA:parseFloat(e.target.value)})}/></div>
                                            <div className="flex flex-col"><label className="text-[9px] text-blue-500 font-black">Î∞∞Ïö∞Ïûê ÏùºÎ∞ò(Ïñµ)</label><input type="number" step="0.1" className="sim-input" value={simInputs.capSpouseNonISA} onChange={e=>setSimInputs({...simInputs, capSpouseNonISA:parseFloat(e.target.value)})}/></div>
                                            <div className="flex flex-col"><label className="text-[9px] text-blue-400 font-black">ÏàòÏùµÎ•†(%)</label><input type="number" step="0.1" className="sim-input" value={simInputs.returnSpouseNonISA} onChange={e=>setSimInputs({...simInputs, returnSpouseNonISA:parseFloat(e.target.value)})}/></div>
                                            
                                            <div className="col-span-2 border-t-2 border-indigo-100 dark:border-slate-700 pt-3">
                                                <div className="grid grid-cols-2 gap-x-3">
                                                    <div className="flex flex-col"><label className="text-[9px] text-purple-600 font-black">Í≥µÎ™®Ï£º ÏûêÏÇ∞(Ïñµ)</label><input type="number" step="0.1" className="sim-input border-indigo-200" value={simInputs.capIPO} onChange={e=>setSimInputs({...simInputs, capIPO:parseFloat(e.target.value)})}/></div>
                                                    <div className="flex flex-col"><label className="text-[9px] text-purple-500 font-black">Í≥µÎ™®Ï£º ÏàòÏùµÎ•†(%)</label><input type="number" step="0.1" className="sim-input border-indigo-200" value={simInputs.returnIPO} onChange={e=>setSimInputs({...simInputs, returnIPO:parseFloat(e.target.value)})}/></div>
                                                    <div className="flex flex-col col-span-2 mt-2 bg-indigo-50 dark:bg-indigo-900/30 p-2 rounded">
                                                        <label className="text-[9px] text-indigo-700 dark:text-indigo-200 font-black">Í≥µÎ™®Ï£º ÎåÄÍ∏∞ÏûêÍ∏à CMA Ïù¥ÏûêÏú®(%)</label>
                                                        <input type="number" step="0.1" className="sim-input !mt-1 !p-1 border-indigo-200" value={simInputs.returnCMA} onChange={e=>setSimInputs({...simInputs, returnCMA:parseFloat(e.target.value)})}/>
                                                    </div>
                                                </div>
                                            </div>

                                            <div className="flex flex-col border-t dark:border-slate-700 pt-3"><label className="text-[9px] text-emerald-600 font-black">Î≥∏Ïù∏ ISA(Ïñµ)</label><input type="number" step="0.1" className="sim-input" value={simInputs.capUserISA} onChange={e=>setSimInputs({...simInputs, capUserISA:parseFloat(e.target.value)})}/></div>
                                            <div className="flex flex-col border-t dark:border-slate-700 pt-3"><label className="text-[9px] text-emerald-500 font-black">ÏàòÏùµÎ•†(%)</label><input type="number" step="0.1" className="sim-input" value={simInputs.returnUserISA} onChange={e=>setSimInputs({...simInputs, returnUserISA:parseFloat(e.target.value)})}/></div>
                                            <div className="flex flex-col border-t dark:border-slate-700 pt-3"><label className="text-[9px] text-emerald-600 font-black">Î∞∞Ïö∞Ïûê ISA(Ïñµ)</label><input type="number" step="0.1" className="sim-input" value={simInputs.capSpouseISA} onChange={e=>setSimInputs({...simInputs, capSpouseISA:parseFloat(e.target.value)})}/></div>
                                            <div className="flex flex-col border-t dark:border-slate-700 pt-3"><label className="text-[9px] text-emerald-500 font-black">ÏàòÏùµÎ•†(%)</label><input type="number" step="0.1" className="sim-input" value={simInputs.returnSpouseISA} onChange={e=>setSimInputs({...simInputs, returnSpouseISA:parseFloat(e.target.value)})}/></div>
                                        </div>
                                    </div>

                                    <div className="bg-white dark:bg-slate-800 p-5 rounded-xl border dark:border-slate-700 shadow-sm space-y-4">
                                        <h3 className="text-orange-600 dark:text-orange-300 text-sm border-b dark:border-slate-700 pb-1 font-black"><i className="fa-solid fa-chart-line mr-1"></i> 3. Î¨ºÍ∞Ä Î∞è ÏÑ∏Ïú® ÏÑ§Ï†ï(%)</h3>
                                        <div className="grid grid-cols-2 gap-3">
                                            <div className="flex flex-col"><label className="text-[10px] text-slate-500 dark:text-white font-black">Î¨ºÍ∞Ä ÏÉÅÏäπÎ•†</label><input type="number" step="0.1" className="sim-input" value={simInputs.inflationRate} onChange={e=>setSimInputs({...simInputs, inflationRate:parseFloat(e.target.value)})}/></div>
                                            <div className="flex flex-col"><label className="text-[10px] text-slate-500 dark:text-white font-black">ÏÉùÌôúÎπÑ ÏÉÅÏäπÎ•†</label><input type="number" step="0.1" className="sim-input" value={simInputs.livingCostInflationRate} onChange={e=>setSimInputs({...simInputs, livingCostInflationRate:parseFloat(e.target.value)})}/></div>
                                            <div className="flex flex-col"><label className="text-[10px] text-red-500 font-black">ÏÑ∏Ïú®1(Í∏∞Î≥∏)</label><input type="number" step="0.1" className="sim-input" value={simInputs.taxRate1} onChange={e=>setSimInputs({...simInputs, taxRate1:parseFloat(e.target.value)})}/></div>
                                            <div className="flex flex-col"><label className="text-[10px] text-red-700 font-black">ÏÑ∏Ïú®2(ÎàÑÏßÑ)</label><input type="number" step="0.1" className="sim-input" value={simInputs.taxRate2} onChange={e=>setSimInputs({...simInputs, taxRate2:parseFloat(e.target.value)})}/></div>
                                        </div>
                                        <div className="flex flex-col border-t dark:border-slate-700 pt-3 mt-1 bg-indigo-50 dark:bg-indigo-900/20 p-2 rounded">
                                            <label className="text-[10px] text-indigo-500 dark:text-indigo-400 font-black">100ÏÑ∏ Î™©Ìëú ÏûîÏï° (ÏÉÅÏÜç Îì±)</label>
                                            <input type="text" className="sim-input !mt-1 !p-1 border-indigo-200 dark:border-indigo-700 text-right" value={simInputs.targetLegacy} onChange={e=>handleCommaChange(e, v=>setSimInputs({...simInputs, targetLegacy: v}))}/>
                                        </div>
                                    </div>
                                    
                                    <div className="bg-white dark:bg-slate-800 p-5 rounded-xl border dark:border-slate-700 shadow-sm space-y-4">
                                        <h3 className="text-rose-600 dark:text-rose-300 text-sm border-b dark:border-slate-700 pb-1 font-black"><i className="fa-solid fa-money-check-dollar mr-1"></i> 4. Ïõî ÏàòÏûÖ Î∞è ÏßÄÏ∂ú(Ïõê)</h3>
                                        <div className="flex flex-col">
                                            <label className="text-[11px] text-red-600 dark:text-red-300 font-black">Í∏∞Î≥∏ ÏÉùÌôúÎπÑ(Ïõî)</label>
                                            <input type="text" className="sim-input text-right text-red-600 dark:text-red-300" value={simInputs.monthlyLiving} onChange={e=>handleCommaChange(e, v=>setSimInputs({...simInputs, monthlyLiving:v}))}/>
                                        </div>
                                        <div className="flex flex-col bg-rose-50 dark:bg-rose-900/20 p-2 rounded">
                                            <label className="text-[10px] text-rose-500 dark:text-rose-400 font-black">Í∞ÑÎ≥ëÍ∏∞ ÏùòÎ£å/Í∞ÑÎ≥ëÎπÑ(Ïõî)</label>
                                            <input type="text" className="sim-input !mt-1 !p-1 text-right text-rose-700 dark:white" placeholder="0" value={simInputs.monthlyMedical} onChange={e=>handleCommaChange(e, v=>setSimInputs({...simInputs, monthlyMedical:v}))}/>
                                        </div>
                                        <div className="grid grid-cols-2 gap-3 pt-2">
                                            <div className="flex flex-col"><label className="text-[10px] text-slate-500 dark:text-white font-black">Ï†ïÏÉÅ Î≥∏Ïù∏ Ïó∞Í∏à(Ïõî)</label><input type="text" className="sim-input text-right" value={simInputs.pensionSelf} onChange={e=>handleCommaChange(e, v=>setSimInputs({...simInputs, pensionSelf: v}))}/></div>
                                            <div className="flex flex-col"><label className="text-[10px] text-slate-500 dark:text-white font-black">Ï†ïÏÉÅ Î∞∞Ïö∞Ïûê Ïó∞Í∏à(Ïõî)</label><input type="text" className="sim-input text-right" value={simInputs.pensionSpouse} onChange={e=>handleCommaChange(e, v=>setSimInputs({...simInputs, pensionSpouse: v}))}/></div>
                                        </div>
                                    </div>
                                    
                                    <div className="bg-white dark:bg-slate-800 p-5 rounded-xl border dark:border-slate-700 shadow-sm space-y-4">
                                        <h3 className="text-blue-600 dark:text-blue-300 text-sm border-b dark:border-slate-700 pb-1 font-black"><i className="fa-solid fa-hand-holding-dollar mr-1"></i> 5. Í∏∞ÌÉÄ Ïó∞Í∞Ñ ÏàòÏûÖ(Ïõê)</h3>
                                        <div className="grid grid-cols-2 gap-3">
                                            <div className="flex flex-col"><label className="text-[10px] text-slate-500 dark:text-white font-black">Í≥µÎ™®Ï£º ÏàòÏùµ</label><input type="text" className="sim-input text-right" value={simInputs.ipoProfit} onChange={e=>handleCommaChange(e, v=>setSimInputs({...simInputs, ipoProfit: v}))}/></div>
                                            <div className="flex flex-col"><label className="text-[10px] text-slate-500 dark:text-white font-black">ÏûÑÎåÄ ÏÜåÎìù</label><input type="text" className="sim-input text-right" value={simInputs.rentalIncome} onChange={e=>handleCommaChange(e, v=>setSimInputs({...simInputs, rentalIncome: v}))}/></div>
                                            <div className="flex flex-col"><label className="text-[10px] text-slate-500 dark:text-white font-black">Í∏∞ÌÉÄ ÏÇ¨ÏóÖ</label><input type="text" className="sim-input text-right" value={simInputs.otherIncome} onChange={e=>handleCommaChange(e, v=>setSimInputs({...simInputs, otherIncome: v}))}/></div>
                                            <div className="flex flex-col"><label className="text-[10px] text-slate-500 dark:text-white font-black">ÎåÄÏó¨ ÏàòÏàòÎ£å</label><input type="text" className="sim-input text-right" value={simInputs.stockLending} onChange={e=>handleCommaChange(e, v=>setSimInputs({...simInputs, stockLending: v}))}/></div>
                                        </div>
                                        <div className="flex flex-col border-t dark:border-slate-700 pt-2 bg-blue-50 dark:bg-blue-900/20 p-2 rounded">
                                            <label className="text-[10px] text-slate-500 dark:text-white font-black">Ïó∞Í∞Ñ ÎπÑÏÉÅÍ∏à</label>
                                            <input type="text" className="sim-input !mt-1 !p-1 text-right" value={simInputs.extraReserve} onChange={e=>handleCommaChange(e, v=>setSimInputs({...simInputs, extraReserve: v}))}/>
                                        </div>
                                    </div>
                                    
                                    <div className={`${simResult.summary?.isSuccess ? 'bg-indigo-600' : 'bg-rose-600'} text-white p-5 rounded-xl shadow-lg flex flex-col justify-center text-center transition-colors duration-500 h-full`}>
                                        <p className="text-xs opacity-90 mb-2 font-black">100ÏÑ∏ ÏòàÏ∏° ÏûêÏÇ∞</p>
                                        <h3 className={`text-xl sm:text-2xl font-black ${simResult.summary?.depletion ? 'text-yellow-300' : 'text-white'} break-all`}>
                                            {simResult.summary?.depletion ? `${simResult.summary.depletion}ÏÑ∏ ÏûêÏÇ∞ Í≥†Í∞à` : formatNumber(simResult.summary?.final) + 'Ïõê'}
                                        </h3>
                                        <div className="mt-3 py-1 px-3 bg-white/20 rounded-full text-[10px] inline-block mx-auto font-black">
                                            {simResult.summary?.isSuccess ? "‚úÖ Î™©Ìëú Îã¨ÏÑ± ÏÑ±Í≥µ" : "‚ö†Ô∏è Î™©Ìëú ÎØ∏Îã¨ (Ï°∞Ï†ï ÌïÑÏöî)"}
                                        </div>
                                    </div>
                                </div>

                                <div className="mt-6 bg-white dark:bg-slate-800 p-6 rounded-xl border dark:border-slate-700 shadow-sm h-[350px] sm:h-[450px]">
                                    <SimulationChart history={simResult.history} />
                                </div>

                                <div className="mt-6 bg-white dark:bg-slate-800 p-3 rounded-xl border dark:border-slate-700 shadow-sm relative">
                                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-2">
                                        <h3 className="text-sm font-black text-slate-900 dark:text-white flex items-center gap-2">
                                            <i className="fa-solid fa-table text-indigo-500"></i>
                                            Ïó∞Î†πÎ≥Ñ ÏÉÅÏÑ∏ ÏûêÍ∏à ÌùêÎ¶Ñ Î∂ÑÏÑù
                                        </h3>
                                        <div className="flex items-center gap-2 w-full sm:w-auto">
                                            <div className="relative w-full sm:w-auto">
                                                <button 
                                                    onClick={() => setIsSimColMenuOpen(!isSimColMenuOpen)}
                                                    className="w-full sm:w-auto bg-slate-100 dark:bg-slate-200 border border-slate-300 dark:border-slate-400 px-3 py-1.5 rounded-lg text-xs font-black flex items-center justify-center gap-2 hover:bg-slate-200 !text-black"
                                                >
                                                    <i className="fa-solid fa-gear"></i> Ìï≠Î™© ÏÑ†ÌÉù
                                                </button>
                                                {isSimColMenuOpen && (
                                                    <div className="absolute right-0 bottom-12 sm:bottom-auto sm:top-10 z-20 w-48 bg-white dark:bg-slate-800 border dark:border-slate-700 rounded-xl shadow-2xl p-4 animate-fade-in">
                                                        <h4 className="text-[10px] font-black mb-3 border-b pb-2 dark:text-white">ÌëúÏãúÌï† Ìï≠Î™©</h4>
                                                        <div className="space-y-2">
                                                            {[
                                                                {id: 'taxable', l: 'Ï¢ÖÌï©Í≥ºÏÑ∏ ÎåÄÏÉÅ'},
                                                                {id: 'exempt', l: 'ÎπÑÍ≥ºÏÑ∏/Î∂ÑÎ¶¨ÏàòÏùµ'},
                                                                {id: 'income', l: 'Í∏∞ÌÉÄÏàòÏûÖ/Ïó∞Í∏à'},
                                                                {id: 'expense', l: 'Ï¥ù ÏßÄÏ∂ú'},
                                                                {id: 'flow', l: 'ÌòÑÍ∏àÌùêÎ¶Ñ/Ï¶ùÍ∞ê'},
                                                                {id: 'status', l: 'ÏÉÅÌÉú'}
                                                            ].map(col => (
                                                                <label key={col.id} className="flex items-center gap-2 cursor-pointer group">
                                                                    <input 
                                                                        type="checkbox" 
                                                                        className="w-3 h-3 rounded text-indigo-600 focus:ring-indigo-500" 
                                                                        checked={simTableVisibleCols[col.id]} 
                                                                        onChange={() => setSimTableVisibleCols({...simTableVisibleCols, [col.id]: !simTableVisibleCols[col.id]})}
                                                                    />
                                                                    <span className="text-[11px] font-bold text-slate-600 dark:text-slate-300 group-hover:text-indigo-600">{col.l}</span>
                                                                </label>
                                                            ))}
                                                        </div>
                                                        <button 
                                                            onClick={() => setIsSimColMenuOpen(false)}
                                                            className="mt-4 w-full bg-indigo-600 text-white py-1.5 rounded-lg text-[10px] font-black"
                                                        >
                                                            ÌôïÏù∏
                                                        </button>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div className="overflow-x-auto">
                                        <table className="w-full text-[11px] sm:text-[12px] text-left border-collapse table-auto min-w-max">
                                            <thead className="bg-slate-100 dark:bg-slate-900 sticky top-0 z-10">
                                                <tr className="text-slate-900 dark:text-white font-black leading-tight">
                                                    <th className="px-2 py-3 border-b dark:border-slate-700 text-center sticky left-0 bg-slate-100 dark:bg-slate-900 z-20">ÎÇòÏù¥</th>
                                                    <th className="px-2 py-3 border-b dark:border-slate-700 text-center">Ï¥ùÏûêÏÇ∞(Ïñµ)</th>
                                                    <th className="px-2 py-3 border-b dark:border-slate-700 text-center">ÏûîÏï°ÏÉÅÌÉú</th>
                                                    
                                                    {simTableVisibleCols.taxable && (
                                                        <th className="px-2 py-3 border-b dark:border-slate-700 text-indigo-600 dark:text-indigo-400 text-right">
                                                            Ï¢ÖÌï©Í≥ºÏÑ∏ ÎåÄÏÉÅ(Ïõê)
                                                        </th>
                                                    )}
                                                    {simTableVisibleCols.exempt && (
                                                        <th className="px-2 py-3 border-b dark:border-slate-700 text-emerald-600 dark:text-emerald-400 text-right">
                                                            ÎπÑÍ≥ºÏÑ∏/Î∂ÑÎ¶¨ÏàòÏùµ(Ïõê)
                                                        </th>
                                                    )}
                                                    {simTableVisibleCols.income && (
                                                        <th className="px-2 py-3 border-b dark:border-slate-700 text-blue-600 dark:text-blue-400 text-right">
                                                            Í∏∞ÌÉÄÏàòÏûÖ/Ïó∞Í∏à(Ïõê)
                                                        </th>
                                                    )}
                                                    {simTableVisibleCols.expense && (
                                                        <th className="px-2 py-3 border-b dark:border-slate-700 text-rose-600 dark:text-rose-400 text-right">
                                                            Ï¥ù ÏßÄÏ∂ú(Ïõê)
                                                        </th>
                                                    )}
                                                    {simTableVisibleCols.flow && (
                                                        <>
                                                            <th className="px-2 py-3 border-b dark:border-slate-700 text-center">ÌùêÎ¶Ñ%</th>
                                                            <th className="px-2 py-3 border-b dark:border-slate-700 text-right">Ïó∞Í∞ÑÏ¶ùÍ∞ê(Ïõê)</th>
                                                        </>
                                                    )}
                                                    {simTableVisibleCols.status && (
                                                        <th className="px-2 py-3 border-b dark:border-slate-700 text-center">ÏÉÅÌÉú</th>
                                                    )}
                                                </tr>
                                            </thead>
                                            <tbody className="bg-white dark:bg-slate-800">
                                                {simResult.history.map((h, idx) => {
                                                    const totalExpense = h.living + h.tax;
                                                    const cashFlowIndex = (h.annualProfit / totalExpense) * 100;
                                                    const rowBgClass = h.isHighCost ? 'bg-amber-50 dark:bg-amber-900/30' : h.isWarn ? 'bg-rose-50/70 dark:bg-rose-900/60' : '';

                                                    return (
                                                        <tr key={idx} className={`hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors border-b dark:border-slate-700 ${rowBgClass}`}>
                                                            <td className="px-2 py-2.5 font-black text-slate-900 dark:text-white text-center sticky left-0 bg-inherit z-10 border-r dark:border-slate-700">
                                                                {h.age}
                                                            </td>
                                                            <td className={`px-2 py-2.5 font-black text-center ${h.isWarn ? 'text-rose-600 dark:text-rose-300' : 'text-indigo-600 dark:text-indigo-300'}`}>
                                                                {h.total.toFixed(2)}
                                                            </td>
                                                            <td className="px-2 py-2.5">
                                                                <div className="flex justify-center gap-1">
                                                                    <div title="Î≥∏Ïù∏ ÏùºÎ∞ò" className={`w-2 h-2 rounded-full ${h.un > 0 ? 'bg-red-500 shadow-sm' : 'bg-slate-200 dark:bg-slate-700'}`}></div>
                                                                    <div title="Î∞∞Ïö∞Ïûê ÏùºÎ∞ò" className={`w-2 h-2 rounded-full ${h.sn > 0 ? 'bg-amber-500 shadow-sm' : 'bg-slate-200 dark:bg-slate-700'}`}></div>
                                                                    <div title="Í≥µÎ™®Ï£º" className={`w-2 h-2 rounded-full ${h.cip > 0 ? 'bg-purple-500 shadow-sm' : 'bg-slate-200 dark:bg-slate-700'}`}></div>
                                                                    <div title="Î∞∞Ïö∞Ïûê ISA" className={`w-2 h-2 rounded-full ${h.si > 0 ? 'bg-blue-500 shadow-sm' : 'bg-slate-200 dark:bg-slate-700'}`}></div>
                                                                    <div title="Î≥∏Ïù∏ ISA" className={`w-2 h-2 rounded-full ${h.ui > 0 ? 'bg-emerald-500 shadow-sm' : 'bg-slate-200 dark:bg-slate-700'}`}></div>
                                                                </div>
                                                            </td>

                                                            {simTableVisibleCols.taxable && (
                                                                <td className={`px-2 py-2.5 font-black num-font text-right ${h.taxableProfit > 20000000 ? 'text-red-500 underline' : 'text-indigo-600 dark:text-indigo-200'}`}>
                                                                    <div className="text-[10px] mb-1">{formatNumber(h.taxableProfit)}</div>
                                                                    <div className="text-[8px] opacity-70 leading-tight border-t dark:border-slate-600 mt-1 pt-1 font-normal">
                                                                        Î≥∏Ïù∏: {formatNumber(h.details.taxable.u)}<br/>
                                                                        Î∞∞Ïö∞Ïûê: {formatNumber(h.details.taxable.s)}<br/>
                                                                        CMA: {formatNumber(h.details.taxable.c)}
                                                                    </div>
                                                                </td>
                                                            )}
                                                            {simTableVisibleCols.exempt && (
                                                                <td className="px-2 py-2.5 text-emerald-600 dark:text-emerald-200 font-black num-font text-right">
                                                                    <div className="text-[10px] mb-1">{formatNumber(h.separateExemptProfit)}</div>
                                                                    <div className="text-[8px] opacity-70 leading-tight border-t dark:border-slate-600 mt-1 pt-1 font-normal">
                                                                        Í≥µÎ™®Ï£º: {formatNumber(h.details.exempt.i)}<br/>
                                                                        Î≥∏Ïù∏ISA: {formatNumber(h.details.exempt.ui)}<br/>
                                                                        Î∞∞Ïö∞ÏûêISA: {formatNumber(h.details.exempt.si)}
                                                                    </div>
                                                                </td>
                                                            )}
                                                            {simTableVisibleCols.income && (
                                                                <td className="px-2 py-2.5 text-blue-600 dark:text-blue-300 font-black num-font text-right">
                                                                    <div className="text-[10px] mb-1">{formatNumber(h.baseIncome)}</div>
                                                                    <div className="text-[8px] opacity-70 leading-tight border-t dark:border-slate-600 mt-1 pt-1 font-normal">
                                                                        Í≥µÏ†ÅÏó∞Í∏à: {formatNumber(h.details.income.p)}<br/>
                                                                        Í∏∞ÌÉÄÏàòÏûÖ: {formatNumber(h.details.income.o)}
                                                                    </div>
                                                                </td>
                                                            )}
                                                            {simTableVisibleCols.expense && (
                                                                <td className="px-2 py-2.5 num-font text-rose-600 dark:text-rose-300 font-black text-right">{formatNumber(totalExpense)}</td>
                                                            )}
                                                            {simTableVisibleCols.flow && (
                                                                <>
                                                                    <td className="px-2 py-2.5 text-center text-slate-900 dark:text-white">
                                                                        <span className={`text-[10px] font-black px-1.5 py-0.5 rounded ${cashFlowIndex >= 100 ? 'bg-emerald-100 text-emerald-700 dark:bg-emerald-900/40 dark:text-emerald-300' : 'bg-rose-100 text-rose-700 dark:bg-rose-900/40 dark:text-rose-300'}`}>
                                                                            {cashFlowIndex.toFixed(0)}%
                                                                        </span>
                                                                    </td>
                                                                    <td className={`px-2 py-2.5 text-right font-bold num-font ${h.netChange >= 0 ? 'text-emerald-600 dark:text-emerald-300' : 'text-rose-500 dark:text-rose-200'}`}>
                                                                        {h.netChange >= 0 ? '+' : ''}{formatNumber(h.netChange)}
                                                                    </td>
                                                                </>
                                                            )}
                                                            {simTableVisibleCols.status && (
                                                                <td className="px-2 py-2.5 text-center text-slate-900 dark:text-white">
                                                                    <span className={`px-1.5 py-0.5 rounded text-[10px] font-black ${h.isHighCost ? 'bg-amber-100 text-amber-700 dark:bg-amber-800 dark:text-amber-100' : 'bg-slate-100 text-slate-500 dark:bg-slate-700 dark:text-slate-100'}`}>
                                                                        {h.isHighCost ? 'Í∞ÑÎ≥ë' : 'ÌôúÎèô'}
                                                                    </span>
                                                                </td>
                                                            )}
                                                        </tr>
                                                    );
                                                })}
                                            </tbody>
                                        </table>
                                    </div>
                                    <div className="mt-4 p-4 bg-slate-100 rounded-xl border border-dashed border-slate-300">
                                        <h4 className="text-[10px] font-black !text-black mb-2">ÏûêÏÇ∞Î≥Ñ ÏûîÏï° ÏÉÅÌÉú Í∞ÄÏù¥Îìú</h4>
                                        <div className="flex flex-wrap gap-4 text-[9px] font-bold">
                                            <div className="flex items-center gap-1.5"><div className="w-2 h-2 rounded-full bg-red-500"></div><span className="!text-black">Î≥∏Ïù∏ ÏùºÎ∞ò</span></div>
                                            <div className="flex items-center gap-1.5"><div className="w-2 h-2 rounded-full bg-amber-500"></div><span className="!text-black">Î∞∞Ïö∞Ïûê ÏùºÎ∞ò</span></div>
                                            <div className="flex items-center gap-1.5"><div className="w-2 h-2 rounded-full bg-purple-500"></div><span className="!text-black">Í≥µÎ™®Ï£º</span></div>
                                            <div className="flex items-center gap-1.5"><div className="w-2 h-2 rounded-full bg-blue-500"></div><span className="!text-black">Î∞∞Ïö∞Ïûê ISA</span></div>
                                            <div className="flex items-center gap-1.5"><div className="w-2 h-2 rounded-full bg-emerald-500"></div><span className="!text-black">Î≥∏Ïù∏ ISA</span></div>
                                            <div className="flex items-center gap-1.5"><div className="w-2 h-2 rounded-full bg-slate-200 dark:bg-slate-700"></div><span className="!text-black">ÏûêÏÇ∞ Í≥†Í∞à</span></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                        {activeTab === 'tax' && renderFinancialTax()}
                    </main>
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>